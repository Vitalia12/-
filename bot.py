import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ChatPermissions, CallbackQuery
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
import sqlite3
from datetime import datetime, timedelta
import asyncio
import json
import os
import re
import secrets
import string


REVIEWS_THREAD_ID = 2181  # ะะะะกะฌ ะะกะขะะะฌ ะะะะะฌะะซะ ID ะขะะะซ ะะขะะซะะะ
# ะะฐัััะพะนะบะฐ ะปะพะณะธัะพะฒะฐะฝะธั
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ะะพะฝัะธะณััะฐัะธั
TOKEN = "8238577942:AAEwk_Qomx-UdFdNaexGcBkwWg19DlK05-I"
ADMIN_GROUP_ID = -1003702109842
TG_CHANNEL_LINK = "https://t.me/putnikvtumane_wow"

# ID ะณะปะฐะฒะฝัั ะฐะดะผะธะฝะพะฒ
MAIN_ADMIN_IDS = [1064040960, 8456444166, 6431631188]

# ID ัะตะผ
PENDING_CHATS_THREAD_ID = 2177
ADMIN_APPS_THREAD_ID = 2179
RESTS_THREAD_ID = 2183

# ะะพะฝััะฐะฝัั ะผะพะดะตัะฐัะธะธ
MAX_WARNS = 5

# RP ะดะตะนััะฒะธั
RP_ACTIONS = {
    "hug": "๐ค ะพะฑะฝะธะผะฐะตั",
    "hugtight": "๐ซ ะบัะตะฟะบะพ ะพะฑะฝะธะผะฐะตั",
    "cuddle": "๐ฅฐ ะฟัะธะถะธะผะฐะตั",
    "snuggle": "๐ ะฟัะธะถะธะผะฐะตััั",
    "nuzzle": "๐ ััะตััั ะฝะพัะพะผ",
    "kiss": "๐ ัะตะปัะตั",
    "kissforehead": "๐ ัะตะปัะตั ะฒ ะปะพะฑ",
    "kisscheek": "๐ ัะตะปัะตั ะฒ ัะตัะบั",
    "kissneck": "๐ ัะตะปัะตั ะฒ ัะตั",
    "kisshand": "๐คต ัะตะปัะตั ััะบั",
    "suck": "๐ ะทะฐัะฐััะฒะฐะตั",
    "bite": "๐ฆท ะฟะพะบัััะฒะฐะตั",
    "nip": "๐ ะฟะพัะธะฟัะฒะฐะตั",
    "lick": "๐ ะพะฑะปะธะทัะฒะฐะตั",
    "pet": "๐ฑ ะณะปะฐะดะธั",
    "stroke": "๐๏ธ ะฟะพะณะปะฐะถะธะฒะฐะตั",
    "caress": "๐ ะปะฐัะบะฐะตั",
    "touch": "๐ ะบะฐัะฐะตััั",
    "hold": "๐คฒ ะดะตัะถะธั ะทะฐ ััะบั",
    "holdwaist": "๐ ะดะตัะถะธั ะทะฐ ัะฐะปะธั",
    "carry": "๐งโ๐ผ ะฝะตัะตั ะฝะฐ ััะบะฐั",
    "lift": "๐๏ธ ะฟะพะดะฝะธะผะฐะตั",
    "swing": "๐ ะบะฐัะฐะตั",
    "rock": "๐ถ ัะบะฐัะธะฒะฐะตั",
    "tuck": "๐๏ธ ัะบััะฒะฐะตั ะพะดะตัะปะพะผ",
    "wrap": "๐ ัะบัััะฒะฐะตั",
    "warm": "๐ฅ ัะพะณัะตะฒะฐะตั",
    "cool": "โ๏ธ ะพัะปะฐะถะดะฐะตั",
    "fan": "๐ชญ ะพะฑะผะฐัะธะฒะฐะตั ะฒะตะตัะพะผ",
    "massage": "๐โโ๏ธ ะดะตะปะฐะตั ะผะฐััะฐะถ",
    "scratch": "๐พ ัะตัะตั ะทะฐ ััะบะพะผ",
    "tickle": "๐คญ ัะตะบะพัะตั",
    "boop": "๐ ััะบะฐะตั ะฒ ะฝะพั",
    "poke": "๐ ััะบะฐะตั",
    "pinch": "๐ค ัะธะฟะฐะตั",
    "squeeze": "๐ค ัะถะธะผะฐะตั",
    "pat": "โ ะฟะพัะปะพะฟัะฒะฐะตั",
    "pathead": "๐ ะณะปะฐะดะธั ะฟะพ ะณะพะปะพะฒะต",
    "rubble": "๐ ััะตััั",
    "nudge": "๐ฆต ะฟะพะดัะฐะปะบะธะฒะฐะตั",
    "nuzzlehair": "๐โโ๏ธ ะตัะพัะธั ะฒะพะปะพัั",
    "fixhair": "๐ ะฟะพะฟัะฐะฒะปัะตั ะฟัะธัะตัะบั",
    "tiehair": "๐ ะทะฐะฒัะทัะฒะฐะตั ะฒะพะปะพัั",
    "wipe": "๐งป ะฒััะธัะฐะตั ัะปะตะทั",
    "blow": "๐จ ะดัะตั ะฝะฐ ะฑะพะปััะบั",
    "kissbooboo": "๐ฉน ัะตะปัะตั ััะธะฑ",
    "bandage": "๐ฉน ะฟะตัะตะฒัะทัะฒะฐะตั ัะฐะฝั",
    "heal": "๐ ะธััะตะปัะตั",
    "cure": "๐ฅ ะปะตัะธั",
    "protect": "๐ก๏ธ ะทะฐัะธัะฐะตั",
# === ะะฎะะะะฌ ะ ะะะะะะขะะะ (40) ===
    "love": "โค๏ธ ะปัะฑะธั",
    "adore": "๐ ะพะฑะพะถะฐะตั",
    "cherish": "๐ ัะตะฝะธั",
    "worship": "๐ ะฑะพะณะพัะฒะพัะธั",
    "heart": "๐ ะดะฐัะธั ัะตัะดัะต",
    "romance": "๐น ััะฐะถะธะฒะฐะตั",
    "date": "๐ท ะฟัะธะณะปะฐัะฐะตั ะฝะฐ ัะฒะธะดะฐะฝะธะต",
    "propose": "๐ ะดะตะปะฐะตั ะฟัะตะดะปะพะถะตะฝะธะต",
    "marry": "๐ ะถะตะฝะธััั",
    "wed": "๐ฐ ะฒััะพะดะธั ะทะฐะผัะถ",
    "engaged": "๐ ะดะตะปะฐะตั ะฟะพะผะพะปะฒะบั",
    "loveletter": "๐ ะฟะธัะตั ะปัะฑะพะฒะฝะพะต ะฟะธััะผะพ",
    "poem": "๐ ะฟะพัะฒััะฐะตั ััะธัะธ",
    "serenade": "๐ธ ะฟะพะตั ัะตัะตะฝะฐะดั",
    "candle": "๐ฏ๏ธ ะทะฐะถะธะณะฐะตั ัะฒะตัะธ",
    "rose": "๐น ะดะฐัะธั ัะพะทั",
    "flowers": "๐ ะดะฐัะธั ัะฒะตัั",
    "bouquet": "๐ธ ะฒัััะฐะตั ะฑัะบะตั",
    "chocolate": "๐ซ ะดะฐัะธั ัะพะบะพะปะฐะด",
    "candy": "๐ฌ ัะณะพัะฐะตั ะบะพะฝัะตัะพะน",
    "sweets": "๐ญ ะดะฐัะธั ัะปะฐะดะพััะธ",
    "perfume": "๐งด ะดะฐัะธั ะดััะธ",
    "jewelry": "๐ ะดะฐัะธั ัะบัะฐัะตะฝะธะต",
    "ring": "๐ ะดะฐัะธั ะบะพะปััะพ",
    "necklace": "๐ฟ ะดะฐัะธั ะพะถะตัะตะปัะต",
    "bracelet": "๐ ะดะฐัะธั ะฑัะฐัะปะตั",
    "watch": "โ ะดะฐัะธั ัะฐัั",
    "teddy": "๐งธ ะดะฐัะธั ะฟะปััะตะฒะพะณะพ ะผะธัะบั",
    "heartballoon": "๐ ะดะฐัะธั ัะตัะดัะต ะธะท ัะฐัะพะฒ",
    "loveletter": "๐ ะฟะธัะตั ะปัะฑะพะฒะฝะพะต ะฟะธััะผะพ",
    "confess": "๐ญ ะฟัะธะทะฝะฐะตััั ะฒ ะปัะฑะฒะธ",
    "whisper": "๐คซ ัะตะฟัะตั ะฝะฐ ััะบะพ",
    "sweetwords": "๐ฌ ะณะพะฒะพัะธั ะฝะตะถะฝะพััะธ",
    "compliment": "โจ ะณะพะฒะพัะธั ะบะพะผะฟะปะธะผะตะฝั",
    "admire": "๐ ะปัะฑัะตััั",
    "gaze": "๐๏ธ ัะผะพััะธั ั ะปัะฑะพะฒัั",
    "stare": "๐ฅบ ัะผะพััะธั ะฝะต ะพัััะฒะฐััั",
    "wink": "๐ ะฟะพะดะผะธะณะธะฒะฐะตั",
    "blowkiss": "๐ ะฒะพะทะดััะฝัะน ะฟะพัะตะปัะน",
    "hearteyes": "๐ ัะผะพััะธั ะฒะปัะฑะปะตะฝะฝัะผะธ ะณะปะฐะทะฐะผะธ",
    "comfort": "๐ค ััะตัะฐะตั",
    "console": "๐ซ ััะฟะพะบะฐะธะฒะฐะตั",
    "calm": "๐ ัะผะธัะพัะฒะพััะตั",
    "support": "๐ช ะฟะพะดะดะตัะถะธะฒะฐะตั",
    "encourage": "๐ฃ ะฒะพะพะดััะตะฒะปัะตั",
    "motivate": "๐ฅ ะผะพัะธะฒะธััะตั",
    "inspire": "โจ ะฒะดะพัะฝะพะฒะปัะตั",
    "help": "๐ ะฟะพะผะพะณะฐะตั",
    "save": "๐ฆธ ัะฟะฐัะฐะตั",
    "rescue": "๐ ะฟัะธัะพะดะธั ะฝะฐ ะฟะพะผะพัั",
    "defend": "๐ก๏ธ ะทะฐัััะฟะฐะตััั",
    "protect": "โ๏ธ ะทะฐัะธัะฐะตั",
    "shield": "๐ก๏ธ ะฟัะธะบััะฒะฐะตั ัะธัะพะผ",
    "guard": "๐ ะพััะฐะฝัะตั",
    "care": "๐ฅ ะทะฐะฑะพัะธััั",
    "nurture": "๐ฑ ะฒะทัะฐัะธะฒะฐะตั",
    "spoil": "๐ ะฑะฐะปัะตั",
    "praise": "๐ ัะฒะฐะปะธั",
    "admire": "๐ ะฒะพััะธัะฐะตััั",
    "respect": "๐ ัะฒะฐะถะฐะตั",
    "applaud": "๐ ะฐะฟะปะพะดะธััะตั",
    "cheer": "๐ฃ ะฟะพะดะดะตัะถะธะฒะฐะตั",
    "boost": "๐ช ะฟะพะดะฝะธะผะฐะตั ะฝะฐัััะพะตะฝะธะต",
    "uplift": "โฌ๏ธ ะฟะพะดะฝะธะผะฐะตั ะดัั",
    "bless": "โจ ะฑะปะฐะณะพัะปะพะฒะปัะตั",
    "pray": "๐ ะผะพะปะธััั ะทะฐ",
    "blessing": "๐๏ธ ะฟะพััะปะฐะตั ะฑะปะฐะณะพัะปะพะฒะตะฝะธะต",
    "forgive": "๐๏ธ ะฟัะพัะฐะตั",
    "understand": "๐ค ะฟะพะฝะธะผะฐะตั",
    "listen": "๐ ะฒะฝะธะผะฐัะตะปัะฝะพ ัะปััะฐะตั",
    "advice": "๐ก ะดะฐะตั ัะพะฒะตั",
    "wisdom": "๐ฆ ะดะตะปะธััั ะผัะดัะพัััั",
    "teach": "๐ ััะธั",
    "guide": "๐งญ ะฝะฐะฟัะฐะฒะปัะตั",
    "mentor": "๐จโ๐ซ ะฝะฐััะฐะฒะปัะตั",
    "highfive": "๐๏ธ ะดะฐะตั ะฟััั",
    "fistbump": "๐ ัััะบะฐะตััั ะบัะปะฐะบะพะผ",
    "handshake": "๐ค ะฟะพะถะธะผะฐะตั ััะบั",
    "brofist": "๐ ะฑัะฐััะบะธะน ะบัะปะฐะบ",
    "pound": "๐ ะบัะปะฐัะพะบ",
    "wave": "๐ ะผะฐัะตั",
    "hello": "๐๏ธ ะฟัะธะฒะตัััะฒัะตั",
    "greet": "๐ค ะทะดะพัะพะฒะฐะตััั",
    "bow": "๐ ะบะปะฐะฝัะตััั",
    "curtsey": "๐คต ะดะตะปะฐะตั ัะตะฒะตัะฐะฝั",
    "salute": "๐ซก ะพัะดะฐะตั ัะตััั",
    "cheers": "๐ฅ ัะพะบะฐะตััั",
    "toast": "๐ป ะฟัะพะธะทะฝะพัะธั ัะพัั",
    "clink": "๐ฅ ะทะฒะตะฝะธั ะฑะพะบะฐะปะฐะผะธ",
    "hangs": "๐ฌ ััััะตััั",
    "chill": "๐ ะพัะดััะฐะตั",
    "hangout": "๐งโ๐คโ๐ง ะฟัะพะฒะพะดะธั ะฒัะตะผั",
    "party": "๐ ะฒะตัะตัะธะฝะบัะตั",
    "celebrate": "๐ฅณ ะฟัะฐะทะดะฝัะตั",
    "dance": "๐ ัะฐะฝััะตั",
    "salsa": "๐บ ัะฐะฝััะตั ัะฐะปััั",
    "waltz": "๐ ัะฐะฝััะตั ะฒะฐะปัั",
    "tango": "๐บ ัะฐะฝััะตั ัะฐะฝะณะพ",
    "breakdance": "๐คธ ะฑัะตะนะบะดะฐะฝัะธั",
    "silly": "๐คช ะดััะฐัะธััั",
    "joke": "๐ ัััะธั",
    "prank": "๐ญ ัะฐะทัะณััะฒะฐะตั",
    "tease": "๐ ะดัะฐะทะฝะธั",
    "mock": "๐ ะฟะพะดัััะธะฒะฐะตั",
    "playfight": "๐คผ ะธะณัะฐะตั ะฒ ะฟะพัะฐัะพะฒะบั",
    "smile": "๐ ัะปัะฑะฐะตััั",
    "grin": "๐ ัะธัะพะบะพ ัะปัะฑะฐะตััั",
    "laugh": "๐ ัะผะตะตััั",
    "giggle": "๐คญ ัะธัะธะบะฐะตั",
    "chuckle": "๐ ะฟะพัะผะตะธะฒะฐะตััั",
    "rofl": "๐คฃ ะบะฐัะฐะตััั ะพั ัะผะตัะฐ",
    "cry": "๐ข ะฟะปะฐัะตั",
    "sob": "๐ญ ััะดะฐะตั",
    "weep": "๐ฅ ะฒััะปะธะฟัะฒะฐะตั",
    "tear": "๐ฅบ ะฟััะบะฐะตั ัะปะตะทั",
    "sad": "๐ ะณััััะธั",
    "unhappy": "๐ ะฝะตะดะพะฒะพะปะตะฝ",
    "frown": "๐ ัะผััะธััั",
    "pout": "๐ ะฝะฐะดัะฒะฐะตั ะณัะฑะบะธ",
    "angry": "๐ ะทะปะธััั",
    "mad": "๐คฌ ะฑะตัะธััั",
    "fury": "๐ฟ ะฒ ััะพััะธ",
    "rage": "๐ข ะฑัััะตั",
    "annoy": "๐ค ัะฐะทะดัะฐะถะฐะตััั",
    "grumpy": "๐ ะฒะพััะธั",
    "surprise": "๐ฎ ัะดะธะฒะปัะตััั",
    "shock": "๐ฑ ัะพะบะธัะพะฒะฐะฝ",
    "amaze": "๐ฒ ะธะทัะผะปะตะฝ",
    "astonish": "๐ฏ ะฟะพัะฐะถะตะฝ",
    "scare": "๐จ ะฟัะณะฐะตััั",
    "fear": "๐ฐ ะฑะพะธััั",
    "panic": "๐ฑ ะฟะฐะฝะธะบัะตั",
    "worry": "๐ ะฑะตัะฟะพะบะพะธััั",
    "nervous": "๐ฌ ะฝะตัะฒะฝะธัะฐะตั",
    "embarrass": "๐ณ ัะผััะฐะตััั",
    "blush": "๐ ะบัะฐัะฝะตะตั",
    "shy": "๐ฅบ ััะตัะฝัะตััั",
    "confuse": "๐ ะทะฐะฟััะฐะปัั",
    "perplex": "๐ ะฒ ะทะฐะผะตัะฐัะตะปัััะฒะต",
    "think": "๐ค ะทะฐะดัะผัะฒะฐะตััั",
    "ponder": "๐ค ัะฐะทะผััะปัะตั",
    "dream": "๐ญ ะผะตััะฐะตั",
    "imagine": "โจ ะฟัะตะดััะฐะฒะปัะตั",
    "hope": "๐ค ะฝะฐะดะตะตััั",
    "wish": "โญ ะทะฐะณะฐะดัะฒะฐะตั ะถะตะปะฐะฝะธะต",
    "excite": "๐คฉ ะฒ ะฒะพััะพัะณะต",
    "thrill": "๐ ะฒ ะฟัะตะดะฒะบััะตะฝะธะธ",
    "calm": "๐ ัะฟะพะบะพะตะฝ",
    "peace": "๐๏ธ ะฒ ะผะธัะต",
    "zen": "๐ง ะดะทะตะฝ",
    "eat": "๐ฝ๏ธ ะตัั",
    "drink": "๐ฅค ะฟัะตั",
    "feed": "๐ผ ะบะพัะผะธั",
    "cook": "๐ณ ะณะพัะพะฒะธั",
    "bake": "๐ฅฎ ะฟะตัะตั",
    "fry": "๐ณ ะถะฐัะธั",
    "boil": "๐ฅ ะฒะฐัะธั",
    "grill": "๐ฅ ะถะฐัะธั ะฝะฐ ะณัะธะปะต",
    "breakfast": "๐ณ ะทะฐะฒััะฐะบะฐะตั",
    "lunch": "๐ฅ ะพะฑะตะดะฐะตั",
    "dinner": "๐ฒ ัะถะธะฝะฐะตั",
    "brunch": "๐ฅ ะทะฐะฒััะฐะบะฐะตั ะฟะพะทะดะฝะพ",
    "snack": "๐ช ะฟะตัะตะบัััะฒะฐะตั",
    "coffee": "โ ะฟัะตั ะบะพัะต",
    "tea": "๐ต ะฟัะตั ัะฐะน",
    "milk": "๐ฅ ะฟัะตั ะผะพะปะพะบะพ",
    "juice": "๐ง ะฟัะตั ัะพะบ",
    "soda": "๐ฅค ะฟัะตั ะณะฐะทะธัะพะฒะบั",
    "wine": "๐ท ะฟัะตั ะฒะธะฝะพ",
    "beer": "๐บ ะฟัะตั ะฟะธะฒะพ",
    "cocktail": "๐ธ ะฟัะตั ะบะพะบัะตะนะปั",
    "champagne": "๐พ ะฟัะตั ัะฐะผะฟะฐะฝัะบะพะต",
    "vodka": "๐ฅ ะฟัะตั ะฒะพะดะบั",
    "pizza": "๐ ะตัั ะฟะธััั",
    "burger": "๐ ะตัั ะฑััะณะตั",
    "fries": "๐ ะตัั ะบะฐััะพัะบั",
    "sushi": "๐ฃ ะตัั ัััะธ",
    "ramen": "๐ ะตัั ัะฐะผะตะฝ",
    "pasta": "๐ ะตัั ะฟะฐััั",
    "salad": "๐ฅ ะตัั ัะฐะปะฐั",
    "soup": "๐ฅฃ ะตัั ััะฟ",
    "icecream": "๐ฆ ะตัั ะผะพัะพะถะตะฝะพะต",
    "cake": "๐ ะตัั ัะพัั",
    "candy": "๐ฌ ะตัั ะบะพะฝัะตัั",
    "chocolate": "๐ซ ะตัั ัะพะบะพะปะฐะด",
    "cookie": "๐ช ะตัั ะฟะตัะตะฝัะต",
    "fruit": "๐ ะตัั ัััะบัั",
    "apple": "๐ ะตัั ัะฑะปะพะบะพ",
    "banana": "๐ ะตัั ะฑะฐะฝะฐะฝ",
    "orange": "๐ ะตัั ะฐะฟะตะปััะธะฝ",
    "run": "๐ ะฑะตะถะธั",
    "jog": "๐โโ๏ธ ะฑะตะณะฐะตั ัััััะพะน",
    "sprint": "๐จ ะผัะธััั",
    "walk": "๐ถ ะณัะปัะตั",
    "stroll": "๐ถโโ๏ธ ะฟัะพะณัะปะธะฒะฐะตััั",
    "wander": "๐ถ ะฑัะพะดะธั",
    "hike": "๐ฅพ ะธะดะตั ะฒ ะฟะพัะพะด",
    "climb": "๐ง ะบะฐัะฐะฑะบะฐะตััั",
    "jump": "๐คพ ะฟััะณะฐะตั",
    "leap": "๐ฆ ัะบะฐัะตั",
    "hop": "๐ฐ ะฟััะณะฐะตั",
    "skip": "๐ ะฟะพะดะฟััะณะธะฒะฐะตั",
    "dance": "๐ ัะฐะฝััะตั",
    "swim": "๐ ะฟะปะฐะฒะฐะตั",
    "dive": "๐คฟ ะฝัััะตั",
    "surf": "๐ ะบะฐัะฐะตััั ะฝะฐ ะฒะพะปะฝะฐั",
    "skate": "โธ๏ธ ะบะฐัะฐะตััั ะฝะฐ ะบะพะฝัะบะฐั",
    "skateboard": "๐น ะบะฐัะฐะตััั ะฝะฐ ัะบะตะนัะต",
    "snowboard": "๐ ะบะฐัะฐะตััั ะฝะฐ ัะฝะพัะฑะพัะดะต",
    "ski": "โท๏ธ ะบะฐัะฐะตััั ะฝะฐ ะปัะถะฐั",
    "cycle": "๐ด ะบะฐัะฐะตััั ะฝะฐ ะฒะตะปะพัะธะฟะตะดะต",
    "unicycle": "๐ฒ ะบะฐัะฐะตััั ะฝะฐ ะผะพะฝะพัะธะบะปะต",
    "motorcycle": "๐๏ธ ะตะดะตั ะฝะฐ ะผะพัะพัะธะบะปะต",
    "drive": "๐ ะฒะตะดะตั ะผะฐัะธะฝั",
    "fly": "โ๏ธ ะปะตัะธั",
    "parachute": "๐ช ะฟััะณะฐะตั ั ะฟะฐัะฐัััะพะผ",
    "paraglide": "๐ช ะฟะฐัะฐะฟะปะฐะฝะตัะธั",
    "balloon": "๐ ะปะตัะธั ะฝะฐ ะฒะพะทะดััะฝะพะผ ัะฐัะต",
    "rocket": "๐ ะปะตัะธั ะฒ ัะฐะบะตัะต",
    "space": "๐ ะปะตัะธั ะฒ ะบะพัะผะพั",
    "yoga": "๐ง ะทะฐะฝะธะผะฐะตััั ะนะพะณะพะน",
    "meditate": "๐งโโ๏ธ ะผะตะดะธัะธััะตั",
    "exercise": "๐๏ธ ััะตะฝะธััะตััั",
    "workout": "๐ช ะบะฐัะฐะตััั",
    "pushup": "๐คธ ะพัะถะธะผะฐะตััั",
    "squat": "๐๏ธ ะฟัะธัะตะดะฐะตั",
    "plank": "๐ง ััะพะธั ะฒ ะฟะปะฐะฝะบะต",
    "stretch": "๐ง ััะฝะตััั",
    "box": "๐ฅ ะฑะพะบัะธััะตั",
    "karate": "๐ฅ ะทะฐะฝะธะผะฐะตััั ะบะฐัะฐัะต",
    "judo": "๐ฅ ะทะฐะฝะธะผะฐะตััั ะดะทัะดะพ",
    "fence": "๐คบ ัะตัััะตั",
    "archery": "๐น ัััะตะปัะตั ะธะท ะปัะบะฐ",
    "shoot": "๐ซ ัััะตะปัะตั",
    "fish": "๐ฃ ััะฑะฐัะธั",
    "draw": "๐จ ัะธััะตั",
    "paint": "๐๏ธ ัะฐัะบัะฐัะธะฒะฐะตั",
    "sketch": "โ๏ธ ะฝะฐะฑัะฐััะฒะฐะตั ััะบะธะท",
    "color": "๐๏ธ ัะฐัะบัะฐัะธะฒะฐะตั",
    "write": "โ๏ธ ะฟะธัะตั",
    "type": "โจ๏ธ ะฟะตัะฐัะฐะตั",
    "compose": "๐ต ัะพัะธะฝัะตั ะผัะทัะบั",
    "sing": "๐ค ะฟะพะตั",
    "hum": "๐ถ ะฝะฐะฟะตะฒะฐะตั",
    "whistle": "๐จ ะฝะฐัะฒะธัััะฒะฐะตั",
    "playguitar": "๐ธ ะธะณัะฐะตั ะฝะฐ ะณะธัะฐัะต",
    "playpiano": "๐น ะธะณัะฐะตั ะฝะฐ ะฟะธะฐะฝะธะฝะพ",
    "playdrums": "๐ฅ ะธะณัะฐะตั ะฝะฐ ะฑะฐัะฐะฑะฐะฝะฐั",
    "playviolin": "๐ป ะธะณัะฐะตั ะฝะฐ ัะบัะธะฟะบะต",
    "playflute": "๐ผ ะธะณัะฐะตั ะฝะฐ ัะปะตะนัะต",
    "playtrumpet": "๐บ ะธะณัะฐะตั ะฝะฐ ัััะฑะต",
    "playharp": "๐ช ะธะณัะฐะตั ะฝะฐ ะฐััะต",
    "playaccordion": "๐ช ะธะณัะฐะตั ะฝะฐ ะฐะบะบะพัะดะตะพะฝะต",
    "photograph": "๐ธ ัะพัะพะณัะฐัะธััะตั",
    "film": "๐ฅ ัะฝะธะผะฐะตั ะฒะธะดะตะพ",
    "edit": "๐ป ะผะพะฝัะธััะตั",
    "craft": "๐ช ะผะฐััะตัะธั",
    "knit": "๐งถ ะฒัะถะตั",
    "sew": "๐ชก ััะตั",
    "embroider": "๐ชก ะฒััะธะฒะฐะตั",
    "pottery": "๐บ ะปะตะฟะธั ะธะท ะณะปะธะฝั",
    "sculpt": "๐ฟ ะปะตะฟะธั ัะบัะปัะฟัััั",
    "origami": "๐ฆข ัะบะปะฐะดัะฒะฐะตั ะพัะธะณะฐะผะธ",
    "build": "๐๏ธ ัััะพะธั",
    "create": "๐๏ธ ัะพะทะดะฐะตั",
    "play": "๐ฎ ะธะณัะฐะตั",
    "game": "๐น๏ธ ะธะณัะฐะตั ะฒ ะธะณัั",
    "videogame": "๐ฎ ะธะณัะฐะตั ะฒ ะฒะธะดะตะพะธะณัั",
    "boardgame": "๐ฒ ะธะณัะฐะตั ะฒ ะฝะฐััะพะปะบะธ",
    "chess": "โ๏ธ ะธะณัะฐะตั ะฒ ัะฐัะผะฐัั",
    "cards": "๐ ะธะณัะฐะตั ะฒ ะบะฐััั",
    "poker": "๐ ะธะณัะฐะตั ะฒ ะฟะพะบะตั",
    "dice": "๐ฒ ะบะธะดะฐะตั ะบัะฑะธะบะธ",
    "read": "๐ ัะธัะฐะตั",
    "book": "๐ ัะธัะฐะตั ะบะฝะธะณั",
    "magazine": "๐ฐ ัะธัะฐะตั ะถััะฝะฐะป",
    "comic": "๐ ัะธัะฐะตั ะบะพะผะธะบัั",
    "watch": "๐บ ัะผะพััะธั",
    "tv": "๐บ ัะผะพััะธั ัะตะปะตะฒะธะทะพั",
    "movie": "๐ฟ ัะผะพััะธั ัะธะปัะผ",
    "anime": "๐ธ ัะผะพััะธั ะฐะฝะธะผะต",
    "series": "๐บ ัะผะพััะธั ัะตัะธะฐะป",
    "youtube": "โถ๏ธ ัะผะพััะธั ัััะฑ",
    "tiktok": "๐ฑ ะปะธััะฐะตั ัะธะบัะพะบ",
    "instagram": "๐ท ะปะธััะฐะตั ะธะฝััะฐะณัะฐะผ",
    "selfie": "๐คณ ะดะตะปะฐะตั ัะตะปัะธ",
    "phone": "๐ฑ ัะธะดะธั ะฒ ัะตะปะตัะพะฝะต",
    "computer": "๐ป ัะธะดะธั ะทะฐ ะบะพะผะฟะพะผ",
    "laptop": "๐ป ัะฐะฑะพัะฐะตั ั ะฝะพััะฑัะบะพะผ",
    "internet": "๐ ัะธะดะธั ะฒ ะธะฝัะตัะฝะตัะต",
    "social": "๐ฅ ัะธะดะธั ะฒ ัะพััะตััั",
    "chat": "๐ฌ ะฟะตัะตะฟะธััะฒะฐะตััั",
    "message": "๐ฑ ะฟะธัะตั ัะพะพะฑัะตะฝะธะต",
    "call": "๐ ะทะฒะพะฝะธั",
    "videochat": "๐น ะพะฑัะฐะตััั ะฟะพ ะฒะธะดะตะพ",
    "stream": "๐ก ัััะธะผะธั",
    "podcast": "๐๏ธ ะทะฐะฟะธััะฒะฐะตั ะฟะพะดะบะฐัั",
    "karaoke": "๐ค ะฟะพะตั ะฒ ะบะฐัะฐะพะบะต",
    "disco": "๐ชฉ ัะฐะฝััะตั ะฝะฐ ะดะธัะบะพัะตะบะต",
    "rave": "๐ ัะฐะฝััะตั ะฝะฐ ัะตะนะฒะต",
    "meow": "๐ฑ ะผััะบะฐะตั",
    "purr": "๐บ ะผััะปััะตั",
    "hiss": "๐ฑ ัะธะฟะธั",
    "woof": "๐ถ ะณะฐะฒะบะฐะตั",
    "bark": "๐ ะปะฐะตั",
    "howl": "๐บ ะฒะพะตั",
    "growl": "๐ฏ ัััะธั",
    "roar": "๐ฆ ัะตะฒะตั",
    "chirp": "๐ฆ ัะธัะธะบะฐะตั",
    "tweet": "๐ฆ ัะตะฑะตัะตั",
    "caw": "๐ฆโโฌ ะบะฐัะบะฐะตั",
    "quack": "๐ฆ ะบััะบะฐะตั",
    "honk": "๐ฆข ะณะพะณะพัะตั",
    "moo": "๐ฎ ะผััะธั",
    "oink": "๐ท ัััะบะฐะตั",
    "neigh": "๐ด ัะถะตั",
    "bleat": "๐ ะฑะปะตะตั",
    "baa": "๐ ะผะตะบะฐะตั",
    "ribbit": "๐ธ ะบะฒะฐะบะฐะตั",
    "croak": "๐ธ ัััะธั",
    "squeak": "๐ญ ะฟะธัะธั",
    "hoot": "๐ฆ ััะฐะตั",
    "cricket": "๐ฆ ัััะตะบะพัะตั",
    "buzz": "๐ ะถัะถะถะธั",
    "trumpet": "๐ ัััะฑะธั",
    "chatter": "๐ ัััะตะบะพัะตั",
    "gibber": "๐ต ะปะพะฟะพัะตั",
    "purrlike": "๐ฝ ะผัััะธั ะบะฐะบ ะบะพัะธะบ",
    "pounce": "๐ ะฟััะณะฐะตั ะบะฐะบ ะบะพัะบะฐ",
    "slither": "๐ ะฟะพะปะทะตั ะบะฐะบ ะทะผะตั",
    "magic": "โจ ะบะพะปะดัะตั",
    "spell": "๐ฎ ะฟัะพะธะทะฝะพัะธั ะทะฐะบะปะธะฝะฐะฝะธะต",
    "curse": "๐ง ะฟัะพะบะปะธะฝะฐะตั",
    "hex": "๐ ะฝะฐะฒะพะดะธั ะฟะพััั",
    "bless": "๐ ะฑะปะฐะณะพัะปะพะฒะปัะตั",
    "enchant": "๐ซ ะทะฐัะฐัะพะฒัะฒะฐะตั",
    "transform": "๐ฆ ะฟัะตะฒัะฐัะฐะตั",
    "shape": "๐ ะผะตะฝัะตั ัะพัะผั",
    "levitate": "๐ช ะทะฐััะฐะฒะปัะตั ะปะตะฒะธัะธัะพะฒะฐัั",
    "fly": "๐งน ะปะตัะธั ะฝะฐ ะผะตัะปะต",
    "teleport": "โจ ัะตะปะตะฟะพััะธััะตััั",
    "disappear": "๐จ ะธััะตะทะฐะตั",
    "vanish": "๐ซ๏ธ ะธัะฟะฐััะตััั",
    "appear": "โจ ะฟะพัะฒะปัะตััั",
    "materialize": "๐ ะผะฐัะตัะธะฐะปะธะทัะตััั",
    "summon": "๐ง ะฟัะธะทัะฒะฐะตั",
    "conjure": "๐ช ัะพะทะดะฐะตั",
    "create": "โจ ัะฒะพัะธั",
    "illusion": "๐ ัะพะทะดะฐะตั ะธะปะปัะทะธั",
    "mirror": "๐ช ัะพะทะดะฐะตั ะทะตัะบะฐะปะพ",
    "clone": "๐ฅ ะบะปะพะฝะธััะตั",
    "shrink": "๐ ัะผะตะฝััะฐะตั",
    "grow": "๐ ัะฒะตะปะธัะธะฒะฐะตั",
    "freeze": "โ๏ธ ะทะฐะผะพัะฐะถะธะฒะฐะตั",
    "melt": "๐ฅ ัะฐััะฐะฟะปะธะฒะฐะตั",
    "burn": "๐ฅ ัะถะธะณะฐะตั",
    "light": "๐ก ะทะฐะถะธะณะฐะตั ัะฒะตั",
    "darken": "๐ ะฟะพะณััะถะฐะตั ะฒะพ ััะผั",
    "thunder": "โก ะฟัะธะทัะฒะฐะตั ะผะพะปะฝะธั",
    "lightning": "โก ะฟััะบะฐะตั ะผะพะปะฝะธั",
    "fireball": "๐ฅ ะทะฐะฟััะบะฐะตั ัะฐะนะตัะฑะพะป",
    "ice": "โ๏ธ ัะพะทะดะฐะตั ะปะตะด",
    "water": "๐ง ัะฟัะฐะฒะปัะตั ะฒะพะดะพะน",
    "earth": "โฐ๏ธ ะดะฒะธะณะฐะตั ะทะตะผะปั",
    "air": "๐จ ัะฟัะฐะฒะปัะตั ะฒะตััะพะผ",
    "mindread": "๐ง ัะธัะฐะตั ะผััะปะธ",
    "future": "๐ฎ ะฟัะตะดัะบะฐะทัะฒะฐะตั ะฑัะดััะตะต",
    "past": "๐ฐ๏ธ ะฒะธะดะธั ะฟัะพัะปะพะต",
    "invisible": "๐ป ััะฐะฝะพะฒะธััั ะฝะตะฒะธะดะธะผัะผ",
    "polymorph": "๐ฆ ะฟัะตะฒัะฐัะฐะตั ะฒ ะถะธะฒะพัะฝะพะต",
    "rain": "๐ง๏ธ ะฒัะทัะฒะฐะตั ะดะพะถะดั",
    "snow": "โ๏ธ ะฒัะทัะฒะฐะตั ัะฝะตะณ",
    "hail": "๐ง ะฒัะทัะฒะฐะตั ะณัะฐะด",
    "thunderstorm": "โ๏ธ ะฒัะทัะฒะฐะตั ะณัะพะทั",
    "lightning": "๐ฉ๏ธ ะฟัะธะทัะฒะฐะตั ะผะพะปะฝะธั",
    "wind": "๐จ ัะพะทะดะฐะตั ะฒะตัะตั",
    "hurricane": "๐ ัะพะทะดะฐะตั ััะฐะณะฐะฝ",
    "tornado": "๐ช๏ธ ัะพะทะดะฐะตั ัะพัะฝะฐะดะพ",
    "sunny": "โ๏ธ ะฟัะธะทัะฒะฐะตั ัะพะปะฝัะต",
    "cloud": "โ๏ธ ัะพะทะดะฐะตั ะพะฑะปะฐะบะฐ",
    "fog": "๐ซ๏ธ ัะพะทะดะฐะตั ััะผะฐะฝ",
    "rainbow": "๐ ัะพะทะดะฐะตั ัะฐะดัะณั",
    "aurora": "โจ ัะพะทะดะฐะตั ัะตะฒะตัะฝะพะต ัะธัะฝะธะต",
    "star": "โญ ะทะฐะถะธะณะฐะตั ะทะฒะตะทะดั",
    "moon": "๐ ะฟัะธะทัะฒะฐะตั ะปัะฝั",
    "eclipse": "๐ ะฒัะทัะฒะฐะตั ะทะฐัะผะตะฝะธะต",
    "dawn": "๐ ัะพะทะดะฐะตั ัะฐััะฒะตั",
    "dusk": "๐ ัะพะทะดะฐะตั ะทะฐะบะฐั",
    "night": "๐ ะพะฟััะบะฐะตั ะฝะพัั",
    "day": "โ๏ธ ะฟัะธะทัะฒะฐะตั ะดะตะฝั",
    "flower": "๐ธ ะฒััะฐัะธะฒะฐะตั ัะฒะตัั",
    "tree": "๐ณ ะฒััะฐัะธะฒะฐะตั ะดะตัะตะฒะพ",
    "forest": "๐ฒ ัะพะทะดะฐะตั ะปะตั",
    "garden": "๐บ ัะพะทะดะฐะตั ัะฐะด",
    "bloom": "๐ผ ะทะฐััะฐะฒะปัะตั ัะฒะตััะธ",
    "space": "๐ ะพัะฟัะฐะฒะปัะตััั ะฒ ะบะพัะผะพั",
    "rocket": "๐ ะปะตัะธั ะฝะฐ ัะฐะบะตัะต",
    "moonwalk": "๐ ะณัะปัะตั ะฟะพ ะปัะฝะต",
    "mars": "๐ด ะปะตัะธั ะฝะฐ ะผะฐัั",
    "venus": "๐ก ะปะตัะธั ะฝะฐ ะฒะตะฝะตัั",
    "jupiter": "๐ค ะปะตัะธั ะฝะฐ ัะฟะธัะตั",
    "saturn": "๐ช ะปะตัะธั ะฝะฐ ัะฐัััะฝ",
    "comet": "โ๏ธ ะฟัะพะปะตัะฐะตั ะฝะฐ ะบะพะผะตัะต",
    "asteroid": "๐ซ ะปะตัะธั ะฝะฐ ะฐััะตัะพะธะดะต",
    "blackhole": "โซ ะทะฐััะณะธะฒะฐะตั ะฒ ัะตัะฝัั ะดััั",
    "galaxy": "๐ ะธััะปะตะดัะตั ะณะฐะปะฐะบัะธะบั",
    "nebula": "โจ ะปัะฑัะตััั ััะผะฐะฝะฝะพัััั",
    "supernova": "๐ฅ ัะพะทะดะฐะตั ัะฒะตััะฝะพะฒัั",
    "planet": "๐ช ัะพะทะดะฐะตั ะฟะปะฐะฝะตัั",
    "star": "โญ ัะพะทะดะฐะตั ะทะฒะตะทะดั",
    "constellation": "โจ ัะพะทะดะฐะตั ัะพะทะฒะตะทะดะธะต",
    "orbit": "๐ ะฒััะพะดะธั ะฝะฐ ะพัะฑะธัั",
    "gravity": "๐ ะพัะบะปััะฐะตั ะณัะฐะฒะธัะฐัะธั",
    "alien": "๐ฝ ะฒัััะตัะฐะตั ะธะฝะพะฟะปะฐะฝะตััะฝะธะฝะฐ",
    "ufo": "๐ธ ะปะตัะธั ะฝะฐ ะะะ",
    "code": "๐จโ๐ป ะฟะธัะตั ะบะพะด",
    "program": "๐ป ะฟัะพะณัะฐะผะผะธััะตั",
    "debug": "๐ ะพัะปะฐะถะธะฒะฐะตั ะบะพะด",
    "hack": "๐ ะฒะทะปะฐะผัะฒะฐะตั",
    "crack": "๐ ะฒะทะปะฐะผัะฒะฐะตั ะฟะฐัะพะปั",
    "encrypt": "๐ ัะธัััะตั",
    "decrypt": "๐ ัะฐััะธััะพะฒัะฒะฐะตั",
    "cyber": "๐ฅ๏ธ ะฟะพะณััะถะฐะตััั ะฒ ะบะธะฑะตัะฟัะพัััะฐะฝััะฒะพ",
    "robot": "๐ค ัะพะทะดะฐะตั ัะพะฑะพัะฐ",
    "ai": "๐ง ัะพะทะดะฐะตั ะะ",
    "virus": "๐ฆ ะทะฐะฟััะบะฐะตั ะฒะธััั",
    "superman": "๐ฆธ ะปะตัะธั ะบะฐะบ ััะฟะตัะผะตะฝ",
    "batman": "๐ฆ ะฒัะทัะฒะฐะตั ะฑััะผะพะฑะธะปั",
    "spiderman": "๐ท๏ธ ัััะตะปัะตั ะฟะฐััะธะฝะพะน",
    "ironman": "๐ค ะฝะฐะดะตะฒะฐะตั ะบะพัััะผ",
    "hulk": "๐ ะฟัะตะฒัะฐัะฐะตััั ะฒ ัะฐะปะบะฐ",
    "thor": "๐จ ะฟัะธะทัะฒะฐะตั ะผะพะปะพั",
    "wonderwoman": "๐ฆธ ะปะตัะธั ะฝะฐ ะฝะตะฒะธะดะธะผะพะผ ัะฐะผะพะปะตัะต",
    "flash": "โก ะฑะตะถะธั ัะพ ัะฒะตัััะบะพัะพัััั",
    "aquaman": "๐ ะณะพะฒะพัะธั ั ััะฑะฐะผะธ",
    "wolverine": "๐บ ะฒัะฟััะบะฐะตั ะบะพะณัะธ",
    "deadpool": "๐ก๏ธ ัััะธั",
    "venom": "๐ค ะฟัะตะฒัะฐัะฐะตััั ะฒ ะฒะตะฝะพะผะฐ",
    "xmen": "โก ะฐะบัะธะฒะธััะตั ะผััะฐัะธั",
    "mutant": "๐งฌ ะผััะธััะตั",
    "superpower": "๐ฅ ะฟะพะปััะฐะตั ััะฟะตััะธะปั",
    "fly": "โ๏ธ ะปะตัะฐะตั",
    "laser": "๐๏ธ ัััะตะปัะตั ะปะฐะทะตัะพะผ",
    "freeze": "โ๏ธ ะทะฐะผะพัะฐะถะธะฒะฐะตั ะฒะทะณะปัะดะพะผ",
    "invisible": "๐ป ััะฐะฝะพะฒะธััั ะฝะตะฒะธะดะธะผัะผ",
    "telepathy": "๐ง ัะธัะฐะตั ะผััะปะธ",
    "telekinesis": "๐ ะดะฒะธะณะฐะตั ะฟัะตะดะผะตัั",
    "timefreeze": "โธ๏ธ ะพััะฐะฝะฐะฒะปะธะฒะฐะตั ะฒัะตะผั",
    "rewind": "โช ะพัะผะฐััะฒะฐะตั ะฒัะตะผั",
    "fastforward": "โฉ ััะบะพััะตั ะฒัะตะผั",
    "dimension": "๐ ะฟััะตัะตััะฒัะตั ะฟะพ ะธะทะผะตัะตะฝะธัะผ",
    "cheers": "๐ ัะฐะดัะตััั",
    "fight": "๐ฅ ะดะตัะตััั",
    "box": "๐ฅ ะฑะพะบัะธััะตั",
    "punch": "๐ ะฑัะตั ะบัะปะฐะบะพะผ",
    "kick": "๐ฆต ะฟะธะฝะฐะตั",
    "slap": "๐๏ธ ัะปะตะฟะฐะตั",
    "drive": "๐ ะฒะตะดะตั ะผะฐัะธะฝั",
    "race": "๐๏ธ ะณะพะฝัะตั",
    "park": "๐ฟ๏ธ ะฟะฐัะบัะตััั",
    "cycle": "๐ด ะบะฐัะฐะตััั ะฝะฐ ะฒะตะปะพัะธะฟะตะดะต",
    "motorcycle": "๐๏ธ ะตะดะตั ะฝะฐ ะผะพัะพัะธะบะปะต",
    "train": "๐ ะตะดะตั ะฝะฐ ะฟะพะตะทะดะต",
    "subway": "๐ ะตะดะตั ะฒ ะผะตััะพ",
    "bus": "๐ ะตะดะตั ะฝะฐ ะฐะฒัะพะฑััะต",
    "tram": "๐ ะตะดะตั ะฝะฐ ััะฐะผะฒะฐะต",
    "think": "๐ค ะดัะผะฐะตั",
    "meditate": "๐ง ะผะตะดะธัะธััะตั",
    "sleep": "๐ด ัะฟะธั",
    "wake": "โฐ ะฟัะพััะฟะฐะตััั",
    "yawn": "๐ฅฑ ะทะตะฒะฐะตั",
    "sneeze": "๐คง ัะธัะฐะตั",
    "cough": "๐ท ะบะฐัะปัะตั",
    "sigh": "๐ฎโ๐จ ะฒะทะดััะฐะตั",
    "stretch": "๐คธ ะฟะพััะณะธะฒะฐะตััั",
    "relax": "๐ ัะฐััะปะฐะฑะปัะตััั",
    "shower": "๐ฟ ะฟัะธะฝะธะผะฐะตั ะดัั",
    "bath": "๐ ะฟัะธะฝะธะผะฐะตั ะฒะฐะฝะฝั",
    "brush": "๐ชฅ ัะธััะธั ะทัะฑั",
    "comb": "๐โโ๏ธ ัะฐััะตััะฒะฐะตััั",
    "dress": "๐ ะพะดะตะฒะฐะตััั",
    "undress": "๐ ัะฐะทะดะตะฒะฐะตััั",
    "shave": "๐ช ะฑัะตะตััั",
    "makeup": "๐ ะบัะฐัะธััั",
    "perfume": "๐งด ะดััะธััั",
    "exercise": "๐๏ธ ัะฟัะฐะถะฝัะตััั",
    "workout": "๐ช ััะตะฝะธััะตััั",
    "sweat": "๐ ะฟะพัะตะตั",
    "shiver": "๐ฅถ ะดัะพะถะธั",
    "sweat": "๐ ะฒัะฟะพัะตะป",
    "freeze": "๐ฅถ ะทะฐะผะตัะท",
    "melt": "๐ฅต ัะฐััะฐัะป",
    "crowdsurf": "๐ค ััััะธั ะฒ ัะพะปะฟะต",
    "stage": "๐ญ ะฒัะฑะตะณะฐะตั ะฝะฐ ััะตะฝั",
    "prank": "๐ ัะฐะทัะณััะฒะฐะตั",
    "troll": "๐ง ััะพะปะปะธั",
    "roast": "๐ฅ ะฟะพะดะถะฐัะธะฒะฐะตั",
    "burn": "๐ฅ ัะถะธะณะฐะตั",
    "destroy": "๐ ัะฝะธััะพะถะฐะตั",
    "demolish": "๐๏ธ ัะฝะพัะธั",
    "obliterate": "๐ซ ััะธัะฐะตั ะฒ ะฟัะปั",
    "omegalul": "๐ ัะผะตะตััั ะบะฐะบ ะพะผะตะณะฐ",
    "pogchamp": "๐คฏ ะฒะทััะฒะฐะตั ะผะพะทะณ",
    "kek": "๐ ััะผัะปัะตััั",
    "lul": "๐ ัะถะตั",
    "xd": "๐ ัะณะฐัะฐะตั",
    "rofl": "๐คฃ ะบะฐัะฐะตััั ะฟะพ ะฟะพะปั",
    "lmao": "๐ ัะผะธัะฐะตั ะพั ัะผะตัะฐ",
    "drunk": "๐บ ะฝะฐะฟะธะฒะฐะตััั",
    "hangover": "๐คข ะผััะฐะตััั ั ะฟะพัะผะตะปัั",
    "puke": "๐คฎ ัะพัะฝะธั",
    "sober": "๐ง ััะตะทะฒะตะตั",
    "fuck": "๐คฌ ะฟะพััะปะฐะตั ะฝะฐััะน",
    "fuckoff": "๐ ะณะพะฒะพัะธั ะธะดะธ ะฝะฐััะน",
    "bitchslap": "๐ ะดะฐะตั ะฟะพัะตัะธะฝั",
    "badass": "๐ ะฒะตะดะตั ัะตะฑั ะบะฐะบ ะฟะปะพัะธั",
    "thug": "๐ช ะฒะตะดะตั ัะตะฑั ะบะฐะบ ะฑะฐะฝะดะธั",
    "mafia": "๐ด๏ธ ะฒะตะดะตั ัะตะฑั ะบะฐะบ ะผะฐัะธะพะทะธ",
    "boss": "๐ ะฒะตะดะตั ัะตะฑั ะบะฐะบ ะฑะพัั",
    "obliterated": "๐ ััะตั ั ะปะธัะฐ ะทะตะผะปะธ",
    "fart": "๐จ ะฟัะบะฐะตั",
    "fartbomb": "๐ฃ ะฟัะบะฐะตั ะฑะพะผะฑะพะน",
    "burp": "๐คข ััะณะฐะตั",
    "bonk": "๐จ ะฑัะตั ะฟะพ ะณะพะปะพะฒะต",
    "bop": "๐ ัััะบะฐะตั",
    "whack": "๐ช ะฑัะตั ัะพ ะฒัะตะน ะดััะธ",
    "thwack": "๐ ะฒะผะฐะทัะฒะฐะตั",
    "smack": "๐๏ธ ัะปะตะฟะฐะตั",
    "wham": "๐ฅ ะฑะฐะฑะฐัะฐะตั",
    "bam": "๐ฅ ะฑะฐะผ",
    "pow": "๐ฅ ะฟะฐั",
    "pee": "๐ฝ ัะพัะตั ะฟะธัะฐัั",
    "poop": "๐ฉ ัะพัะตั ะบะฐะบะฐัั",
    "toiletbreak": "๐ฝ ัะฒะฐะปะธะฒะฐะตั ะฟะพ ะดะตะปะฐะผ",
    "scene": "๐ฌ ััััะฐะธะฒะฐะตั ััะตะฝั",
    "tantrum": "๐ค ะธััะตัะธั",
    "meltdown": "๐ฅ ัััะฒะฐะตััั",
    "breakdown": "๐ ัััะฒะฐะตััั",
    "freakout": "๐คฏ ะฑะตัะธััั",
    "ragequit": "๐ฎ ะฒัะปะตัะฐะตั ะฒ ััะพััะธ",
        "fuck": "๐๐ฆ ััะฐัะฐะตั",
        "fuckhard": "๐ฅต๐ฆ ะถะตััะบะพ ััะฐัะฐะตั",
        "fuckrough": "๐ฅ๐ฆ ะณััะฑะพ ััะฐัะฐะตั",
        "fuckpassionate": "๐๐ฆ ัััะฐััะฝะพ ััะฐัะฐะตั",
        "fuckdoggy": "๐๐ฆ ััะฐัะฐะตั ัะฐะบะพะผ",
        "fuckcowgirl": "๐ค๐ฆ ััะฐัะฐะตั ัะฒะตััั",
        "fuckmissionary": "๐๐ฆ ััะฐัะฐะตั ะผะธััะธะพะฝะตััะบะธ",
        "fuck69": "69๏ธโฃ๐ฆ ะทะฐะฝะธะผะฐะตััั 69",
        "undress": "๐ ัะฐะทะดะตะฒะฐะตั",
        "strip": "๐ฉฒ ัััะธะฟัะธะทะธั",
        "tease": "๐ ะดัะฐะทะฝะธั",
        "seduce": "๐ ัะพะฑะปะฐะทะฝัะตั",
        "flirt": "๐ ัะปะธัััะตั",
        "dirtytalk": "๐ฌ ะณะพะฒะพัะธั ะฟะพัะปะพััะธ",
        "whisperdirty": "๐ ัะตะฟัะตั ะฟะพัะปะพััะธ",
        "grope": "โ ะปะฐะฟะฐะตั",
        "touchboobs": "๐ ััะพะณะฐะตั ะณััะดั",
        "touchass": "๐ ััะพะณะฐะตั ะฟะพะฟั",
        "touchpussy": "๐ฎ ััะพะณะฐะตั ะบะธัะบั",
        "touchdick": "๐ ััะพะณะฐะตั ัะปะตะฝ",
        "blowjob": "๐ ะดะตะปะฐะตั ะผะธะฝะตั",
        "cunnilingus": "๐ ะบัะฝะธะปะธะฝะณัั",
        "lickpussy": "๐ ะปะธะถะตั ะบะธัะบั",
        "suckdick": "๐ ัะพัะตั ัะปะตะฝ",
        "cuffs": "๐ ะฝะฐะดะตะฒะฐะตั ะฝะฐัััะฝะธะบะธ",
        "blindfold": "๐๏ธ ะทะฐะฒัะทัะฒะฐะตั ะณะปะฐะทะฐ",
        "dom": "๐ ะดะพะผะธะฝะธััะตั",
        "sub": "๐ฅบ ะฟะพะดัะธะฝัะตััั",
        "tied": "๐ชข ัะฒัะทัะฒะฐะตั",
        "spank": "๐ ัะปะตะฟะฐะตั",
        "moan": "๐ซ ััะพะฝะตั",
        "beg": "๐ ัะผะพะปัะตั",
        "spread": "๐ฆต ัะฐะทะดะฒะธะณะฐะตั ะฝะพะณะธ",
        "present": "๐ ะฟะพะดััะฐะฒะปัะตั ะฟะพะฟั",
        "kneel": "๐ง ััะฐะฝะพะฒะธััั ะฝะฐ ะบะพะปะตะฝะธ",
        "crawl": "๐ ะฟะพะปะทะตั",
        "bendover": "๐คธ ะฝะฐะณะธะฑะฐะตััั",
        "cum": "๐ฆ ะบะพะฝัะฐะตั",
        "handjob": "๐๏ธ ะดัะพัะธั ััะบะพะน",
        "facesit": "๐ค ัะฐะดะธััั ะฝะฐ ะปะธัะพ"
}

user_data = {}

COLORS = {
    'purple': '๐ฃ',
    'blue': '๐ต',
    'violet': '๐ช',
    'indigo': '๐',
    'light_blue': '๐ฆ',
    'night': '๐',
    'fog': '๐ซ๏ธ',
    'moon': '๐',
    'cloud': 'โ๏ธ',
    'green': '๐ข',
    'yellow': '๐ก',
    'orange': '๐',
    'red': '๐ด',           # โ ะญะขะะข ะะะฎะง ะะขะกะฃะขะกะขะะะะะ
    'dark_red': 'โญ',      # โ ะ ะญะขะะข
    'pink': '๐',
    'sparkles': 'โจ',
    'star': 'โญ'
}

MESSAGE_TYPES = {
    "communication": "๐ฌ ะะฑัะตะฝะธะต",
    "support": "๐ ะะพะดะดะตัะถะบะฐ",
    "both": "๐ค ะะฑัะตะฝะธะต ะธ ะฟะพะดะดะตัะถะบะฐ"
}


def get_current_time():
    return datetime.now().strftime('%Y-%m-%d %H:%M:%S')


def reset_database():
    db_path = 'support_bot.db'
    if os.path.exists(db_path):
        os.remove(db_path)
        print("๐๏ธ ะกัะฐัะฐั ะฑะฐะทะฐ ะดะฐะฝะฝัั ัะดะฐะปะตะฝะฐ")
    init_database()


def init_database():
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute('''CREATE TABLE IF NOT EXISTS applications
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  user_id INTEGER, username TEXT, app_type TEXT,
                  name TEXT, answers TEXT, created_at TEXT,
                  status TEXT DEFAULT 'pending', reviewed_at TEXT,
                  reviewed_by INTEGER, message_id INTEGER, thread_id INTEGER)''')

    c.execute('''CREATE TABLE IF NOT EXISTS user_tags
                 (user_id INTEGER PRIMARY KEY,
                  user_tag TEXT, user_name TEXT, username TEXT,
                  registered_at TEXT, is_active INTEGER DEFAULT 1,
                  is_group_member INTEGER DEFAULT 0)''')

    c.execute('''CREATE TABLE IF NOT EXISTS active_chats
                 (user_id INTEGER PRIMARY KEY,
                  user_name TEXT, username TEXT, thread_id INTEGER,
                  taken_by_id INTEGER, taken_by_tag TEXT,
                  message_type TEXT, first_message TEXT,
                  created_at TEXT, taken_at TEXT,
                  status TEXT DEFAULT 'pending')''')

    c.execute('''CREATE TABLE IF NOT EXISTS messages
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  user_id INTEGER, text TEXT, from_user INTEGER,
                  from_taker INTEGER, taker_tag TEXT,
                  created_at TEXT, is_read INTEGER DEFAULT 0)''')

    c.execute('''CREATE TABLE IF NOT EXISTS reviews
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  user_id INTEGER, user_name TEXT, username TEXT,
                  rating INTEGER, review_text TEXT, created_at TEXT,
                  status TEXT DEFAULT 'new', reviewed_by INTEGER,
                  reviewed_at TEXT, message_id INTEGER, thread_id INTEGER)''')

    c.execute('''CREATE TABLE IF NOT EXISTS rests
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  admin_id INTEGER, admin_tag TEXT, admin_name TEXT,
                  start_date TEXT, end_date TEXT, reason TEXT,
                  status TEXT DEFAULT 'active', created_at TEXT,
                  completed_at TEXT, notified INTEGER DEFAULT 0,
                  message_id INTEGER, thread_id INTEGER)''')

    c.execute('''CREATE TABLE IF NOT EXISTS warnings
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  user_id INTEGER, admin_id INTEGER, reason TEXT,
                  created_at TEXT, expires_at TEXT)''')

    # ะขะฐะฑะปะธัะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (user_id INTEGER PRIMARY KEY,
                  username TEXT,
                  first_name TEXT,
                  last_name TEXT,
                  first_seen TEXT,
                  last_activity TEXT,
                  is_bot_blocked INTEGER DEFAULT 0,
                  is_active INTEGER DEFAULT 1)''')

    c.execute('''CREATE TABLE IF NOT EXISTS bot_stats
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  date TEXT,
                  total_users INTEGER,
                  active_users INTEGER,
                  blocked_users INTEGER,
                  total_messages INTEGER,
                  admin_responses INTEGER)''')

    # ะขะฐะฑะปะธัะฐ ะดะปั ะพะดะฝะพัะฐะทะพะฒัั ัััะปะพะบ
    c.execute('''CREATE TABLE IF NOT EXISTS invite_links
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  user_id INTEGER,
                  chat_id TEXT,
                  link TEXT,
                  created_at TEXT,
                  expires_at TEXT,
                  is_used INTEGER DEFAULT 0,
                  used_by INTEGER,
                  used_at TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS topic_ids
                 (topic_name TEXT PRIMARY KEY, 
                  thread_id INTEGER,
                  created_at TEXT DEFAULT CURRENT_TIMESTAMP)'''
              )
    # ะะพะฑะฐะฒะธัั ะฒ init_database():
    c.execute('''CREATE TABLE IF NOT EXISTS mood_tracker
             (id INTEGER PRIMARY KEY AUTOINCREMENT,
              user_id INTEGER,
              mood INTEGER,
              anxiety INTEGER,
              energy INTEGER,
              sleep INTEGER,
              notes TEXT,
              created_at TEXT,
              FOREIGN KEY (user_id) REFERENCES users (user_id))''')

    c.execute('''CREATE TABLE IF NOT EXISTS mood_alerts
             (id INTEGER PRIMARY KEY AUTOINCREMENT,
              user_id INTEGER,
              alert_type TEXT,
              threshold INTEGER,
              is_active INTEGER DEFAULT 1,
              created_at TEXT)''')

    conn.commit()
    conn.close()
    print("โ ะะพะฒะฐั ะฑะฐะทะฐ ะดะฐะฝะฝัั ัะพะทะดะฐะฝะฐ")


async def mood_track(update: Update, context):
    """ะขัะตะบะตั ะฝะฐัััะพะตะฝะธั /mood ะธะปะธ /ะฝะฐัััะพะตะฝะธะต"""
    user_id = update.effective_user.id
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ะฐะบัะธะฒะฝัะน ัะฐั ั ะฐะดะผะธะฝะพะผ
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT status, taken_by_id, taken_by_tag FROM active_chats WHERE user_id = ?", (user_id,))
    chat = c.fetchone()
    
    if not chat or chat[0] != 'active':
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ ั ะฐะดะผะธะฝะพะผ.\n\n"
            f"{COLORS['blue']} ะกะฝะฐัะฐะปะฐ ะฝะฐะฟะธัะธัะต ัะพะพะฑัะตะฝะธะต ัะตัะตะท /write"
        )
        conn.close()
        return
    
    taker_id, taker_tag = chat[1], chat[2]
    
    # ะกะพะทะดะฐะตะผ ะบะปะฐะฒะธะฐัััั ะดะปั ะพัะตะฝะบะธ
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะัะปะธัะฝะพ (5)", "mood_5", 'green'),
         create_fancy_button("๐ ะฅะพัะพัะพ (4)", "mood_4", 'light_blue')],
        [create_fancy_button("๐ ะกัะตะดะฝะต (3)", "mood_3", 'yellow'),
         create_fancy_button("๐ ะะปะพัะพ (2)", "mood_2", 'orange')],
        [create_fancy_button("๐ซ ะฃะถะฐัะฝะพ (1)", "mood_1", 'red'),
         create_fancy_button("๐จ ะัะธัะธัะฝะพ (0)", "mood_0", 'dark_red')],
        [create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')]
    ])
    
    context.user_data['mood_tracker'] = {
        'taker_id': taker_id,
        'taker_tag': taker_tag,
        'step': 'mood'
    }
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะะะกะขะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะัะตะฝะธัะต ะฒะฐัะต ะฝะฐัััะพะตะฝะธะต ัะตะนัะฐั:",
        reply_markup=keyboard
    )


async def mood_anxiety(update: Update, context):
    """ะัะตะฝะบะฐ ััะตะฒะพะณะธ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    mood = int(data.split('_')[1])
    
    context.user_data['mood_tracker']['mood'] = mood
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะะตั ััะตะฒะพะณะธ (1)", "anxiety_1", 'green'),
         create_fancy_button("๐ ะะตะณะบะฐั (2)", "anxiety_2", 'light_blue')],
        [create_fancy_button("๐ฐ ะกัะตะดะฝัั (3)", "anxiety_3", 'yellow'),
         create_fancy_button("๐ฑ ะกะธะปัะฝะฐั (4)", "anxiety_4", 'orange')],
        [create_fancy_button("๐ ะะฐะฝะธะบะฐ (5)", "anxiety_5", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'anxiety'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะะะกะขะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะัะตะฝะธัะต ััะพะฒะตะฝั ััะตะฒะพะณะธ:",
        reply_markup=keyboard
    )


async def mood_energy(update: Update, context):
    """ะัะตะฝะบะฐ ัะฝะตัะณะธะธ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    anxiety = int(data.split('_')[1])
    
    context.user_data['mood_tracker']['anxiety'] = anxiety
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โก ะะพะปะพะฝ ัะธะป (5)", "energy_5", 'green'),
         create_fancy_button("๐ ะะพัะผะฐะปัะฝะพ (4)", "energy_4", 'light_blue')],
        [create_fancy_button("๐ชซ ะกัะตะดะฝะต (3)", "energy_3", 'yellow'),
         create_fancy_button("๐ด ะะฐะปะพ ัะธะป (2)", "energy_2", 'orange')],
        [create_fancy_button("๐ ะะตั ัะธะป (1)", "energy_1", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'energy'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะะะกะขะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะัะตะฝะธัะต ััะพะฒะตะฝั ัะฝะตัะณะธะธ:",
        reply_markup=keyboard
    )


async def mood_sleep(update: Update, context):
    """ะัะตะฝะบะฐ ัะฝะฐ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    energy = int(data.split('_')[1])
    
    context.user_data['mood_tracker']['energy'] = energy
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ด ะัะปะธัะฝะพ (5+)", "sleep_5", 'green'),
         create_fancy_button("๐ ะฅะพัะพัะพ (7-8ั)", "sleep_4", 'light_blue')],
        [create_fancy_button("๐ ะกัะตะดะฝะต (5-6ั)", "sleep_3", 'yellow'),
         create_fancy_button("๐ ะะฐะปะพ (3-4ั)", "sleep_2", 'orange')],
        [create_fancy_button("๐ซ ะะพััะธ ะฝะต ัะฟะฐะป", "sleep_1", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'sleep'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะะะกะขะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะะฐะบ ะฒั ัะฟะฐะปะธ ะฟัะพัะปะพะน ะฝะพััั?",
        reply_markup=keyboard
    )


async def mood_notes(update: Update, context):
    """ะะฐะผะตัะบะฐ ะบ ััะตะบะตัั"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    sleep = int(data.split('_')[1])
    
    context.user_data['mood_tracker']['sleep'] = sleep
    context.user_data['mood_tracker']['step'] = 'notes'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะะะกะขะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะะฐะฟะธัะธัะต ะบะพัะพัะบัั ะทะฐะผะตัะบั (ััะพ ะฟะพะฒะปะธัะปะพ ะฝะฐ ัะพััะพัะฝะธะต):\n\n"
        f"{COLORS['violet']} ะะปะธ ะพัะฟัะฐะฒััะต /skip ััะพะฑั ะฟัะพะฟัััะธัั"
    )


async def mood_save(update: Update, context):
    """ะกะพััะฐะฝะตะฝะธะต ััะตะบะตัะฐ"""
    user = update.effective_user
    user_id = user.id
    
    tracker_data = context.user_data.get('mood_tracker', {})
    
    if 'mood' not in tracker_data or 'anxiety' not in tracker_data or 'energy' not in tracker_data or 'sleep' not in tracker_data:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ: ะฝะต ะฒัะต ะดะฐะฝะฝัะต ัะพะฑัะฐะฝั.\n"
            f"{COLORS['blue']} ะะฐัะฝะธัะต ะทะฐะฝะพะฒะพ: /mood"
        )
        return
    
    mood = tracker_data['mood']
    anxiety = tracker_data['anxiety']
    energy = tracker_data['energy']
    sleep = tracker_data['sleep']
    taker_id = tracker_data['taker_id']
    taker_tag = tracker_data['taker_tag']
    
    # ะะพะปััะฐะตะผ ะทะฐะผะตัะบั
    note = update.message.text if update.message.text != '/skip' else ''
    
    # ะกะพััะฐะฝัะตะผ ะฒ ะฑะฐะทั
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""INSERT INTO mood_tracker 
                 (user_id, mood, anxiety, energy, sleep, notes, created_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?)""",
              (user_id, mood, anxiety, energy, sleep, note, get_current_time()))
    tracker_id = c.lastrowid
    
    # ะัะพะฒะตััะตะผ ะบัะธัะธัะตัะบะธะต ะทะฝะฐัะตะฝะธั
    alerts = []
    if mood <= 1:
        alerts.append("๐ด ะะะะขะะงะะกะะ ะะะะะะ ะะะกะขะะะะะะ")
    if anxiety >= 4:
        alerts.append("๐ ะะซะกะะะะ ะฃะะะะะะฌ ะขะะะะะะ")
    if energy <= 1:
        alerts.append("โก ะะะะะะ ะะกะขะะฉะะะะ")
    if sleep <= 1:
        alerts.append("๐ด ะกะะะฌะะะะซะ ะะะะะะะะซ ะกะ ะกะะะ")
    
    conn.commit()
    
    # ะัะฟัะฐะฒะปัะตะผ ะฐะดะผะธะฝั ะฒ ัะฐั
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    mood_text = f"{COLORS['purple']} ๐ ะะะะะฏ ะะะะะกะฌ ะขะะะะะะ #{tracker_id}\n\n"
    mood_text += f"{COLORS['blue']} ๐ค ะะพะปัะทะพะฒะฐัะตะปั: {user.full_name} (@{user.username})\n"
    mood_text += f"{COLORS['violet']} ๐ ID: {user_id}\n\n"
    mood_text += f"{COLORS['night']} {mood_emoji.get(mood, '๐')} ะะฐัััะพะตะฝะธะต: {mood}/5\n"
    mood_text += f"{COLORS['purple']} {anxiety_emoji.get(anxiety, '๐')} ะขัะตะฒะพะณะฐ: {anxiety}/5\n"
    mood_text += f"{COLORS['blue']} {energy_emoji.get(energy, '๐')} ะญะฝะตัะณะธั: {energy}/5\n"
    mood_text += f"{COLORS['violet']} {sleep_emoji.get(sleep, '๐ด')} ะกะพะฝ: {sleep}/5\n"
    
    if note:
        mood_text += f"\n{COLORS['night']} ๐ ะะฐะผะตัะบะฐ: {note}\n"
    
    mood_text += f"\n{COLORS['fog']} โฑ {get_current_time()}"
    
    if alerts:
        mood_text += f"\n\n{COLORS['red']} โ๏ธ ะะะะะะะะ!\n"
        for alert in alerts:
            mood_text += f"{COLORS['dark_red']} {alert}\n"
    
    # ะะฐัะพะดะธะผ ััะตะด ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
    c.execute("SELECT thread_id FROM active_chats WHERE user_id = ?", (user_id,))
    thread = c.fetchone()
    conn.close()
    
    if thread:
        await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread[0],
            text=mood_text
        )
    
    # ะัะฟัะฐะฒะปัะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
    user_text = f"{COLORS['purple']} โ ะะะะะกะฌ ะกะะฅะะะะะะ\n\n"
    user_text += f"{COLORS['blue']} {mood_emoji.get(mood, '๐')} ะะฐัััะพะตะฝะธะต: {mood}/5\n"
    user_text += f"{COLORS['violet']} {anxiety_emoji.get(anxiety, '๐')} ะขัะตะฒะพะณะฐ: {anxiety}/5\n"
    user_text += f"{COLORS['night']} {energy_emoji.get(energy, '๐')} ะญะฝะตัะณะธั: {energy}/5\n"
    user_text += f"{COLORS['purple']} {sleep_emoji.get(sleep, '๐ด')} ะกะพะฝ: {sleep}/5\n"
    
    if alerts:
        user_text += f"\n{COLORS['orange']} โ๏ธ ะะฐัะธ ะฟะพะบะฐะทะฐัะตะปะธ ััะตะฑััั ะฒะฝะธะผะฐะฝะธั.\n"
        user_text += f"{COLORS['blue']} ะะดะผะธะฝะธัััะฐัะพั ัะถะต ะฟะพะปััะธะป ัะฒะตะดะพะผะปะตะฝะธะต."
    
    await update.message.reply_text(user_text)
    
    # ะัะธัะฐะตะผ ะดะฐะฝะฝัะต
    del context.user_data['mood_tracker']


async def mood_history(update: Update, context):
    """ะััะพัะธั ััะตะบะตัะฐ /mood_history ะธะปะธ /ะธััะพัะธั_ะฝะฐัััะพะตะฝะธั"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT mood, anxiety, energy, sleep, notes, created_at 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 10""", (user_id,))
    entries = c.fetchall()
    conn.close()
    
    if not entries:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        return
    
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะขะะะะะะ (ะฟะพัะปะตะดะฝะธะต 10 ะทะฐะฟะธัะตะน)\n\n"
    
    for mood, anxiety, energy, sleep, notes, created_at in entries:
        text += f"{COLORS['blue']} {created_at[:16]}\n"
        text += f"{COLORS['violet']} {mood_emoji.get(mood, '๐')} {mood} | "
        text += f"{anxiety_emoji.get(anxiety, '๐')} {anxiety} | "
        text += f"{energy_emoji.get(energy, '๐')} {energy} | "
        text += f"{sleep_emoji.get(sleep, '๐ด')} {sleep}\n"
        if notes:
            text += f"{COLORS['night']} ๐ {notes[:50]}{'...' if len(notes) > 50 else ''}\n"
        text += "\n"
    
    # ะะฐะทะฑะธะฒะฐะตะผ ะดะปะธะฝะฝัะต ัะพะพะฑัะตะฝะธั
    if len(text) > 4000:
        parts = [text[i:i+4000] for i in range(0, len(text), 4000)]
        for part in parts:
            await update.message.reply_text(part)
    else:
        await update.message.reply_text(text)


async def mood_stats(update: Update, context):
    """ะกัะฐัะธััะธะบะฐ ััะตะบะตัะฐ /mood_stats ะธะปะธ /ััะฐัะธััะธะบะฐ_ะฝะฐัััะพะตะฝะธั"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT AVG(mood), AVG(anxiety), AVG(energy), AVG(sleep), COUNT(*) 
                 FROM mood_tracker 
                 WHERE user_id = ?""", (user_id,))
    stats = c.fetchone()
    
    avg_mood, avg_anxiety, avg_energy, avg_sleep, count = stats
    
    if not count:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะทะฐะฟะธัะตะน ะดะปั ััะฐัะธััะธะบะธ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        conn.close()
        return
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ะดะฝัะผ ะฝะตะดะตะปะธ
    c.execute("""SELECT strftime('%w', created_at) as weekday, AVG(mood) 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 GROUP BY weekday""", (user_id,))
    weekday_stats = c.fetchall()
    conn.close()
    
    days = ['ะะพัะบัะตัะตะฝัะต', 'ะะพะฝะตะดะตะปัะฝะธะบ', 'ะัะพัะฝะธะบ', 'ะกัะตะดะฐ', 'ะงะตัะฒะตัะณ', 'ะััะฝะธัะฐ', 'ะกัะฑะฑะพัะฐ']
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะขะะะะะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ะทะฐะฟะธัะตะน: {count}\n\n"
    text += f"{COLORS['violet']} ๐ ะกะะะะะะ ะะะะะะะขะะะ:\n"
    text += f"{COLORS['night']} ๐ ะะฐัััะพะตะฝะธะต: {avg_mood:.1f}/5\n"
    text += f"{COLORS['purple']} ๐ฐ ะขัะตะฒะพะณะฐ: {avg_anxiety:.1f}/5\n"
    text += f"{COLORS['blue']} โก ะญะฝะตัะณะธั: {avg_energy:.1f}/5\n"
    text += f"{COLORS['violet']} ๐ด ะกะพะฝ: {avg_sleep:.1f}/5\n\n"
    
    if weekday_stats:
        text += f"{COLORS['night']} ๐ ะะ ะะะฏะ ะะะะะะ:\n"
        for wd, mood_avg in weekday_stats:
            day = days[int(wd)]
            emoji = '๐' if mood_avg >= 4 else '๐' if mood_avg >= 3 else '๐'
            text += f"{COLORS['blue']} {emoji} {day}: {mood_avg:.1f}\n"
    
    await update.message.reply_text(text)


async def mood_alert(update: Update, context):
    """ะฃััะฐะฝะพะฒะบะฐ ะพะฟะพะฒะตัะตะฝะธะน /mood_alert ะธะปะธ /ัะฒะตะดะพะผะปะตะฝะธั"""
    user_id = update.effective_user.id
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะัะธ ะฟะฐะดะตะฝะธะธ ะฝะฐัััะพะตะฝะธั", "alert_mood", 'purple')],
        [create_fancy_button("๐ฐ ะัะธ ะฒััะพะบะพะน ััะตะฒะพะณะต", "alert_anxiety", 'blue')],
        [create_fancy_button("โก ะัะธ ะฝะธะทะบะพะน ัะฝะตัะณะธะธ", "alert_energy", 'violet')],
        [create_fancy_button("๐ด ะัะธ ะฟะปะพัะพะผ ัะฝะต", "alert_sleep", 'night')],
        [create_fancy_button("โ ะัะบะปััะธัั ะฒัะต", "alert_off", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "user_main_menu", 'fog')]
    ])
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ ะฃะะะะะะะะะะฏ\n\n"
        f"{COLORS['blue']} ะัะฑะตัะธัะต, ะพ ัะตะผ ัะฒะตะดะพะผะปััั ะฐะดะผะธะฝะธัััะฐัะพัะฐ:",
        reply_markup=keyboard
    )


async def set_mood_alert(query, context, alert_type):
    """ะฃััะฐะฝะพะฒะบะฐ ะบะพะฝะบัะตัะฝะพะณะพ ะพะฟะพะฒะตัะตะฝะธั"""
    user_id = query.from_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    if alert_type == 'off':
        c.execute("UPDATE mood_alerts SET is_active = 0 WHERE user_id = ?", (user_id,))
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะต ัะฒะตะดะพะผะปะตะฝะธั ะพัะบะปััะตะฝั"
        )
    else:
        thresholds = {
            'mood': 2,
            'anxiety': 4,
            'energy': 2,
            'sleep': 2
        }
        
        c.execute("""INSERT OR REPLACE INTO mood_alerts 
                     (user_id, alert_type, threshold, is_active, created_at)
                     VALUES (?, ?, ?, ?, ?)""",
                  (user_id, alert_type, thresholds[alert_type], 1, get_current_time()))
        
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะฃะฒะตะดะพะผะปะตะฝะธะต ะฝะฐัััะพะตะฝะพ!\n\n"
            f"{COLORS['blue']} ะะดะผะธะฝะธัััะฐัะพั ะฟะพะปััะธั ะพะฟะพะฒะตัะตะฝะธะต ะฟัะธ ะบัะธัะธัะตัะบะธั ะฟะพะบะฐะทะฐัะตะปัั."
        )
    
    conn.commit()
    conn.close()


async def admin_mood_history(update: Update, context):
    """ะััะพัะธั ััะตะบะตัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั /mood_history [ID]"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    args = context.args
    if not args:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃะบะฐะถะธัะต ID ะฟะพะปัะทะพะฒะฐัะตะปั\n\n"
            f"{COLORS['blue']} ะัะธะผะตั: /mood_history 123456789"
        )
        return
    
    try:
        user_id = int(args[0])
    except ValueError:
        await update.message.reply_text(f"{COLORS['purple']} โ ID ะดะพะปะถะตะฝ ะฑััั ัะธัะปะพะผ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT mood, anxiety, energy, sleep, notes, created_at 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 20""", (user_id,))
    entries = c.fetchall()
    
    c.execute("SELECT user_name FROM active_chats WHERE user_id = ?", (user_id,))
    user = c.fetchone()
    conn.close()
    
    if not entries:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะตั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ"
        )
        return
    
    user_name = user[0] if user else f"ID: {user_id}"
    
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
async def mood_track(update: Update, context): 

    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ะฐะบัะธะฒะฝัะน ัะฐั ั ะฐะดะผะธะฝะพะผ
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT status, taken_by_id, taken_by_tag, thread_id FROM active_chats WHERE user_id = ?", (user_id,))
    chat = c.fetchone()
    conn.close()
    
    if not chat or chat[0] != 'active':
        # ะัะปะธ ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ - ัะพะทะดะฐะตะผ ะบะปะฐะฒะธะฐัััั ะดะปั ัะพะทะดะฐะฝะธั ัะฐัะฐ
        keyboard = InlineKeyboardMarkup([
            [create_fancy_button("๐ ะะฐะฟะธัะฐัั ะฐะดะผะธะฝั", "write", 'purple')],
            [create_fancy_button("โ๏ธ ะ ะผะตะฝั", "user_main_menu", 'fog')]
        ])
        
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ ั ะฐะดะผะธะฝะพะผ.\n\n"
            f"{COLORS['blue']} ะกะฝะฐัะฐะปะฐ ะฝะฐะฟะธัะธัะต ัะพะพะฑัะตะฝะธะต, ััะพะฑั ัะพะทะดะฐัั ัะฐั:",
            reply_markup=keyboard
        )
        return
    
    status, taker_id, taker_tag, thread_id = chat
    
    # ะกะพััะฐะฝัะตะผ ะดะฐะฝะฝัะต ััะตะบะตัะฐ
    context.user_data['mood_tracker'] = {
        'taker_id': taker_id,
        'taker_tag': taker_tag,
        'thread_id': thread_id,
        'step': 'mood'
    }
    
    # ะะพะบะฐะทัะฒะฐะตะผ ะฟะตัะฒัะน ัะฐะณ - ะพัะตะฝะบะฐ ะฝะฐัััะพะตะฝะธั
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะัะปะธัะฝะพ (5)", "mood_5", 'green'),
         create_fancy_button("๐ ะฅะพัะพัะพ (4)", "mood_4", 'light_blue')],
        [create_fancy_button("๐ ะกัะตะดะฝะต (3)", "mood_3", 'yellow'),
         create_fancy_button("๐ ะะปะพัะพ (2)", "mood_2", 'orange')],
        [create_fancy_button("๐ซ ะฃะถะฐัะฝะพ (1)", "mood_1", 'red'),
         create_fancy_button("๐จ ะัะธัะธัะฝะพ (0)", "mood_0", 'dark_red')],
        [create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')]
    ])
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
        f"{COLORS['blue']} ะจะฐะณ 1/5: ะัะตะฝะธัะต ะฒะฐัะต ะฝะฐัััะพะตะฝะธะต ัะตะนัะฐั:",
        reply_markup=keyboard
    )


async def mood_anxiety(update: Update, context):
    """ะจะฐะณ 2: ะัะตะฝะบะฐ ััะตะฒะพะณะธ"""
    query = update.callback_query
    await query.answer()
    
    # ะะพะปััะฐะตะผ ะพัะตะฝะบั ะฝะฐัััะพะตะฝะธั
    data = query.data
    mood = int(data.split('_')[1])
    context.user_data['mood_tracker']['mood'] = mood
    
    # ะะปะฐะฒะธะฐัััะฐ ะดะปั ะพัะตะฝะบะธ ััะตะฒะพะณะธ
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะะตั ััะตะฒะพะณะธ (1)", "anxiety_1", 'green'),
         create_fancy_button("๐ ะะตะณะบะฐั (2)", "anxiety_2", 'light_blue')],
        [create_fancy_button("๐ฐ ะกัะตะดะฝัั (3)", "anxiety_3", 'yellow'),
         create_fancy_button("๐ฑ ะกะธะปัะฝะฐั (4)", "anxiety_4", 'orange')],
        [create_fancy_button("๐ ะะฐะฝะธะบะฐ (5)", "anxiety_5", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'anxiety'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
        f"{COLORS['blue']} ะจะฐะณ 2/5: ะัะตะฝะธัะต ััะพะฒะตะฝั ััะตะฒะพะณะธ:",
        reply_markup=keyboard
    )


async def mood_energy(update: Update, context):
    """ะจะฐะณ 3: ะัะตะฝะบะฐ ัะฝะตัะณะธะธ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    anxiety = int(data.split('_')[1])
    context.user_data['mood_tracker']['anxiety'] = anxiety
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โก ะะพะปะพะฝ ัะธะป (5)", "energy_5", 'green'),
         create_fancy_button("๐ ะะพัะผะฐะปัะฝะพ (4)", "energy_4", 'light_blue')],
        [create_fancy_button("๐ชซ ะกัะตะดะฝะต (3)", "energy_3", 'yellow'),
         create_fancy_button("๐ด ะะฐะปะพ ัะธะป (2)", "energy_2", 'orange')],
        [create_fancy_button("๐ ะะตั ัะธะป (1)", "energy_1", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'energy'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
        f"{COLORS['blue']} ะจะฐะณ 3/5: ะัะตะฝะธัะต ััะพะฒะตะฝั ัะฝะตัะณะธะธ:",
        reply_markup=keyboard
    )


async def mood_sleep(update: Update, context):
    """ะจะฐะณ 4: ะัะตะฝะบะฐ ัะฝะฐ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    energy = int(data.split('_')[1])
    context.user_data['mood_tracker']['energy'] = energy
    
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ด ะัะปะธัะฝะพ (8+ั)", "sleep_5", 'green'),
         create_fancy_button("๐ ะฅะพัะพัะพ (7-8ั)", "sleep_4", 'light_blue')],
        [create_fancy_button("๐ ะกัะตะดะฝะต (5-6ั)", "sleep_3", 'yellow'),
         create_fancy_button("๐ ะะฐะปะพ (3-4ั)", "sleep_2", 'orange')],
        [create_fancy_button("๐ซ ะะพััะธ ะฝะต ัะฟะฐะป (1-2ั)", "sleep_1", 'red')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    context.user_data['mood_tracker']['step'] = 'sleep'
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
        f"{COLORS['blue']} ะจะฐะณ 4/5: ะะฐะบ ะฒั ัะฟะฐะปะธ ะฟัะพัะปะพะน ะฝะพััั?",
        reply_markup=keyboard
    )


async def mood_notes(update: Update, context):
    """ะจะฐะณ 5: ะะฐะผะตัะบะฐ ะบ ััะตะบะตัั"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    sleep = int(data.split('_')[1])
    context.user_data['mood_tracker']['sleep'] = sleep
    context.user_data['mood_tracker']['step'] = 'notes'
    
    # ะะปะฐะฒะธะฐัััะฐ ั ะฒะฐัะธะฐะฝัะฐะผะธ ะฑัััััั ะทะฐะผะตัะพะบ
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ค ะะพะปะตั", "note_sick", 'red'),
         create_fancy_button("๐ผ ะะฐะฑะพัะฐ", "note_work", 'blue')],
        [create_fancy_button("๐จโ๐ฉโ๐งโ๐ฆ ะกะตะผัั", "note_family", 'green'),
         create_fancy_button("โค๏ธ ะัะฝะพัะตะฝะธั", "note_relationship", 'pink')],
        [create_fancy_button("๐ ะกะฟะพัั", "note_sport", 'orange'),
         create_fancy_button("๐ฎ ะัะดัั", "note_relax", 'purple')],
        [create_fancy_button("โ๏ธ ะกะฒะพะน ะฒะฐัะธะฐะฝั", "note_custom", 'violet')],
        [create_fancy_button("โญ๏ธ ะัะพะฟัััะธัั", "note_skip", 'fog')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "mood_track", 'fog')]
    ])
    
    await query.edit_message_text(
        f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
        f"{COLORS['blue']} ะจะฐะณ 5/5: ะงัะพ ะฟะพะฒะปะธัะปะพ ะฝะฐ ะฒะฐัะต ัะพััะพัะฝะธะต?\n\n"
        f"{COLORS['violet']} ะัะฑะตัะธัะต ะฑัััััั ะทะฐะผะตัะบั ะธะปะธ ะฝะฐะฟะธัะธัะต ัะฒะพั:",
        reply_markup=keyboard
    )


async def mood_note_callback(update: Update, context):
    """ะะฑัะฐะฑะพัะบะฐ ะฒัะฑะพัะฐ ะฑััััะพะน ะทะฐะผะตัะบะธ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    # ะกะปะพะฒะฐัั ะทะฐะผะตัะพะบ
    note_map = {
        "note_sick": "๐ค ะะพะปะตั",
        "note_work": "๐ผ ะัะพะฑะปะตะผั ะฝะฐ ัะฐะฑะพัะต",
        "note_family": "๐จโ๐ฉโ๐งโ๐ฆ ะกะตะผะตะนะฝัะต ะดะตะปะฐ",
        "note_relationship": "โค๏ธ ะกะปะพะถะฝะพััะธ ะฒ ะพัะฝะพัะตะฝะธัั",
        "note_sport": "๐ ะคะธะทะธัะตัะบะฐั ะฝะฐะณััะทะบะฐ",
        "note_relax": "๐ฎ ะฅะพัะพัะพ ะพัะดะพัะฝัะป"
    }
    
    if data == "note_skip":
        note = ""
        await mood_save_with_note(update, context, note)
    elif data == "note_custom":
        context.user_data['mood_tracker']['awaiting_custom_note'] = True
        await query.edit_message_text(
            f"{COLORS['purple']} ๐ ะขะะะะะ ะกะะะะงะฃะะกะขะะะฏ\n\n"
            f"{COLORS['blue']} ะะฐะฟะธัะธัะต ะฒะฐัั ะทะฐะผะตัะบั ัะตะบััะพะผ:"
        )
    else:
        note = note_map.get(data, "")
        await mood_save_with_note(update, context, note)


async def mood_save_with_note(update: Update, context, note_text):
    """ะกะพััะฐะฝะตะฝะธะต ััะตะบะตัะฐ ั ะทะฐะผะตัะบะพะน"""
    query = update.callback_query
    user = query.from_user
    user_id = user.id
    
    tracker_data = context.user_data.get('mood_tracker', {})
    
    mood = tracker_data.get('mood')
    anxiety = tracker_data.get('anxiety')
    energy = tracker_data.get('energy')
    sleep = tracker_data.get('sleep')
    taker_id = tracker_data.get('taker_id')
    taker_tag = tracker_data.get('taker_tag')
    thread_id = tracker_data.get('thread_id')
    
    # ะัะพะฒะตััะตะผ, ััะพ ะฒัะต ะดะฐะฝะฝัะต ะตััั
    if None in (mood, anxiety, energy, sleep):
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ: ะฝะต ะฒัะต ะดะฐะฝะฝัะต ัะพะฑัะฐะฝั.\n"
            f"{COLORS['blue']} ะะฐัะฝะธัะต ะทะฐะฝะพะฒะพ: /mood"
        )
        return
    
    # ะกะพััะฐะฝัะตะผ ะฒ ะฑะฐะทั
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""INSERT INTO mood_tracker 
                 (user_id, mood, anxiety, energy, sleep, notes, created_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?)""",
              (user_id, mood, anxiety, energy, sleep, note_text, get_current_time()))
    tracker_id = c.lastrowid
    
    # ะัะพะฒะตััะตะผ ะบัะธัะธัะตัะบะธะต ะทะฝะฐัะตะฝะธั
    alerts = []
    if mood <= 1:
        alerts.append("๐ด ะะะะขะะงะะกะะ ะะะะะะ ะะะกะขะะะะะะ")
    if anxiety >= 4:
        alerts.append("๐ ะะซะกะะะะ ะฃะะะะะะฌ ะขะะะะะะ")
    if energy <= 1:
        alerts.append("โก ะะะะะะ ะะกะขะะฉะะะะ")
    if sleep <= 1:
        alerts.append("๐ด ะกะะะฌะะะะซะ ะะะะะะะะซ ะกะ ะกะะะ")
    
    conn.commit()
    
    # ะญะผะพะดะทะธ ะดะปั ะพัะพะฑัะฐะถะตะฝะธั
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    # ะกะพะพะฑัะตะฝะธะต ะดะปั ะฐะดะผะธะฝะฐ
    admin_text = f"{COLORS['purple']} ๐ ะะะะะฏ ะะะะะกะฌ ะขะะะะะะ #{tracker_id}\n\n"
    admin_text += f"{COLORS['blue']} ๐ค ะะพะปัะทะพะฒะฐัะตะปั: {user.full_name} (@{user.username})\n"
    admin_text += f"{COLORS['violet']} ๐ ID: {user_id}\n\n"
    admin_text += f"{COLORS['night']} {mood_emoji.get(mood, '๐')} ะะฐัััะพะตะฝะธะต: {mood}/5\n"
    admin_text += f"{COLORS['purple']} {anxiety_emoji.get(anxiety, '๐')} ะขัะตะฒะพะณะฐ: {anxiety}/5\n"
    admin_text += f"{COLORS['blue']} {energy_emoji.get(energy, '๐')} ะญะฝะตัะณะธั: {energy}/5\n"
    admin_text += f"{COLORS['violet']} {sleep_emoji.get(sleep, '๐ด')} ะกะพะฝ: {sleep}/5\n"
    
    if note_text:
        admin_text += f"\n{COLORS['night']} ๐ ะะฐะผะตัะบะฐ: {note_text}\n"
    
    admin_text += f"\n{COLORS['fog']} โฑ {get_current_time()}"
    
    if alerts:
        admin_text += f"\n\n{COLORS['red']} โ๏ธ ะะะะะะะะ!\n"
        for alert in alerts:
            admin_text += f"{COLORS['dark_red']} {alert}\n"
    
    # ะัะฟัะฐะฒะปัะตะผ ะฐะดะผะธะฝั ะฒ ััะตะด
    if thread_id:
        try:
            await context.bot.send_message(
                chat_id=ADMIN_GROUP_ID,
                message_thread_id=thread_id,
                text=admin_text
            )
        except Exception as e:
            print(f"ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ะฐะดะผะธะฝั: {e}")
    
    # ะะพะดัะฒะตัะถะดะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
    user_text = f"{COLORS['purple']} โ ะะะะะกะฌ ะกะะฅะะะะะะ\n\n"
    user_text += f"{COLORS['blue']} {mood_emoji.get(mood, '๐')} ะะฐัััะพะตะฝะธะต: {mood}/5\n"
    user_text += f"{COLORS['violet']} {anxiety_emoji.get(anxiety, '๐')} ะขัะตะฒะพะณะฐ: {anxiety}/5\n"
    user_text += f"{COLORS['night']} {energy_emoji.get(energy, '๐')} ะญะฝะตัะณะธั: {energy}/5\n"
    user_text += f"{COLORS['purple']} {sleep_emoji.get(sleep, '๐ด')} ะกะพะฝ: {sleep}/5\n"
    
    if note_text:
        user_text += f"\n{COLORS['blue']} ๐ ะะฐะผะตัะบะฐ: {note_text}\n"
    
    if alerts:
        user_text += f"\n{COLORS['orange']} โ๏ธ ะะฐัะธ ะฟะพะบะฐะทะฐัะตะปะธ ััะตะฑััั ะฒะฝะธะผะฐะฝะธั.\n"
        user_text += f"{COLORS['blue']} ะะดะผะธะฝะธัััะฐัะพั ัะถะต ะฟะพะปััะธะป ัะฒะตะดะพะผะปะตะฝะธะต."
    
    # ะะฝะพะฟะบะฐ ะดะปั ะฟะพะฒัะพัะฝะพะน ะทะฐะฟะธัะธ
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ ะะพะฒะฐั ะทะฐะฟะธัั", "mood_track", 'purple')],
        [create_fancy_button("โ๏ธ ะ ะผะตะฝั", "user_main_menu", 'fog')]
    ])
    
    await query.edit_message_text(user_text, reply_markup=keyboard)
    
    # ะัะธัะฐะตะผ ะดะฐะฝะฝัะต
    del context.user_data['mood_tracker']
    conn.close()


async def mood_custom_note(update: Update, context):
    """ะะฑัะฐะฑะพัะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะน ะทะฐะผะตัะบะธ"""
    user = update.effective_user
    
    if 'mood_tracker' not in context.user_data or not context.user_data['mood_tracker'].get('awaiting_custom_note'):
        return
    
    note_text = update.message.text
    context.user_data['mood_tracker']['awaiting_custom_note'] = False
    
    # ะกะพะทะดะฐะตะผ callback_query ะดะปั ัะพััะฐะฝะตะฝะธั
    class MockQuery:
        def __init__(self, user):
            self.from_user = user
            
        async def answer(self):
            pass
            
        async def edit_message_text(self, text, reply_markup=None):
            await update.message.reply_text(text, reply_markup=reply_markup)
    
    mock_query = MockQuery(user)
    update.callback_query = mock_query
    
    await mood_save_with_note(update, context, note_text)


async def mood_history(update: Update, context):
    """ะััะพัะธั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT mood, anxiety, energy, sleep, notes, created_at 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 10""", (user_id,))
    entries = c.fetchall()
    conn.close()
    
    if not entries:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ ะฒะฐั ะตัะต ะฝะตั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        return
    
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะขะะะะะะ (ะฟะพัะปะตะดะฝะธะต 10 ะทะฐะฟะธัะตะน)\n\n"
    
    for mood, anxiety, energy, sleep, notes, created_at in entries:
        text += f"{COLORS['blue']} {created_at[:16]}\n"
        text += f"{COLORS['violet']} {mood_emoji.get(mood, '๐')} {mood} | "
        text += f"{anxiety_emoji.get(anxiety, '๐')} {anxiety} | "
        text += f"{energy_emoji.get(energy, '๐')} {energy} | "
        text += f"{sleep_emoji.get(sleep, '๐ด')} {sleep}\n"
        if notes:
            text += f"{COLORS['night']} ๐ {notes[:50]}{'...' if len(notes) > 50 else ''}\n"
        text += "\n"
    
    await update.message.reply_text(text)


async def mood_stats(update: Update, context):
    """ะกัะฐัะธััะธะบะฐ ััะตะบะตัะฐ"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT AVG(mood), AVG(anxiety), AVG(energy), AVG(sleep), COUNT(*) 
                 FROM mood_tracker 
                 WHERE user_id = ?""", (user_id,))
    stats = c.fetchone()
    
    avg_mood, avg_anxiety, avg_energy, avg_sleep, count = stats
    
    if not count:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะทะฐะฟะธัะตะน ะดะปั ััะฐัะธััะธะบะธ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        conn.close()
        return
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ะดะฝัะผ ะฝะตะดะตะปะธ
    c.execute("""SELECT strftime('%w', created_at) as weekday, AVG(mood) 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 GROUP BY weekday""", (user_id,))
    weekday_stats = c.fetchall()
    conn.close()
    
    days = ['ะะพัะบัะตัะตะฝัะต', 'ะะพะฝะตะดะตะปัะฝะธะบ', 'ะัะพัะฝะธะบ', 'ะกัะตะดะฐ', 'ะงะตัะฒะตัะณ', 'ะััะฝะธัะฐ', 'ะกัะฑะฑะพัะฐ']
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะขะะะะะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ะทะฐะฟะธัะตะน: {count}\n\n"
    text += f"{COLORS['violet']} ๐ ะกะะะะะะ ะะะะะะะขะะะ:\n"
    text += f"{COLORS['night']} ๐ ะะฐัััะพะตะฝะธะต: {avg_mood:.1f}/5\n"
    text += f"{COLORS['purple']} ๐ฐ ะขัะตะฒะพะณะฐ: {avg_anxiety:.1f}/5\n"
    text += f"{COLORS['blue']} โก ะญะฝะตัะณะธั: {avg_energy:.1f}/5\n"
    text += f"{COLORS['violet']} ๐ด ะกะพะฝ: {avg_sleep:.1f}/5\n\n"
    
    if weekday_stats:
        text += f"{COLORS['night']} ๐ ะะ ะะะฏะ ะะะะะะ:\n"
        for wd, mood_avg in weekday_stats:
            day = days[int(wd)]
            emoji = '๐' if mood_avg >= 4 else '๐' if mood_avg >= 3 else '๐'
            text += f"{COLORS['blue']} {emoji} {day}: {mood_avg:.1f}\n"
    
    await update.message.reply_text(text)


async def mood_history(update: Update, context):
    """ะััะพัะธั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT mood, anxiety, energy, sleep, notes, created_at 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 10""", (user_id,))
    entries = c.fetchall()
    conn.close()
    
    if not entries:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ ะฒะฐั ะตัะต ะฝะตั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        return
    
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะขะะะะะะ (ะฟะพัะปะตะดะฝะธะต 10 ะทะฐะฟะธัะตะน)\n\n"
    
    for mood, anxiety, energy, sleep, notes, created_at in entries:
        text += f"{COLORS['blue']} {created_at[:16]}\n"
        text += f"{COLORS['violet']} {mood_emoji.get(mood, '๐')} {mood} | "
        text += f"{anxiety_emoji.get(anxiety, '๐')} {anxiety} | "
        text += f"{energy_emoji.get(energy, '๐')} {energy} | "
        text += f"{sleep_emoji.get(sleep, '๐ด')} {sleep}\n"
        if notes:
            text += f"{COLORS['night']} ๐ {notes[:50]}{'...' if len(notes) > 50 else ''}\n"
        text += "\n"
    
    await update.message.reply_text(text)


async def mood_stats(update: Update, context):
    """ะกัะฐัะธััะธะบะฐ ััะตะบะตัะฐ"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT AVG(mood), AVG(anxiety), AVG(energy), AVG(sleep), COUNT(*) 
                 FROM mood_tracker 
                 WHERE user_id = ?""", (user_id,))
    stats = c.fetchone()
    
    avg_mood, avg_anxiety, avg_energy, avg_sleep, count = stats
    
    if not count:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะทะฐะฟะธัะตะน ะดะปั ััะฐัะธััะธะบะธ.\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /mood ััะพะฑั ัะพะทะดะฐัั ะฟะตัะฒัั ะทะฐะฟะธัั."
        )
        conn.close()
        return
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ะดะฝัะผ ะฝะตะดะตะปะธ
    c.execute("""SELECT strftime('%w', created_at) as weekday, AVG(mood) 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 GROUP BY weekday""", (user_id,))
    weekday_stats = c.fetchall()
    conn.close()
    
    days = ['ะะพัะบัะตัะตะฝัะต', 'ะะพะฝะตะดะตะปัะฝะธะบ', 'ะัะพัะฝะธะบ', 'ะกัะตะดะฐ', 'ะงะตัะฒะตัะณ', 'ะััะฝะธัะฐ', 'ะกัะฑะฑะพัะฐ']
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะขะะะะะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ะทะฐะฟะธัะตะน: {count}\n\n"
    text += f"{COLORS['violet']} ๐ ะกะะะะะะ ะะะะะะะขะะะ:\n"
    text += f"{COLORS['night']} ๐ ะะฐัััะพะตะฝะธะต: {avg_mood:.1f}/5\n"
    text += f"{COLORS['purple']} ๐ฐ ะขัะตะฒะพะณะฐ: {avg_anxiety:.1f}/5\n"
    text += f"{COLORS['blue']} โก ะญะฝะตัะณะธั: {avg_energy:.1f}/5\n"
    text += f"{COLORS['violet']} ๐ด ะกะพะฝ: {avg_sleep:.1f}/5\n\n"
    
    if weekday_stats:
        text += f"{COLORS['night']} ๐ ะะ ะะะฏะ ะะะะะะ:\n"
        for wd, mood_avg in weekday_stats:
            day = days[int(wd)]
            emoji = '๐' if mood_avg >= 4 else '๐' if mood_avg >= 3 else '๐'
            text += f"{COLORS['blue']} {emoji} {day}: {mood_avg:.1f}\n"
    
    await update.message.reply_text(text)


async def admin_mood_history(update: Update, context):
    """ะัะพัะผะพัั ะธััะพัะธะธ ััะตะบะตัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั (ะดะปั ะฐะดะผะธะฝะพะฒ)"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /admin_mood_history [ID ะฟะพะปัะทะพะฒะฐัะตะปั]\n"
            f"{COLORS['blue']} ะัะธะผะตั: /admin_mood_history 123456789"
        )
        return
    
    try:
        user_id = int(context.args[0])
    except ValueError:
        await update.message.reply_text(f"{COLORS['purple']} โ ID ะดะพะปะถะตะฝ ะฑััั ัะธัะปะพะผ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT mood, anxiety, energy, sleep, notes, created_at 
                 FROM mood_tracker 
                 WHERE user_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 20""", (user_id,))
    entries = c.fetchall()
    
    # ะะพะปััะฐะตะผ ะธะผั ะฟะพะปัะทะพะฒะฐัะตะปั
    c.execute("SELECT user_name FROM active_chats WHERE user_id = ?", (user_id,))
    user = c.fetchone()
    conn.close()
    
    if not entries:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะตั ะทะฐะฟะธัะตะน ััะตะบะตัะฐ"
        )
        return
    
    user_name = user[0] if user else f"ID: {user_id}"
    
    mood_emoji = {5: '๐', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ', 0: '๐จ'}
    anxiety_emoji = {1: '๐', 2: '๐', 3: '๐ฐ', 4: '๐ฑ', 5: '๐'}
    energy_emoji = {5: 'โก', 4: '๐', 3: '๐ชซ', 2: '๐ด', 1: '๐'}
    sleep_emoji = {5: '๐ดโจ', 4: '๐', 3: '๐', 2: '๐', 1: '๐ซ'}
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะขะะะะะะ ะะะะฌะะะะะขะะะฏ\n{COLORS['blue']} {user_name}\n\n"
    
    for mood, anxiety, energy, sleep, notes, created_at in entries[:10]:
        text += f"{COLORS['night']} {created_at[:16]}\n"
        text += f"{COLORS['violet']} {mood_emoji.get(mood, '๐')} {mood} | "
        text += f"{anxiety_emoji.get(anxiety, '๐')} {anxiety} | "
        text += f"{energy_emoji.get(energy, '๐')} {energy} | "
        text += f"{sleep_emoji.get(sleep, '๐ด')} {sleep}\n"
        if notes:
            text += f"{COLORS['blue']} ๐ {notes}\n"
        text += "\n"
    
    if len(entries) > 10:
        text += f"{COLORS['violet']} ... ะธ ะตัะต {len(entries) - 10} ะทะฐะฟะธัะตะน"
    
    await update.message.reply_text(text)


async def is_group_member(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    try:
        member = await context.bot.get_chat_member(ADMIN_GROUP_ID, user_id)
        return member.status not in ['left', 'kicked']
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะฟัะพะฒะตัะบะต ััะฐััะฝะธะบะฐ ะณััะฟะฟั: {e}")
        return False


async def track_user(user, context):
    """ะััะปะตะถะธะฒะฐะฝะธะต ะฐะบัะธะฒะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT * FROM users WHERE user_id = ?", (user.id,))
    existing = c.fetchone()

    if not existing:
        c.execute("""INSERT INTO users 
                     (user_id, username, first_name, last_name, first_seen, last_activity, is_active)
                     VALUES (?, ?, ?, ?, ?, ?, ?)""",
                  (user.id, user.username, user.first_name, user.last_name,
                   get_current_time(), get_current_time(), 1))
    else:
        c.execute("UPDATE users SET last_activity = ?, is_active = 1 WHERE user_id = ?",
                  (get_current_time(), user.id))

    conn.commit()
    conn.close()


def generate_invite_link():
    """ะะตะฝะตัะธััะตั ัะฝะธะบะฐะปัะฝัั ัััะพะบั ะดะปั ัััะปะบะธ"""
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(32))


async def create_invite_link(context, user_id):
    """ะกะพะทะดะฐะตั ะพะดะฝะพัะฐะทะพะฒัั ัััะปะบั-ะฟัะธะณะปะฐัะตะฝะธะต"""
    try:
        expire_date = datetime.now() + timedelta(days=7)
        invite_link = await context.bot.create_chat_invite_link(
            chat_id=ADMIN_GROUP_ID,
            expire_date=expire_date,
            member_limit=1
        )

        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        c.execute("""INSERT INTO invite_links 
                     (user_id, chat_id, link, created_at, expires_at, is_used)
                     VALUES (?, ?, ?, ?, ?, ?)""",
                  (user_id, str(ADMIN_GROUP_ID), invite_link.invite_link,
                   get_current_time(), expire_date.strftime('%Y-%m-%d %H:%M:%S'), 0))
        conn.commit()
        conn.close()

        return invite_link.invite_link
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัััะปะบะธ: {e}")
        return None


async def create_new_invite_link(context, old_link):
    """ะกะพะทะดะฐะตั ะฝะพะฒัั ัััะปะบั ะฒะทะฐะผะตะฝ ะธัะฟะพะปัะทะพะฒะฐะฝะฝะพะน"""
    try:
        if "t.me/+" in old_link or "t.me/joinchat/" in old_link:
            await context.bot.revoke_chat_invite_link(
                chat_id=ADMIN_GROUP_ID,
                invite_link=old_link
            )

        return await create_invite_link(context, None)
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ัััะปะบะธ: {e}")
        return None


def mark_link_used(link, user_id):
    """ะัะผะตัะฐะตั ัััะปะบั ะบะฐะบ ะธัะฟะพะปัะทะพะฒะฐะฝะฝัั"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""UPDATE invite_links 
                 SET is_used = 1, used_by = ?, used_at = ? 
                 WHERE link = ?""",
              (user_id, get_current_time(), link))
    conn.commit()
    conn.close()


async def new_chat_members(update: Update, context):
    """ะััะปะตะถะธะฒะฐะฝะธะต ะฝะพะฒัั ััะฐััะฝะธะบะพะฒ"""
    for member in update.message.new_chat_members:
        if member.is_bot:
            continue

        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        c.execute("""SELECT link FROM invite_links 
                     WHERE user_id = ? AND is_used = 0 
                     ORDER BY created_at DESC LIMIT 1""", (member.id,))
        link_info = c.fetchone()

        if link_info:
            c.execute("""UPDATE invite_links SET is_used = 1, used_at = ? 
                         WHERE link = ?""", (get_current_time(), link_info[0]))
            conn.commit()

            await context.bot.send_message(
                chat_id=member.id,
                text=f"{COLORS['purple']} ๐ ะะะะะ ะะะะะะะะะขะฌ ะ ะะะะะะะฃ!\n\n"
                     f"{COLORS['blue']} ะั ััะฟะตัะฝะพ ะฒัััะฟะธะปะธ ะฒ ะณััะฟะฟั ะฐะดะผะธะฝะพะฒ.\n\n"
                     f"{COLORS['violet']} ะขะตะฟะตัั ะทะฐัะตะณะธัััะธััะนัะต ัะฒะพะน ัะตะณ:\n"
                     f"/settag ะฒะฐั_ัะตะณ"
            )
        conn.close()


async def register_tag(update: Update, context):
    user = update.effective_user
    await track_user(user, context)

    args = context.args
    if not args:
        await update.message.reply_text(
            f"{COLORS['fog']} ะะฐะบ ะทะฐัะตะณะธัััะธัะพะฒะฐัั ัะตะณ:\n\n"
            f"{COLORS['purple']} ะัะฟะพะปัะทัะนัะต: /settag [ะฒะฐั_ัะตะณ]\n"
            f"{COLORS['blue']} ะัะธะผะตั: /settag #ัะธะณัะธัะฐ\n\n"
            f"{COLORS['violet']} ะขะตะณ ะดะพะปะถะตะฝ ะฝะฐัะธะฝะฐัััั ั #"
        )
        return

    tag = args[0]
    if not tag.startswith('#'):
        tag = '#' + tag

    is_admin = await is_group_member(user.id, context)

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""INSERT OR REPLACE INTO user_tags 
                 (user_id, user_tag, user_name, username, registered_at, is_active, is_group_member)
                 VALUES (?, ?, ?, ?, ?, ?, ?)""",
              (user.id, tag, user.full_name, user.username, get_current_time(), 1, 1 if is_admin else 0))
    conn.commit()
    conn.close()

    if is_admin:
        await update.message.reply_text(
            f"{COLORS['moon']} ะขะะ ะฃะกะะะจะะ ะกะะฅะะะะะ! {COLORS['moon']}\n\n"
            f"{COLORS['purple']} ะะฐั ัะตะณ: {tag}\n"
            f"{COLORS['blue']} ะกัะฐััั: ะะดะผะธะฝะธัััะฐัะพั\n\n"
            f"{COLORS['violet']} {COLORS['cloud']} ะัะฟะพะปัะทัะนัะต ะผะตะฝั ะดะปั ัะฐะฑะพัั!",
            reply_markup=get_admin_keyboard()
        )
    else:
        await update.message.reply_text(
            f"{COLORS['moon']} ะขะะ ะฃะกะะะจะะ ะกะะฅะะะะะ! {COLORS['moon']}\n\n"
            f"{COLORS['purple']} ะะฐั ัะตะณ: {tag}\n"
            f"{COLORS['blue']} ะกัะฐััั: ะะพะปัะทะพะฒะฐัะตะปั\n\n"
            f"{COLORS['violet']} {COLORS['cloud']} ะัะฟะพะปัะทัะนัะต ะผะตะฝั!",
            reply_markup=get_user_keyboard()
        )


def get_user_tag(user_id):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT user_tag FROM user_tags WHERE user_id = ? AND is_active = 1", (user_id,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else None  # โ ะญะขะ ะะะะะะะฌะะ


def check_active_rest(admin_id):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT id, start_date, end_date, reason FROM rests 
                 WHERE admin_id = ? AND status = 'active'""", (admin_id,))
    rest = c.fetchone()
    conn.close()
    return rest


def create_fancy_button(text, callback_data, color='purple'):
    emoji_map = {
        'purple': '๐ฃ', 'blue': '๐ต', 'violet': '๐ช',
        'indigo': '๐', 'light_blue': '๐ฆ', 'night': '๐',
        'fog': '๐ซ๏ธ', 'moon': '๐', 'cloud': 'โ๏ธ'
    }
    emoji = emoji_map.get(color, '๐ซ๏ธ')
    return InlineKeyboardButton(f"{emoji} {text}", callback_data=callback_data)


def get_user_keyboard():
    keyboard = [
        [create_fancy_button("๐ ะะฐะฟะธัะฐัั ัะพะพะฑัะตะฝะธะต", "write", 'purple')],
        [create_fancy_button("๐ ะกัะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ", "become_admin", 'night')],
        [create_fancy_button("โญ ะััะฐะฒะธัั ะพัะทัะฒ", "leave_review", 'blue')],
        [create_fancy_button("๐ ะะพัะผะพััะตัั ะพัะทัะฒั", "view_reviews", 'light_blue')],
        [create_fancy_button("๐ข ะขะะ ะะฐะฝะฐะป", "tg_channel", 'moon')],
        [create_fancy_button("๐ ะัะฐะฒะธะปะฐ", "rules", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_admin_keyboard():
    keyboard = [
        [create_fancy_button("๐ ะะถะธะดะฐััะธะต ะทะฐัะฒะบะธ", "pending_chats", 'purple')],
        [create_fancy_button("๐ ะะฐัะฒะบะธ ะฒ ะฐะดะผะธะฝั", "applications_menu", 'night')],
        [create_fancy_button("โญ ะฃะฟัะฐะฒะปะตะฝะธะต ะพัะทัะฒะฐะผะธ", "reviews_menu", 'blue')],
        [create_fancy_button("๐ด ะฃะฟัะฐะฒะปะตะฝะธะต ัะตััะฐะผะธ", "rests_menu", 'light_blue')],
        [create_fancy_button("๐ ะกัะฐัะธััะธะบะฐ ะฑะพัะฐ", "stats_menu", 'fog')],
        [create_fancy_button("๐ ะกัะฐัะธััะธะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน", "user_stats_menu", 'purple')],  # โ ะญะขะ
        [create_fancy_button("๐ข ะะฐัััะปะบะฐ", "broadcast_menu", 'night')],
        [create_fancy_button("๐ซ ะะฐะฑะปะพะบะธัะพะฒะฐะฒัะธะต", "blocked_users_menu", 'violet')],        # โ ะญะขะ
        [create_fancy_button("๐ ะะฑะฝะพะฒะธัั ัััะปะบั", "refresh_invite", 'moon')],              # โ ะญะขะ
        [create_fancy_button("๐ข ะขะะ ะะฐะฝะฐะป", "tg_channel", 'moon')],
        [create_fancy_button("โ๏ธ ะกะผะตะฝะธัั ัะตะณ", "change_tag", 'moon')],
        [create_fancy_button("๐ ะะพะบะธะฝััั ะฑะพั", "leave_bot", 'night')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_active_chat_keyboard(user_id, thread_id):
    keyboard = [
        [create_fancy_button("โ ะัะบะฐะทะฐัััั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั", f"decline_user_{user_id}_{thread_id}", 'night')],
        [create_fancy_button("๐ ะกะผะตะฝะธัั ะฐะดะผะธะฝะฐ", f"change_admin_{user_id}_{thread_id}", 'moon')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_user_chat_keyboard(user_id, thread_id):
    keyboard = [
        [create_fancy_button("๐ ะกะผะตะฝะธัั ะฐะดะผะธะฝะฐ", f"user_change_admin_{user_id}_{thread_id}", 'moon')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_reviews_menu_keyboard():
    keyboard = [
        [create_fancy_button("๐ ะะพะฒัะต ะพัะทัะฒั", "reviews_new", 'purple')],
        [create_fancy_button("โ ะัะพัะผะพััะตะฝะฝัะต", "reviews_viewed", 'blue')],
        [create_fancy_button("๐ ะัะต ะพัะทัะฒั", "reviews_all", 'light_blue')],
        [create_fancy_button("๐ ะกัะฐัะธััะธะบะฐ ะพัะทัะฒะพะฒ", "reviews_stats", 'night')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_rests_main_menu_keyboard():
    keyboard = [
        [create_fancy_button("๐ค ะะพะน ัะตัั", "rest_my", 'moon')],
        [create_fancy_button("๐ ะะบัะธะฒะฝัะต ัะตััั", "rests_active", 'blue')],
        [create_fancy_button("๐ ะััะพัะธั ัะตััะพะฒ", "rests_history", 'light_blue')],
        [create_fancy_button("๐ ะกัะฐัะธััะธะบะฐ ัะตััะพะฒ", "rests_stats", 'night')],
        [create_fancy_button("๐ ะะทััั ัะตัั", "rest_take", 'fog')],
        [create_fancy_button("โ ะะพะผะพัั ะฟะพ ัะตััะฐะผ", "rests_help", 'purple')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_rest_actions_keyboard(rest_id, admin_id):
    keyboard = [
        [create_fancy_button("๐ ะะพััะพัะฝัะน ะฒััะพะด", f"rest_early_{rest_id}_{admin_id}", 'night'),
         create_fancy_button("โ ะัะพะดะปะธัั", f"rest_extend_{rest_id}_{admin_id}", 'moon')],
        [create_fancy_button("๐ ะะฝัะพัะผะฐัะธั", f"rest_info_{rest_id}", 'blue')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_rests_back_to_menu_keyboard():
    keyboard = [
        [create_fancy_button("โ๏ธ ะ ะผะตะฝั ัะตััะพะฒ", "rests_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_rating_keyboard():
    keyboard = [
        [InlineKeyboardButton("โญ", callback_data="rating_1"),
         InlineKeyboardButton("โญโญ", callback_data="rating_2"),
         InlineKeyboardButton("โญโญโญ", callback_data="rating_3")],
        [InlineKeyboardButton("โญโญโญโญ", callback_data="rating_4"),
         InlineKeyboardButton("โญโญโญโญโญ", callback_data="rating_5")],
        [create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_review_keyboard(review_id):
    keyboard = [
        [create_fancy_button("โ ะัะผะตัะธัั ะฟัะพัะผะพััะตะฝะฝัะผ", f"review_view_{review_id}", 'moon')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "reviews_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_stats_menu_keyboard():
    keyboard = [
        [create_fancy_button("๐ ะะฑัะฐั ััะฐัะธััะธะบะฐ", "stats_general", 'purple')],
        [create_fancy_button("๐ค ะะพั ััะฐัะธััะธะบะฐ", "stats_my", 'blue')],
        [create_fancy_button("๐ฅ ะะพ ะฐะดะผะธะฝะฐะผ", "stats_admins", 'light_blue')],
        [create_fancy_button("๐ ะะฐ ัะตะณะพะดะฝั", "stats_today", 'night')],
        [create_fancy_button("๐ ะะฐ ะฝะตะดะตะปั", "stats_week", 'moon')],
        [create_fancy_button("๐ ะะฐ ะผะตััั", "stats_month", 'fog')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_applications_menu_keyboard():
    keyboard = [
        [create_fancy_button("๐ข ะะถะธะดะฐััะธะต", "apps_pending", 'purple')],
        [create_fancy_button("โ ะัะธะฝัััะต", "apps_accepted", 'blue')],
        [create_fancy_button("โ ะัะบะปะพะฝะตะฝะฝัะต", "apps_rejected", 'light_blue')],
        [create_fancy_button("๐ ะัะต ะทะฐัะฒะบะธ", "apps_all", 'night')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_message_type_keyboard():
    keyboard = [
        [create_fancy_button("๐ฌ ะะฑัะตะฝะธะต", "msg_type_communication", 'purple')],
        [create_fancy_button("๐ ะะพะดะดะตัะถะบะฐ", "msg_type_support", 'blue')],
        [create_fancy_button("๐ค ะะฑัะตะฝะธะต ะธ ะฟะพะดะดะตัะถะบะฐ", "msg_type_both", 'night')],
        [create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_app_type_keyboard():
    keyboard = [
        [create_fancy_button("๐ฌ ะะฑัะตะฝะธะต", "app_type_communication", 'purple')],
        [create_fancy_button("๐ ะะพะดะดะตัะถะบะฐ", "app_type_support", 'blue')],
        [create_fancy_button("๐ค ะะฑัะตะฝะธะต ะธ ะฟะพะดะดะตัะถะบะฐ", "app_type_both", 'night')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "user_main_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_pending_chat_keyboard(user_id):
    keyboard = [
        [create_fancy_button("โ ะะทััั ะฒ ัะฐะฑะพัั", f"take_chat_{user_id}", 'moon')]
    ]
    return InlineKeyboardMarkup(keyboard)


def get_application_keyboard(app_id, user_id):
    keyboard = [
        [create_fancy_button("โ ะัะธะฝััั", f"accept_app_{app_id}_{user_id}", 'moon'),
         create_fancy_button("โ ะัะบะปะพะฝะธัั", f"reject_app_{app_id}_{user_id}", 'night')],
        [create_fancy_button("๐ ะะฝะบะตัะฐ", f"view_app_{app_id}", 'blue')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')]
    ]
    return InlineKeyboardMarkup(keyboard)


COMMUNICATION_QUESTIONS = [
    "1๏ธโฃ ะะผั, ะฟะพะป, ะดะฐัะฐ ัะพะถะดะตะฝะธั, ัะฐัะพะฒะพะน ะฟะพัั:",
    "2๏ธโฃ ะขะฒะพะน ะฟัะตะฒะดะพะฝะธะผ ะฒ ะฑะพัะต:",
    "3๏ธโฃ ะขะฒะพะน ัะทะตัะฝะตะนะผ:",
    "4๏ธโฃ ะกะบะพะปัะบะพ ะฒัะตะผะตะฝะธ ะณะพัะพะฒ ัะดะตะปััั ะฑะพัั?",
    "5๏ธโฃ ะะฐะบ ะฑัะดะตัั ัะฟัะฐะฒะปััััั ั ะบะพะฝัะปะธะบัะฐะผะธ?",
    "6๏ธโฃ ะงัะพ ะปะตะณัะต - ัะฐััะบะฐะทัะฒะฐัั ะพ ัะตะฑะต ะธะปะธ ัะทะฝะฐะฒะฐัั ะดััะณะพะณะพ?",
    "7๏ธโฃ ะงัะพ ะฒ ัะตะฑะต ัะฐะผะพะต ะถะธะฒะพะต ะธ ะฝะฐััะพััะตะต, ะบะพะณะดะฐ ัั ะพะฑัะฐะตัััั ั ะปัะดัะผะธ?",
    "8๏ธโฃ ะะฐะบะธะต ััะธ ัะตะผั ัะตะฑะต ะดะตะนััะฒะธัะตะปัะฝะพ ะฑะปะธะทะบะธ ะธ ะธะฝัะตัะตัะฝั?",
    "9๏ธโฃ ะงัะพ ะฒ ะพะฑัะตะฝะธะธ ั ะปัะดัะผะธ ะฝะฐะฟะพะปะฝัะตั ัะตะฑั, ะฐ ััะพ ะทะฐะฑะธัะฐะตั ัะธะปั?",
    "๐ ะะฐะบ ัั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตัั ัะธะปั, ะบะพะณะดะฐ ัััะฐะตัั ะพั ะพะฑัะตะฝะธั?",
    "1๏ธโฃ1๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะะพะปัะทะพะฒะฐัะตะปั ะฟะธัะตั: ะฟัะธะฒะตั, ะบะฐะบ ะฟัะพัะพะดะธั ัะฒะพะน ะดะตะฝั? โ ะธ ััะพ ะฒัะต. ะขะฒะพะธ ะฟะตัะฒัะต 2-3 ัะตะฟะปะธะบะธ, ััะพะฑั ัะฐะทะณะพะฒะพัะธัั ัะตะปะพะฒะตะบะฐ ะธ ะทะฐะดะฐัั ัะพะฝ ัะตะฟะปะพะน ะฑะตัะตะดะต",
    "1๏ธโฃ2๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะงะตะปะพะฒะตะบ ะดะตะปะธััั ั ัะพะฑะพะน ัะฐะดะพัััั - ะฟะพะดะฐัะธะปะธ ะฟะพะดะฐัะพะบ, ะธัะฟะตะบ ะฒะบััะฝัะน ัะพัั, ะบัะฟะธะป ะบัะฐัะธะฒัั ะพะดะตะถะดั. ะขะฒะพั ะฟะตัะฒะฐั ัะตะฐะบัะธั?",
    "1๏ธโฃ3๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะะฐะทะณะพะฒะพั ะทะฐัะพะดะธั ะฒ ััะฟะธะบ. ะะฐะบ ัั ะฟะพัััะฟะธัั ะฒ ัะฐะบะพะน ะผะพะผะตะฝั",
    "1๏ธโฃ4๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะกะพะฑะตัะตะดะฝะธะบ ัะฐััะบะฐะทัะฒะฐะตั ะพ ัะฒะพะตะผ ัะฒะปะตัะตะฝะธะธ ั ะพะณะฝะตะผ ะฒ ะณะปะฐะทะฐั. ะะพ ะฒ ะตะณะพ ะณะพะปะพัะต ัะปััะฝะพ, ััะพ ะพะฝ ะฑะพะธััั, ััะพ ะตะณะพ ะพััะดัั ะธะปะธ ะฝะต ะฟะพะนะผัั. ะะฐะบ ัั ะพััะตะฐะณะธััะตัั, ััะพะฑั ััะพั ะฝะต ะฟะพะณะฐั?",
    "1๏ธโฃ5๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะขั ะฒะธะดะธัั, ััะพ ัะตะปะพะฒะตะบ ััะตัะฝัะตััั ะธะปะธ ััะฒััะฒัะตั ัะตะฑั ะฝะต ะฒ ัะฒะพะตะน ัะฐัะตะปะบะต ะฒ ัะฐะทะณะพะฒะพัะต. ะะฐะบ ัั ะฟะพะผะพะถะตัั ะตะผั ัะฐัะบัะตะฟะพััะธัััั - ะฝะต ะฝะฐััะพะนัะธะฒะพ, ะฐ ะผัะณะบะพ?"
]

SUPPORT_QUESTIONS = [
    "1๏ธโฃ ะะผั, ะฟะพะป, ะดะฐัะฐ ัะพะถะดะตะฝะธั, ัะฐัะพะฒะพะน ะฟะพัั:",
    "2๏ธโฃ ะขะฒะพะน ะฟัะตะฒะดะพะฝะธะผ ะฒ ะฑะพัะต:",
    "3๏ธโฃ ะขะฒะพะน ัะทะตัะฝะตะนะผ:",
    "4๏ธโฃ ะะฐะบะฐั ัะฒะพั ะณะปะฐะฒะฝะฐั ะฒะฝัััะตะฝะฝัั ัะตะฝั (ัะปะฐะฑะพััั, ัััะฐั)? ะธ ะบะฐะบ ัั ั ะฝะตะน ะถะธะฒะตัั?",
    "5๏ธโฃ ะัะป ะปะธ ะพะฟัั ะฒ ะฟะพะดะดะตัะถะบะต? ะะพัะตะผั ัะพัะตัั ะบ ะฝะฐะผ?",
    "6๏ธโฃ ะงัะพ ะดะปั ัะตะฑั ะพะฟะฐัะฝะตะต ะฒ ะพะฑัะตะฝะธะธ: ัะพะปะพะดะฝะฐั ะฒะตะถะปะธะฒะพััั ะธะปะธ ะณะพัััะฐั ะธัะบัะตะฝะฝะพััั, ะณัะฐะฝะธัะฐัะฐั ั ะถะตััะพะบะพัััั, ะธ ะฟะพัะตะผั??",
    "7๏ธโฃ ะะฐะบ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตัั ัะธะปั ะฟะพัะปะต ะฟะพะดะดะตัะถะบะธ ะดััะณะธั?",
    "8๏ธโฃ ะกะบะพะปัะบะพ ะฒัะตะผะตะฝะธ ะณะพัะพะฒ ัะดะตะปััั ัะฐะฑะพัะต ะฒ ะฝะฐัะตะผ ะฑะพัะต?",
    "9๏ธโฃ ะะฐะบ ะฑัะดะตัั ัะฟัะฐะฒะปััััั ั ะบะพะฝัะปะธะบัะฐะผะธ?",
    "๐ ะงัะพ ะฒะฐะถะฝะตะต ะฒ ัะฐะทะณะพะฒะพัะต: ะฟะพะผะพัั ะธะปะธ ะฟะพะฝััั?",
    "1๏ธโฃ1๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะะพััะพัะฝะฝะพ ััะฒััะฒัั ัะตะฑั ะปะธัะฝะธะผ ะฒ ะบะพะผะฟะฐะฝะธัั. ะัะต ััััั, ัะฒะพะธ ัััะบะธ ะตััั ั ะฒัะตั, ะฐ ั ะบะฐะบ ะฑัะดัะพ ะฝะตะฒะตะดะธะผะบะฐ. ะญัะพ ัะพ ะผะฝะพะน ััะพ-ัะพ ะฝะต ัะฐะบ?'",
    "1๏ธโฃ2๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะะฝะต ะบะฐะถะตััั ั ัััะฐะปะฐ ะพั ะปัะดะตะน, ะผะฝะต ััะถะตะปะพ ะพะฑัะฐัััั. ะฃััะฐะปะฐ ะพั ะฒัะตะณะพ. ะฅะพัะตััั ัะธัะธะฝั, ะฝะพ ะฒะฝัััะธ ะฟัััะพัะฐ. ะงัะพ ะดะตะปะฐัั?'",
    "1๏ธโฃ3๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะฏ ะทะฐะบััะปะฐัั ะฒ ัะตะฑะต ะธ ะผะฝะต ัะปะพะถะฝะพ ะพัะบััะฒะฐัััั ะปัะดัะผ. ะะท-ะทะฐ ััะพะณะพ ะฒัะต ะผะพะธ ะดััะทัั ะฝะต ัะพััั ะดะฐะปััะต ะธะดัะธ ัะพ ะผะฝะพะน ะฟะพ ะถะธะทะฝะธ ะฟะพะด ะฟัะตะดะปะพะณะพะผ: ัั ะฝะพะตัั, ะฝะพ ะฝะต ะผะพะถะตัั ะพะฑัััะฝะธัั ัะฒะพะต ัะพััะพัะฝะธะต ะธ ะฟะพะดะตะปะธัััั ัะตะผ, ััะพ ัะตะฑั ััะตะฒะพะถะธั. ะะฐะบ ะผะฝะต ั ััะธะผ ัะฟัะฐะฒะธัััั?'",
    "1๏ธโฃ4๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะะฝะต ะบะฐะถะตััั, ั ะฝะตะดะพััะพะนะฝะฐ ะปัะฑะฒะธ, ะผะตะฝั ะฒัะต ะฑัะพัะฐัั, ััะพะดัั, ะธะณัะฐัั ั ััะฒััะฒะฐะผะธ. ะะฐะบ-ะฑัะดัะพ ะฑั ะผะฝะต ััะพะธั ะฒะพะพะฑัะต ะฑััั ะพะดะฝะพะน? ะะฝะต ะบะฐะถะตััั ั ะฝะต ัะผะพะณั ะฒัััะตัะธัั ัะฒะพะตะณะพ ัะตะปะพะฒะตะบะฐ'",
    "1๏ธโฃ5๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะ ะพะดะฝะพะน ััะบะต - ะฒะพะทะผะพะถะฝะพััั ััะฐัั ัะฒะตัะพะผ ะดะปั ะดััะณะธั, ะฒ ะดััะณะพะน - ัะธัะบ ัะณะพัะตัั, ะทะฐะฑัะฒ ัะฒะพะน ัะพะฑััะฒะตะฝะฝัะน ะพะณะพะฝั, ะะพัะตะผั ะฒัะฑะตัะตัั ััะพั ะฟััั?'"
]

BOTH_QUESTIONS = [
    "1๏ธโฃ ะะผั, ะฟะพะป, ะดะฐัะฐ ัะพะถะดะตะฝะธั, ัะฐัะพะฒะพะน ะฟะพัั:",
    "2๏ธโฃ ะขะฒะพะน ะฟัะตะฒะดะพะฝะธะผ ะฒ ะฑะพัะต:",
    "3๏ธโฃ ะขะฒะพะน ัะทะตัะฝะตะนะผ:",
    "4๏ธโฃ ะัะป ะปะธ ะพะฟัั ะฒ ะฟะพะดะดะตัะถะบะต? ะะพัะตะผั ัะพัะตัั ะบ ะฝะฐะผ?",
    "5๏ธโฃ ะ ัะตะผ ัะฒะพั ัะฐะผะฐั ัะตะปะพะฒะตัะฝะฐั, ะผะพะถะตั ะฑััั, ะดะฐะถะต ัะผะตัะฝะฐั ัะตััะฐ ะฒ ะพะฑัะตะฝะธะธ?:",
    "6๏ธโฃ ะะฐะบ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตัั ัะธะปั ะฟะพัะปะต ะฟะพะดะดะตัะถะบะธ ะดััะณะธั?",
    "7๏ธโฃ ะกะบะพะปัะบะพ ะฒัะตะผะตะฝะธ ะณะพัะพะฒ ัะดะตะปััั ัะฐะฑะพัะต ะฒ ะฑะพัะต?",
    "8๏ธโฃ ะะฐะบ ั ะบะพะฝัะปะธะบัะฐะผะธ ัะฟัะฐะฒะปัะตัััั?",
    "9๏ธโฃ ะะฐะบะธะต ััะธ ัะตะผั ัะตะฑะต ะดะตะนััะฒะธัะตะปัะฝะพ ะธะฝัะตัะตัะฝั?:",
    "๐ ะะฐะบะฐั ัะฒะพั ะณะปะฐะฒะฝะฐั ะฒะฝัััะตะฝะฝัั ัะตะฝั (ัะปะฐะฑะพััั, ัััะฐั)? ะธ ะบะฐะบ ัั ั ะฝะตะน ะถะธะฒะตัั?:",
    "1๏ธโฃ1๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะกะพะฑะตัะตะดะฝะธะบ ัะฐััะบะฐะทัะฒะฐะตั ะพ ัะฒะพะตะผ ัะฒะปะตัะตะฝะธะธ ั ะพะณะฝะตะผ ะฒ ะณะปะฐะทะฐั. ะะพ ะฒ ะตะณะพ ะณะพะปะพัะต ัะปััะฝะพ, ััะพ ะพะฝ ะฑะพะธััั, ััะพ ะตะณะพ ะพััะดัั ะธะปะธ ะฝะต ะฟะพะนะผัั. ะะฐะบ ัั ะพััะตะฐะณะธััะตัั, ััะพะฑั ััะพั ะฝะต ะฟะพะณะฐั?",
    "1๏ธโฃ2๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: ะะพะปัะทะพะฒะฐัะตะปั ะฟะธัะตั: ะฟัะธะฒะตั, ะบะฐะบ ะฟัะพัะพะดะธั ัะฒะพะน ะดะตะฝั? โ ะธ ััะพ ะฒัะต. ะขะฒะพะธ ะฟะตัะฒัะต 2-3 ัะตะฟะปะธะบะธ, ััะพะฑั ัะฐะทะณะพะฒะพัะธัั ัะตะปะพะฒะตะบะฐ ะธ ะทะฐะดะฐัั ัะพะฝ ัะตะฟะปะพะน ะฑะตัะตะดะต",
    "1๏ธโฃ3๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะฏ ะทะฐะบััะปะฐัั ะฒ ัะตะฑะต ะธ ะผะฝะต ัะปะพะถะฝะพ ะพัะบััะฒะฐัััั ะปัะดัะผ. ะะท-ะทะฐ ััะพะณะพ ะฒัะต ะผะพะธ ะดััะทัั ะฝะต ัะพััั ะดะฐะปััะต ะธะดัะธ ัะพ ะผะฝะพะน ะฟะพ ะถะธะทะฝะธ ะฟะพะด ะฟัะตะดะปะพะณะพะผ: ัั ะฝะพะตัั, ะฝะพ ะฝะต ะผะพะถะตัั ะพะฑัััะฝะธัั ัะฒะพะต ัะพััะพัะฝะธะต ะธ ะฟะพะดะตะปะธัััั ัะตะผ, ััะพ ัะตะฑั ััะตะฒะพะถะธั. ะะฐะบ ะผะฝะต ั ััะธะผ ัะฟัะฐะฒะธัััั?'",
    "1๏ธโฃ4๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะะฝะต ะบะฐะถะตััั, ั ะฝะตะดะพััะพะนะฝะฐ ะปัะฑะฒะธ, ะผะตะฝั ะฒัะต ะฑัะพัะฐัั, ััะพะดัั, ะธะณัะฐัั ั ััะฒััะฒะฐะผะธ. ะะฐะบ-ะฑัะดัะพ ะฑั ะผะฝะต ััะพะธั ะฒะพะพะฑัะต ะฑััั ะพะดะฝะพะน? ะะฝะต ะบะฐะถะตััั ั ะฝะต ัะผะพะณั ะฒัััะตัะธัั ัะฒะพะตะณะพ ัะตะปะพะฒะตะบะฐ'",
    "1๏ธโฃ5๏ธโฃ ะกะธััะฐัะธั, ะพัะฒะตัะฐะน ะฟะพะดัะพะฑะฝะพ: 'ะ ะพะดะฝะพะน ััะบะต - ะฒะพะทะผะพะถะฝะพััั ััะฐัั ัะฒะตัะพะผ ะดะปั ะดััะณะธั, ะฒ ะดััะณะพะน - ัะธัะบ ัะณะพัะตัั, ะทะฐะฑัะฒ ัะฒะพะน ัะพะฑััะฒะตะฝะฝัะน ะพะณะพะฝั, ะะพัะตะผั ะฒัะฑะตัะตัั ััะพั ะฟััั?'"
]


async def load_topics(application):
    """ะะฐะณััะถะฐะตั ัััะตััะฒัััะธะต ัะตะผั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั (ะะ ัะพะทะดะฐะตั ะฝะพะฒัะต)"""
    global PENDING_CHATS_THREAD_ID, ADMIN_APPS_THREAD_ID, REVIEWS_THREAD_ID, RESTS_THREAD_ID
    
    print("๐ ะะฐะณััะถะฐะตะผ ัััะตััะฒัััะธะต ัะตะผั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั...")
    
    try:
        await application.bot.initialize()
        
        # ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะฑะพัะฐ (ะดะปั ะพัะฟัะฐะฒะบะธ ัะพะพะฑัะตะฝะธะน)
        bot_member = await application.bot.get_chat_member(ADMIN_GROUP_ID, application.bot.id)
        if bot_member.status != 'administrator':
            logger.error("โ ะะพั ะฝะต ัะฒะปัะตััั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ ะณััะฟะฟั!")
            print("โ ะะพั ะฝะต ัะฒะปัะตััั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ ะณััะฟะฟั! ะกะดะตะปะฐะนัะต ะฑะพัะฐ ะฐะดะผะธะฝะธัััะฐัะพัะพะผ.")
            return
        
        # ะะพะดะบะปััะฐะตะผัั ะบ ะฑะฐะทะต
        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        
        # ะกะพะทะดะฐะตะผ ัะฐะฑะปะธัั ะตัะปะธ ะตั ะฝะตั (ะฝะฐ ัะปััะฐะน ัะธััะพะน ะฑะฐะทั)
        c.execute('''CREATE TABLE IF NOT EXISTS topic_ids
                     (topic_name TEXT PRIMARY KEY, thread_id INTEGER)''')
        
        # ะะฐะณััะถะฐะตะผ ะฒัะต ัะพััะฐะฝะตะฝะฝัะต ัะตะผั
        c.execute("SELECT topic_name, thread_id FROM topic_ids")
        saved_topics = dict(c.fetchall())
        
        if not saved_topics:
            print("โ ะ ะฑะฐะทะต ะฝะตั ัะพััะฐะฝะตะฝะฝัั ัะตะผ!")
            print("โ๏ธ ะฃะฒะตะดะพะผะปะตะฝะธั ะฑัะดัั ะพัะฟัะฐะฒะปััััั ะฒ ะพะฑัะธะน ัะฐั, ะฐ ะฝะต ะฒ ัะตะผั")
            conn.close()
            return
        
        # ะะฐะฟะฟะธะฝะณ ะฝะฐะทะฒะฐะฝะธะน ัะตะผ ะธะท ะะ ะฒ ะณะปะพะฑะฐะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต
        topic_mapping = {
            "pending_chats": ("โณ ะะถะธะดะฐััะธะต ะทะฐัะฒะบะธ", "PENDING_CHATS_THREAD_ID"),
            "admin_apps": ("๐ ะะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะพะฒ", "ADMIN_APPS_THREAD_ID"),
            "reviews": ("โญ ะัะทัะฒั", "REVIEWS_THREAD_ID"),
            "rests": ("๐ด ะะตััั ะฐะดะผะธะฝะพะฒ", "RESTS_THREAD_ID")
        }
        
        # ะัะพะฒะตััะตะผ ะบะฐะถะดัั ัะตะผั ะธะท ะผะฐะฟะฟะธะฝะณะฐ
        for topic_key, (topic_title, var_name) in topic_mapping.items():
            thread_id = saved_topics.get(topic_key)
            
            if thread_id:
                try:
                    # ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั ัะตะผั
                    test_msg = await application.bot.send_message(
                        chat_id=ADMIN_GROUP_ID,
                        message_thread_id=thread_id,
                        text=f"๐ ะะพั ะฟะตัะตะทะฐะฟััะตะฝ. ะัะพะฒะตัะบะฐ ัะฒัะทะธ ั ัะตะผะพะน {topic_title}..."
                    )
                    await test_msg.delete()
                    
                    # ะัะธัะฒะฐะธะฒะฐะตะผ ะณะปะพะฑะฐะปัะฝะพะน ะฟะตัะตะผะตะฝะฝะพะน
                    if topic_key == "pending_chats":
                        PENDING_CHATS_THREAD_ID = thread_id
                    elif topic_key == "admin_apps":
                        ADMIN_APPS_THREAD_ID = thread_id
                    elif topic_key == "reviews":
                        REVIEWS_THREAD_ID = thread_id
                    elif topic_key == "rests":
                        RESTS_THREAD_ID = thread_id
                    
                    print(f"โ ะขะตะผะฐ {topic_title} ะทะฐะณััะถะตะฝะฐ (ID: {thread_id})")
                    
                    # ะัะฟัะฐะฒะปัะตะผ ัะตััะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะพ ะณะพัะพะฒะฝะพััะธ
                    await application.bot.send_message(
                        chat_id=ADMIN_GROUP_ID,
                        message_thread_id=thread_id,
                        text=f"{COLORS['purple']} ๐ค ะะพั ะฟะตัะตะทะฐะฟััะตะฝ ะธ ะณะพัะพะฒ ะบ ัะฐะฑะพัะต ะฒ ััะพะน ัะตะผะต!"
                    )
                    
                except Exception as e:
                    print(f"โ ะขะตะผะฐ {topic_title} (ID: {thread_id}) ะฝะตะดะพัััะฟะฝะฐ: {e}")
                    print(f"โ๏ธ ะฃะฒะตะดะพะผะปะตะฝะธั ะดะปั {topic_title} ะฑัะดัั ะฟัะธัะพะดะธัั ะฒ ะพะฑัะธะน ัะฐั")
            else:
                print(f"โ๏ธ ะขะตะผะฐ {topic_title} ะฝะต ะฝะฐะนะดะตะฝะฐ ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั")
        
        conn.close()
        
        # ะัะฒะพะดะธะผ ะธัะพะณะพะฒัั ะธะฝัะพัะผะฐัะธั
        print("\n" + "=" * 70)
        print("๐ ะะะะะฃะะะะะซะ ะขะะะซ (ะะะะซะ ะะ ะกะะะะะฎะขะกะฏ):")
        print("=" * 70)
        print(f"โณ ะะถะธะดะฐััะธะต ะทะฐัะฒะบะธ: {PENDING_CHATS_THREAD_ID or 'โ ะะต ะทะฐะณััะถะตะฝะฐ (ะฑัะดะตั ะพะฑัะธะน ัะฐั)'}")
        print(f"๐ ะะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะพะฒ: {ADMIN_APPS_THREAD_ID or 'โ ะะต ะทะฐะณััะถะตะฝะฐ (ะฑัะดะตั ะพะฑัะธะน ัะฐั)'}")
        print(f"โญ ะัะทัะฒั: {REVIEWS_THREAD_ID or 'โ ะะต ะทะฐะณััะถะตะฝะฐ (ะฑัะดะตั ะพะฑัะธะน ัะฐั)'}")
        print(f"๐ด ะะตััั ะฐะดะผะธะฝะพะฒ: {RESTS_THREAD_ID or 'โ ะะต ะทะฐะณััะถะตะฝะฐ (ะฑัะดะตั ะพะฑัะธะน ัะฐั)'}")
        print("=" * 70)
        
        if all([PENDING_CHATS_THREAD_ID, ADMIN_APPS_THREAD_ID, REVIEWS_THREAD_ID, RESTS_THREAD_ID]):
            print("๐ ะะกะ ะขะะะซ ะฃะกะะะจะะ ะะะะะฃะะะะซ!")
        else:
            print("โ๏ธ ะะตะบะพัะพััะต ัะตะผั ะฝะต ะทะฐะณััะถะตะฝั, ัะฒะตะดะพะผะปะตะฝะธั ะฑัะดัั ะฒ ะพะฑัะตะผ ัะฐัะต")
        print("=" * 70)
        
    except Exception as e:
        logger.error(f"โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะณััะทะบะต ัะตะผ: {e}")
        print(f"\nโ ะะจะะะะ: {e}")
        print("โ๏ธ ะะพั ะฟัะพะดะพะปะถะธั ัะฐะฑะพัั, ะฝะพ ัะฒะตะดะพะผะปะตะฝะธั ะฑัะดัั ะฒ ะพะฑัะตะผ ัะฐัะต")


async def start(update: Update, context):
    user = update.effective_user
    await track_user(user, context)

    user_tag = get_user_tag(user.id)
    is_group_admin_flag = await is_group_member(user.id, context)

    text = f"{COLORS['moon']} ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั, ะฟััะฝะธะบ {user.first_name}! {COLORS['moon']}\n\n"
    text += f"{COLORS['purple']} ะฏ - ัะฒะพะน ะฟัะพะฒะพะดะฝะธะบ ะฒ ััะผะฐะฝะต ๐ซ๏ธ\n\n"
    text += f"{COLORS['sparkles']} ะงัะพะฑั ัะฟัะพััะธัั ะถะธะทะฝั ะธ ะฝะต ะฒะพะทะฒัะฐัะฐัััั ะฒ ะผะตะฝั, ะฟะพัะผะพััะธ ะฒัะต ะดะพัััะฟะฝัะต ะบะพะผะฐะฝะดั - /help ๐ซ๏ธ\n\n"

    if user_tag:
        text += f"{COLORS['blue']} ะะฐั ัะตะณ: {user_tag}\n\n"

    if user_tag and is_group_admin_flag:
        text += f"{COLORS['blue']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต ะฒ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ:"
        reply_markup = get_admin_keyboard()
    else:
        text += f"{COLORS['blue']} ะะพัััะฟะฝัะต ะดะตะนััะฒะธั:"
        reply_markup = get_user_keyboard()

    await update.message.reply_text(text, reply_markup=reply_markup)


async def broadcast(update: Update, context):
    """ะะพะผะฐะฝะดะฐ ะดะปั ัะฐัััะปะบะธ ัะพะพะฑัะตะฝะธะน ะฒัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ"""
    admin_id = update.effective_user.id

    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฟัะฐะฒ ะดะปั ัะฐัััะปะบะธ")
        return

    broadcast_text = ' '.join(context.args)
    if not broadcast_text:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /broadcast [ัะตะบัั]\n"
            f"ะัะธะผะตั: /broadcast ะัะตะผ ะฟัะธะฒะตั! ๐"
        )
        return

    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โ ะัะฟัะฐะฒะธัั ะฒัะตะผ", "confirm_broadcast", 'moon'),
         create_fancy_button("โ ะัะผะตะฝะฐ", "admin_main_menu", 'night')]
    ])

    context.user_data['broadcast_text'] = broadcast_text

    await update.message.reply_text(
        f"{COLORS['purple']} ๐ข ะะะะะะะะกะะะขะ ะะะกะกะซะะะ\n\n"
        f"{COLORS['blue']} ะขะตะบัั:\n{broadcast_text}\n\n"
        f"{COLORS['violet']} ะะพะดัะฒะตัะดะธัะต ะพัะฟัะฐะฒะบั ะฒัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ:",
        reply_markup=keyboard
    )


async def confirm_broadcast(query, context):
    """ะะพะดัะฒะตัะถะดะตะฝะธะต ะธ ะพัะฟัะฐะฒะบะฐ ัะฐัััะปะบะธ"""
    admin_id = query.from_user.id

    if admin_id not in MAIN_ADMIN_IDS:
        await query.answer("ะะตั ะฟัะฐะฒ!")
        return

    broadcast_text = context.user_data.get('broadcast_text', '')
    if not broadcast_text:
        await query.edit_message_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ: ัะตะบัั ะฝะต ะฝะฐะนะดะตะฝ")
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT user_id FROM users WHERE is_active = 1 AND is_bot_blocked = 0")
    users = c.fetchall()
    conn.close()

    if not users:
        await query.edit_message_text(f"{COLORS['purple']} ๐ข ะะตั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะดะปั ัะฐัััะปะบะธ")
        return

    await query.edit_message_text(
        f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ ะะะงะะขะ\n\n"
        f"{COLORS['blue']} ะัะตะณะพ ะฟะพะปััะฐัะตะปะตะน: {len(users)}\n"
        f"{COLORS['violet']} ะัะฟัะฐะฒะบะฐ... 0/{len(users)}"
    )

    sent = 0
    failed = 0
    blocked = 0

    for i, (user_id,) in enumerate(users, 1):
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ\n\n{broadcast_text}"
            )
            sent += 1
        except Exception as e:
            if "Forbidden: bot was blocked by the user" in str(e):
                conn = sqlite3.connect('support_bot.db')
                c = conn.cursor()
                c.execute("UPDATE users SET is_bot_blocked = 1, is_active = 0 WHERE user_id = ?", (user_id,))
                conn.commit()
                conn.close()
                blocked += 1
            else:
                failed += 1
                logger.error(f"ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั {user_id}: {e}")

        if i % 10 == 0:
            await query.edit_message_text(
                f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ ะะะงะะขะ\n\n"
                f"{COLORS['blue']} ะัะตะณะพ ะฟะพะปััะฐัะตะปะตะน: {len(users)}\n"
                f"{COLORS['violet']} ะัะฟัะฐะฒะบะฐ... {i}/{len(users)}"
            )

    await query.edit_message_text(
        f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ ะะะะะะจะะะ\n\n"
        f"{COLORS['blue']} โ ะฃัะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝะพ: {sent}\n"
        f"{COLORS['violet']} โ ะัะธะฑะพะบ: {failed}\n"
        f"{COLORS['night']} ๐ซ ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {blocked}\n"
        f"{COLORS['purple']} ๐ ะัะตะณะพ ะฒ ัะฟะธัะบะต: {len(users)}",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
        ]])
    )

    context.user_data.pop('broadcast_text', None)


async def user_stats(query: CallbackQuery, context):
    """ะกัะฐัะธััะธะบะฐ ะฟะพ ะฟะพะปัะทะพะฒะฐัะตะปัะผ"""
    admin_id = query.from_user.id

    if admin_id not in MAIN_ADMIN_IDS:
        await query.edit_message_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM users")
    total_users = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM users WHERE is_active = 1")
    active_users = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    blocked_users_count = c.fetchone()[0] or 0

    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (yesterday,))
    active_24h = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL")
    user_messages = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL")
    admin_messages = c.fetchone()[0] or 0

    c.execute("""SELECT u.user_id, u.username, u.first_name, COUNT(m.id) as msg_count
                 FROM users u
                 LEFT JOIN messages m ON u.user_id = m.user_id
                 GROUP BY u.user_id
                 ORDER BY msg_count DESC
                 LIMIT 10""")
    top_users = c.fetchall()

    conn.close()

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะะฌะะะะะขะะะะ\n\n"
    text += f"{COLORS['blue']} ๐ฅ ะัะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {total_users}\n"
    text += f"{COLORS['violet']} โ ะะบัะธะฒะฝัั: {active_users}\n"
    text += f"{COLORS['night']} ๐ซ ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {blocked_users_count}\n"
    text += f"{COLORS['purple']} โฑ ะะบัะธะฒะฝั ะทะฐ 24ั: {active_24h}\n\n"
    text += f"{COLORS['blue']} ๐จ ะกะพะพะฑัะตะฝะธะน ะพั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {user_messages}\n"
    text += f"{COLORS['violet']} ๐ฌ ะัะฒะตัะพะฒ ะพั ะฐะดะผะธะฝะพะฒ: {admin_messages}\n\n"

    if top_users:
        text += f"{COLORS['purple']} ๐ ะขะะ-10 ะะ ะะะขะะะะะกะขะ:\n"
        for i, (user_id, username, first_name, msg_count) in enumerate(top_users, 1):
            name = first_name or f"ID:{user_id}"
            username_str = f" @{username}" if username else ""
            text += f"{COLORS['blue']} {i}. {name}{username_str} - {msg_count} ัะพะพะฑั.\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
        ]])
    )


async def blocked_users(query: CallbackQuery, context):
    """ะกะฟะธัะพะบ ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ"""
    admin_id = query.from_user.id

    if admin_id not in MAIN_ADMIN_IDS:
        await query.edit_message_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT user_id, username, first_name, last_activity 
                 FROM users 
                 WHERE is_bot_blocked = 1 
                 ORDER BY last_activity DESC 
                 LIMIT 50""")
    blocked = c.fetchall()
    conn.close()

    if not blocked:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} ๐ซ ะะะะะะะะะะะะะจะะ ะะะขะ (ะฟะพัะปะตะดะฝะธะต 50)\n\n"
    for user_id, username, first_name, last_activity in blocked:
        name = first_name or "ะะตะท ะธะผะตะฝะธ"
        username_str = f" @{username}" if username else ""
        text += f"{COLORS['blue']} โข {name}{username_str}\n"
        text += f"{COLORS['violet']}   ID: {user_id}\n"
        text += f"{COLORS['night']}   ะะพัะปะตะดะฝัั ะฐะบัะธะฒะฝะพััั: {last_activity[:16]}\n\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
        ]])
    )


async def refresh_invite_link(query: CallbackQuery, context):
    """ะะฑะฝะพะฒะธัั ัััะปะบั-ะฟัะธะณะปะฐัะตะฝะธะต"""
    admin_id = query.from_user.id

    if admin_id not in MAIN_ADMIN_IDS:
        await query.edit_message_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT link FROM invite_links 
                 WHERE is_used = 0 
                 ORDER BY created_at DESC LIMIT 1""")
    last_link = c.fetchone()
    conn.close()

    if last_link:
        old_link = last_link[0]
        new_link = await create_new_invite_link(context, old_link)
        if new_link:
            await query.edit_message_text(
                f"{COLORS['purple']} ๐ ะกะกะซะะะ ะะะะะะะะะ\n\n"
                f"{COLORS['blue']} ะกัะฐัะฐั ัััะปะบะฐ ะพัะพะทะฒะฐะฝะฐ\n"
                f"{COLORS['violet']} ะะพะฒะฐั ัััะปะบะฐ:\n{new_link}",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
                ]])
            )
        else:
            await query.edit_message_text(
                f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฝะพะฒะพะน ัััะปะบะธ",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
                ]])
            )
    else:
        new_link = await create_invite_link(context, None)
        if new_link:
            await query.edit_message_text(
                f"{COLORS['purple']} ๐ ะะะะะฏ ะกะกะซะะะ ะกะะะะะะ\n\n"
                f"{COLORS['blue']} ะกััะปะบะฐ:\n{new_link}",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
                ]])
            )
        else:
            await query.edit_message_text(
                f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัััะปะบะธ",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
                ]])
            )


async def decline_user(query, context, target_user_id, thread_id):
    admin_id = query.from_user.id
    admin_tag = get_user_tag(admin_id)

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("""UPDATE active_chats 
                 SET status = 'pending', taken_by_id = NULL, taken_by_tag = NULL, taken_at = NULL 
                 WHERE user_id = ?""", (target_user_id,))
    conn.commit()
    conn.close()

    try:
        await context.bot.edit_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            name=f"โณ ะะถะธะดะฐะฝะธะต"
        )
    except:
        pass

    await context.bot.send_message(
        chat_id=ADMIN_GROUP_ID,
        message_thread_id=PENDING_CHATS_THREAD_ID,
        text=f"{COLORS['purple']} ๐ ะะฐัะฒะบะฐ ัะฝะพะฒะฐ ะดะพัััะฟะฝะฐ\n\n{COLORS['blue']} ะะดะผะธะฝ {admin_tag} ะพัะบะฐะทะฐะปัั ะพั ัะฐัะฐ",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ ะะทััั ะฒ ัะฐะฑะพัั", f"take_chat_{target_user_id}", 'moon')
        ]])
    )

    await context.bot.send_message(
        chat_id=target_user_id,
        text=f"{COLORS['purple']} ๐ ะะดะผะธะฝ ะพัะบะฐะทะฐะปัั ะพั ัะฐัะฐ\n\n{COLORS['blue']} ะะถะธะดะฐะนัะต ะฝะพะฒะพะณะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐ"
    )

    await query.edit_message_text(f"{COLORS['purple']} โ ะั ะพัะบะฐะทะฐะปะธัั ะพั ัะฐัะฐ")


async def change_admin(query, context, user_id, thread_id):
    admin_id = query.from_user.id
    admin_tag = get_user_tag(admin_id)

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT message_type, taken_by_tag FROM active_chats WHERE user_id = ?", (user_id,))
    result = c.fetchone()
    conn.close()

    if not result:
        await query.edit_message_text(f"โ ะงะฐั ะฝะต ะฝะฐะนะดะตะฝ")
        return

    msg_type, old_admin_tag = result

    await context.bot.send_message(
        chat_id=ADMIN_GROUP_ID,
        message_thread_id=PENDING_CHATS_THREAD_ID,
        text=f"{COLORS['purple']} ๐ ะะะฏะะะ ะะ ะกะะะะฃ ะะะะะะ\n\n{COLORS['blue']} ะขะธะฟ: {msg_type}\n{COLORS['violet']} ะขะตะบััะธะน ะฐะดะผะธะฝ: {old_admin_tag}\n{COLORS['night']} ะะฐะฟัะพัะธะป ัะผะตะฝั: {admin_tag}\n\n{COLORS['fog']} ะงะฐั ััะตะฑัะตั ะฝะพะฒะพะณะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐ",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ ะะทััั ัะฐั", f"take_chat_{user_id}", 'moon')
        ]])
    )

    try:
        await context.bot.edit_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            name=f"๐ ะกะผะตะฝะฐ ะฐะดะผะธะฝะฐ - {old_admin_tag}"
        )
    except:
        pass

    await query.edit_message_text(
        f"{COLORS['purple']} โ ะะฐัะฒะบะฐ ะฝะฐ ัะผะตะฝั ะฐะดะผะธะฝะฐ ัะพะทะดะฐะฝะฐ!\n\n{COLORS['blue']} ะะพะถะดะธัะตัั ะฝะพะฒะพะณะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐ")


async def user_change_admin(query, context, user_id, thread_id):
    user_tag = get_user_tag(user_id) or "ะะพะปัะทะพะฒะฐัะตะปั"

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT message_type, taken_by_tag FROM active_chats WHERE user_id = ? AND status = 'active'", (user_id,))
    result = c.fetchone()
    conn.close()

    if not result:
        await context.bot.send_message(
            chat_id=user_id,
            text=f"{COLORS['purple']} โ ะะบัะธะฒะฝัะน ัะฐั ะฝะต ะฝะฐะนะดะตะฝ"
        )
        return

    msg_type, old_admin_tag = result

    try:
        await context.bot.edit_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            name=f"๐ ะกะผะตะฝะฐ ะฐะดะผะธะฝะฐ - {old_admin_tag}"
        )
    except:
        pass

    await context.bot.send_message(
        chat_id=ADMIN_GROUP_ID,
        message_thread_id=PENDING_CHATS_THREAD_ID,
        text=f"{COLORS['purple']} ๐ ะะะฏะะะ ะะ ะกะะะะฃ ะะะะะะ (ะะข ะะะะฌะะะะะขะะะฏ)\n\n{COLORS['blue']} ะขะธะฟ: {msg_type}\n{COLORS['violet']} ะัะตะดัะดััะธะน ะฐะดะผะธะฝ: {old_admin_tag}\n{COLORS['night']} ะะพะปัะทะพะฒะฐัะตะปั: {user_tag}\n\n{COLORS['fog']} ะงะฐั ััะตะฑัะตั ะฝะพะฒะพะณะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐ",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ ะะทััั ัะฐั", f"take_chat_{user_id}", 'moon')
        ]])
    )

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""UPDATE active_chats 
                 SET status = 'pending', taken_by_id = NULL, taken_by_tag = NULL, taken_at = NULL 
                 WHERE user_id = ?""", (user_id,))
    conn.commit()
    conn.close()

    await context.bot.send_message(
        chat_id=user_id,
        text=f"{COLORS['purple']} โ ะะฐะฟัะพั ะฝะฐ ัะผะตะฝั ะฐะดะผะธะฝะฐ ะพัะฟัะฐะฒะปะตะฝ!\n\n{COLORS['blue']} ะะพะฒัะน ะฐะดะผะธะฝะธัััะฐัะพั ัะบะพัะพ ั ะฒะฐะผะธ ัะฒัะถะตััั. {COLORS['cloud']}"
    )

    await query.answer("ะะฐะฟัะพั ะฝะฐ ัะผะตะฝั ะฐะดะผะธะฝะฐ ะพัะฟัะฐะฒะปะตะฝ!")


async def view_review(query: CallbackQuery, context, review_id, admin_id):
    """ะัะผะตัะธัั ะพัะทัะฒ ะบะฐะบ ะฟัะพัะผะพััะตะฝะฝัะน"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะธะฝัะพัะผะฐัะธั ะพะฑ ะพัะทัะฒะต
    c.execute("SELECT user_name, rating, review_text FROM reviews WHERE id = ?", (review_id,))
    review_info = c.fetchone()
    
    if not review_info:
        await query.answer("ะัะทัะฒ ะฝะต ะฝะฐะนะดะตะฝ!")
        conn.close()
        return
    
    user_name, rating, review_text = review_info
    
    # ะะฑะฝะพะฒะปัะตะผ ััะฐััั
    c.execute("""UPDATE reviews 
                 SET status = 'viewed', reviewed_by = ?, reviewed_at = ? 
                 WHERE id = ?""",
              (admin_id, get_current_time(), review_id))
    conn.commit()
    conn.close()

    # ะัะฟัะฐะฒะปัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฒ ัะฐั ะฐะดะผะธะฝะพะฒ
    try:
        admin_tag = get_user_tag(admin_id) or f"ID{admin_id}"
        await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            text=f"{COLORS['purple']} โ ะัะทัะฒ #{review_id} ะพั {user_name} (ัะตะนัะธะฝะณ: {rating}โญ) ะพัะผะตัะตะฝ ะบะฐะบ ะฟัะพัะผะพััะตะฝะฝัะน\n{COLORS['blue']} ะะดะผะธะฝ: {admin_tag}"
        )
    except:
        pass

    await query.edit_message_reply_markup(reply_markup=None)
    await query.answer("โ ะัะทัะฒ ะพัะผะตัะตะฝ ะบะฐะบ ะฟัะพัะผะพััะตะฝะฝัะน!")


async def show_reviews_by_status(query: CallbackQuery, context, status, title):
    """ะะพะบะฐะทะฐัั ะพัะทัะฒั ะฟะพ ััะฐัััั ะดะปั ะฐะดะผะธะฝะพะฒ"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    if status == "all":
        c.execute("""SELECT id, user_name, rating, review_text, created_at, status 
                     FROM reviews ORDER BY created_at DESC LIMIT 20""")
    else:
        c.execute("""SELECT id, user_name, rating, review_text, created_at, status 
                     FROM reviews WHERE status = ? ORDER BY created_at DESC LIMIT 20""", (status,))

    reviews = c.fetchall()
    conn.close()

    if not reviews:
        await query.edit_message_text(
            f"{COLORS['purple']} {title}:\n\n{COLORS['blue']} ะะตั ะพัะทัะฒะพะฒ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "reviews_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} {title}:\n\n"
    keyboard = []

    for review in reviews:
        review_id, user_name, rating, review_text, created_at, status = review
        stars = "โญ" * rating
        status_emoji = "๐" if status == "new" else "โ"
        created_str = created_at[:16] if created_at else "ะฝะตะธะทะฒะตััะฝะพ"
        
        text += f"{COLORS['blue']} {status_emoji} ะั {user_name}\n"
        text += f"{COLORS['violet']} {stars} ({rating}/5)\n"
        text += f"{COLORS['night']} ๐ {review_text[:100]}{'...' if len(review_text) > 100 else ''}\n"
        text += f"{COLORS['purple']} ๐ {created_str}\n\n"

        if status == "new":
            keyboard.append([create_fancy_button(f"โ ะัะผะตัะธัั #{review_id}", f"review_view_{review_id}", 'moon')])

    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "reviews_menu", 'fog')])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

async def show_reviews_stats(query: CallbackQuery, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะพัะทัะฒะพะฒ"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM reviews")
    total = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'new'")
    new = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'viewed'")
    viewed = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(rating) FROM reviews")
    avg_rating = c.fetchone()[0] or 0
    
    c.execute("SELECT rating, COUNT(*) FROM reviews GROUP BY rating ORDER BY rating")
    rating_dist = c.fetchall()

    conn.close()

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะขะะซะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะพัะทัะฒะพะฒ: {total}\n"
    text += f"{COLORS['violet']} ๐ ะะพะฒัั: {new}\n"
    text += f"{COLORS['night']} โ ะัะพัะผะพััะตะฝะฝัั: {viewed}\n"
    text += f"{COLORS['purple']} ะกัะตะดะฝะธะน ัะตะนัะธะฝะณ: {avg_rating:.1f}/5\n\n"
    text += f"{COLORS['blue']} ะะฐัะฟัะตะดะตะปะตะฝะธะต:\n"

    for rating, count in rating_dist:
        stars = "โญ" * rating
        text += f"{COLORS['violet']} {stars}: {count}\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "reviews_menu", 'fog')
        ]])
    )


async def show_reviews_for_user(query: CallbackQuery, context):
    """ะะพะบะฐะทะฐัั ะพัะทัะฒั ะดะปั ะพะฑััะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT rating, review_text, created_at, user_name 
                 FROM reviews 
                 WHERE status = 'viewed'
                 ORDER BY created_at DESC 
                 LIMIT 20""")
    reviews = c.fetchall()
    conn.close()

    if not reviews:
        await query.edit_message_text(
            f"{COLORS['purple']} ๐ ะะตั ะพะฟัะฑะปะธะบะพะฒะฐะฝะฝัั ะพัะทัะฒะพะฒ\n\n{COLORS['blue']} ะัะดััะต ะฟะตัะฒัะผ, ะบัะพ ะพััะฐะฒะธั ะพัะทัะฒ! โญ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โญ ะััะฐะฒะธัั ะพัะทัะฒ", "leave_review", 'moon'),
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "user_main_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} โญ ะะขะะซะะซ ะะะะฌะะะะะขะะะะ โญ\n\n"
    for rating, review, created, name in reviews:
        stars = "โญ" * rating
        created_str = created[:16] if created else "ะฝะตะธะทะฒะตััะฝะพ"
        text += f"{COLORS['blue']} {stars} ะพั {name}\n"
        text += f"{COLORS['violet']} ๐ {review[:100]}{'...' if len(review) > 100 else ''}\n"
        text += f"{COLORS['night']} ๐ {created_str}\n\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โญ ะััะฐะฒะธัั ะพัะทัะฒ", "leave_review", 'moon'),
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "user_main_menu", 'fog')
        ]])
    )


async def button_handler(update: Update, context):
    query = update.callback_query
    await query.answer()

    data = query.data
    user_id = query.from_user.id
    user_tag = get_user_tag(user_id)
    is_admin = await is_group_member(user_id, context)

    if data == "user_main_menu":
        text = f"{COLORS['moon']} ะะะะะะะ ะะะะฎ {COLORS['moon']}\n\n"
        text += f"{COLORS['purple']} {COLORS['cloud']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
        await query.edit_message_text(text=text, reply_markup=get_user_keyboard())
        return

    if data == "admin_main_menu":
        text = f"{COLORS['moon']} ะะะะะ-ะะะะะะฌ {COLORS['moon']}\n\n"
        if user_tag:
            text += f"{COLORS['purple']} ะะฐั ัะตะณ: {user_tag}\n\n"
        text += f"{COLORS['blue']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
        await query.edit_message_text(text=text, reply_markup=get_admin_keyboard())
        return

    if data == "main_menu":
        text = f"{COLORS['moon']} ะะะะะะะ ะะะะฎ {COLORS['moon']}\n\n"

        if user_tag and is_admin:
            if user_tag:
                text += f"{COLORS['purple']} ะะฐั ัะตะณ: {user_tag}\n\n"
            text += f"{COLORS['blue']} ะะดะผะธะฝ-ะฟะฐะฝะตะปั:"
            reply_markup = get_admin_keyboard()
        else:
            text += f"{COLORS['purple']} {COLORS['cloud']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
            reply_markup = get_user_keyboard()

        await query.edit_message_text(text=text, reply_markup=reply_markup)
        return

    if data == "tg_channel":
        text = f"{COLORS['purple']} ๐ข ะะฐั ะขะะ ะะฐะฝะฐะป:\n\n{TG_CHANNEL_LINK}"
        back_button = "admin_main_menu" if (user_tag and is_admin) else "user_main_menu"
        keyboard = InlineKeyboardMarkup([[
            InlineKeyboardButton("๐ข ะะตัะตะนัะธ", url=TG_CHANNEL_LINK),
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", back_button, 'fog')
        ]])
        await query.edit_message_text(text=text, reply_markup=keyboard)
        return

    if data.startswith("decline_user_"):
        parts = data.split("_")
        target_user_id = int(parts[2])
        thread_id = int(parts[3])
        await decline_user(query, context, target_user_id, thread_id)
        return

    if data.startswith("change_admin_"):
        parts = data.split("_")
        target_user_id = int(parts[2])
        thread_id = int(parts[3])
        await change_admin(query, context, target_user_id, thread_id)
        return

    if data.startswith("user_change_admin_"):
        parts = data.split("_")
        target_user_id = int(parts[3])
        thread_id = int(parts[4])
        await user_change_admin(query, context, target_user_id, thread_id)
        return

    if data == "write":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะฐะฟะธัะฐัั ัะพะพะฑัะตะฝะธะต\n\n{COLORS['blue']} ะัะฑะตัะธัะต ัะธะฟ ะพะฑัะฐัะตะฝะธั:",
            reply_markup=get_message_type_keyboard()
        )
        return

    elif data == "become_admin":
        await query.edit_message_text(
            text=f"{COLORS['night']} ๐ ะกัะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ\n\n{COLORS['purple']} ะะฐะฟะพะปะฝะธัะต ะฐะฝะบะตัั:\n\n{COLORS['blue']} ะัะฑะตัะธัะต ะฝะฐะฟัะฐะฒะปะตะฝะธะต:",
            reply_markup=get_app_type_keyboard()
        )
        return



    elif data == "view_reviews":
        await show_reviews_for_user(query, context)
        return

    elif data.startswith("msg_type_"):
        msg_type = data.replace("msg_type_", "")
        context.user_data['awaiting_message_type'] = msg_type
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะั ะฒัะฑัะฐะปะธ: {MESSAGE_TYPES[msg_type]}\n\n{COLORS['blue']} ะขะตะฟะตัั ะพัะฟัะฐะฒััะต ะปัะฑะพะต ัะพะพะฑัะตะฝะธะต:",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_message'] = True
        return
    # ะ ััะฝะบัะธะธ button_handler ะดะพะฑะฐะฒััะต:

    # ะขัะตะบะตั ะฝะฐัััะพะตะฝะธั
    elif data == "mood_track":
        await mood_track(update, context)
        return
        
    elif data.startswith("mood_"):
        await mood_anxiety(update, context)
        return
        
    elif data.startswith("anxiety_"):
        await mood_energy(update, context)
        return
        
    elif data.startswith("energy_"):
        await mood_sleep(update, context)
        return
        
    elif data.startswith("sleep_"):
        await mood_notes(update, context)
        return
        
    elif data.startswith("note_"):
        await mood_note_callback(update, context)
        return
    elif data.startswith("blocked_page_"):
        page = int(data.split("_")[2])
    # ะะตัะตะดะฐะตะผ ัะฟัะฐะฒะปะตะฝะธะต ะพะฑัะฐัะฝะพ ะฒ ะบะพะผะฐะฝะดั
        update.effective_message.text = f"/blockedlist {page}"
        await blocked_users_list(update, context)
        return

    elif data == "leave_review":
        await query.edit_message_text(
            text=f"{COLORS['purple']} โญ ะััะฐะฒะธัั ะพัะทัะฒ\n\n{COLORS['blue']} ะัะตะฝะธัะต ะฝะฐัั ัะฐะฑะพัั ะพั 1 ะดะพ 5 ะทะฒะตะทะด:",
            reply_markup=get_rating_keyboard()
        )
        context.user_data['awaiting_review_rating'] = True
        return
    elif data.startswith("rating_"):
        rating = int(data.split("_")[1])
        context.user_data['review_rating'] = rating
        await query.edit_message_text(
            text=f"{COLORS['purple']} โญ ะั ะฒัะฑัะฐะปะธ {rating} ะทะฒะตะทะด\n\n{COLORS['blue']} ะขะตะฟะตัั ะฝะฐะฟะธัะธัะต ะฒะฐั ะพัะทัะฒ ัะตะบััะพะผ:",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_review_text'] = True
        return
    
    elif data.startswith("apps_page_"):
        await apps_page_callback(update, context)
        return

    elif data == "rules":
        rules_text = (
            f"{COLORS['purple']} ๐ ะะะะะะะ ะกะะะะฉะะกะขะะ ๐\n\n"
            f"{COLORS['blue']} 1. ะััั ะฒะตะถะปะธะฒัะผ, ะฝะต ะพัะบะพัะฑะปััั ััะฐะฝะธัะตะปะตะน\n"
            f"{COLORS['violet']} 2. ะขะตะผั, ัะฒัะทะฐะฝะฝัะต ั 18+ ะทะฐะฟัะตัะตะฝั\n"
            f"{COLORS['night']} 3. ะะตัะตัะพะด ะฒ ะปะธัะฝัะต ัะพะพะฑัะตะฝะธั ะฝะต ะฒะพะทะผะพะถะตะฝ\n"
            f"{COLORS['purple']} 4. ะะต ัะฟะฐะผะธัั\n"
            f"{COLORS['blue']} 5. ะะต ะฟัะพัะธัั ะฒะฝะตัะฝะพััั ััะฐะฝะธัะตะปั, ะธะผั, ะฒะพะทัะฐัั ะธ ะณะพัะพะด\n\n"
            f"{COLORS['fog']} {COLORS['cloud']} ะะฐัััะธัะตะปะธ ะฑัะดัั ะทะฐะฑะฐะฝะตะฝั {COLORS['cloud']}"
        )
        back_button = "admin_main_menu" if (user_tag and is_admin) else "user_main_menu"
        await query.edit_message_text(
            text=rules_text,
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", back_button, 'fog')
            ]])
        )
        return

    if data == "stats_menu":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะขะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ัะฐะทะดะตะป:",
            reply_markup=get_stats_menu_keyboard()
        )
        return

    elif data == "stats_general":
        await show_general_stats(query, context)
        return

    elif data == "stats_my":
        await show_my_stats(query, context, user_id, user_tag)
        return

    elif data == "stats_admins":
        await show_admins_stats(query, context)
        return

    elif data == "stats_today":
        await show_stats_by_period(query, context, "today", "ะทะฐ ัะตะณะพะดะฝั")
        return

    elif data == "stats_week":
        await show_stats_by_period(query, context, "week", "ะทะฐ ะฝะตะดะตะปั")
        return

    elif data == "stats_month":
        await show_stats_by_period(query, context, "month", "ะทะฐ ะผะตััั")
        return


    elif data == "user_stats_menu":

        # ะะตัะตะดะฐะตะผ query, ะฐ ะฝะต update

        await user_stats(query, context)

        return


    elif data == "broadcast_menu":
        keyboard = InlineKeyboardMarkup([
            [create_fancy_button("๐ ะขะพะปัะบะพ ัะตะบัั", "broadcast_text", 'blue')],
            [create_fancy_button("๐ผ๏ธ ะขะตะบัั + ัะพัะพ", "broadcast_photo", 'green')],
            [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
        ])
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ัะธะฟ ัะพะพะฑัะตะฝะธั:",
            reply_markup=keyboard
        )
        return

        # โโโ ะะะะะะฌะขะ ะญะขะะข ะะะะ ะกะะะะฃ ะะะกะะ broadcast_menu โโโ
    elif data == "broadcast_text":
        context.user_data['broadcast_type'] = 'text'
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะขะะะกะขะะะะฏ ะะะกะกะซะะะ\n\n{COLORS['blue']} ะะฒะตะดะธัะต ัะตะบัั ะดะปั ัะฐัััะปะบะธ:",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "admin_main_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_broadcast_text'] = True
        return

    elif data == "broadcast_photo":
        context.user_data['broadcast_type'] = 'photo'
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ผ๏ธ ะะะกะกะซะะะ ะก ะคะะขะ\n\n{COLORS['blue']} ะัะฟัะฐะฒััะต ัะพัะพ ะธ ะฟะพะดะฟะธัั ะบ ะฝะตะผั (ะผะพะถะฝะพ ะพะดะฝะธะผ ัะพะพะฑัะตะฝะธะตะผ):",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "admin_main_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_broadcast_photo'] = True
        return
    # โโโ ะะะะะฆ ะะะะะ โโโ


    elif data == "blocked_users_menu":

        # ะะตัะตะดะฐะตะผ query, ะฐ ะฝะต update

        await blocked_users(query, context)

        return

    elif data == "refresh_invite":
        await refresh_invite_link(query, context)
        return

    elif data == "reviews_menu":
        await query.edit_message_text(
            text=f"{COLORS['purple']} โญ ะฃะะะะะะะะะ ะะขะะซะะะะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ัะฐะทะดะตะป:",
            reply_markup=get_reviews_menu_keyboard()
        )
        return

    elif data == "reviews_new":
        await show_reviews_by_status(query, context, "new", "๐ ะะพะฒัะต ะพัะทัะฒั")
        return

    elif data == "reviews_viewed":
        await show_reviews_by_status(query, context, "viewed", "โ ะัะพัะผะพััะตะฝะฝัะต")
        return

    elif data == "reviews_all":
        await show_reviews_by_status(query, context, "all", "๐ ะัะต ะพัะทัะฒั")
        return

    elif data == "reviews_stats":
        await show_reviews_stats(query, context)
        return

    elif data.startswith("review_view_"):
        review_id = int(data.split("_")[2])
        await view_review(query, context, review_id, user_id)
        return

    elif data == "applications_menu":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะะฏะะะ ะะ ะะะะะะะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ะบะฐัะตะณะพัะธั:",
            reply_markup=get_applications_menu_keyboard()
        )
        return

    elif data == "apps_pending":
        await show_applications_by_status(query, context, "pending", "๐ข ะะถะธะดะฐััะธะต ะทะฐัะฒะบะธ")
        return

    elif data == "apps_accepted":
        await show_applications_by_status(query, context, "accepted", "โ ะัะธะฝัััะต ะทะฐัะฒะบะธ")
        return

    elif data == "apps_rejected":
        await show_applications_by_status(query, context, "rejected", "โ ะัะบะปะพะฝะตะฝะฝัะต ะทะฐัะฒะบะธ")
        return

    elif data == "apps_all":
        await show_applications_by_status(query, context, "all", "๐ ะัะต ะทะฐัะฒะบะธ")
        return

    elif data.startswith("view_app_"):
        app_id = int(data.split("_")[2])
        await view_application(query, context, app_id)
        return

    elif data.startswith("accept_app_"):
        parts = data.split("_")
        app_id = int(parts[2])
        applicant_id = int(parts[3])
        await accept_application(query, context, app_id, applicant_id)
        return

    elif data.startswith("reject_app_"):
        parts = data.split("_")
        app_id = int(parts[2])
        applicant_id = int(parts[3])
        await reject_application(query, context, app_id, applicant_id)
        return

    elif data == "pending_chats":
        await show_pending_chats(query, context)
        return

    elif data.startswith("take_chat_"):
        target_user_id = int(data.split("_")[2])
        await take_chat(query, context, target_user_id)
        return

    elif data == "rests_menu":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ด ะฃะะะะะะะะะ ะะะกะขะะะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:",
            reply_markup=get_rests_main_menu_keyboard()
        )
        return

    elif data == "rest_my":
        active_rest = check_active_rest(user_id)
        if active_rest:
            rest_id, start_date, end_date, reason = active_rest
            text = (
                f"{COLORS['purple']} ๐ค ะะะ ะะะกะข\n\n"
                f"{COLORS['blue']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n"
                f"{COLORS['violet']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n"
                f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n\n"
                f"{COLORS['purple']} ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
            )
            await query.edit_message_text(
                text=text,
                reply_markup=get_rest_actions_keyboard(rest_id, user_id)
            )
        else:
            await query.edit_message_text(
                text=f"{COLORS['purple']} โ ะะตั ะฐะบัะธะฒะฝะพะณะพ ัะตััะฐ\n\n{COLORS['blue']} ะั ะผะพะถะตัะต ะฒะทััั ัะตัั, ะฝะฐะถะฐะฒ ะบะฝะพะฟะบั '๐ ะะทััั ัะตัั'.",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("๐ ะะทััั ัะตัั", "rest_take", 'moon'),
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')
                ]])
            )
        return

    elif data == "rest_take":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะคะะะะะะะะ ะะะกะขะ\n\n{COLORS['blue']} ะะฒะตะดะธัะต ะดะฐัั ะฝะฐัะฐะปะฐ ัะตััะฐ ะฒ ัะพัะผะฐัะต ะะ.ะะ.ะะะะ\n\n{COLORS['violet']} ะะฐะฟัะธะผะตั: 12.09.2005",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_rest_start_date'] = True
        return

    elif data == "rests_active":
        await show_rests_by_status(query, context, "active", "๐ ะะบัะธะฒะฝัะต ัะตััั")
        return

    elif data == "rests_history":
        await show_rests_by_status(query, context, "all", "๐ ะััะพัะธั ัะตััะพะฒ")
        return

    elif data == "rests_stats":
        await show_rests_stats(query, context)
        return

    elif data == "rests_help":
        help_text = (
            f"{COLORS['purple']} โ ะะะะะฉะฌ ะะ ะะะกะขะะ\n\n"
            f"{COLORS['blue']} ๐ ะะฐะบ ะฒะทััั ัะตัั:\n"
            f"1. ะะฐะถะผะธัะต '๐ ะะทััั ัะตัั'\n"
            f"2. ะะฒะตะดะธัะต ะดะฐัั ะฝะฐัะฐะปะฐ\n"
            f"3. ะะฒะตะดะธัะต ะดะฐัั ะพะบะพะฝัะฐะฝะธั\n"
            f"4. ะะฒะตะดะธัะต ะฟัะธัะธะฝั\n\n"
            f"{COLORS['violet']} ๐ ะะพััะพัะฝัะน ะฒััะพะด:\n"
            f"โข ะะฐะถะผะธัะต ะบะฝะพะฟะบั ะฟะพะด ะฒะฐัะธะผ ัะตััะพะผ\n\n"
            f"{COLORS['night']} โ ะัะพะดะปะตะฝะธะต:\n"
            f"โข ะะฐะถะผะธัะต 'โ ะัะพะดะปะธัั' ะฟะพะด ัะตััะพะผ\n"
            f"โข ะะฒะตะดะธัะต ะฝะพะฒัั ะดะฐัั\n\n"
            f"{COLORS['purple']} ๐ ะัะพัะผะพัั:\n"
            f"โข ะะบัะธะฒะฝัะต - ะบัะพ ะพัะดััะฐะตั ัะตะนัะฐั\n"
            f"โข ะััะพัะธั - ะฒัะต ะฟัะพัะตะดัะธะต ัะตััั\n"
            f"โข ะกัะฐัะธััะธะบะฐ - ะพะฑัะฐั ะธะฝัะพัะผะฐัะธั"
        )
        await query.edit_message_text(
            text=help_text,
            reply_markup=get_rests_back_to_menu_keyboard()
        )
        return

    elif data.startswith("rest_early_"):
        parts = data.split("_")
        rest_id = int(parts[2])
        admin_id = int(parts[3])
        await early_return_from_rest(query, context, rest_id, admin_id)
        return

    elif data.startswith("rest_extend_"):
        parts = data.split("_")
        rest_id = int(parts[2])
        admin_id = int(parts[3])
        if user_id != admin_id:
            await query.edit_message_text(
                text=f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะขะพะปัะบะพ ะฒะปะฐะดะตะปะตั ัะตััะฐ ะผะพะถะตั ะตะณะพ ะฟัะพะดะปะธัั.",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')
                ]])
            )
            return
        context.user_data['extend_rest_id'] = rest_id
        context.user_data['extend_admin_id'] = admin_id
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะะะะะะะะ ะะะกะขะ\n\n{COLORS['blue']} ะะฒะตะดะธัะต ะฝะพะฒัั ะดะฐัั ะพะบะพะฝัะฐะฝะธั ะฒ ัะพัะผะฐัะต ะะ.ะะ.ะะะะ\n\n{COLORS['violet']} ะะฐะฟัะธะผะตั: 13.09.2005",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        context.user_data['awaiting_rest_extend_date'] = True
        return

    elif data.startswith("rest_info_"):
        rest_id = int(data.split("_")[2])
        await view_rest_info(query, context, rest_id)
        return

    elif data == "change_tag":
        await query.edit_message_text(
            text=f"{COLORS['purple']} โ๏ธ ะกะะะะ ะขะะะ\n\n{COLORS['blue']} ะัะฟะพะปัะทัะนัะต ะบะพะผะฐะฝะดั: /settag [ะฝะพะฒัะน_ัะตะณ]\n\n{COLORS['violet']} ะัะธะผะตั: /settag #ะฝะพะฒัะน_ัะตะณ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
            ]])
        )
        return

    elif data == "leave_bot":
        keyboard = InlineKeyboardMarkup([
            [create_fancy_button("โฑ ะัะตะผะตะฝะฝะพ (ะบะธะบ)", "leave_temp", 'blue')],
            [create_fancy_button("๐ด ะะฐะฒัะตะณะดะฐ (ะฑะฐะฝ)", "leave_forever", 'night')],
            [create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "admin_main_menu", 'fog')]
        ])
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะะะะะะะะ ะะะขะ\n\n{COLORS['blue']} ะัะฑะตัะธัะต ะพะฟัะธั:\nโข ะัะตะผะตะฝะฝะพ - ะฒะฐั ะบะธะบะฝัั, ะฝะพ ะผะพะถะฝะพ ะฒะตัะฝััััั ัะตัะตะท /start\nโข ะะฐะฒัะตะณะดะฐ - ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฑะฐะฝ ะฒ ัะธััะตะผะต, ะฒะพะทะฒัะฐั ะฝะตะฒะพะทะผะพะถะตะฝ",
            reply_markup=keyboard
        )
        return

    elif data == "leave_temp":
        await query.edit_message_text(
            text=f"{COLORS['purple']} โฑ ะัะตะผะตะฝะฝัะน ะฒััะพะด\n\n{COLORS['blue']} ะั ะฑัะดะตัะต ะบะธะบะฝััั ะธะท ะณััะฟะฟั. ะะปั ะฒะพะทะฒัะฐัะฐ ะธัะฟะพะปัะทัะนัะต /start",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ ะะพะดัะฒะตัะดะธัั", f"confirm_leave_temp_{user_id}", 'moon'),
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "admin_main_menu", 'fog')
            ]])
        )
        return

    elif data == "leave_forever":
        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ด ะะฐะฒัะตะณะดะฐ\n\n{COLORS['blue']} ะั ะฑัะดะตัะต ะทะฐะฑะฐะฝะตะฝั ะฒ ัะธััะตะผะต. ะญัะพ ะดะตะนััะฒะธะต ะฝะตะพะฑัะฐัะธะผะพ!",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ ะะพะดัะฒะตัะดะธัั ะฝะฐะฒัะตะณะดะฐ", f"confirm_leave_forever_{user_id}", 'night'),
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "admin_main_menu", 'fog')
            ]])
        )
        return

    elif data.startswith("confirm_leave_temp_"):
        parts = data.split("_")
        target_id = int(parts[3])
        await process_leave_temp(query, context, target_id)
        return

    elif data.startswith("confirm_leave_forever_"):
        parts = data.split("_")
        target_id = int(parts[3])
        await process_leave_forever(query, context, target_id)
        return

    elif data == "confirm_broadcast":
        await confirm_broadcast(query, context)
        return

    elif data.startswith("apps_page_"):
        parts = data.split("_")
        page = int(parts[2])
        apps = context.user_data.get('current_apps', [])
        title = context.user_data.get('current_title', "ะะฐัะฒะบะธ")
        if apps:
            await show_applications_page(query, context, apps, page, title)
        return

    elif data.startswith("app_type_"):
        app_type = data.replace("app_type_", "")
        context.user_data['filling_app'] = True
        context.user_data['app_type'] = app_type
        context.user_data['app_step'] = 0
        context.user_data['app_answers'] = []

        if app_type == "communication":
            questions = COMMUNICATION_QUESTIONS
        elif app_type == "support":
            questions = SUPPORT_QUESTIONS
        else:
            questions = BOTH_QUESTIONS

        type_names = {
            "communication": "ะะะฉะะะะ",
            "support": "ะะะะะะะะะ",
            "both": "ะะะฉะะะะ ะ ะะะะะะะะะ"
        }

        await query.edit_message_text(
            text=f"{COLORS['purple']} ๐ ะะะะะขะ: {type_names[app_type]}\n\n{COLORS['blue']} {questions[0]}",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "user_main_menu", 'fog')
            ]])
        )
        return

    logger.warning(f"ะะตะพะฑัะฐะฑะพัะฐะฝะฝัะน callback: {data}")


async def show_applications_by_status(query, context, status, title):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    if status == "all":
        c.execute("""SELECT id, name, app_type, status, created_at 
                     FROM applications 
                     ORDER BY created_at DESC""")
    else:
        c.execute("""SELECT id, name, app_type, status, created_at 
                     FROM applications 
                     WHERE status = ? 
                     ORDER BY created_at DESC""", (status,))

    apps = c.fetchall()
    conn.close()

    if not apps:
        await query.edit_message_text(
            f"{COLORS['purple']} {title}:\n\n{COLORS['blue']} ะะตั ะทะฐัะฒะพะบ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')
            ]])
        )
        return

    context.user_data['current_apps'] = apps
    context.user_data['current_status'] = status
    context.user_data['current_title'] = title

    await show_applications_page(query, context, apps, 0, title)

async def clear_new_reviews(update: Update, context):
    """ะัะธััะธัั ัะพะปัะบะพ ะฝะพะฒัะต (ะฝะตะฟัะพัะผะพััะตะฝะฝัะต) ะพัะทัะฒั"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("DELETE FROM reviews WHERE status = 'new'")
    deleted_count = c.rowcount
    
    conn.commit()
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐๏ธ ะะะะซะ ะะขะะซะะซ ะฃะะะะะะซ!\n\n"
        f"{COLORS['blue']} ะฃะดะฐะปะตะฝะพ ะฝะพะฒัั ะพัะทัะฒะพะฒ: {deleted_count}"
    )


async def show_applications_page(query, context, apps, page, title):
    apps_per_page = 5
    start = page * apps_per_page
    end = start + apps_per_page
    current_apps = apps[start:end]
    total_pages = (len(apps) + apps_per_page - 1) // apps_per_page

    status_emoji = {
        'pending': '๐ข',
        'accepted': 'โ',
        'rejected': 'โ'
    }

    text = f"{COLORS['purple']} {title} (ัััะฐะฝะธัะฐ {page + 1} ะธะท {total_pages}):\n\n"
    keyboard = []

    for app in current_apps:
        app_id, name, app_type, status, created_at = app
        emoji = status_emoji.get(status, '๐')
        text += f"{COLORS['blue']} {emoji} #{app_id} - {name}\n"
        text += f"{COLORS['violet']}    ะขะธะฟ: {app_type}\n"
        text += f"{COLORS['night']}    ะกัะฐััั: {status}\n"
        text += f"{COLORS['purple']}    ๐ {created_at[:16]}\n\n"

        keyboard.append([create_fancy_button(
            f"๐ ะะฐัะฒะบะฐ #{app_id}",
            f"view_app_{app_id}", 'moon'
        )])

    nav_buttons = []
    if page > 0:
        nav_buttons.append(create_fancy_button("โ๏ธ ะัะตะดัะดััะฐั", f"apps_page_{page - 1}", 'moon'))
    if page < total_pages - 1:
        nav_buttons.append(create_fancy_button("ะกะปะตะดัััะฐั โถ๏ธ", f"apps_page_{page + 1}", 'night'))

    if nav_buttons:
        keyboard.append(nav_buttons)

    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')])

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def view_application(query, context, app_id):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT * FROM applications WHERE id = ?", (app_id,))
    app = c.fetchone()
    conn.close()

    if not app:
        await query.edit_message_text(f"โ ะะฐัะฒะบะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ")
        return

    app_id, user_id, username, app_type, name, answers_json, created_at, status, reviewed_at, reviewed_by, msg_id, thread_id = app
    answers = json.loads(answers_json)

    status_emoji = {
        'pending': '๐ข',
        'accepted': 'โ',
        'rejected': 'โ'
    }.get(status, '๐')

    text = f"{COLORS['purple']} {status_emoji} ะะะฏะะะ #{app_id}\n\n"
    text += f"{COLORS['blue']} ะขะธะฟ: {app_type}\n"
    text += f"{COLORS['violet']} ะกัะฐััั: {status}\n"
    text += f"{COLORS['night']} ะั: {name} (ID: {user_id})\n"
    text += f"{COLORS['purple']} Username: @{username}\n"
    text += f"{COLORS['blue']} ะัะตะผั ะฟะพะดะฐัะธ: {created_at}\n"
    if reviewed_at:
        text += f"{COLORS['violet']} ะะฐััะผะพััะตะฝะพ: {reviewed_at}\n"
    if reviewed_by:
        reviewer_tag = get_user_tag(reviewed_by) or str(reviewed_by)
        text += f"{COLORS['night']} ะะฐััะผะพััะตะป: {reviewer_tag}\n"
    text += f"\n{COLORS['purple']} ะะขะะะขะซ ะะ ะะะะะะกะซ:\n\n"

    for i, answer in enumerate(answers, 1):
        text += f"{COLORS['blue']} {i}. {answer}\n\n"

    await query.edit_message_text(
        text,
        reply_markup=get_application_keyboard(app_id, user_id)
    )


async def accept_application(query, context, app_id, applicant_id):
    taker_id = query.from_user.id
    taker_tag = get_user_tag(taker_id)

    if taker_id not in MAIN_ADMIN_IDS:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะขะพะปัะบะพ ะณะปะฐะฒะฝัะต ะฐะดะผะธะฝะธัััะฐัะพัั ะผะพะณัั ะฟัะธะฝะธะผะฐัั ะทะฐัะฒะบะธ!"
        )
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT user_id, username FROM applications WHERE id = ?", (app_id,))
    app_info = c.fetchone()

    if not app_info:
        await query.edit_message_text(f"โ ะะฐัะฒะบะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ")
        conn.close()
        return

    user_id, username = app_info

    c.execute("""UPDATE applications SET status = 'accepted', reviewed_at = ?, reviewed_by = ? WHERE id = ?""",
              (get_current_time(), taker_id, app_id))

    c.execute("SELECT message_id, thread_id FROM applications WHERE id = ?", (app_id,))
    msg_info = c.fetchone()
    conn.commit()
    conn.close()

    if msg_info and msg_info[0]:
        try:
            await context.bot.edit_message_text(
                chat_id=ADMIN_GROUP_ID,
                message_id=msg_info[0],
                text=f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะฟัะธะฝััะฐ!\n\nะัะธะฝัะป: {taker_tag}",
                reply_markup=None
            )
        except:
            pass

    try:
        invite_link = await create_invite_link(context, user_id)

        if invite_link:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"{COLORS['purple']} โ ะะะะะะะะะฏะะ!\n\n"
                     f"{COLORS['blue']} ะะฐัะฐ ะทะฐัะฒะบะฐ ะฝะฐ ะฐะดะผะธะฝะฐ ะฟัะธะฝััะฐ!\n\n"
                     f"{COLORS['violet']} ๐ ะะะะะะะะะะะฏ ะกะกะซะะะ ะะะฏ ะะกะขะฃะะะะะะฏ:\n"
                     f"{invite_link}\n\n"
                     f"{COLORS['night']} โ๏ธ ะกััะปะบะฐ ะดะตะนััะฒะธัะตะปัะฝะฐ 7 ะดะฝะตะน ะธ ัะพะปัะบะพ ะดะปั ะพะดะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!\n\n"
                     f"{COLORS['purple']} ะะพัะปะต ะฒัััะฟะปะตะฝะธั ะทะฐัะตะณะธัััะธััะนัะต ัะฒะพะน ัะตะณ:\n"
                     f"/settag ะฒะฐั_ัะตะณ\n\n"
                     f"ะัะธะผะตั: /settag #ัะธะณัะธัะฐ"
            )

            await query.edit_message_text(
                f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะฟัะธะฝััะฐ!\n\n"
                f"{COLORS['blue']} ะะดะฝะพัะฐะทะพะฒะฐั ัััะปะบะฐ ะพัะฟัะฐะฒะปะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')
                ]])
            )
        else:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"{COLORS['purple']} โ ะะะะะะะะะฏะะ!\n\n"
                     f"{COLORS['blue']} ะะฐัะฐ ะทะฐัะฒะบะฐ ะฝะฐ ะฐะดะผะธะฝะฐ ะฟัะธะฝััะฐ!\n\n"
                     f"{COLORS['violet']} ะะพ ะฒะพะทะฝะธะบะปะฐ ะพัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัััะปะบะธ. ะะฑัะฐัะธัะตัั ะบ ะฐะดะผะธะฝะธัััะฐัะพัั."
            )

            await query.edit_message_text(
                f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะฟัะธะฝััะฐ!\n\n"
                f"{COLORS['red']} โ ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ัััะปะบะธ!",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')
                ]])
            )

    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ัะฒะตะดะพะผะปะตะฝะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั: {e}")
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะฟัะธะฝััะฐ!\n\n"
            f"{COLORS['red']} โ ะัะธะฑะบะฐ ะฟัะธ ะพัะฟัะฐะฒะบะต ัะฒะตะดะพะผะปะตะฝะธั",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')
            ]])
        )


async def reject_application(query, context, app_id, applicant_id):
    taker_id = query.from_user.id
    taker_tag = get_user_tag(taker_id)

    if taker_id not in MAIN_ADMIN_IDS:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะขะพะปัะบะพ ะณะปะฐะฒะฝัะต ะฐะดะผะธะฝะธัััะฐัะพัั ะผะพะณัั ะพัะบะปะพะฝััั ะทะฐัะฒะบะธ!"
        )
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""UPDATE applications SET status = 'rejected', reviewed_at = ?, reviewed_by = ? WHERE id = ?""",
              (get_current_time(), taker_id, app_id))
    c.execute("SELECT message_id, thread_id FROM applications WHERE id = ?", (app_id,))
    msg_info = c.fetchone()
    conn.commit()
    conn.close()

    if msg_info and msg_info[0]:
        try:
            await context.bot.edit_message_text(
                chat_id=ADMIN_GROUP_ID,
                message_id=msg_info[0],
                text=f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะพัะบะปะพะฝะตะฝะฐ\n\nะัะบะปะพะฝะธะป: {taker_tag}",
                reply_markup=None
            )
        except:
            pass

    try:
        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        c.execute("SELECT user_id FROM applications WHERE id = ?", (app_id,))
        result = c.fetchone()
        conn.close()
        if result:
            user_id = result[0]
            await context.bot.send_message(
                chat_id=user_id,
                text=f"{COLORS['purple']} โ ะ ัะพะถะฐะปะตะฝะธั, ะฒะฐัะฐ ะทะฐัะฒะบะฐ ะพัะบะปะพะฝะตะฝะฐ\n\n{COLORS['blue']} ะั ะผะพะถะตัะต ะฟัะพะดะพะปะถะฐัั ะพะฑัะฐัััั ั ะฟะพะดะดะตัะถะบะพะน ะฒ ัะตะบััะตะผ ัะฐัะต."
            )
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ัะฒะตะดะพะผะปะตะฝะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั: {e}")

    await query.edit_message_text(
        f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะพัะบะปะพะฝะตะฝะฐ",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "applications_menu", 'fog')
        ]])
    )


async def show_pending_chats(query, context):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT user_id, user_name, message_type, first_message, created_at, thread_id 
                 FROM active_chats WHERE status = 'pending' ORDER BY created_at DESC""")
    chats = c.fetchall()
    conn.close()

    if not chats:
        await query.edit_message_text(
            f"{COLORS['purple']} ๐ ะะตั ะพะถะธะดะฐััะธั ะทะฐัะฒะพะบ\n\n{COLORS['blue']} ะัะต ะทะฐัะฒะบะธ ะพะฑัะฐะฑะพัะฐะฝั! {COLORS['cloud']}",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} โณ ะะะะะะฎะฉะะ ะะะฏะะะ\n\n"
    keyboard = []

    for chat in chats[:10]:
        user_id, user_name, msg_type, first_msg, created_at, thread_id = chat
        preview = first_msg[:50] + "..." if len(first_msg) > 50 else first_msg
        created_short = created_at[:16] if created_at else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['blue']} ๐ค {user_name}\n"
        text += f"{COLORS['violet']}    ๐ ID: {user_id}\n"
        text += f"{COLORS['night']}    ๐ ะขะธะฟ: {msg_type}\n"
        text += f"{COLORS['purple']}    ๐ {preview}\n"
        text += f"{COLORS['blue']}    โฑ {created_short}\n\n"
        keyboard.append([create_fancy_button(f"โ ะะทััั: {user_name}", f"take_chat_{user_id}", 'moon')])

    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def take_chat(query, context, target_user_id):
    taker_id = query.from_user.id
    taker_tag = get_user_tag(taker_id)

    if not taker_tag:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะฒะพะน ัะตะณ ัะตัะตะท /settag",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "pending_chats", 'fog')
            ]])
        )
        return

    if not await is_group_member(taker_id, context):
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะดะพัััะฟะฐ\n\n{COLORS['blue']} ะั ะฝะต ัะฒะปัะตัะตัั ััะฐััะฝะธะบะพะผ ะณััะฟะฟั ะฐะดะผะธะฝะพะฒ!\n\nะัััะฟะธัะต ะฒ ะณััะฟะฟั ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ.",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "pending_chats", 'fog')
            ]])
        )
        return


    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT user_name, thread_id, message_type, first_message FROM active_chats 
                 WHERE user_id = ? AND status = 'pending'""", (target_user_id,))
    chat = c.fetchone()

    if not chat:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะะฐัะฒะบะฐ ัะถะต ะฒะทััะฐ ะฒ ัะฐะฑะพัั",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "pending_chats", 'fog')
            ]])
        )
        conn.close()
        return

    user_name, thread_id, msg_type, first_message = chat

    c.execute("""UPDATE active_chats 
                 SET status = 'active', taken_by_id = ?, taken_by_tag = ?, taken_at = ? 
                 WHERE user_id = ?""",
              (taker_id, taker_tag, get_current_time(), target_user_id))
    conn.commit()
    conn.close()

    try:
        new_topic_name = f"{taker_tag} - {user_name}"
        await context.bot.edit_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            name=new_topic_name[:128]
        )

        await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            text=f"๐ซ๏ธ {taker_tag} ะฒะทัะป ะทะฐัะฒะบั ะฒ ัะฐะฑะพัั",
            reply_markup=get_active_chat_keyboard(target_user_id, thread_id)
        )

        await context.bot.send_message(
            chat_id=target_user_id,
            text=f"{COLORS['purple']} ๐ ะะฐัั ะทะฐัะฒะบั ะฟัะธะฝัะป {taker_tag}\n\n{COLORS['blue']} ะขะตะฟะตัั ะฒั ะผะพะถะตัะต ะพะฑัะฐัััั ะฒ ััะพะผ ัะฐัะต. {COLORS['cloud']}",
            reply_markup=get_user_chat_keyboard(target_user_id, thread_id)
        )

    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะฟะตัะตะธะผะตะฝะพะฒะฐะฝะธะธ ัะตะผั: {e}")

    chat_link = f"https://t.me/c/{str(ADMIN_GROUP_ID).replace('-100', '')}/{thread_id}"
    await query.edit_message_text(
        f"{COLORS['purple']} โ ะะฐัะฒะบะฐ ะพั {user_name} ะฒะทััะฐ ะฒ ัะฐะฑะพัั!\n\n{COLORS['blue']} ะะฐั ัะตะณ: {taker_tag}\n\n๐ [ะะตัะตะนัะธ ะฒ ัะฐั ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ]({chat_link})",
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("๐ฑ ะะตัะตะนัะธ ะฒ ัะฐั", url=chat_link)
        ]]),
        disable_web_page_preview=True
    )


async def show_general_stats(query, context):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM applications")
    total_apps = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'pending'")
    pending_apps = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'accepted'")
    accepted_apps = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'rejected'")
    rejected_apps = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM active_chats")
    total_chats = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM active_chats WHERE status = 'pending'")
    pending_chats = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM active_chats WHERE status = 'active'")
    active_chats = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM messages")
    total_messages = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL")
    user_messages = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL")
    admin_messages = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM reviews")
    total_reviews = c.fetchone()[0] or 0
    c.execute("SELECT AVG(rating) FROM reviews")
    avg_rating = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'active'")
    active_rests = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests")
    total_rests = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM user_tags")
    total_admins = c.fetchone()[0] or 0

    conn.close()

    text = f"{COLORS['purple']} ๐ ะะะฉะะฏ ะกะขะะขะะกะขะะะ ะะะขะ\n\n"
    text += f"{COLORS['blue']} ๐ฅ ะะดะผะธะฝะพะฒ ั ัะตะณะฐะผะธ: {total_admins}\n\n"
    text += f"{COLORS['violet']} ๐ ะะะฏะะะ ะะ ะะะะะะ\n"
    text += f"โ ะัะตะณะพ: {total_apps}\n"
    text += f"โ ๐ข ะะถะธะดะฐัั: {pending_apps}\n"
    text += f"โ โ ะัะธะฝััะพ: {accepted_apps}\n"
    text += f"โ โ ะัะบะปะพะฝะตะฝะพ: {rejected_apps}\n\n"
    text += f"{COLORS['night']} ๐ฌ ะงะะขะซ ะะะะะะะะะ\n"
    text += f"โ ะัะตะณะพ: {total_chats}\n"
    text += f"โ โณ ะะถะธะดะฐัั: {pending_chats}\n"
    text += f"โ ๐ฌ ะะบัะธะฒะฝัั: {active_chats}\n\n"
    text += f"{COLORS['purple']} ๐จ ะกะะะะฉะะะะฏ\n"
    text += f"โ ะัะตะณะพ: {total_messages}\n"
    text += f"โ ๐ค ะั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {user_messages}\n"
    text += f"โ ๐จโ๐ผ ะั ะฐะดะผะธะฝะพะฒ: {admin_messages}\n\n"
    text += f"{COLORS['blue']} โญ ะะขะะซะะซ\n"
    text += f"โ ะัะตะณะพ: {total_reviews}\n"
    text += f"โ ะกัะตะดะฝะธะน ัะตะนัะธะฝะณ: {avg_rating:.1f}/5\n\n"
    text += f"{COLORS['night']} ๐ด ะะะกะขะซ\n"
    text += f"โ ะัะตะณะพ: {total_rests}\n"
    text += f"โ ะะบัะธะฒะฝัั: {active_rests}"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
        ]])
    )


async def show_my_stats(query, context, admin_id, admin_tag):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_by_id = ? AND status = 'active'", (admin_id,))
    active_chats = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_by_id = ?", (admin_id,))
    total_taken = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker = ?", (admin_id,))
    messages_sent = c.fetchone()[0] or 0

    c.execute("SELECT AVG(LENGTH(text)) FROM messages WHERE from_taker = ?", (admin_id,))
    avg_length = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ? AND status = 'active'", (admin_id,))
    active_rests = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ?", (admin_id,))
    total_rests = c.fetchone()[0] or 0

    c.execute("SELECT MIN(created_at) FROM active_chats WHERE taken_by_id = ?", (admin_id,))
    first_chat = c.fetchone()[0] or "ะฝะตั"
    c.execute("SELECT MAX(created_at) FROM active_chats WHERE taken_by_id = ?", (admin_id,))
    last_chat = c.fetchone()[0] or "ะฝะตั"

    c.execute("""SELECT strftime('%w', created_at) as weekday, COUNT(*) 
                 FROM messages 
                 WHERE from_taker = ? 
                 GROUP BY weekday""", (admin_id,))
    weekday_stats = c.fetchall()

    conn.close()

    days = ['ะั', 'ะะฝ', 'ะั', 'ะกั', 'ะงั', 'ะั', 'ะกะฑ']
    weekday_text = ""
    for wd, count in weekday_stats:
        weekday_text += f"{COLORS['violet']}    {days[int(wd)]}: {count} ัะพะพะฑัะตะฝะธะน\n"

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ {admin_tag}\n\n"
    text += f"{COLORS['blue']} ๐ ะงะฐัั:\n"
    text += f"โ ะัะตะณะพ ะฒะทััะพ: {total_taken}\n"
    text += f"โ ะะบัะธะฒะฝัั ัะตะนัะฐั: {active_chats}\n\n"
    text += f"{COLORS['violet']} ๐จ ะกะพะพะฑัะตะฝะธั:\n"
    text += f"โ ะัะฟัะฐะฒะปะตะฝะพ: {messages_sent}\n"
    text += f"โ ะกัะตะดะฝัั ะดะปะธะฝะฐ: {avg_length:.0f} ัะธะผะฒะพะปะพะฒ\n\n"
    text += f"{COLORS['night']} ๐ด ะะตััั:\n"
    text += f"โ ะัะตะณะพ: {total_rests}\n"
    text += f"โ ะะบัะธะฒะฝัั: {active_rests}\n\n"
    text += f"{COLORS['purple']} ๐ ะะบัะธะฒะฝะพััั:\n"
    text += f"โ ะะตัะฒัะน ัะฐั: {first_chat[:16] if first_chat != 'ะฝะตั' else 'ะฝะตั'}\n"
    text += f"โ ะะพัะปะตะดะฝะธะน ัะฐั: {last_chat[:16] if last_chat != 'ะฝะตั' else 'ะฝะตั'}\n"
    if weekday_text:
        text += f"โ ะะพ ะดะฝัะผ:\n{weekday_text}"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
        ]])
    )


async def show_admins_stats(query, context):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("""SELECT ut.user_id, ut.user_tag, 
                        COUNT(DISTINCT ac.user_id) as chats_count,
                        COUNT(m.id) as messages_count,
                        COUNT(r.id) as rests_count
                 FROM user_tags ut
                 LEFT JOIN active_chats ac ON ut.user_id = ac.taken_by_id
                 LEFT JOIN messages m ON ut.user_id = m.from_taker
                 LEFT JOIN rests r ON ut.user_id = r.admin_id
                 WHERE ut.is_active = 1
                 GROUP BY ut.user_id
                 ORDER BY messages_count DESC""")
    admins_stats = c.fetchall()
    conn.close()

    if not admins_stats:
        await query.edit_message_text(
            f"{COLORS['purple']} ๐ ะะตั ะฐะบัะธะฒะฝัั ะฐะดะผะธะฝะพะฒ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะ ะะะะะะะ\n\n"

    total_messages = sum(stat[3] for stat in admins_stats)
    total_chats = sum(stat[2] for stat in admins_stats)
    total_rests = sum(stat[4] for stat in admins_stats)

    text += f"{COLORS['blue']} ๐จ ะัะตะณะพ ัะพะพะฑัะตะฝะธะน: {total_messages}\n"
    text += f"{COLORS['violet']} ๐ ะัะตะณะพ ัะฐัะพะฒ: {total_chats}\n"
    text += f"{COLORS['night']} ๐ด ะัะตะณะพ ัะตััะพะฒ: {total_rests}\n"
    text += f"{COLORS['purple']} ๐ฅ ะัะตะณะพ ะฐะดะผะธะฝะพะฒ: {len(admins_stats)}\n\n"
    text += f"{COLORS['blue']} ะะพ ะฐะดะผะธะฝะฐะผ:\n"

    medals = ['๐ฅ', '๐ฅ', '๐ฅ']
    for i, (admin_id, tag, chats, msgs, rests) in enumerate(admins_stats[:10]):
        medal = medals[i] if i < 3 else f"{i + 1}."
        text += f"{COLORS['violet']} {medal} {tag}: {msgs} ัะพะพะฑั. | {chats} ัะฐัะพะฒ | {rests} ัะตััะพะฒ\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
        ]])
    )


async def show_stats_by_period(query, context, period, period_name):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    now = datetime.now()
    if period == "today":
        start_date = now.replace(hour=0, minute=0, second=0, microsecond=0)
    elif period == "week":
        start_date = now - timedelta(days=7)
    elif period == "month":
        start_date = now - timedelta(days=30)
    else:
        start_date = now - timedelta(days=1)

    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')

    c.execute("SELECT COUNT(*) FROM applications WHERE created_at > ?", (start_str,))
    new_apps = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM applications WHERE reviewed_at > ?", (start_str,))
    reviewed_apps = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM active_chats WHERE created_at > ?", (start_str,))
    new_chats = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_at > ?", (start_str,))
    taken_chats = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM messages WHERE created_at > ?", (start_str,))
    total_msgs = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL AND created_at > ?", (start_str,))
    user_msgs = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL AND created_at > ?", (start_str,))
    admin_msgs = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM reviews WHERE created_at > ?", (start_str,))
    new_reviews = c.fetchone()[0] or 0

    c.execute("SELECT COUNT(*) FROM rests WHERE created_at > ?", (start_str,))
    new_rests = c.fetchone()[0] or 0

    c.execute("""SELECT taker_tag, COUNT(*) as msg_count 
                 FROM messages 
                 WHERE from_taker IS NOT NULL AND created_at > ? 
                 GROUP BY taker_tag 
                 ORDER BY msg_count DESC 
                 LIMIT 5""", (start_str,))
    top_admins = c.fetchall()

    conn.close()

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ {period_name.upper()}\n\n"
    text += f"{COLORS['blue']} ๐ ะะพะฒัั ะทะฐัะฒะพะบ ะฝะฐ ะฐะดะผะธะฝะฐ: {new_apps}\n"
    text += f"{COLORS['violet']} โ ะะฐััะผะพััะตะฝะพ ะทะฐัะฒะพะบ: {reviewed_apps}\n\n"
    text += f"{COLORS['night']} ๐ฌ ะะพะฒัั ัะฐัะพะฒ: {new_chats}\n"
    text += f"{COLORS['purple']} ๐ ะะทััะพ ะฒ ัะฐะฑะพัั: {taken_chats}\n\n"
    text += f"{COLORS['blue']} ๐จ ะกะพะพะฑัะตะฝะธะน:\n"
    text += f"โ ะัะตะณะพ: {total_msgs}\n"
    text += f"โ ๐ค ะั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {user_msgs}\n"
    text += f"โ ๐จโ๐ผ ะั ะฐะดะผะธะฝะพะฒ: {admin_msgs}\n\n"
    text += f"{COLORS['violet']} โญ ะะพะฒัั ะพัะทัะฒะพะฒ: {new_reviews}\n"
    text += f"{COLORS['night']} ๐ด ะะพะฒัั ัะตััะพะฒ: {new_rests}\n\n"

    if top_admins:
        text += f"{COLORS['purple']} ๐ ะขะพะฟ ะฐะดะผะธะฝะพะฒ:\n"
        for tag, count in top_admins:
            text += f"{COLORS['blue']}    {tag}: {count} ัะพะพะฑั.\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
        ]])
    )


async def process_rest_start_date(update: Update, context, text):
    user = update.effective_user
    user_tag = get_user_tag(user.id)

    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
            ]])
        )
        del context.user_data['awaiting_rest_start_date']
        return

    active_rest = check_active_rest(user.id)
    if active_rest:
        rest_id, start_date, end_date, reason = active_rest
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ัะถะต ะตััั ะฐะบัะธะฒะฝัะน ัะตัั!\n\n{COLORS['blue']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n{COLORS['violet']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
            ]])
        )
        del context.user_data['awaiting_rest_start_date']
        return

    try:
        start_date = datetime.strptime(text.strip(), '%d.%m.%Y')
        if start_date < datetime.now() - timedelta(days=1):
            await update.message.reply_text(
                f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะฐัะฐ ะฝะฐัะฐะปะฐ ะฝะต ะผะพะถะตั ะฑััั ะฒ ะฟัะพัะปะพะผ.\nะะพะฟัะพะฑัะนัะต ะตัะต ัะฐะท:",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
                ]])
            )
            return
    except ValueError:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ัะพัะผะฐัะฐ\n\n{COLORS['blue']} ะัะฟะพะปัะทัะนัะต ัะพัะผะฐั ะะ.ะะ.ะะะะ\nะะฐะฟัะธะผะตั: 12.09.2005",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        return

    context.user_data['rest_start_date'] = start_date.strftime('%d.%m.%Y')
    del context.user_data['awaiting_rest_start_date']
    context.user_data['awaiting_rest_end_date'] = True

    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date.strftime('%d.%m.%Y')}\n\n{COLORS['blue']} ะขะตะฟะตัั ะฒะฒะตะดะธัะต ะดะฐัั ะพะบะพะฝัะฐะฝะธั ัะตััะฐ\nะฒ ัะพัะผะฐัะต ะะ.ะะ.ะะะะ\n\nะะฐะฟัะธะผะตั: 13.09.2005",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
        ]])
    )


async def process_rest_end_date(update: Update, context, text):
    user = update.effective_user

    start_date_str = context.user_data.get('rest_start_date')
    if not start_date_str:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะฐัะฐ ะฝะฐัะฐะปะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ. ะะฐัะฝะธัะต ะทะฐะฝะพะฒะพ."
        )
        context.user_data.clear()
        return

    try:
        end_date = datetime.strptime(text.strip(), '%d.%m.%Y')
        start_date = datetime.strptime(start_date_str, '%d.%m.%Y')

        if end_date <= start_date:
            await update.message.reply_text(
                f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั ะดะพะปะถะฝะฐ ะฑััั ะฟะพะทะถะต ะดะฐัั ะฝะฐัะฐะปะฐ.\nะะพะฟัะพะฑัะนัะต ะตัะต ัะฐะท:",
                reply_markup=InlineKeyboardMarkup([[
                    create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
                ]])
            )
            return
    except ValueError:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ัะพัะผะฐัะฐ\n\n{COLORS['blue']} ะัะฟะพะปัะทัะนัะต ัะพัะผะฐั ะะ.ะะ.ะะะะ\nะะฐะฟัะธะผะตั: 13.09.2005",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        return

    context.user_data['rest_end_date'] = end_date.strftime('%d.%m.%Y')
    del context.user_data['awaiting_rest_end_date']
    context.user_data['awaiting_rest_reason'] = True

    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date.strftime('%d.%m.%Y')}\n\n{COLORS['blue']} ะขะตะฟะตัั ะฝะฐะฟะธัะธัะต ะฟัะธัะธะฝั ัะตััะฐ:",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
        ]])
    )


async def process_rest_reason(update: Update, context, text):
    user = update.effective_user
    user_tag = get_user_tag(user.id)

    start_date = context.user_data.get('rest_start_date')
    end_date = context.user_data.get('rest_end_date')

    if not start_date or not end_date:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะฐัั ะฝะต ะฝะฐะนะดะตะฝั. ะะฐัะฝะธัะต ะทะฐะฝะพะฒะพ."
        )
        context.user_data.clear()
        return

    active_rest = check_active_rest(user.id)
    if active_rest:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ัะถะต ะตััั ะฐะบัะธะฒะฝัะน ัะตัั!",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
            ]])
        )
        context.user_data.clear()
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""INSERT INTO rests 
                 (admin_id, admin_tag, admin_name, start_date, end_date, reason, status, created_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
              (user.id, user_tag, user.full_name, start_date, end_date, text, 'active', get_current_time()))
    rest_id = c.lastrowid
    conn.commit()

    if RESTS_THREAD_ID:
        rest_text = f"{COLORS['purple']} ๐ด ะะะะซะ ะะะกะข\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {user_tag}\n{COLORS['violet']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n{COLORS['night']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n{COLORS['purple']} ๐ ะัะธัะธะฝะฐ: {text}"

        sent_message = await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=RESTS_THREAD_ID,
            text=rest_text,
            reply_markup=get_rest_actions_keyboard(rest_id, user.id)
        )

        c.execute("UPDATE rests SET message_id = ?, thread_id = ? WHERE id = ?",
                  (sent_message.message_id, RESTS_THREAD_ID, rest_id))
        conn.commit()

    conn.close()

    context.user_data.clear()

    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะะกะข ะะคะะะะะะ!\n\n{COLORS['blue']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n{COLORS['violet']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {text}\n\n{COLORS['fog']} {COLORS['cloud']} ะฅะพัะพัะตะณะพ ะพัะดััะฐ! {COLORS['cloud']}",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
        ]])
    )


async def process_rest_extend_date(update: Update, context, text):
    user = update.effective_user

    rest_id = context.user_data.get('extend_rest_id')
    admin_id = context.user_data.get('extend_admin_id')

    if not rest_id or not admin_id:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะตัั ะฝะต ะฝะฐะนะดะตะฝ"
        )
        return

    if user.id != admin_id:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะขะพะปัะบะพ ะฒะปะฐะดะตะปะตั ัะตััะฐ ะผะพะถะตั ะตะณะพ ะฟัะพะดะปะธัั"
        )
        return

    try:
        new_end_date = datetime.strptime(text.strip(), '%d.%m.%Y')
    except ValueError:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ัะพัะผะฐัะฐ\n\n{COLORS['blue']} ะัะฟะพะปัะทัะนัะต ัะพัะผะฐั ะะ.ะะ.ะะะะ\nะะฐะฟัะธะผะตั: 13.09.2005",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT start_date, end_date, reason, admin_tag FROM rests WHERE id = ?", (rest_id,))
    rest = c.fetchone()

    if not rest:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะตัั ะฝะต ะฝะฐะนะดะตะฝ"
        )
        conn.close()
        return

    start_date, old_end_date, reason, admin_tag = rest

    old_end = datetime.strptime(old_end_date, '%d.%m.%Y')
    if new_end_date <= old_end:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะะพะฒะฐั ะดะฐัะฐ ะพะบะพะฝัะฐะฝะธั ะดะพะปะถะฝะฐ ะฑััั ะฟะพะทะถะต ัะตะบััะตะน",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะัะผะตะฝะฐ", "rests_menu", 'fog')
            ]])
        )
        conn.close()
        return

    c.execute("UPDATE rests SET end_date = ? WHERE id = ?", (new_end_date.strftime('%d.%m.%Y'), rest_id))

    c.execute("SELECT message_id, thread_id FROM rests WHERE id = ?", (rest_id,))
    msg_info = c.fetchone()
    conn.commit()
    conn.close()

    if msg_info and msg_info[0]:
        try:
            rest_text = f"{COLORS['purple']} ๐ด ะะะกะข ะะะะะะะ\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {admin_tag}\n{COLORS['violet']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n{COLORS['night']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {new_end_date.strftime('%d.%m.%Y')} (ะฑัะปะพ: {old_end_date})\n{COLORS['purple']} ๐ ะัะธัะธะฝะฐ: {reason}"

            await context.bot.edit_message_text(
                chat_id=ADMIN_GROUP_ID,
                message_id=msg_info[0],
                text=rest_text,
                reply_markup=get_rest_actions_keyboard(rest_id, admin_id)
            )
        except Exception as e:
            logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ัะพะพะฑัะตะฝะธั: {e}")

    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะตัั ะฟัะพะดะปะตะฝ ะดะพ {new_end_date.strftime('%d.%m.%Y')}",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
        ]])
    )

    del context.user_data['extend_rest_id']
    del context.user_data['extend_admin_id']
    del context.user_data['awaiting_rest_extend_date']


async def show_rests_by_status(query, context, status, title):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    if status == "all":
        c.execute("""SELECT id, admin_tag, start_date, end_date, reason, status 
                     FROM rests 
                     ORDER BY created_at DESC""")
    else:
        c.execute("""SELECT id, admin_tag, start_date, end_date, reason, status 
                     FROM rests 
                     WHERE status = ? 
                     ORDER BY created_at DESC""", (status,))

    rests = c.fetchall()
    conn.close()

    if not rests:
        await query.edit_message_text(
            f"{COLORS['purple']} {title}:\n\n{COLORS['blue']} ะะตั ัะตััะพะฒ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')
            ]])
        )
        return

    text = f"{COLORS['purple']} {title}:\n\n"
    now = datetime.now()

    for rest in rests[:10]:
        rest_id, admin_tag, start_date, end_date, reason, status = rest

        end = datetime.strptime(end_date, '%d.%m.%Y')
        days_left = (end - now).days

        status_emoji = "๐ด" if status == "active" else "โ"
        time_info = f" (ะพััะฐะปะพัั {days_left} ะดะฝ.)" if status == "active" and days_left >= 0 else ""

        text += f"{COLORS['blue']} {status_emoji} {admin_tag}\n"
        text += f"{COLORS['violet']}    ๐ {start_date} - {end_date}{time_info}\n"
        text += f"{COLORS['night']}    ๐ ะัะธัะธะฝะฐ: {reason}\n"
        text += f"{COLORS['purple']}    ๐ ID: {rest_id}\n\n"

    keyboard = [
        [create_fancy_button("๐ ะะฑะฝะพะฒะธัั", f"rests_{'active' if status == 'active' else 'history'}", 'moon')],
        [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')]
    ]

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def show_rests_stats(query, context):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM rests")
    total = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'active'")
    active = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'completed'")
    completed = c.fetchone()[0] or 0

    c.execute("""SELECT admin_tag, COUNT(*) as rest_count, 
                        AVG(julianday(substr(end_date,7,4)||'-'||substr(end_date,4,2)||'-'||substr(end_date,1,2)) - 
                             julianday(substr(start_date,7,4)||'-'||substr(start_date,4,2)||'-'||substr(start_date,1,2))) as avg_duration
                 FROM rests 
                 GROUP BY admin_id 
                 ORDER BY rest_count DESC 
                 LIMIT 5""")
    admin_stats = c.fetchall()

    c.execute("""SELECT admin_tag, end_date FROM rests 
                 WHERE status = 'active' 
                 ORDER BY end_date""")
    active_rests = c.fetchall()

    conn.close()

    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะกะขะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ัะตััะพะฒ: {total}\n"
    text += f"{COLORS['violet']} ๐ด ะะบัะธะฒะฝัั: {active}\n"
    text += f"{COLORS['night']} โ ะะฐะฒะตััะตะฝะพ: {completed}\n\n"

    if active_rests:
        text += f"{COLORS['purple']} ะะบัะธะฒะฝัะต ัะตััั:\n"
        now = datetime.now()
        for tag, end_date in active_rests:
            end = datetime.strptime(end_date, '%d.%m.%Y')
            days_left = (end - now).days
            text += f"{COLORS['blue']} โข {tag}: ะดะพ {end_date} (ะพััะฐะปะพัั {days_left} ะดะฝ.)\n"
        text += "\n"

    if admin_stats:
        text += f"{COLORS['violet']} ะขะพะฟ ะฟะพ ัะตััะฐะผ:\n"
        for tag, count, avg_duration in admin_stats:
            text += f"{COLORS['night']} โข {tag}: {count} ัะตััะพะฒ, ััะตะดะฝัั ะดะปะธั. {avg_duration:.1f} ะดะฝ.\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')
        ]])
    )


async def early_return_from_rest(query, context, rest_id, admin_id):
    user_id = query.from_user.id

    if user_id != admin_id:
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ\n\n{COLORS['blue']} ะขะพะปัะบะพ ะฒะปะฐะดะตะปะตั ัะตััะฐ ะผะพะถะตั ะฒัะนัะธ ะธะท ะฝะตะณะพ ะดะพััะพัะฝะพ.",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')
            ]])
        )
        return

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    c.execute("SELECT admin_tag, start_date, end_date, reason, message_id, thread_id FROM rests WHERE id = ?",
              (rest_id,))
    rest = c.fetchone()

    if not rest:
        await query.edit_message_text(f"โ ะะตัั ะฝะต ะฝะฐะนะดะตะฝ")
        conn.close()
        return

    admin_tag, start_date, end_date, reason, msg_id, thread_id = rest

    c.execute("""UPDATE rests 
                 SET status = 'completed', completed_at = ? 
                 WHERE id = ?""",
              (get_current_time(), rest_id))
    conn.commit()
    conn.close()

    if msg_id:
        try:
            new_text = f"{COLORS['purple']} ๐ ะะะกะะะงะะซะ ะะซะฅะะ ะะ ะะะกะขะ\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {admin_tag}\n{COLORS['violet']} ๐ ะัะป ะฒ ัะตััะต: {start_date} - {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n{COLORS['purple']} โฑ ะััะตะป: {get_current_time()[:16]}"

            await context.bot.edit_message_text(
                chat_id=ADMIN_GROUP_ID,
                message_id=msg_id,
                text=new_text,
                reply_markup=None
            )
        except Exception as e:
            if "Message is not modified" not in str(e):
                logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ัะพะพะฑัะตะฝะธั: {e}")

    await query.edit_message_text(
        f"{COLORS['purple']} โ ะั ะดะพััะพัะฝะพ ะฒััะปะธ ะธะท ัะตััะฐ\n\n{COLORS['blue']} ะขะตะฟะตัั ะฒั ัะฝะพะฒะฐ ะผะพะถะตัะต ะฑัะฐัั ะทะฐัะฒะบะธ!",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
        ]])
    )


async def view_rest_info(query, context, rest_id):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT * FROM rests WHERE id = ?", (rest_id,))
    rest = c.fetchone()
    conn.close()

    if not rest:
        await query.edit_message_text(f"โ ะะตัั ะฝะต ะฝะฐะนะดะตะฝ")
        return

    (rest_id, admin_id, admin_tag, admin_name, start_date, end_date,
     reason, status, created_at, completed_at, notified, msg_id, thread_id) = rest

    now = datetime.now()
    end = datetime.strptime(end_date, '%d.%m.%Y')
    days_left = (end - now).days

    status_emoji = "๐ด" if status == "active" else "โ"
    status_text = "ะะบัะธะฒะตะฝ" if status == "active" else "ะะฐะฒะตััะตะฝ"

    text = f"{COLORS['purple']} {status_emoji} ะะะคะะะะะฆะะฏ ะ ะะะกะขะ\n\n"
    text += f"{COLORS['blue']} ๐ ID: #{rest_id}\n"
    text += f"{COLORS['violet']} ๐ค ะะดะผะธะฝ: {admin_tag} ({admin_name})\n"
    text += f"{COLORS['night']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n"
    text += f"{COLORS['purple']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n"

    if status == 'active':
        text += f"{COLORS['blue']} โณ ะััะฐะปะพัั ะดะฝะตะน: {days_left}\n"
    if completed_at:
        text += f"{COLORS['violet']} โ ะะฐะฒะตััะตะฝ: {completed_at}\n"
    text += f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n"
    text += f"{COLORS['purple']} ๐ ะกัะฐััั: {status_text}"

    keyboard = [[create_fancy_button("โ๏ธ ะะฐะทะฐะด", "rests_menu", 'fog')]]

    if status == 'active' and query.from_user.id == admin_id:
        keyboard.insert(0, [
            create_fancy_button("๐ ะะพััะพัะฝัะน ะฒััะพะด", f"rest_early_{rest_id}_{admin_id}", 'night'),
            create_fancy_button("โ ะัะพะดะปะธัั", f"rest_extend_{rest_id}_{admin_id}", 'moon')
        ])

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def kick_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user
    reason = ' '.join(context.args) if context.args else "ะะต ัะบะฐะทะฐะฝะฐ"

    try:
        await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id)
        await context.bot.unban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id)

        conn_kick = sqlite3.connect('support_bot.db')
        c_kick = conn_kick.cursor()
        c_kick.execute("""SELECT id, start_date, end_date, reason, message_id, thread_id 
                         FROM rests WHERE admin_id = ? AND status = 'active'""", (target.id,))
        active_rest_kick = c_kick.fetchone()

        if active_rest_kick:
            rest_id, start_date, end_date, reason_rest, msg_id, thread_id = active_rest_kick
            c_kick.execute("""UPDATE rests SET status = 'completed', completed_at = ? 
                             WHERE id = ?""", (get_current_time(), rest_id))

            if msg_id:
                try:
                    new_text = f"{COLORS['purple']} ๐ ะะะกะข ะะะะะะจะะ (ะฟะพะปัะทะพะฒะฐัะตะปั ะบะธะบะฝัั)\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {get_user_tag(target.id)}\n{COLORS['violet']} ๐ ะัะป ะฒ ัะตััะต: {start_date} - {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason_rest}\n{COLORS['purple']} โฑ ะะฐะฒะตััะตะฝ: {get_current_time()[:16]}"

                    await context.bot.edit_message_text(
                        chat_id=ADMIN_GROUP_ID,
                        message_id=msg_id,
                        text=new_text,
                        reply_markup=None
                    )
                except:
                    pass
            conn_kick.commit()
        conn_kick.close()

        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะธัะบะปััะตะฝ\n{COLORS['blue']} ะัะธัะธะฝะฐ: {reason}"
        )
    except Exception as e:
        await update.message.reply_text(f"โ ะัะธะฑะบะฐ: {e}")

async def unmute_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฟัะฐะฒ")
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user

    try:
        # ะัะฐะฒะธะปัะฝัะต ะฟัะฐะฒะฐ ะดะปั ัะฐะทะผััะฐ
        permissions = ChatPermissions(
            can_send_messages=True,
            can_send_other_messages=True,
            can_add_web_page_previews=True,
            can_send_polls=True,
            can_change_info=False,  # ะะฟัะธะพะฝะฐะปัะฝะพ
            can_invite_users=False,  # ะะฟัะธะพะฝะฐะปัะฝะพ
            can_pin_messages=False   # ะะฟัะธะพะฝะฐะปัะฝะพ
        )
        
        await context.bot.restrict_chat_member(
            chat_id=ADMIN_GROUP_ID,
            user_id=target.id,
            permissions=permissions
        )
        
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ัะฐะทะผััะตะฝ"
        )
    except Exception as e:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ: {e}")


async def ban_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user
    args = context.args

    ban_time = "ะฝะฐะฒัะตะณะดะฐ"
    reason = "ะะต ัะบะฐะทะฐะฝะฐ"

    if args:
        if args[0] in ["ะฝะฐะฒัะตะณะดะฐ", "forever"]:
            ban_time = "ะฝะฐะฒัะตะณะดะฐ"
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        else:
            time_str = args[0]
            if time_str.endswith('ะดะตะฝั') or time_str.endswith('ะดะฝะตะน') or time_str.endswith('ะดะฝ'):
                try:
                    days = int(''.join(filter(str.isdigit, time_str)))
                    ban_time = timedelta(days=days)
                    reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
                except:
                    reason = ' '.join(args)
            else:
                reason = ' '.join(args)

    try:
        if ban_time == "ะฝะฐะฒัะตะณะดะฐ":
            await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id)
            time_text = "ะฝะฐะฒัะตะณะดะฐ"

            conn_ban = sqlite3.connect('support_bot.db')
            c_ban = conn_ban.cursor()
            c_ban.execute("""SELECT id, start_date, end_date, reason, message_id, thread_id 
                             FROM rests WHERE admin_id = ? AND status = 'active'""", (target.id,))
            active_rest_ban = c_ban.fetchone()

            if active_rest_ban:
                rest_id, start_date, end_date, reason_rest, msg_id, thread_id = active_rest_ban
                c_ban.execute("""UPDATE rests SET status = 'completed', completed_at = ? 
                                 WHERE id = ?""", (get_current_time(), rest_id))

                if msg_id:
                    try:
                        new_text = f"{COLORS['purple']} ๐ ะะะกะข ะะะะะะจะะ (ะฟะพะปัะทะพะฒะฐัะตะปั ะทะฐะฑะฐะฝะตะฝ)\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {get_user_tag(target.id)}\n{COLORS['violet']} ๐ ะัะป ะฒ ัะตััะต: {start_date} - {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason_rest}\n{COLORS['purple']} โฑ ะะฐะฒะตััะตะฝ: {get_current_time()[:16]}"

                        await context.bot.edit_message_text(
                            chat_id=ADMIN_GROUP_ID,
                            message_id=msg_id,
                            text=new_text,
                            reply_markup=None
                        )
                    except:
                        pass
                conn_ban.commit()
            conn_ban.close()

        else:
            until_date = datetime.now() + ban_time
            await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id, until_date=until_date)
            time_text = f"ะฝะฐ {ban_time.days} ะดะฝะตะน"

        await update.message.reply_text(
            f"{COLORS['purple']} ๐จ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะทะฐะฑะฐะฝะตะฝ {time_text}\n{COLORS['blue']} ะัะธัะธะฝะฐ: {reason}"
        )
    except Exception as e:
        await update.message.reply_text(f"โ ะัะธะฑะบะฐ: {e}")


async def unban_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฟัะฐะฒ")
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user

    try:
        await context.bot.unban_chat_member(
            chat_id=ADMIN_GROUP_ID,
            user_id=target.id,
            only_if_banned=True
        )
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ัะฐะทะฑะฐะฝะตะฝ"
        )
    except Exception as e:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ: {e}")


async def mute_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user
    args = context.args

    mute_time = 60
    reason = "ะะต ัะบะฐะทะฐะฝะฐ"

    if args:
        if args[0].isdigit():
            mute_time = int(args[0])
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        elif args[0] == "ะดะตะฝั" or args[0] == "1ะดะตะฝั":
            mute_time = 24 * 60
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        else:
            reason = ' '.join(args)

    try:
        until_date = datetime.now() + timedelta(minutes=mute_time)
        await context.bot.restrict_chat_member(
            chat_id=ADMIN_GROUP_ID,
            user_id=target.id,
            permissions=ChatPermissions(can_send_messages=False),
            until_date=until_date
        )

        time_text = f"{mute_time} ะผะธะฝ" if mute_time < 24 * 60 else f"{mute_time // 24 * 60} ะดะฝะตะน"
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะทะฐะผััะตะฝ ะฝะฐ {time_text}\n{COLORS['blue']} ะัะธัะธะฝะฐ: {reason}"
        )
    except Exception as e:
        await update.message.reply_text(f"โ ะัะธะฑะบะฐ: {e}")


async def unban_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฟัะฐะฒ")
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user

    try:
        await context.bot.unban_chat_member(
            chat_id=ADMIN_GROUP_ID,
            user_id=target.id,
            only_if_banned=True
        )
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ัะฐะทะฑะฐะฝะตะฝ"
        )
    except Exception as e:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ: {e}")


async def warn_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user
    args = context.args

    warn_duration = "ะฝะฐะฒัะตะณะดะฐ"
    reason = "ะะต ัะบะฐะทะฐะฝะฐ"

    if args:
        if args[0] in ["ะฝะฐะฒัะตะณะดะฐ", "forever"]:
            warn_duration = "ะฝะฐะฒัะตะณะดะฐ"
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        elif args[0] in ["ะฝะตะดะตะปั", "week"]:
            warn_duration = timedelta(days=7)
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        elif args[0] in ["ะผะตััั", "month"]:
            warn_duration = timedelta(days=30)
            reason = ' '.join(args[1:]) if len(args) > 1 else "ะะต ัะบะฐะทะฐะฝะฐ"
        else:
            reason = ' '.join(args)

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    expires_at = None
    if warn_duration != "ะฝะฐะฒัะตะณะดะฐ":
        expires_at = (datetime.now() + warn_duration).strftime('%Y-%m-%d %H:%M:%S')

    c.execute("""INSERT INTO warnings (user_id, admin_id, reason, created_at, expires_at)
                 VALUES (?, ?, ?, ?, ?)""",
              (target.id, admin_id, reason, get_current_time(), expires_at))

    c.execute("""SELECT COUNT(*) FROM warnings 
                 WHERE user_id = ? AND (expires_at IS NULL OR expires_at > ?)""",
              (target.id, get_current_time()))
    warn_count = c.fetchone()[0] or 0

    if warn_count >= MAX_WARNS:
        await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id)
        await context.bot.unban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=target.id)
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะธัะบะปััะตะฝ\n{COLORS['blue']} ะัะธัะธะฝะฐ: ะฟัะตะฒััะตะฝะธะต ะปะธะผะธัะฐ ะฒะฐัะฝะพะฒ ({MAX_WARNS})"
        )
    else:
        duration_text = "ะฝะฐะฒัะตะณะดะฐ" if warn_duration == "ะฝะฐะฒัะตะณะดะฐ" else f"ะฝะฐ {warn_duration.days} ะดะฝะตะน"
        await update.message.reply_text(
            f"{COLORS['purple']} โ๏ธ ะะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะฟะพะปััะธะป ะฒะฐัะฝ {duration_text}\n{COLORS['blue']} ะัะธัะธะฝะฐ: {reason}\n{COLORS['violet']} ะัะตะณะพ ะฒะฐัะฝะพะฒ: {warn_count}/{MAX_WARNS}"
        )

    conn.commit()
    conn.close()


async def unwarn_user(update: Update, context):
    admin_id = update.effective_user.id
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฟัะฐะฒ")
        return

    if not update.message.reply_to_message:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะฒะตัััะต ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั")
        return

    target = update.message.reply_to_message.from_user

    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะฃะดะฐะปัะตะผ ะฟะพัะปะตะดะฝะธะน ะฒะฐัะฝ
    c.execute("""DELETE FROM warnings 
                 WHERE id = (SELECT id FROM warnings 
                             WHERE user_id = ? 
                             ORDER BY created_at DESC LIMIT 1)""",
              (target.id,))
    
    if c.rowcount > 0:
        conn.commit()
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะก ะฟะพะปัะทะพะฒะฐัะตะปั {target.full_name} ัะฝััะพ ะพะดะฝะพ ะฟัะตะดัะฟัะตะถะดะตะฝะธะต"
        )
    else:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฟะพะปัะทะพะฒะฐัะตะปั {target.full_name} ะฝะตั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน"
        )
    
    conn.close()


async def process_leave_temp(query, context, user_id):
    if query.from_user.id != user_id:
        await query.answer("ะญัะพ ะฝะต ะฒะฐัะฐ ะบะพะผะฐะฝะดะฐ!")
        return

    try:
        await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=user_id)
        await context.bot.unban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=user_id)

        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()

        c.execute("UPDATE user_tags SET is_active = 0 WHERE user_id = ?", (user_id,))

        c.execute("""SELECT id, start_date, end_date, reason, message_id, thread_id 
                     FROM rests WHERE admin_id = ? AND status = 'active'""", (user_id,))
        active_rest = c.fetchone()

        if active_rest:
            rest_id, start_date, end_date, reason, msg_id, thread_id = active_rest
            c.execute("""UPDATE rests SET status = 'completed', completed_at = ? 
                         WHERE id = ?""", (get_current_time(), rest_id))

            if msg_id:
                try:
                    new_text = f"{COLORS['purple']} ๐ ะะะกะข ะะะะะะจะะ (ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะบะธะฝัะป ะฑะพั)\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {get_user_tag(user_id)}\n{COLORS['violet']} ๐ ะัะป ะฒ ัะตััะต: {start_date} - {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n{COLORS['purple']} โฑ ะะฐะฒะตััะตะฝ: {get_current_time()[:16]}"

                    await context.bot.edit_message_text(
                        chat_id=ADMIN_GROUP_ID,
                        message_id=msg_id,
                        text=new_text,
                        reply_markup=None
                    )
                except:
                    pass

        conn.commit()
        conn.close()

        await query.edit_message_text(
            f"{COLORS['purple']} โ ะั ะฒัะตะผะตะฝะฝะพ ะฟะพะบะธะฝัะปะธ ะฑะพั\n\n{COLORS['blue']} ะะปั ะฒะพะทะฒัะฐัะฐ ะธัะฟะพะปัะทัะนัะต /start",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะ ะผะตะฝั", "admin_main_menu", 'fog')
            ]])
        )
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะบะธะบะต: {e}")
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ะฒัะฟะพะปะฝะตะฝะธะธ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
            ]])
        )


async def process_leave_forever(query, context, user_id):
    if query.from_user.id != user_id:
        await query.answer("ะญัะพ ะฝะต ะฒะฐัะฐ ะบะพะผะฐะฝะดะฐ!")
        return

    try:
        await context.bot.ban_chat_member(chat_id=ADMIN_GROUP_ID, user_id=user_id)

        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()

        c.execute("UPDATE user_tags SET is_active = 0 WHERE user_id = ?", (user_id,))

        c.execute(
            "UPDATE active_chats SET status = 'pending', taken_by_id = NULL, taken_by_tag = NULL WHERE user_id = ?",
            (user_id,))

        c.execute("""SELECT id, start_date, end_date, reason, message_id, thread_id 
                     FROM rests WHERE admin_id = ? AND status = 'active'""", (user_id,))
        active_rest = c.fetchone()

        if active_rest:
            rest_id, start_date, end_date, reason, msg_id, thread_id = active_rest
            c.execute("""UPDATE rests SET status = 'completed', completed_at = ? 
                         WHERE id = ?""", (get_current_time(), rest_id))

            if msg_id:
                try:
                    new_text = f"{COLORS['purple']} ๐ ะะะกะข ะะะะะะจะะ (ะฟะพะปัะทะพะฒะฐัะตะปั ะทะฐะฑะฐะฝะตะฝ)\n\n{COLORS['blue']} ๐ค ะะดะผะธะฝ: {get_user_tag(user_id)}\n{COLORS['violet']} ๐ ะัะป ะฒ ัะตััะต: {start_date} - {end_date}\n{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n{COLORS['purple']} โฑ ะะฐะฒะตััะตะฝ: {get_current_time()[:16]}"

                    await context.bot.edit_message_text(
                        chat_id=ADMIN_GROUP_ID,
                        message_id=msg_id,
                        text=new_text,
                        reply_markup=None
                    )
                except:
                    pass

        conn.commit()
        conn.close()

        await query.edit_message_text(
            f"{COLORS['purple']} ๐ด ะั ะฝะฐะฒัะตะณะดะฐ ะฟะพะบะธะฝัะปะธ ะฑะพั\n\n{COLORS['blue']} ะะพะทะฒัะฐั ะฝะตะฒะพะทะผะพะถะตะฝ",
            reply_markup=None
        )
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะฑะฐะฝะต: {e}")
        await query.edit_message_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ะฒัะฟะพะปะฝะตะฝะธะธ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')
            ]])
        )

async def show_rests_by_status(query, context, status, title):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    if status == "all":
        c.execute("""SELECT id, admin_tag, start_date, end_date, reason, status 
                     FROM rests ORDER BY created_at DESC""")
    else:
        c.execute("""SELECT id, admin_tag, start_date, end_date, reason, status 
                     FROM rests WHERE status = ? ORDER BY created_at DESC""", (status,))
    rests = c.fetchall()
    conn.close()
    if not rests:
        await query.edit_message_text(f"{COLORS['purple']} {title}:\n\n{COLORS['blue']} ะะตั ัะตััะพะฒ")
        return
    text = f"{COLORS['purple']} {title}:\n\n"
    now = datetime.now()
    for rest in rests[:10]:
        rest_id, admin_tag, start_date, end_date, reason, status = rest
        end = datetime.strptime(end_date, '%d.%m.%Y')
        days_left = (end - now).days
        status_emoji = "๐ด" if status == "active" else "โ"
        time_info = f" (ะพััะฐะปะพัั {days_left} ะดะฝ.)" if status == "active" and days_left >= 0 else ""
        text += f"{COLORS['blue']} {status_emoji} {admin_tag}\n"
        text += f"{COLORS['violet']}    ๐ {start_date} - {end_date}{time_info}\n"
        text += f"{COLORS['night']}    ๐ {reason}\n\n"
    await query.edit_message_text(text)


async def show_rests_stats(query, context):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM rests")
    total = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'active'")
    active = c.fetchone()[0] or 0
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'completed'")
    completed = c.fetchone()[0] or 0
    c.execute("""SELECT admin_tag, COUNT(*) as rest_count 
                 FROM rests GROUP BY admin_id ORDER BY rest_count DESC LIMIT 5""")
    admin_stats = c.fetchall()
    c.execute("""SELECT admin_tag, end_date FROM rests 
                 WHERE status = 'active' ORDER BY end_date""")
    active_rests = c.fetchall()
    conn.close()
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะกะขะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ัะตััะพะฒ: {total}\n"
    text += f"{COLORS['violet']} ๐ด ะะบัะธะฒะฝัั: {active}\n"
    text += f"{COLORS['night']} โ ะะฐะฒะตััะตะฝะพ: {completed}\n\n"
    if active_rests:
        text += f"{COLORS['purple']} ะะบัะธะฒะฝัะต ัะตััั:\n"
        now = datetime.now()
        for tag, end_date in active_rests:
            end = datetime.strptime(end_date, '%d.%m.%Y')
            days_left = (end - now).days
            text += f"{COLORS['blue']} โข {tag}: ะดะพ {end_date} (ะพััะฐะปะพัั {days_left} ะดะฝ.)\n"
        text += "\n"
    if admin_stats:
        text += f"{COLORS['violet']} ะขะพะฟ ะฟะพ ัะตััะฐะผ:\n"
        for tag, count in admin_stats:
            text += f"{COLORS['night']} โข {tag}: {count} ัะตััะพะฒ\n"
    await query.edit_message_text(text)


async def early_return_from_rest(query, context, rest_id, admin_id):
    user_id = query.from_user.id
    if user_id != admin_id:
        await query.edit_message_text(f"{COLORS['purple']} โ ะขะพะปัะบะพ ะฒะปะฐะดะตะปะตั ัะตััะฐ ะผะพะถะตั ะฒัะนัะธ ะดะพััะพัะฝะพ")
        return
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT admin_tag, start_date, end_date, reason FROM rests WHERE id = ?", (rest_id,))
    rest = c.fetchone()
    if not rest:
        await query.edit_message_text(f"โ ะะตัั ะฝะต ะฝะฐะนะดะตะฝ")
        conn.close()
        return
    admin_tag, start_date, end_date, reason = rest
    c.execute("UPDATE rests SET status = 'completed', completed_at = ? WHERE id = ?",
              (get_current_time(), rest_id))
    conn.commit()
    conn.close()
    await query.edit_message_text(
        f"{COLORS['purple']} โ ะั ะดะพััะพัะฝะพ ะฒััะปะธ ะธะท ัะตััะฐ\n\n"
        f"{COLORS['blue']} ะขะตะฟะตัั ะฒั ัะฝะพะฒะฐ ะผะพะถะตัะต ะฑัะฐัั ะทะฐัะฒะบะธ!"
    )


async def view_rest_info(query, context, rest_id):
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT * FROM rests WHERE id = ?", (rest_id,))
    rest = c.fetchone()
    conn.close()
    if not rest:
        await query.edit_message_text(f"โ ะะตัั ะฝะต ะฝะฐะนะดะตะฝ")
        return
    rest_id, admin_id, admin_tag, admin_name, start_date, end_date, reason, status, created_at, completed_at, notified, msg_id, thread_id = rest
    now = datetime.now()
    end = datetime.strptime(end_date, '%d.%m.%Y')
    days_left = (end - now).days
    status_emoji = "๐ด" if status == "active" else "โ"
    status_text = "ะะบัะธะฒะตะฝ" if status == "active" else "ะะฐะฒะตััะตะฝ"
    text = f"{COLORS['purple']} {status_emoji} ะะะคะะะะะฆะะฏ ะ ะะะกะขะ\n\n"
    text += f"{COLORS['blue']} ๐ ID: #{rest_id}\n"
    text += f"{COLORS['violet']} ๐ค ะะดะผะธะฝ: {admin_tag}\n"
    text += f"{COLORS['night']} ๐ ะะฐัะฐ ะฝะฐัะฐะปะฐ: {start_date}\n"
    text += f"{COLORS['purple']} ๐ ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั: {end_date}\n"
    if status == 'active':
        text += f"{COLORS['blue']} โณ ะััะฐะปะพัั ะดะฝะตะน: {days_left}\n"
    if completed_at:
        text += f"{COLORS['violet']} โ ะะฐะฒะตััะตะฝ: {completed_at[:16]}\n"
    text += f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n"
    text += f"{COLORS['purple']} ๐ ะกัะฐััั: {status_text}"
    await query.edit_message_text(text)


def get_message_type(message):
    if message.text:
        return "ัะตะบัั"
    elif message.photo:
        return "ัะพัะพ"
    elif message.video:
        return "ะฒะธะดะตะพ"
    elif message.document:
        return "ะดะพะบัะผะตะฝั"
    elif message.audio:
        return "ะฐัะดะธะพ"
    elif message.voice:
        return "ะณะพะปะพัะพะฒะพะต"
    elif message.sticker:
        return "ััะธะบะตั"
    elif message.animation:
        return "gif"
    elif message.video_note:
        return "ะฒะธะดะตะพัะพะพะฑัะตะฝะธะต"
    else:
        return "ะฝะตะธะทะฒะตััะฝัะน ัะธะฟ"


async def copy_message_to_chat(context, message, chat_id, thread_id=None, caption_prefix=""):
    try:
        if message.text:
            await context.bot.send_message(
                chat_id=chat_id, message_thread_id=thread_id,
                text=f"{caption_prefix}\n\n{message.text}"
            )
        elif message.photo:
            await context.bot.send_photo(
                chat_id=chat_id, message_thread_id=thread_id,
                photo=message.photo[-1].file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.video:
            await context.bot.send_video(
                chat_id=chat_id, message_thread_id=thread_id,
                video=message.video.file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.document:
            await context.bot.send_document(
                chat_id=chat_id, message_thread_id=thread_id,
                document=message.document.file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.audio:
            await context.bot.send_audio(
                chat_id=chat_id, message_thread_id=thread_id,
                audio=message.audio.file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.voice:
            await context.bot.send_voice(
                chat_id=chat_id, message_thread_id=thread_id,
                voice=message.voice.file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.sticker:
            if caption_prefix:
                await context.bot.send_message(
                    chat_id=chat_id, message_thread_id=thread_id, text=caption_prefix
                )
            await context.bot.send_sticker(
                chat_id=chat_id, message_thread_id=thread_id, sticker=message.sticker.file_id
            )
        elif message.animation:
            await context.bot.send_animation(
                chat_id=chat_id, message_thread_id=thread_id,
                animation=message.animation.file_id,
                caption=f"{caption_prefix}\n\n{message.caption or ''}"
            )
        elif message.video_note:
            if caption_prefix:
                await context.bot.send_message(
                    chat_id=chat_id, message_thread_id=thread_id, text=caption_prefix
                )
            await context.bot.send_video_note(
                chat_id=chat_id, message_thread_id=thread_id, video_note=message.video_note.file_id
            )
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะบะพะฟะธัะพะฒะฐะฝะธะธ ัะพะพะฑัะตะฝะธั: {e}")
        await context.bot.send_message(
            chat_id=chat_id, message_thread_id=thread_id,
            text=f"{caption_prefix}\n\n[ะัะธะฑะบะฐ ะฟัะธ ะพัะฟัะฐะฒะบะต: {e}]"
        )


async def message_handler(update: Update, context):
    user = update.effective_user
    chat_id = update.effective_chat.id
    message_thread_id = update.effective_message.message_thread_id
    user_tag = get_user_tag(user.id)

    await track_user(user, context)
    if context.user_data.get('mood_tracker', {}).get('awaiting_custom_note'):
        await mood_custom_note(update, context)
        return
    
    logger.info(f"=== ะะะะะ ะกะะะะฉะะะะ ===")
    logger.info(f"ะั: {user.id} ({user.full_name})")
    logger.info(f"ะงะฐั: {chat_id}, ะขัะตะด: {message_thread_id}")
    logger.info(f"ะขะธะฟ: {get_message_type(update.message)}")
    
    # ะะตััั
    if context.user_data.get('awaiting_rest_start_date'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ัะตะบัั")
            return
        await process_rest_start_date(update, context, update.message.text)
        return

    if context.user_data.get('awaiting_rest_end_date'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ัะตะบัั")
            return
        await process_rest_end_date(update, context, update.message.text)
        return

    if context.user_data.get('awaiting_rest_reason'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ัะตะบัั")
            return
        await process_rest_reason(update, context, update.message.text)
        return

    if context.user_data.get('awaiting_rest_extend_date'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ัะตะบัั")
            return
        await process_rest_extend_date(update, context, update.message.text)
        return

    # ะะฐัััะปะบะฐ ัะตะบัั
    if context.user_data.get('awaiting_broadcast_text'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะพัะฟัะฐะฒััะต ัะตะบัั")
            return

        broadcast_text = update.message.text
        context.user_data['broadcast_content'] = broadcast_text

        keyboard = InlineKeyboardMarkup([
            [create_fancy_button("โ ะัะฟัะฐะฒะธัั ะฒัะตะผ", "confirm_broadcast", 'moon'),
             create_fancy_button("โ ะัะผะตะฝะฐ", "admin_main_menu", 'night')]
        ])

        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะะะะะะะะกะะะขะ ะะะกะกะซะะะ\n\n"
            f"{COLORS['blue']} ะขะตะบัั:\n{broadcast_text}\n\n"
            f"{COLORS['violet']} ะะพะดัะฒะตัะดะธัะต ะพัะฟัะฐะฒะบั ะฒัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ:",
            reply_markup=keyboard
        )

        del context.user_data['awaiting_broadcast_text']
        return

    # ะะฐัััะปะบะฐ ัะพัะพ
    if context.user_data.get('awaiting_broadcast_photo'):
        if not update.message.photo:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะพัะฟัะฐะฒััะต ัะพัะพ ั ะฟะพะดะฟะธััั")
            return

        photo = update.message.photo[-1]
        caption = update.message.caption or ""

        context.user_data['broadcast_photo'] = photo.file_id
        context.user_data['broadcast_caption'] = caption

        keyboard = InlineKeyboardMarkup([
            [create_fancy_button("โ ะัะฟัะฐะฒะธัั ะฒัะตะผ", "confirm_broadcast", 'moon'),
             create_fancy_button("โ ะัะผะตะฝะฐ", "admin_main_menu", 'night')]
        ])

        await update.message.reply_photo(
            photo=photo.file_id,
            caption=f"{COLORS['purple']} ๐ข ะะะะะะะะกะะะขะ ะะะกะกะซะะะ\n\n{COLORS['blue']} {caption}\n\n{COLORS['violet']} ะะพะดัะฒะตัะดะธัะต ะพัะฟัะฐะฒะบั ะฒัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ:",
            reply_markup=keyboard
        )

        del context.user_data['awaiting_broadcast_photo']
        return

    # === 2. ะะะะะะะขะะ ะะขะะซะะ (ะขะะะะฃะะข conn) ===
    if context.user_data.get('awaiting_review_text'):
        if not update.message.text:
            await update.message.reply_text(f"{COLORS['purple']} โ ะะพะถะฐะปัะนััะฐ, ะฝะฐะฟะธัะธัะต ะพัะทัะฒ ัะตะบััะพะผ")
            return

        rating = context.user_data.get('review_rating', 5)
        
        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        
        try:
            c.execute("""INSERT INTO reviews 
                         (user_id, user_name, username, rating, review_text, created_at, status)
                         VALUES (?, ?, ?, ?, ?, ?, ?)""",
                      (user.id, user.full_name, user.username, rating, update.message.text, get_current_time(), 'new'))
            review_id = c.lastrowid
            conn.commit()

            if REVIEWS_THREAD_ID:
                try:
                    stars = "โญ" * rating
                    review_text = f"{COLORS['purple']} โญ ะะะะซะ ะะขะะซะ #{review_id}\n\n{COLORS['blue']} ะัะตะฝะบะฐ: {stars} ({rating}/5)\n{COLORS['violet']} ะั: {user.full_name}\n{COLORS['night']} ID: {user.id}\n{COLORS['purple']} Username: @{user.username}\n{COLORS['blue']} ะัะตะผั: {get_current_time()}\n\nะัะทัะฒ:\n{update.message.text}"

                    sent_message = await context.bot.send_message(
                        chat_id=ADMIN_GROUP_ID,
                        message_thread_id=REVIEWS_THREAD_ID,
                        text=review_text,
                        reply_markup=get_review_keyboard(review_id)
                    )
                    
                    c.execute("UPDATE reviews SET message_id = ?, thread_id = ? WHERE id = ?",
                              (sent_message.message_id, REVIEWS_THREAD_ID, review_id))
                    conn.commit()
                except Exception as e:
                    print(f"ะัะธะฑะบะฐ ะฟัะธ ะพัะฟัะฐะฒะบะต ะฒ ััะตะด: {e}")
        finally:
            conn.close()

        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฟะฐัะธะฑะพ ะทะฐ ะฒะฐั ะพัะทัะฒ! ะะฐะผ ะพัะตะฝั ะฟัะธััะฝะพ โญ",
            reply_markup=get_user_keyboard()
        )
        
        del context.user_data['awaiting_review_text']
        del context.user_data['review_rating']
        return

    # === 3. ะะะะะะะขะะ ะะะฏะะะ ะะ ะะะะะะ (ะขะะะะฃะะข conn) ===
    if context.user_data.get('filling_app') and update.message.text:
        app_type = context.user_data.get('app_type')
        step = context.user_data.get('app_step', 0)
        answers = context.user_data.get('app_answers', [])

        answers.append(update.message.text)
        step += 1

        if app_type == "communication":
            questions = COMMUNICATION_QUESTIONS
        elif app_type == "support":
            questions = SUPPORT_QUESTIONS
        else:
            questions = BOTH_QUESTIONS

        if step < len(questions):
            context.user_data['app_step'] = step
            context.user_data['app_answers'] = answers
            await update.message.reply_text(f"{COLORS['purple']} {questions[step]}")
            return
        else:
            name = answers[0].split(',')[0].strip() if answers else "Unknown"
            
            conn = sqlite3.connect('support_bot.db')
            c = conn.cursor()
            
            try:
                c.execute("""INSERT INTO applications 
                            (user_id, username, app_type, name, answers, created_at, status)
                            VALUES (?, ?, ?, ?, ?, ?, ?)""",
                          (user.id, user.username, MESSAGE_TYPES.get(app_type, app_type), name,
                           json.dumps(answers, ensure_ascii=False), get_current_time(), 'pending'))
                app_id = c.lastrowid
                conn.commit()

                if ADMIN_APPS_THREAD_ID:
                    try:
                        app_text = f"{COLORS['purple']} ๐ ะะพะฒะฐั ะทะฐัะฒะบะฐ ะฝะฐ ะฐะดะผะธะฝะฐ #{app_id}\n\n{COLORS['blue']} ะขะธะฟ: {MESSAGE_TYPES.get(app_type, app_type)}\n{COLORS['violet']} ะั: {name}\n{COLORS['night']} ID: {user.id}\n{COLORS['purple']} Username: @{user.username}\n\nะัะตะณะพ ะพัะฒะตัะพะฒ: {len(answers)}"

                        sent_message = await context.bot.send_message(
                            chat_id=ADMIN_GROUP_ID, 
                            message_thread_id=ADMIN_APPS_THREAD_ID,
                            text=app_text, 
                            reply_markup=get_application_keyboard(app_id, user.id)
                        )
                        
                        c.execute("UPDATE applications SET message_id = ?, thread_id = ? WHERE id = ?",
                                  (sent_message.message_id, ADMIN_APPS_THREAD_ID, app_id))
                        conn.commit()
                    except Exception as e:
                        print(f"ะัะธะฑะบะฐ ะฟัะธ ะพัะฟัะฐะฒะบะต ะฒ ะฐะดะผะธะฝัะบัั ัะตะผั: {e}")
            finally:
                conn.close()

            await update.message.reply_text(
                f"{COLORS['purple']} โ ะะฝะบะตัะฐ ะพัะฟัะฐะฒะปะตะฝะฐ ะฝะฐ ัะฐััะผะพััะตะฝะธะต! {COLORS['cloud']}"
            )
            
            del context.user_data['filling_app']
            del context.user_data['app_type']
            del context.user_data['app_step']
            del context.user_data['app_answers']
            return

    # === 4. ะะกะะะะะะฏ ะงะะกะขะฌ - ะกะะะะะะ conn ===
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    try:
        # ะัะพะฒะตัะบะฐ ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ
        c.execute("SELECT status, thread_id, taken_by_id, taken_by_tag FROM active_chats WHERE user_id = ?", (user.id,))
        chat = c.fetchone()

        if chat and chat[0] == 'active':
            thread_id = chat[1]
            taker_id = chat[2]
            taker_tag = chat[3]

            await copy_message_to_chat(
                context, update.message, ADMIN_GROUP_ID, thread_id,
                f"๐ซ๏ธ {user.first_name}:"
            )

            content_type = get_message_type(update.message)
            c.execute("""INSERT INTO messages (user_id, text, from_user, created_at, is_read)
                         VALUES (?, ?, ?, ?, ?)""",
                      (user.id, f"[{content_type}]", user.id, get_current_time(), 0))
            conn.commit()
            return

        # ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะน ะทะฐัะฒะบะธ
        if context.user_data.get('awaiting_message') and not user_tag:
            msg_type = context.user_data.get('awaiting_message_type', 'communication')
            msg_type_name = MESSAGE_TYPES.get(msg_type, "๐ฌ ะะฑัะตะฝะธะต")
            
            c.execute("SELECT status FROM active_chats WHERE user_id = ?", (user.id,))
            existing_chat = c.fetchone()

            if existing_chat and existing_chat[0] == 'pending':
                await update.message.reply_text(
                    f"{COLORS['purple']} โ ะฃ ะฒะฐั ัะถะต ะตััั ะพะถะธะดะฐััะฐั ะทะฐัะฒะบะฐ")
                del context.user_data['awaiting_message']
                del context.user_data['awaiting_message_type']
                return

            thread_name = f"โณ {user.first_name}"
            thread = await context.bot.create_forum_topic(
                chat_id=ADMIN_GROUP_ID, 
                name=thread_name[:128]
            )

            content_type = get_message_type(update.message)
            c.execute("""INSERT INTO active_chats 
                         (user_id, user_name, username, thread_id, message_type, first_message, created_at, status)
                         VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                      (user.id, user.full_name, user.username, thread.message_thread_id,
                       msg_type_name, f"[{content_type}]", get_current_time(), 'pending'))
            conn.commit()

            await copy_message_to_chat(
                context, update.message, ADMIN_GROUP_ID, thread.message_thread_id,
                f"๐ซ๏ธ ะะพะฒะฐั ะทะฐัะฒะบะฐ ะพั {user.first_name}\nID: {user.id} | @{user.username}\nะขะธะฟ: {msg_type_name}"
            )

            if PENDING_CHATS_THREAD_ID:
    # ะะพะปััะฐะตะผ ัะตะบัั ะฟะตัะฒะพะณะพ ัะพะพะฑัะตะฝะธั
                first_message_text = ""
                if update.message.text:
                    first_message_text = update.message.text
                elif update.message.caption:
                    first_message_text = update.message.caption
                else:
                    first_message_text = f"[{content_type}]"
    
    # ะะฑัะตะทะฐะตะผ ะตัะปะธ ัะปะธัะบะพะผ ะดะปะธะฝะฝะพะต
                if len(first_message_text) > 100:
                    first_message_text = first_message_text[:100] + "..."
                    await context.bot.send_message(
                        chat_id=ADMIN_GROUP_ID, 
                        message_thread_id=PENDING_CHATS_THREAD_ID,
                        text=f"{COLORS['purple']} ๐ ะะะะะฏ ะะะฏะะะ\n\n"
                            f"{COLORS['blue']} ๐ค ะั: {user.full_name}\n"
                            f"{COLORS['violet']} ๐ ID: {user.id}\n"
                            f"{COLORS['night']} ๐ฑ Username: @{user.username}\n"
                            f"{COLORS['purple']} ๐ ะขะธะฟ: {msg_type_name}\n"
                            f"{COLORS['blue']} ๐ ะะตัะฒะพะต ัะพะพะฑัะตะฝะธะต:\n"
                            f"โ {first_message_text}\n\n"
                            f"{COLORS['violet']} ๐ ะงะฐั: {thread_name}",
                        reply_markup=InlineKeyboardMarkup([[
                            create_fancy_button("โ ะะทััั ะฒ ัะฐะฑะพัั", f"take_chat_{user.id}", 'moon')
                        ]])
                    )

        # ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธะน ะพั ะฐะดะผะธะฝะพะฒ ะฒ ััะตะดะฐั
        if user_tag and chat_id == ADMIN_GROUP_ID and message_thread_id:
            c.execute("SELECT user_id FROM active_chats WHERE thread_id = ? AND status = 'active'",
                      (message_thread_id,))
            active_chat = c.fetchone()

            if active_chat:
                target_user_id = active_chat[0]
                await copy_message_to_chat(
                    context, update.message, target_user_id, None,
                    f"๐ซ๏ธ {user_tag}:"
                )
                content_type = get_message_type(update.message)
                c.execute("""INSERT INTO messages 
                             (user_id, text, from_taker, taker_tag, created_at, is_read)
                             VALUES (?, ?, ?, ?, ?, ?)""",
                          (target_user_id, f"[{content_type}]", user.id, user_tag, get_current_time(), 1))
                conn.commit()
    finally:
        conn.close()


async def rest_take_command(update: Update, context):
    """ะะพะผะฐะฝะดะฐ ะดะปั ะฒะทััะธั ัะตััะฐ: /resttake [ะดะปะธัะตะปัะฝะพััั] [ะฟัะธัะธะฝะฐ]"""
    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user_id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    # ะัะพะฒะตััะตะผ ะฐะบัะธะฒะฝัะน ัะตัั
    active_rest = check_active_rest(user_id)
    if active_rest:
        rest_id, start_date, end_date, reason = active_rest
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ัะถะต ะตััั ะฐะบัะธะฒะฝัะน ัะตัั!\n\n"
            f"{COLORS['blue']} ๐ ะะฐัะฐะปะพ: {start_date}\n"
            f"{COLORS['violet']} ๐ ะะบะพะฝัะฐะฝะธะต: {end_date}\n"
            f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}"
        )
        return
    
    # ะัะพะฒะตััะตะผ ะฐัะณัะผะตะฝัั
    args = context.args
    if len(args) < 2:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะฐะบ ะฒะทััั ัะตัั:\n\n"
            f"{COLORS['blue']} /resttake [ะดะปะธัะตะปัะฝะพััั] [ะฟัะธัะธะฝะฐ]\n\n"
            f"{COLORS['violet']} ะัะธะผะตัั:\n"
            f"/resttake 3ะดะฝ ะัะดะพัะฝััั\n"
            f"/resttake 1ะฝะตะด ะัะฟััะบ\n"
            f"/resttake 2ะผะตั ะะธัะฝัะต ะดะตะปะฐ"
        )
        return
    
    # ะะฐััะธะผ ะดะปะธัะตะปัะฝะพััั
    duration_str = args[0].lower()
    reason = ' '.join(args[1:])
    
    # ะะฟัะตะดะตะปัะตะผ ะบะพะปะธัะตััะฒะพ ะดะฝะตะน
    days = 0
    if 'ะดะฝ' in duration_str:
        days = int(''.join(filter(str.isdigit, duration_str)) or 0)
    elif 'ะฝะตะด' in duration_str:
        weeks = int(''.join(filter(str.isdigit, duration_str)) or 0)
        days = weeks * 7
    elif 'ะผะตั' in duration_str:
        months = int(''.join(filter(str.isdigit, duration_str)) or 0)
        days = months * 30
    else:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตะฒะตัะฝัะน ัะพัะผะฐั ะดะปะธัะตะปัะฝะพััะธ\n"
            f"ะัะฟะพะปัะทัะนัะต: 3ะดะฝ, 1ะฝะตะด, 2ะผะตั"
        )
        return
    
    if days <= 0:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะปะธัะตะปัะฝะพััั ะดะพะปะถะฝะฐ ะฑััั ะฟะพะปะพะถะธัะตะปัะฝะพะน")
        return
    
    # ะกะพะทะดะฐะตะผ ัะตัั
    start_date = datetime.now().strftime('%d.%m.%Y')
    end_date = (datetime.now() + timedelta(days=days)).strftime('%d.%m.%Y')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""INSERT INTO rests 
                 (admin_id, admin_tag, admin_name, start_date, end_date, reason, status, created_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
              (user_id, user_tag, user.full_name, start_date, end_date, reason, 'active', get_current_time()))
    rest_id = c.lastrowid
    conn.commit()
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะะกะข ะะคะะะะะะ!\n\n"
        f"{COLORS['blue']} ๐ ะะฐัะฐะปะพ: {start_date}\n"
        f"{COLORS['violet']} ๐ ะะบะพะฝัะฐะฝะธะต: {end_date}\n"
        f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n\n"
        f"{COLORS['purple']} ะฅะพัะพัะตะณะพ ะพัะดััะฐ!"
    )


async def rest_active_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฒัะต ะฐะบัะธะฒะฝัะต ัะตััั: /restactive"""
    user = update.effective_user
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user.id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT admin_tag, start_date, end_date, reason FROM rests 
                 WHERE status = 'active' 
                 ORDER BY end_date ASC""")
    rests = c.fetchall()
    conn.close()
    
    if not rests:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ด ะะตั ะฐะบัะธะฒะฝัั ัะตััะพะฒ"
        )
        return
    
    text = f"{COLORS['purple']} ๐ ะะะขะะะะซะ ะะะกะขะซ:\n\n"
    now = datetime.now()
    
    for admin_tag, start_date, end_date, reason in rests:
        try:
            end = datetime.strptime(end_date, '%d.%m.%Y')
            days_left = (end - now).days
            days_text = f" (ะพััะฐะปะพัั {days_left} ะดะฝ.)" if days_left >= 0 else " (ะฟัะพััะพัะตะฝ)"
        except:
            days_text = ""
        
        text += f"{COLORS['blue']} ๐ค {admin_tag}\n"
        text += f"{COLORS['violet']} ๐ {start_date} - {end_date}{days_text}\n"
        text += f"{COLORS['night']} ๐ {reason}\n\n"
    
    await update.message.reply_text(text)



async def rest_my_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะฒะพะน ัะตัั: /restmy"""
    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user_id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    active_rest = check_active_rest(user_id)
    
    if not active_rest:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะตััะฐ"
        )
        return
    
    rest_id, start_date, end_date, reason = active_rest
    
    try:
        now = datetime.now()
        end = datetime.strptime(end_date, '%d.%m.%Y')
        days_left = (end - now).days
        days_text = f" (ะพััะฐะปะพัั {days_left} ะดะฝ.)"
    except:
        days_text = ""
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ค ะะะ ะะะกะข\n\n"
        f"{COLORS['blue']} ๐ ะะฐัะฐะปะพ: {start_date}\n"
        f"{COLORS['violet']} ๐ ะะบะพะฝัะฐะฝะธะต: {end_date}{days_text}\n"
        f"{COLORS['night']} ๐ ะัะธัะธะฝะฐ: {reason}\n\n"
        f"{COLORS['purple']} ะงัะพะฑั ะฒัะนัะธ ะดะพััะพัะฝะพ: /restend"
    )



async def rest_history_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะธััะพัะธั ัะตััะพะฒ: /resthistory [ะฝะธะบ]"""
    user = update.effective_user
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user.id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    # ะะฟัะตะดะตะปัะตะผ ััั ะธััะพัะธั ะฟะพะบะฐะทัะฒะฐะตะผ
    args = context.args
    if args:
        target_tag = args[0]
        if not target_tag.startswith('#'):
            target_tag = '#' + target_tag
    else:
        target_tag = user_tag
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT start_date, end_date, reason, status, created_at 
                 FROM rests 
                 WHERE admin_tag = ? 
                 ORDER BY created_at DESC 
                 LIMIT 20""", (target_tag,))
    rests = c.fetchall()
    conn.close()
    
    if not rests:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ {target_tag} ะฝะตั ะธััะพัะธะธ ัะตััะพะฒ"
        )
        return
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะะะกะขะะ {target_tag}:\n\n"
    
    for start_date, end_date, reason, status, created_at in rests:
        status_emoji = "โ" if status == "completed" else "๐ด"
        date_obj = datetime.strptime(created_at, '%Y-%m-%d %H:%M:%S') if created_at else datetime.now()
        date_str = date_obj.strftime('%d.%m.%Y')
        
        text += f"{COLORS['blue']} {status_emoji} {start_date} - {end_date}\n"
        text += f"{COLORS['violet']}    ๐ ะกะพะทะดะฐะฝ: {date_str}\n"
        text += f"{COLORS['night']}    ๐ {reason}\n\n"
    
    # ะะพะฑะฐะฒะปัะตะผ ะฟะฐะณะธะฝะฐัะธั ะตัะปะธ ะผะฝะพะณะพ
    if len(rests) >= 20:
        text += f"{COLORS['purple']} ะะพะบะฐะทะฐะฝั ะฟะพัะปะตะดะฝะธะต 20 ัะตััะพะฒ"
    
    await update.message.reply_text(text)


async def rest_stats_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ัะตััะพะฒ: /reststats"""
    user = update.effective_user
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user.id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะฑัะฐั ััะฐัะธััะธะบะฐ
    c.execute("SELECT COUNT(*) FROM rests")
    total = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'active'")
    active = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'completed'")
    completed = c.fetchone()[0] or 0
    
    # ะขะพะฟ ะฟะพ ัะตััะฐะผ
    c.execute("""SELECT admin_tag, COUNT(*) as rest_count 
                 FROM rests 
                 GROUP BY admin_tag 
                 ORDER BY rest_count DESC 
                 LIMIT 10""")
    top_admins = c.fetchall()
    
    # ะกัะตะดะฝัั ะดะปะธัะตะปัะฝะพััั
    c.execute("""SELECT AVG(
                    julianday(substr(end_date,7,4)||'-'||substr(end_date,4,2)||'-'||substr(end_date,1,2)) - 
                    julianday(substr(start_date,7,4)||'-'||substr(start_date,4,2)||'-'||substr(start_date,1,2))
                 ) FROM rests WHERE status = 'completed'""")
    avg_duration = c.fetchone()[0] or 0
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ะผะตัััะฐะผ
    c.execute("""SELECT strftime('%Y-%m', created_at) as month, COUNT(*) 
                 FROM rests 
                 GROUP BY month 
                 ORDER BY month DESC 
                 LIMIT 6""")
    monthly = c.fetchall()
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะกะขะะ\n\n"
    text += f"{COLORS['blue']} ๐ ะัะตะณะพ ัะตััะพะฒ: {total}\n"
    text += f"{COLORS['violet']} ๐ด ะะบัะธะฒะฝัั ัะตะนัะฐั: {active}\n"
    text += f"{COLORS['night']} โ ะะฐะฒะตััะตะฝะพ: {completed}\n"
    text += f"{COLORS['purple']} โฑ ะกัะตะดะฝัั ะดะปะธัะตะปัะฝะพััั: {avg_duration:.1f} ะดะฝ.\n\n"
    
    if top_admins:
        text += f"{COLORS['blue']} ๐ ะขะะ ะะะะะะะ ะะ ะะะกะขะะ:\n"
        for i, (tag, count) in enumerate(top_admins[:5], 1):
            medal = "๐ฅ" if i == 1 else "๐ฅ" if i == 2 else "๐ฅ" if i == 3 else f"{i}."
            text += f"{COLORS['violet']} {medal} {tag}: {count} ัะตััะพะฒ\n"
    
    if monthly:
        text += f"\n{COLORS['night']} ๐ ะะ ะะะกะฏะฆะะ:\n"
        for month, count in monthly:
            text += f"{COLORS['purple']}    {month}: {count} ัะตััะพะฒ\n"
    
    await update.message.reply_text(text)


async def rest_end_command(update: Update, context):
    """ะะพััะพัะฝะพ ะทะฐะฒะตััะธัั ัะตัั: /restend"""
    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ ัะตะณ
    user_tag = get_user_tag(user_id)
    if not user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    active_rest = check_active_rest(user_id)
    
    if not active_rest:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะตััะฐ"
        )
        return
    
    rest_id, start_date, end_date, reason = active_rest
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""UPDATE rests SET status = 'completed', completed_at = ? 
                 WHERE id = ?""", (get_current_time(), rest_id))
    conn.commit()
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} โ ะั ะดะพััะพัะฝะพ ะฒััะปะธ ะธะท ัะตััะฐ\n\n"
        f"{COLORS['blue']} ะะตัั ะฑัะป: {start_date} - {end_date}\n"
        f"{COLORS['violet']} ะัะธัะธะฝะฐ: {reason}\n\n"
        f"{COLORS['purple']} ะขะตะฟะตัั ะฒั ัะฝะพะฒะฐ ะผะพะถะตัะต ะฑัะฐัั ะทะฐัะฒะบะธ!"
    )



async def rp_action(update: Update, context):
    try:
        # ะะพะปััะฐะตะผ ัะตะบัั ัะพะพะฑัะตะฝะธั
        message_text = update.message.text
        if not message_text or not message_text.startswith('/'):
            return
        
        # ะะพะปััะฐะตะผ ะบะพะผะฐะฝะดั ะฑะตะท ัะปะตัะฐ
        command = message_text.split()[0][1:].lower()
        
        # ะัะพะฒะตััะตะผ ะตััั ะปะธ ะบะพะผะฐะฝะดะฐ ะฒ ัะปะพะฒะฐัะต
        if command not in RP_ACTIONS:
            return
        
        # ะะพะปััะฐะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั
        user = update.effective_user
        if not user:
            return
        
        # ะะพะปััะฐะตะผ ะดะตะนััะฒะธะต ะธะท ัะปะพะฒะฐัั
        action_text = RP_ACTIONS[command]
        
        # ะะฐะทะฑะธะฒะฐะตะผ ะฝะฐ ัะผะพะดะทะธ ะธ ะดะตะนััะฒะธะต
        if ' ' in action_text:
            emoji, action = action_text.split(' ', 1)
        else:
            emoji = "๐ซ"
            action = action_text
        
        # ะัะพะฒะตััะตะผ ะตััั ะปะธ ัะตะณ ั ะฟะพะปัะทะพะฒะฐัะตะปั
        user_tag = None
        try:
            conn = sqlite3.connect('support_bot.db')
            c = conn.cursor()
            c.execute("SELECT user_tag FROM user_tags WHERE user_id = ? AND is_active = 1", (user.id,))
            result = c.fetchone()
            conn.close()
            if result:
                user_tag = result[0]
        except:
            pass
        
        # ะัะปะธ ะฝะตั ัะตะณะฐ, ะธัะฟะพะปัะทัะตะผ ะธะผั
        if not user_tag:
            user_tag = user.first_name if user.first_name else f"User{user.id}"
        
        # ะัะพะฒะตััะตะผ ะตััั ะปะธ ะพัะฒะตั ะฝะฐ ัะพะพะฑัะตะฝะธะต
        if update.message.reply_to_message:
            target = update.message.reply_to_message.from_user
            if target:
                # ะัะพะฒะตััะตะผ ัะตะณ ัะตะปะธ
                target_tag = None
                try:
                    conn = sqlite3.connect('support_bot.db')
                    c = conn.cursor()
                    c.execute("SELECT user_tag FROM user_tags WHERE user_id = ? AND is_active = 1", (target.id,))
                    result = c.fetchone()
                    conn.close()
                    if result:
                        target_tag = result[0]
                except:
                    pass
                
                if not target_tag:
                    target_tag = target.first_name if target.first_name else f"User{target.id}"
                
                # ะัะฟัะฐะฒะปัะตะผ ะพัะฒะตั
                await update.message.reply_text(
                    f"{emoji} {user_tag} {action} {target_tag}"
                )
                return
        
        # ะัะปะธ ะฝะตั ะพัะฒะตัะฐ - ะดะตะนััะฒะธะต ะฝะฐ ัะตะฑั
        await update.message.reply_text(
            f"{emoji} {user_tag} {action}"
        )
        
    except Exception as e:
        print(f"ะัะธะฑะบะฐ ะฒ RP ะบะพะผะฐะฝะดะต: {e}")


async def show_admins_stats(query: CallbackQuery, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะฟะพ ะฐะดะผะธะฝะฐะผ (ะขะะะฌะะ ะะะขะะะะซะ ะะะกะขะซ)"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    # ะะพะปััะฐะตะผ ััะฐัะธััะธะบั ะฟะพ ะฐะดะผะธะฝะฐะผ ั ะฟัะฐะฒะธะปัะฝัะผ ะฟะพะดััะตัะพะผ ัะตััะพะฒ
    c.execute("""
        SELECT 
            ut.user_id, 
            ut.user_tag, 
            COUNT(DISTINCT ac.user_id) as chats_count,
            COUNT(m.id) as messages_count,
            COUNT(DISTINCT CASE WHEN r.status = 'active' THEN r.id END) as active_rests_count
        FROM user_tags ut
        LEFT JOIN active_chats ac ON ut.user_id = ac.taken_by_id
        LEFT JOIN messages m ON ut.user_id = m.from_taker
        LEFT JOIN rests r ON ut.user_id = r.admin_id AND r.status = 'active'
        WHERE ut.is_active = 1
        GROUP BY ut.user_id, ut.user_tag
        ORDER BY messages_count DESC
    """)
    admins_stats = c.fetchall()
    
    # ะะพะปััะฐะตะผ ัะฟะธัะพะบ ะฐะดะผะธะฝะพะฒ ะฒ ะฐะบัะธะฒะฝะพะผ ัะตััะต ัะตะนัะฐั
    c.execute("""
        SELECT admin_tag, start_date, end_date 
        FROM rests 
        WHERE status = 'active' 
        ORDER BY end_date
    """)
    active_rests_list = c.fetchall()
    
    conn.close()

    if not admins_stats:
        await query.edit_message_text(
            f"{COLORS['purple']} ๐ ะะตั ะฐะบัะธะฒะฝัั ะฐะดะผะธะฝะพะฒ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
            ]])
        )
        return

    # ะะฐะณะพะปะพะฒะพะบ
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะ ะะะะะะะ\n"
    text += f"{COLORS['blue']} (ะฟะพะบะฐะทัะฒะฐัััั ะขะะะฌะะ ะะะขะะะะซะ ัะตััั)\n\n"

    # ะะฑัะฐั ััะฐัะธััะธะบะฐ
    total_messages = sum(stat[3] for stat in admins_stats)
    total_chats = sum(stat[2] for stat in admins_stats)
    total_active_rests = len(active_rests_list)
    
    text += f"{COLORS['blue']} ๐จ ะัะตะณะพ ัะพะพะฑัะตะฝะธะน: {total_messages}\n"
    text += f"{COLORS['violet']} ๐ ะัะตะณะพ ัะฐัะพะฒ: {total_chats}\n"
    text += f"{COLORS['night']} ๐ด ะะดะผะธะฝะพะฒ ะฒ ัะตััะต ัะตะนัะฐั: {total_active_rests}\n"
    text += f"{COLORS['purple']} ๐ฅ ะัะตะณะพ ะฐะดะผะธะฝะพะฒ: {len(admins_stats)}\n\n"
    
    text += f"{COLORS['blue']} ะะพ ะฐะดะผะธะฝะฐะผ:\n"

    medals = ['๐ฅ', '๐ฅ', '๐ฅ']
    for i, (admin_id, tag, chats, msgs, active_rests) in enumerate(admins_stats[:10]):
        medal = medals[i] if i < 3 else f"{i + 1}."
        
        # ะะพะบะฐะทัะฒะฐะตะผ ัะพะปัะบะพ ะฐะบัะธะฒะฝัะต ัะตััั
        if active_rests > 0:
            rest_text = f" | ๐ด {active_rests} ะะะขะะะะซะ ะะะกะข"
        else:
            rest_text = ""
        
        text += f"{COLORS['violet']} {medal} {tag}: {msgs} ัะพะพะฑั. | {chats} ัะฐัะพะฒ{rest_text}\n"

    # ะัะปะธ ะตััั ะฐะดะผะธะฝั ะฒ ะฐะบัะธะฒะฝะพะผ ัะตััะต, ะฟะพะบะฐะถะตะผ ะธั ะพัะดะตะปัะฝะพ
    if active_rests_list:
        text += f"\n{COLORS['purple']} ๐ด ะกะะะงะะก ะ ะะะกะขะ:\n"
        for tag, start, end in active_rests_list:
            text += f"{COLORS['blue']} โข {tag}: {start} - {end}\n"

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ๏ธ ะะฐะทะฐะด", "stats_menu", 'fog')
        ]])
    )


async def pending_requests(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะฟะธัะพะบ ะพะถะธะดะฐััะธั ะทะฐัะฒะพะบ (ะฟัะพััะฐั ะบะพะผะฐะฝะดะฐ)"""
    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะดะผะธะฝ (ะตััั ัะตะณ)
    user_tag = get_user_tag(user_id)
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะต ะพะถะธะดะฐััะธะต ะทะฐัะฒะบะธ
    c.execute("""
        SELECT user_id, user_name, message_type, created_at 
        FROM active_chats 
        WHERE status = 'pending' 
        ORDER BY created_at DESC
    """)
    chats = c.fetchall()
    conn.close()
    
    if not chats:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะพะถะธะดะฐััะธั ะทะฐัะฒะพะบ\n\n"
            f"{COLORS['blue']} ะัะต ัะพัะพัะพ, ะผะพะถะฝะพ ะพัะดััะฐัั! ๐"
        )
        return
    
    # ะคะพัะผะธััะตะผ ัะพะพะฑัะตะฝะธะต
    text = f"{COLORS['purple']} โณ ะะะะะะฎะฉะะ ะะะฏะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {len(chats)}\n\n"
    
    for i, (user_id, user_name, msg_type, created_at) in enumerate(chats, 1):
        # ะะฑัะตะทะฐะตะผ ะดะฐัั
        if created_at and len(created_at) > 16:
            created_short = created_at[:16]
        else:
            created_short = created_at or "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} {i}. {user_name}\n"
        text += f"{COLORS['night']}    ID: {user_id}\n"
        text += f"{COLORS['purple']}    ะขะธะฟ: {msg_type}\n"
        text += f"{COLORS['blue']}    โฑ {created_short}\n\n"
    
    # ะะพะฑะฐะฒะปัะตะผ ะธะฝัะพัะผะฐัะธั ะบะฐะบ ะฒะทััั ะทะฐัะฒะบั
    text += f"{COLORS['cloud']} ะงัะพะฑั ะฒะทััั ะทะฐัะฒะบั, ะฝะฐะถะผะธัะต ะฝะฐ ะบะฝะพะฟะบั ะฒ ะผะตะฝั"
    
    await update.message.reply_text(text)


async def show_apps_pending(update: Update, context):
    """ะะพะบะฐะทะฐัั ะพะถะธะดะฐััะธะต ะทะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, name, app_type, created_at 
        FROM applications 
        WHERE status = 'pending' 
        ORDER BY created_at DESC
    """)
    apps = c.fetchall()
    conn.close()
    
    if not apps:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะพะถะธะดะฐััะธั ะทะฐัะฒะพะบ ะฝะฐ ะฐะดะผะธะฝะฐ"
        )
        return
    
    text = f"{COLORS['purple']} ๐ข ะะะะะะฎะฉะะ ะะะฏะะะ ะะ ะะะะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {len(apps)}\n\n"
    
    for app in apps:
        app_id, name, app_type, created = app
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} #{app_id} - {name}\n"
        text += f"{COLORS['night']}    ะขะธะฟ: {app_type}\n"
        text += f"{COLORS['purple']}    ๐ {created_short}\n\n"
    
    text += f"{COLORS['cloud']} ะะปั ะฟัะพัะผะพััะฐ ะดะตัะฐะปะตะน ะธัะฟะพะปัะทัะนัะต /app {apps[0][0]}"
    
    await update.message.reply_text(text)


async def show_apps_accepted(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฟัะธะฝัััะต ะทะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, name, app_type, reviewed_at 
        FROM applications 
        WHERE status = 'accepted' 
        ORDER BY reviewed_at DESC
    """)
    apps = c.fetchall()
    conn.close()
    
    if not apps:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะฟัะธะฝัััั ะทะฐัะฒะพะบ"
        )
        return
    
    text = f"{COLORS['purple']} โ ะะะะะฏะขะซะ ะะะฏะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {len(apps)}\n\n"
    
    for app in apps:
        app_id, name, app_type, reviewed = app
        reviewed_short = reviewed[:16] if reviewed else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} #{app_id} - {name}\n"
        text += f"{COLORS['night']}    ะขะธะฟ: {app_type}\n"
        text += f"{COLORS['purple']}    โ {reviewed_short}\n\n"
    
    await update.message.reply_text(text)


async def show_apps_rejected(update: Update, context):
    """ะะพะบะฐะทะฐัั ะพัะบะปะพะฝะตะฝะฝัะต ะทะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, name, app_type, reviewed_at 
        FROM applications 
        WHERE status = 'rejected' 
        ORDER BY reviewed_at DESC
    """)
    apps = c.fetchall()
    conn.close()
    
    if not apps:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะพัะบะปะพะฝะตะฝะฝัั ะทะฐัะฒะพะบ"
        )
        return
    
    text = f"{COLORS['purple']} โ ะะขะะะะะะะะซะ ะะะฏะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {len(apps)}\n\n"
    
    for app in apps:
        app_id, name, app_type, reviewed = app
        reviewed_short = reviewed[:16] if reviewed else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} #{app_id} - {name}\n"
        text += f"{COLORS['night']}    ะขะธะฟ: {app_type}\n"
        text += f"{COLORS['purple']}    โ {reviewed_short}\n\n"
    
    await update.message.reply_text(text)


async def show_apps_all(update: Update, context):
    """ะะพะบะฐะทะฐัั ะะกะ ะทะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ (ั ะฟะฐะณะธะฝะฐัะธะตะน ะฟะพ ัััะฐะฝะธัะฐะผ)"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    # ะะฟัะตะดะตะปัะตะผ ะฝะพะผะตั ัััะฐะฝะธัั
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะะกะ ะทะฐัะฒะบะธ (ะฑะตะท LIMIT)
    c.execute("""
        SELECT id, name, app_type, status, created_at 
        FROM applications 
        ORDER BY created_at DESC
    """)
    all_apps = c.fetchall()
    
    # ะะพะปััะฐะตะผ ะพะฑััั ััะฐัะธััะธะบั
    c.execute("SELECT COUNT(*) FROM applications")
    total_all = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'pending'")
    total_pending = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'accepted'")
    total_accepted = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'rejected'")
    total_rejected = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_apps:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะทะฐัะฒะพะบ ะฝะฐ ะฐะดะผะธะฝะฐ"
        )
        return
    
    # ะะฐัััะพะนะบะธ ะฟะฐะณะธะฝะฐัะธะธ
    apps_per_page = 10
    total_pages = (len(all_apps) + apps_per_page - 1) // apps_per_page
    
    # ะัะพะฒะตััะตะผ ะบะพััะตะบัะฝะพััั ัััะฐะฝะธัั
    if page < 1:
        page = 1
    elif page > total_pages:
        page = total_pages
    
    # ะะพะปััะฐะตะผ ะทะฐัะฒะบะธ ะดะปั ัะตะบััะตะน ัััะฐะฝะธัั
    start_idx = (page - 1) * apps_per_page
    end_idx = min(start_idx + apps_per_page, len(all_apps))
    current_apps = all_apps[start_idx:end_idx]
    
    # ะคะพัะผะธััะตะผ ะทะฐะณะพะปะพะฒะพะบ
    text = f"{COLORS['purple']} ๐ ะะกะ ะะะฏะะะ (ัััะฐะฝะธัะฐ {page}/{total_pages})\n\n"
    
    # ะกัะฐัะธััะธะบะฐ
    text += f"{COLORS['blue']} ๐ข ะะถะธะดะฐััะธั: {total_pending}\n"
    text += f"{COLORS['violet']} โ ะัะธะฝัััั: {total_accepted}\n"
    text += f"{COLORS['night']} โ ะัะบะปะพะฝะตะฝะฝัั: {total_rejected}\n"
    text += f"{COLORS['purple']} ๐ ะัะตะณะพ: {total_all}\n\n"
    
    # ะกะฟะธัะพะบ ะทะฐัะฒะพะบ ะฝะฐ ัะตะบััะตะน ัััะฐะฝะธัะต
    for app in current_apps:
        app_id, name, app_type, status, created = app
        
        status_emoji = "๐ข" if status == 'pending' else "โ" if status == 'accepted' else "โ"
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['purple']} {status_emoji} #{app_id} {name}\n"
        text += f"{COLORS['blue']}    {app_type} | {created_short}\n\n"
    
    # ะะฐะฒะธะณะฐัะธั
    nav_buttons = []
    
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ ะัะตะดัะดััะฐั", f"apps_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("ะกะปะตะดัััะฐั โถ๏ธ", f"apps_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    # ะะฝะพะฟะบะธ ะดะปั ะฑััััะพะณะพ ะฟะตัะตัะพะดะฐ ะฟะพ ััะฐัััะฐะผ
    keyboard.append([
        create_fancy_button("๐ข ะะถะธะดะฐััะธะต", "apps_pending", 'green'),
        create_fancy_button("โ ะัะธะฝัััะต", "apps_accepted", 'blue'),
        create_fancy_button("โ ะัะบะปะพะฝะตะฝะฝัะต", "apps_rejected", 'red')
    ])
    
    keyboard.append([create_fancy_button("๐ ะะตัะฐะปะธ ะทะฐัะฒะบะธ /app [ะฝะพะผะตั]", "noop", 'fog')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    # ะกะพััะฐะฝัะตะผ ัะตะบััะธะน ัะฟะธัะพะบ ะฒ user_data ะดะปั ะฝะฐะฒะธะณะฐัะธะธ
    context.user_data['current_apps'] = all_apps
    context.user_data['current_page'] = page
    
    await update.message.reply_text(
        text, 
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def apps_page_callback(update: Update, context):
    """ะะฑัะฐะฑะพััะธะบ ะฟะตัะตะบะปััะตะฝะธั ัััะฐะฝะธั"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    if not data.startswith('apps_page_'):
        return
    
    page = int(data.split('_')[2])
    apps = context.user_data.get('current_apps', [])
    
    if not apps:
        await query.edit_message_text(f"{COLORS['purple']} โ ะะฐะฝะฝัะต ัััะฐัะตะปะธ, ะธัะฟะพะปัะทัะนัะต ะบะพะผะฐะฝะดั ะทะฐะฝะพะฒะพ")
        return
    
    apps_per_page = 10
    total_pages = (len(apps) + apps_per_page - 1) // apps_per_page
    
    if page < 1 or page > total_pages:
        return
    
    start_idx = (page - 1) * apps_per_page
    end_idx = min(start_idx + apps_per_page, len(apps))
    current_apps = apps[start_idx:end_idx]
    
    # ะะพะปััะฐะตะผ ััะฐัะธััะธะบั
    total_pending = sum(1 for app in apps if app[3] == 'pending')
    total_accepted = sum(1 for app in apps if app[3] == 'accepted')
    total_rejected = sum(1 for app in apps if app[3] == 'rejected')
    
    text = f"{COLORS['purple']} ๐ ะะกะ ะะะฏะะะ (ัััะฐะฝะธัะฐ {page}/{total_pages})\n\n"
    text += f"{COLORS['blue']} ๐ข ะะถะธะดะฐััะธั: {total_pending}\n"
    text += f"{COLORS['violet']} โ ะัะธะฝัััั: {total_accepted}\n"
    text += f"{COLORS['night']} โ ะัะบะปะพะฝะตะฝะฝัั: {total_rejected}\n"
    text += f"{COLORS['purple']} ๐ ะัะตะณะพ: {len(apps)}\n\n"
    
    for app in current_apps:
        app_id, name, app_type, status, created = app
        status_emoji = "๐ข" if status == 'pending' else "โ" if status == 'accepted' else "โ"
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        text += f"{COLORS['purple']} {status_emoji} #{app_id} {name}\n"
        text += f"{COLORS['blue']}    {app_type} | {created_short}\n\n"
    
    # ะะฐะฒะธะณะฐัะธั
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ ะัะตะดัะดััะฐั", f"apps_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("ะกะปะตะดัััะฐั โถ๏ธ", f"apps_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([
        create_fancy_button("๐ข ะะถะธะดะฐััะธะต", "apps_pending", 'green'),
        create_fancy_button("โ ะัะธะฝัััะต", "apps_accepted", 'blue'),
        create_fancy_button("โ ะัะบะปะพะฝะตะฝะฝัะต", "apps_rejected", 'red')
    ])
    
    keyboard.append([create_fancy_button("๐ ะะตัะฐะปะธ ะทะฐัะฒะบะธ /app [ะฝะพะผะตั]", "noop", 'fog')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    context.user_data['current_page'] = page


async def show_app_detail(update: Update, context):
    """ะะพะบะฐะทะฐัั ะดะตัะฐะปะธ ะบะพะฝะบัะตัะฝะพะน ะทะฐัะฒะบะธ: /app 123"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /app [ะฝะพะผะตั ะทะฐัะฒะบะธ]\n"
            f"{COLORS['blue']} ะัะธะผะตั: /app 5"
        )
        return
    
    try:
        app_id = int(context.args[0])
    except ValueError:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะฒะตะดะธัะต ัะธัะปะพ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, user_id, username, name, app_type, answers, created_at, status, reviewed_at, reviewed_by
        FROM applications 
        WHERE id = ?
    """, (app_id,))
    app = c.fetchone()
    conn.close()
    
    if not app:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะฐัะฒะบะฐ #{app_id} ะฝะต ะฝะฐะนะดะตะฝะฐ")
        return
    
    app_id, user_id, username, name, app_type, answers_json, created, status, reviewed_at, reviewed_by = app
    
    status_emoji = "๐ข" if status == 'pending' else "โ" if status == 'accepted' else "โ"
    
    text = f"{COLORS['purple']} {status_emoji} ะะะฏะะะ #{app_id}\n\n"
    text += f"{COLORS['blue']} ๐ค ะะผั: {name}\n"
    text += f"{COLORS['violet']} ๐ ID: {user_id}\n"
    text += f"{COLORS['night']} ๐ฑ Username: @{username}\n"
    text += f"{COLORS['purple']} ๐ ะขะธะฟ: {app_type}\n"
    text += f"{COLORS['blue']} ๐ ะกะพะทะดะฐะฝะฐ: {created[:16]}\n"
    
    if reviewed_at:
        reviewer_tag = get_user_tag(reviewed_by) or f"ID{reviewed_by}"
        text += f"{COLORS['violet']} {'โ ะัะธะฝััะฐ' if status == 'accepted' else 'โ ะัะบะปะพะฝะตะฝะฐ'}: {reviewed_at[:16]}\n"
        text += f"{COLORS['night']} ๐ค ะะตะผ: {reviewer_tag}\n"
    
    text += f"\n{COLORS['purple']} ๐ ะะขะะะขะซ:\n\n"
    
    try:
        answers = json.loads(answers_json)
        for i, answer in enumerate(answers, 1):
            # ะะฑัะตะทะฐะตะผ ัะปะธัะบะพะผ ะดะปะธะฝะฝัะต ะพัะฒะตัั
            if len(answer) > 200:
                answer = answer[:200] + "..."
            text += f"{COLORS['blue']} {i}. {answer}\n\n"
    except:
        text += f"{COLORS['red']} ะัะธะฑะบะฐ ะทะฐะณััะทะบะธ ะพัะฒะตัะพะฒ\n"
    
    await update.message.reply_text(text)


async def apps_stats(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะฟะพ ะทะฐัะฒะบะฐะผ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("SELECT COUNT(*) FROM applications")
    total = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'pending'")
    pending = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'accepted'")
    accepted = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'rejected'")
    rejected = c.fetchone()[0] or 0
    
    # ะะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน
    week_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM applications WHERE created_at > ?", (week_ago,))
    new_week = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะฏะะะ ะะ ะะะะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะทะฐัะฒะพะบ: {total}\n"
    text += f"{COLORS['violet']} ๐ข ะะถะธะดะฐััะธั: {pending}\n"
    text += f"{COLORS['night']} โ ะัะธะฝัััั: {accepted}\n"
    text += f"{COLORS['purple']} โ ะัะบะปะพะฝะตะฝะฝัั: {rejected}\n"
    text += f"{COLORS['blue']} ๐ ะะฐ ะฝะตะดะตะปั: {new_week}\n\n"
    
    text += f"{COLORS['cloud']} ะะพะผะฐะฝะดั:\n"
    text += f"/appspending - ะพะถะธะดะฐััะธะต\n"
    text += f"/appsaccepted - ะฟัะธะฝัััะต\n"
    text += f"/appsrejected - ะพัะบะปะพะฝะตะฝะฝัะต\n"
    text += f"/appsall - ะฒัะต ะทะฐัะฒะบะธ\n"
    text += f"/app [ะฝะพะผะตั] - ะดะตัะฐะปะธ ะทะฐัะฒะบะธ"
    
    await update.message.reply_text(text)


async def show_reviews_new(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฝะพะฒัะต (ะฝะตะฟัะพัะผะพััะตะฝะฝัะต) ะพัะทัะฒั"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    # ะะพะปััะฐะตะผ ะฝะพะผะตั ัััะฐะฝะธัั
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะะกะ ะฝะพะฒัะต ะพัะทัะฒั
    c.execute("""
        SELECT id, user_name, rating, review_text, created_at 
        FROM reviews 
        WHERE status = 'new' 
        ORDER BY created_at DESC
    """)
    all_reviews = c.fetchall()
    
    # ะะฑัะตะต ะบะพะปะธัะตััะฒะพ ะฝะพะฒัั
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'new'")
    total_new = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_reviews:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะฝะพะฒัั ะพัะทัะฒะพะฒ"
        )
        return
    
    # ะะฐะณะธะฝะฐัะธั
    items_per_page = 5
    total_pages = (len(all_reviews) + items_per_page - 1) // items_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * items_per_page
    end_idx = min(start_idx + items_per_page, len(all_reviews))
    current_reviews = all_reviews[start_idx:end_idx]
    
    text = f"{COLORS['purple']} ๐ ะะะะซะ ะะขะะซะะซ (ััั. {page}/{total_pages})\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะฝะพะฒัั: {total_new}\n\n"
    
    for review in current_reviews:
        review_id, user_name, rating, review_text, created = review
        stars = "โญ" * rating
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        # ะะฑัะตะทะฐะตะผ ะดะปะธะฝะฝัะน ัะตะบัั
        if len(review_text) > 100:
            review_text = review_text[:100] + "..."
        
        text += f"{COLORS['violet']} #{review_id} {user_name}\n"
        text += f"{COLORS['night']}    {stars} ({rating}/5)\n"
        text += f"{COLORS['purple']}    ๐ {review_text}\n"
        text += f"{COLORS['blue']}    ๐ {created_short}\n\n"
    
    # ะะฐะฒะธะณะฐัะธั
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ", f"reviews_new_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("โถ๏ธ", f"reviews_new_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([create_fancy_button("โ ะัะผะตัะธัั ะฟัะพัะผะพััะตะฝะฝัะผ", "reviews_mark_all", 'green')])
    keyboard.append([create_fancy_button("๐ ะะตัะฐะปะธ /review [ะฝะพะผะตั]", "noop", 'fog')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_reviews_viewed(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฟัะพัะผะพััะตะฝะฝัะต ะพัะทัะฒั"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, user_name, rating, review_text, created_at, reviewed_at 
        FROM reviews 
        WHERE status = 'viewed' 
        ORDER BY reviewed_at DESC
    """)
    all_reviews = c.fetchall()
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'viewed'")
    total_viewed = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_reviews:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะฟัะพัะผะพััะตะฝะฝัั ะพัะทัะฒะพะฒ"
        )
        return
    
    items_per_page = 5
    total_pages = (len(all_reviews) + items_per_page - 1) // items_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * items_per_page
    end_idx = min(start_idx + items_per_page, len(all_reviews))
    current_reviews = all_reviews[start_idx:end_idx]
    
    text = f"{COLORS['purple']} โ ะะะะกะะะขะะะะะซะ ะะขะะซะะซ (ััั. {page}/{total_pages})\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะฟัะพัะผะพััะตะฝะฝัั: {total_viewed}\n\n"
    
    for review in current_reviews:
        review_id, user_name, rating, review_text, created, reviewed = review
        stars = "โญ" * rating
        reviewed_short = reviewed[:16] if reviewed else "ะฝะตะธะทะฒ."
        
        if len(review_text) > 100:
            review_text = review_text[:100] + "..."
        
        text += f"{COLORS['violet']} #{review_id} {user_name}\n"
        text += f"{COLORS['night']}    {stars} ({rating}/5)\n"
        text += f"{COLORS['purple']}    ๐ {review_text}\n"
        text += f"{COLORS['blue']}    โ {reviewed_short}\n\n"
    
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ", f"reviews_viewed_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("โถ๏ธ", f"reviews_viewed_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([create_fancy_button("๐ ะะตัะฐะปะธ /review [ะฝะพะผะตั]", "noop", 'fog')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_reviews_all(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฒัะต ะพัะทัะฒั"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, user_name, rating, review_text, status, created_at 
        FROM reviews 
        ORDER BY created_at DESC
    """)
    all_reviews = c.fetchall()
    
    # ะกัะฐัะธััะธะบะฐ
    c.execute("SELECT COUNT(*) FROM reviews")
    total_all = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'new'")
    total_new = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'viewed'")
    total_viewed = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_reviews:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะพัะทัะฒะพะฒ"
        )
        return
    
    items_per_page = 5
    total_pages = (len(all_reviews) + items_per_page - 1) // items_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * items_per_page
    end_idx = min(start_idx + items_per_page, len(all_reviews))
    current_reviews = all_reviews[start_idx:end_idx]
    
    text = f"{COLORS['purple']} ๐ ะะกะ ะะขะะซะะซ (ััั. {page}/{total_pages})\n\n"
    text += f"{COLORS['blue']} ๐ ะะพะฒัั: {total_new}\n"
    text += f"{COLORS['violet']} โ ะัะพัะผะพััะตะฝะฝัั: {total_viewed}\n"
    text += f"{COLORS['night']} ๐ ะัะตะณะพ: {total_all}\n\n"
    
    for review in current_reviews:
        review_id, user_name, rating, review_text, status, created = review
        stars = "โญ" * rating
        status_emoji = "๐" if status == 'new' else "โ"
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        if len(review_text) > 100:
            review_text = review_text[:100] + "..."
        
        text += f"{COLORS['purple']} {status_emoji} #{review_id} {user_name}\n"
        text += f"{COLORS['blue']}    {stars} ({rating}/5)\n"
        text += f"{COLORS['violet']}    ๐ {review_text}\n"
        text += f"{COLORS['night']}    ๐ {created_short}\n\n"
    
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ", f"reviews_all_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("โถ๏ธ", f"reviews_all_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([
        create_fancy_button("๐ ะะพะฒัะต", "reviews_new", 'green'),
        create_fancy_button("โ ะัะพัะผะพััะตะฝะฝัะต", "reviews_viewed", 'blue')
    ])
    keyboard.append([create_fancy_button("๐ ะะตัะฐะปะธ /review [ะฝะพะผะตั]", "noop", 'fog')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_reviews_stats_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะพัะทัะฒะพะฒ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("SELECT COUNT(*) FROM reviews")
    total = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'new'")
    new = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM reviews WHERE status = 'viewed'")
    viewed = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(rating) FROM reviews")
    avg_rating = c.fetchone()[0] or 0
    
    c.execute("SELECT rating, COUNT(*) FROM reviews GROUP BY rating ORDER BY rating")
    rating_dist = c.fetchall()
    
    # ะะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน
    week_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM reviews WHERE created_at > ?", (week_ago,))
    week_count = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะขะะซะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะพัะทัะฒะพะฒ: {total}\n"
    text += f"{COLORS['violet']} ๐ ะะพะฒัั: {new}\n"
    text += f"{COLORS['night']} โ ะัะพัะผะพััะตะฝะฝัั: {viewed}\n"
    text += f"{COLORS['purple']} ะกัะตะดะฝะธะน ัะตะนัะธะฝะณ: {avg_rating:.1f}/5\n"
    text += f"{COLORS['blue']} ะะฐ ะฝะตะดะตะปั: {week_count}\n\n"
    
    if rating_dist:
        text += f"{COLORS['violet']} ะะฐัะฟัะตะดะตะปะตะฝะธะต:\n"
        for rating, count in rating_dist:
            stars = "โญ" * rating
            text += f"{COLORS['night']} {stars}: {count}\n"
    
    text += f"\n{COLORS['cloud']} ะะพะผะฐะฝะดั:\n"
    text += f"/reviewsnew - ะฝะพะฒัะต ะพัะทัะฒั\n"
    text += f"/reviewsviewed - ะฟัะพัะผะพััะตะฝะฝัะต\n"
    text += f"/reviewsall - ะฒัะต ะพัะทัะฒั\n"
    text += f"/reviewstats - ััะฐ ััะฐัะธััะธะบะฐ"
    
    await update.message.reply_text(text)


async def show_review_detail(update: Update, context):
    """ะะพะบะฐะทะฐัั ะดะตัะฐะปะธ ะพัะทัะฒะฐ: /review 123"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /review [ะฝะพะผะตั]\n"
            f"{COLORS['blue']} ะัะธะผะตั: /review 5"
        )
        return
    
    try:
        review_id = int(context.args[0])
    except ValueError:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะฒะตะดะธัะต ัะธัะปะพ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT id, user_id, user_name, username, rating, review_text, created_at, status, reviewed_by, reviewed_at
        FROM reviews 
        WHERE id = ?
    """, (review_id,))
    review = c.fetchone()
    conn.close()
    
    if not review:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะทัะฒ #{review_id} ะฝะต ะฝะฐะนะดะตะฝ")
        return
    
    (review_id, user_id, user_name, username, rating, review_text, 
     created, status, reviewed_by, reviewed_at) = review
    
    status_emoji = "๐" if status == 'new' else "โ"
    stars = "โญ" * rating
    
    text = f"{COLORS['purple']} {status_emoji} ะะขะะซะ #{review_id}\n\n"
    text += f"{COLORS['blue']} ๐ค {user_name}\n"
    text += f"{COLORS['violet']} ๐ ID: {user_id}\n"
    text += f"{COLORS['night']} ๐ฑ Username: @{username}\n"
    text += f"{COLORS['purple']} โญ {stars} ({rating}/5)\n"
    text += f"{COLORS['blue']} ๐ ะกะพะทะดะฐะฝ: {created[:16]}\n"
    
    if reviewed_at:
        reviewer_tag = get_user_tag(reviewed_by) or f"ID{reviewed_by}"
        text += f"{COLORS['violet']} โ ะัะพัะผะพััะตะฝ: {reviewed_at[:16]}\n"
        text += f"{COLORS['night']} ๐ค ะะตะผ: {reviewer_tag}\n"
    
    text += f"\n{COLORS['purple']} ๐ ะขะตะบัั ะพัะทัะฒะฐ:\n"
    text += f"{COLORS['blue']} {review_text}\n"
    
    # ะะฝะพะฟะบะฐ ะดะปั ะพัะผะตัะบะธ ะตัะปะธ ะพัะทัะฒ ะฝะพะฒัะน
    keyboard = []
    if status == 'new':
        keyboard.append([create_fancy_button("โ ะัะผะตัะธัั ะฟัะพัะผะพััะตะฝะฝัะผ", f"review_view_{review_id}", 'moon')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def stats_general_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะพะฑััั ััะฐัะธััะธะบั ะฑะพัะฐ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()

    # ะะพะปัะทะพะฒะฐัะตะปะธ
    c.execute("SELECT COUNT(*) FROM users")
    total_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_active = 1")
    active_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    blocked_users = c.fetchone()[0] or 0
    
    # ะะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ
    c.execute("SELECT COUNT(*) FROM applications")
    total_apps = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'pending'")
    pending_apps = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'accepted'")
    accepted_apps = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE status = 'rejected'")
    rejected_apps = c.fetchone()[0] or 0
    
    # ะงะฐัั
    c.execute("SELECT COUNT(*) FROM active_chats")
    total_chats = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM active_chats WHERE status = 'pending'")
    pending_chats = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM active_chats WHERE status = 'active'")
    active_chats = c.fetchone()[0] or 0
    
    # ะกะพะพะฑัะตะฝะธั
    c.execute("SELECT COUNT(*) FROM messages")
    total_messages = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL")
    user_messages = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL")
    admin_messages = c.fetchone()[0] or 0
    
    # ะัะทัะฒั
    c.execute("SELECT COUNT(*) FROM reviews")
    total_reviews = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(rating) FROM reviews")
    avg_rating = c.fetchone()[0] or 0
    
    # ะะตััั
    c.execute("SELECT COUNT(*) FROM rests WHERE status = 'active'")
    active_rests = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM rests")
    total_rests = c.fetchone()[0] or 0
    
    # ะะดะผะธะฝั ั ัะตะณะฐะผะธ
    c.execute("SELECT COUNT(*) FROM user_tags WHERE is_active = 1")
    total_admins = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะะะฉะะฏ ะกะขะะขะะกะขะะะ ะะะขะ\n\n"
    
    text += f"{COLORS['blue']} ๐ฅ ะะะะฌะะะะะขะะะ\n"
    text += f"   โข ะัะตะณะพ: {total_users}\n"
    text += f"   โข ะะบัะธะฒะฝัั: {active_users}\n"
    text += f"   โข ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {blocked_users}\n"
    text += f"   โข ะะดะผะธะฝะพะฒ ั ัะตะณะฐะผะธ: {total_admins}\n\n"
    
    text += f"{COLORS['violet']} ๐ ะะะฏะะะ ะะ ะะะะะะ\n"
    text += f"   โข ะัะตะณะพ: {total_apps}\n"
    text += f"   โข ๐ข ะะถะธะดะฐัั: {pending_apps}\n"
    text += f"   โข โ ะัะธะฝััะพ: {accepted_apps}\n"
    text += f"   โข โ ะัะบะปะพะฝะตะฝะพ: {rejected_apps}\n\n"
    
    text += f"{COLORS['night']} ๐ฌ ะงะะขะซ ะะะะะะะะะ\n"
    text += f"   โข ะัะตะณะพ: {total_chats}\n"
    text += f"   โข โณ ะะถะธะดะฐัั: {pending_chats}\n"
    text += f"   โข ๐ฌ ะะบัะธะฒะฝัั: {active_chats}\n\n"
    
    text += f"{COLORS['purple']} ๐จ ะกะะะะฉะะะะฏ\n"
    text += f"   โข ะัะตะณะพ: {total_messages}\n"
    text += f"   โข ๐ค ะั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {user_messages}\n"
    text += f"   โข ๐จโ๐ผ ะั ะฐะดะผะธะฝะพะฒ: {admin_messages}\n\n"
    
    text += f"{COLORS['blue']} โญ ะะขะะซะะซ\n"
    text += f"   โข ะัะตะณะพ: {total_reviews}\n"
    text += f"   โข ะกัะตะดะฝะธะน ัะตะนัะธะฝะณ: {avg_rating:.1f}/5\n\n"
    
    text += f"{COLORS['night']} ๐ด ะะะกะขะซ\n"
    text += f"   โข ะัะตะณะพ: {total_rests}\n"
    text += f"   โข ะะบัะธะฒะฝัั ัะตะนัะฐั: {active_rests}"
    
    await update.message.reply_text(text)


async def user_write(update: Update, context):
    """ะะฐะฟะธัะฐัั ัะพะพะฑัะตะฝะธะต /write ะธะปะธ /ะฝะฐะฟะธัะฐัั"""
    user_id = update.effective_user.id
    user_tag = get_user_tag(user_id)
    
    if user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะั ะฐะดะผะธะฝะธัััะฐัะพั. ะัะฟะพะปัะทัะนัะต ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั ะดะปั ัะฐะฑะพัั ั ัะฐัะฐะผะธ.",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("๐ ะะดะผะธะฝ-ะฟะฐะฝะตะปั", "admin_main_menu", 'purple')
            ]])
        )
        return
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ ะะฐะฟะธัะฐัั ัะพะพะฑัะตะฝะธะต\n\n"
        f"{COLORS['blue']} ะัะฑะตัะธัะต ัะธะฟ ะพะฑัะฐัะตะฝะธั:",
        reply_markup=get_message_type_keyboard()
    )


async def user_become_admin(update: Update, context):
    """ะกัะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ /admin ะธะปะธ /ััะฐััะฐะดะผะธะฝะพะผ"""
    user_id = update.effective_user.id
    user_tag = get_user_tag(user_id)
    
    if user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะั ัะถะต ัะฒะปัะตัะตัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ!",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("๐ ะะดะผะธะฝ-ะฟะฐะฝะตะปั", "admin_main_menu", 'purple')
            ]])
        )
        return
    
    await update.message.reply_text(
        f"{COLORS['night']} ๐ ะกัะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ\n\n"
        f"{COLORS['purple']} ะะฐะฟะพะปะฝะธัะต ะฐะฝะบะตัั:\n\n"
        f"{COLORS['blue']} ะัะฑะตัะธัะต ะฝะฐะฟัะฐะฒะปะตะฝะธะต:",
        reply_markup=get_app_type_keyboard()
    )


async def user_leave_review(update: Update, context):
    """ะััะฐะฒะธัั ะพัะทัะฒ /review ะธะปะธ /ะพัะทัะฒ"""
    await update.message.reply_text(
        f"{COLORS['purple']} โญ ะััะฐะฒะธัั ะพัะทัะฒ\n\n"
        f"{COLORS['blue']} ะัะตะฝะธัะต ะฝะฐัั ัะฐะฑะพัั ะพั 1 ะดะพ 5 ะทะฒะตะทะด:",
        reply_markup=get_rating_keyboard()
    )
    context.user_data['awaiting_review_rating'] = True


async def user_view_reviews(update: Update, context):
    """ะะพัะผะพััะตัั ะพัะทัะฒั /reviews ะธะปะธ /ะพัะทัะฒั"""
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("""SELECT rating, review_text, created_at, user_name 
                 FROM reviews 
                 WHERE status = 'viewed'
                 ORDER BY created_at DESC 
                 LIMIT 20""")
    reviews = c.fetchall()
    conn.close()
    
    if not reviews:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะพะฟัะฑะปะธะบะพะฒะฐะฝะฝัั ะพัะทัะฒะพะฒ\n\n"
            f"{COLORS['blue']} ะัะดััะต ะฟะตัะฒัะผ, ะบัะพ ะพััะฐะฒะธั ะพัะทัะฒ! โญ",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โญ ะััะฐะฒะธัั ะพัะทัะฒ", "leave_review", 'moon')
            ]])
        )
        return
    
    text = f"{COLORS['purple']} โญ ะะขะะซะะซ ะะะะฌะะะะะขะะะะ โญ\n\n"
    for rating, review, created, name in reviews:
        stars = "โญ" * rating
        text += f"{COLORS['blue']} {stars} ะพั {name}\n"
        text += f"{COLORS['violet']} ๐ {review[:100]}{'...' if len(review) > 100 else ''}\n"
        text += f"{COLORS['night']} ๐ {created[:16]}\n\n"
    
    # ะะฐะทะฑะธะฒะฐะตะผ ะดะปะธะฝะฝัะต ัะพะพะฑัะตะฝะธั
    if len(text) > 4000:
        parts = [text[i:i+4000] for i in range(0, len(text), 4000)]
        for part in parts:
            await update.message.reply_text(part)
    else:
        await update.message.reply_text(text)


async def user_rules(update: Update, context):
    """ะัะฐะฒะธะปะฐ /rules ะธะปะธ /ะฟัะฐะฒะธะปะฐ"""
    rules_text = (
        f"{COLORS['purple']} ๐ ะะะะะะะ ะกะะะะฉะะกะขะะ ๐\n\n"
        f"{COLORS['blue']} 1. ะััั ะฒะตะถะปะธะฒัะผ, ะฝะต ะพัะบะพัะฑะปััั ััะฐะฝะธัะตะปะตะน\n"
        f"{COLORS['violet']} 2. ะขะตะผั, ัะฒัะทะฐะฝะฝัะต ั 18+ ะทะฐะฟัะตัะตะฝั\n"
        f"{COLORS['night']} 3. ะะตัะตัะพะด ะฒ ะปะธัะฝัะต ัะพะพะฑัะตะฝะธั ะฝะต ะฒะพะทะผะพะถะตะฝ\n"
        f"{COLORS['purple']} 4. ะะต ัะฟะฐะผะธัั\n"
        f"{COLORS['blue']} 5. ะะต ะฟัะพัะธัั ะฒะฝะตัะฝะพััั ััะฐะฝะธัะตะปั, ะธะผั, ะฒะพะทัะฐัั ะธ ะณะพัะพะด\n\n"
        f"{COLORS['fog']} {COLORS['cloud']} ะะฐัััะธัะตะปะธ ะฑัะดัั ะทะฐะฑะฐะฝะตะฝั {COLORS['cloud']}"
    )
    
    await update.message.reply_text(rules_text)


async def user_change_admin(update: Update, context):
    """ะะฐะฟัะพัะธัั ัะผะตะฝั ะฐะดะผะธะฝะฐ /changeadmin"""
    user_id = update.effective_user.id
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ั ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะบัะธะฒะฝัะน ัะฐั
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT status, thread_id, taken_by_tag FROM active_chats WHERE user_id = ?", (user_id,))
    chat = c.fetchone()
    
    if not chat or chat[0] != 'active':
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ ั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ"
        )
        conn.close()
        return
    
    status, thread_id, old_admin_tag = chat
    
    user_tag = get_user_tag(user_id) or "ะะพะปัะทะพะฒะฐัะตะปั"
    
    # ะะตะฝัะตะผ ะฝะฐะทะฒะฐะฝะธะต ัะตะผั ะฒ ะณััะฟะฟะต
    try:
        await context.bot.edit_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=thread_id,
            name=f"๐ ะกะผะตะฝะฐ ะฐะดะผะธะฝะฐ - {old_admin_tag}"
        )
    except:
        pass
    
    # ะกะพะทะดะฐะตะผ ะทะฐัะฒะบั ะฝะฐ ัะผะตะฝั ะฐะดะผะธะฝะฐ
    await context.bot.send_message(
        chat_id=ADMIN_GROUP_ID,
        message_thread_id=PENDING_CHATS_THREAD_ID,
        text=f"{COLORS['purple']} ๐ ะะะฏะะะ ะะ ะกะะะะฃ ะะะะะะ (ะะข ะะะะฌะะะะะขะะะฏ)\n\n"
             f"{COLORS['blue']} ๐ค ะะพะปัะทะพะฒะฐัะตะปั: {user_tag}\n"
             f"{COLORS['violet']} ๐จโ๐ผ ะขะตะบััะธะน ะฐะดะผะธะฝ: {old_admin_tag}\n\n"
             f"{COLORS['fog']} ะงะฐั ััะตะฑัะตั ะฝะพะฒะพะณะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐ",
        reply_markup=InlineKeyboardMarkup([[
            create_fancy_button("โ ะะทััั ัะฐั", f"take_chat_{user_id}", 'moon')
        ]])
    )
    
    # ะะฑะฝะพะฒะปัะตะผ ััะฐััั ัะฐัะฐ
    c.execute("""UPDATE active_chats 
                 SET status = 'pending', taken_by_id = NULL, taken_by_tag = NULL, taken_at = NULL 
                 WHERE user_id = ?""", (user_id,))
    conn.commit()
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะฐะฟัะพั ะฝะฐ ัะผะตะฝั ะฐะดะผะธะฝะฐ ะพัะฟัะฐะฒะปะตะฝ!\n\n"
        f"{COLORS['blue']} ะะพะฒัะน ะฐะดะผะธะฝะธัััะฐัะพั ัะบะพัะพ ั ะฒะฐะผะธ ัะฒัะถะตััั. {COLORS['cloud']}"
    )


async def user_my_chat(update: Update, context):
    """ะะฝัะพัะผะฐัะธั ะพ ะผะพะตะผ ัะฐัะต /mychat"""
    user_id = update.effective_user.id
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT status, taken_by_tag, created_at, message_type FROM active_chats WHERE user_id = ?", (user_id,))
    chat = c.fetchone()
    conn.close()
    
    if not chat:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะฐะบัะธะฒะฝะพะณะพ ัะฐัะฐ ั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ.\n\n"
            f"{COLORS['blue']} ะงัะพะฑั ัะพะทะดะฐัั ัะฐั, ะธัะฟะพะปัะทัะนัะต /write"
        )
        return
    
    status, taker_tag, created_at, msg_type = chat
    
    status_text = {
        'pending': 'โณ ะะถะธะดะฐะตั ะฐะดะผะธะฝะธัััะฐัะพัะฐ',
        'active': '๐ฌ ะะบัะธะฒะฝัะน ัะฐั'
    }.get(status, status)
    
    text = f"{COLORS['purple']} ๐ ะะะคะะะะะฆะะฏ ะ ะะะจะะ ะงะะขะ\n\n"
    text += f"{COLORS['blue']} ๐ ะกัะฐััั: {status_text}\n"
    text += f"{COLORS['violet']} ๐ ะกะพะทะดะฐะฝ: {created_at[:16]}\n"
    text += f"{COLORS['night']} ๐ ะขะธะฟ: {msg_type}\n"
    
    if status == 'active' and taker_tag:
        text += f"{COLORS['purple']} ๐จโ๐ผ ะะดะผะธะฝ: {taker_tag}\n"
        text += f"\n{COLORS['blue']} ๐ ะงัะพะฑั ัะผะตะฝะธัั ะฐะดะผะธะฝะฐ, ะธัะฟะพะปัะทัะนัะต /changeadmin"
    
    await update.message.reply_text(text)


async def user_help(update: Update, context):
    """ะกะฟัะฐะฒะบะฐ ะฟะพ ะบะพะผะฐะฝะดะฐะผ /help ะธะปะธ /ะฟะพะผะพัั"""
    help_text = (
        f"{COLORS['purple']} ๐ค ะะะกะขะฃะะะซะ ะะะะะะะซ\n\n"
        f"{COLORS['blue']} ๐ /write - ะฝะฐะฟะธัะฐัั ัะพะพะฑัะตะฝะธะต ะฐะดะผะธะฝั\n"
        f"{COLORS['violet']} ๐ /admin  - ััะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะพะผ\n"
        f"{COLORS['night']} โญ /review  - ะพััะฐะฒะธัั ะพัะทัะฒ\n"
        f"{COLORS['purple']} ๐ /reviews - ะฟะพัะผะพััะตัั ะพัะทัะฒั\n"
        f"{COLORS['blue']} ๐ข /channel - ะขะะ ะบะฐะฝะฐะป\n"
        f"{COLORS['violet']} ๐ /rules - ะฟัะฐะฒะธะปะฐ ัะพะพะฑัะตััะฒะฐ\n"
        f"{COLORS['night']} ๐ฌ /mychat - ะธะฝัะพัะผะฐัะธั ะพ ะฒะฐัะตะผ ัะฐัะต\n"
        f"{COLORS['purple']} ๐ /changeadmin - ัะผะตะฝะธัั ะฐะดะผะธะฝะธัััะฐัะพัะฐ\n"
        f"{COLORS['blue']} ๐ /help - ััะพ ะผะตะฝั\n\n"
        f"{COLORS['violet']} โจ /mood  - ะทะฐะฟะพะปะฝะธัั ััะตะบะตั ะฝะฐัััะพะตะฝะธั ะธ ัะพััะพัะฝะธั \n"
        f"{COLORS['night']} ๐ /mood_history  - ะธััะพัะธั ััะตะบะตัะพะฒ\n"
        f"{COLORS['purple']} โญ /mood_stats - ััะฐัะธััะธะบะฐ ััะตะบะตัะพะฒ\n"
        f"{COLORS['violet']} {COLORS['cloud']} ะขะฐะบะถะต ะฒั ะผะพะถะตัะต ะธัะฟะพะปัะทะพะฒะฐัั ะบะฝะพะฟะบะธ ะผะตะฝั {COLORS['cloud']}"
    )
    
    await update.message.reply_text(help_text)


async def user_channel(update: Update, context):
    """ะขะะ ะะฐะฝะฐะป /channel ะธะปะธ /ะบะฐะฝะฐะป"""
    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("๐ข ะะตัะตะนัะธ", url=TG_CHANNEL_LINK),
        create_fancy_button("โ๏ธ ะ ะผะตะฝั", "user_main_menu", 'fog')
    ]])
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ข ะะฐั ะขะะ ะะฐะฝะฐะป:\n\n{TG_CHANNEL_LINK}",
        reply_markup=keyboard
    )


async def handle_user_message_command(update: Update, context):
    """ะะฑัะฐะฑะพััะธะบ ัะพะพะฑัะตะฝะธะน ะฟะพัะปะต ะบะพะผะฐะฝะดั /write"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    # ะัะพะฒะตััะตะผ, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะพะถะธะดะฐะตั ะฒะฒะพะดะฐ ัะพะพะฑัะตะฝะธั
    if not context.user_data.get('awaiting_message_command'):
        return False
    
    if user_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะั ะฐะดะผะธะฝะธัััะฐัะพั. ะัะฟะพะปัะทัะนัะต ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั."
        )
        del context.user_data['awaiting_message_command']
        return True
    
    msg_type = context.user_data.get('awaiting_message_type', 'communication')
    msg_type_name = MESSAGE_TYPES.get(msg_type, "๐ฌ ะะฑัะตะฝะธะต")
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("SELECT status FROM active_chats WHERE user_id = ?", (user.id,))
    existing_chat = c.fetchone()
    
    if existing_chat and existing_chat[0] == 'pending':
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ัะถะต ะตััั ะพะถะธะดะฐััะฐั ะทะฐัะฒะบะฐ, ะถะดะธัะต ะพัะฒะตัะฐ"
        )
        conn.close()
        del context.user_data['awaiting_message_command']
        del context.user_data['awaiting_message_type']
        return True
    
    thread_name = f"โณ {user.first_name}"
    
    try:
        thread = await context.bot.create_forum_topic(
            chat_id=ADMIN_GROUP_ID,
            name=thread_name[:128]
        )
        thread_id = thread.message_thread_id
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ัะตะผั: {e}")
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะทะฐัะฒะบะธ. ะะพะฟัะพะฑัะนัะต ะฟะพะทะถะต."
        )
        conn.close()
        del context.user_data['awaiting_message_command']
        del context.user_data['awaiting_message_type']
        return True
    
    content_type = get_message_type(update.message)
    c.execute("""INSERT INTO active_chats 
                 (user_id, user_name, username, thread_id, message_type, first_message, created_at, status)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
              (user.id, user.full_name, user.username, thread_id,
               msg_type_name, f"[{content_type}]", get_current_time(), 'pending'))
    conn.commit()
    
    await copy_message_to_chat(
        context, update.message, ADMIN_GROUP_ID, thread_id,
        f"๐ซ๏ธ ะะะะะฏ ะะะฏะะะ ะพั {user.first_name}\nID: {user.id} | @{user.username}\nะขะธะฟ: {msg_type_name}"
    )
    
    if PENDING_CHATS_THREAD_ID:
        # ะะพะปััะฐะตะผ ัะตะบัั ะฟะตัะฒะพะณะพ ัะพะพะฑัะตะฝะธั
        first_message_text = ""
        if update.message.text:
            first_message_text = update.message.text
        elif update.message.caption:
            first_message_text = update.message.caption
        else:
            content_type = get_message_type(update.message)
            first_message_text = f"[{content_type}]"
    
    # ะะฑัะตะทะฐะตะผ ะตัะปะธ ัะปะธัะบะพะผ ะดะปะธะฝะฝะพะต
        if len(first_message_text) > 100:
            first_message_text = first_message_text[:100] + "..."
    
        await context.bot.send_message(
            chat_id=ADMIN_GROUP_ID,
            message_thread_id=PENDING_CHATS_THREAD_ID,
            text=f"{COLORS['purple']} ๐ ะะะะะฏ ะะะฏะะะ\n\n"
                 f"{COLORS['blue']} ๐ค ะั: {user.full_name}\n"
                 f"{COLORS['violet']} ๐ ID: {user.id}\n"
                 f"{COLORS['night']} ๐ฑ Username: @{user.username}\n"
                 f"{COLORS['purple']} ๐ ะขะธะฟ: {msg_type_name}\n"
                 f"{COLORS['blue']} ๐ ะะตัะฒะพะต ัะพะพะฑัะตะฝะธะต:\n"
                 f"โ {first_message_text}\n\n"
                 f"{COLORS['violet']} ๐ ะงะฐั: {thread_name}",
            reply_markup=InlineKeyboardMarkup([[
                create_fancy_button("โ ะะทััั ะฒ ัะฐะฑะพัั", f"take_chat_{user.id}", 'moon')
            ]])
        )
    
    await update.message.reply_text(
        f"{COLORS['purple']} โ ะะฐัะฐ ะทะฐัะฒะบะฐ ัะพะทะดะฐะฝะฐ! ะัะตะผ ะฐะดะผะธะฝะฐ {COLORS['cloud']}"
    )
    
    conn.close()
    del context.user_data['awaiting_message_command']
    del context.user_data['awaiting_message_type']
    return True



async def stats_my_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะผะพั ััะฐัะธััะธะบั"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะงะฐัั
    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_by_id = ? AND status = 'active'", (user_id,))
    active_chats = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_by_id = ?", (user_id,))
    total_taken = c.fetchone()[0] or 0
    
    # ะกะพะพะฑัะตะฝะธั
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker = ?", (user_id,))
    messages_sent = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(LENGTH(text)) FROM messages WHERE from_taker = ?", (user_id,))
    avg_length = c.fetchone()[0] or 0
    
    # ะะตััั
    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ? AND status = 'active'", (user_id,))
    active_rests = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ?", (user_id,))
    total_rests = c.fetchone()[0] or 0
    
    # ะะตัะฒัะน ะธ ะฟะพัะปะตะดะฝะธะน ัะฐั
    c.execute("SELECT MIN(created_at) FROM active_chats WHERE taken_by_id = ?", (user_id,))
    first_chat = c.fetchone()[0] or "ะฝะตั"
    
    c.execute("SELECT MAX(created_at) FROM active_chats WHERE taken_by_id = ?", (user_id,))
    last_chat = c.fetchone()[0] or "ะฝะตั"
    
    # ะะบัะธะฒะฝะพััั ะฟะพ ะดะฝัะผ ะฝะตะดะตะปะธ
    c.execute("""
        SELECT strftime('%w', created_at) as weekday, COUNT(*) 
        FROM messages 
        WHERE from_taker = ? 
        GROUP BY weekday
    """, (user_id,))
    weekday_stats = c.fetchall()
    
    conn.close()
    
    days = ['ะั', 'ะะฝ', 'ะั', 'ะกั', 'ะงั', 'ะั', 'ะกะฑ']
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ {user_tag}\n\n"
    
    text += f"{COLORS['blue']} ๐ ะงะะขะซ\n"
    text += f"   โข ะัะตะณะพ ะฒะทััะพ: {total_taken}\n"
    text += f"   โข ะะบัะธะฒะฝัั ัะตะนัะฐั: {active_chats}\n\n"
    
    text += f"{COLORS['violet']} ๐จ ะกะะะะฉะะะะฏ\n"
    text += f"   โข ะัะฟัะฐะฒะปะตะฝะพ: {messages_sent}\n"
    text += f"   โข ะกัะตะดะฝัั ะดะปะธะฝะฐ: {avg_length:.0f} ัะธะผะฒ.\n\n"
    
    text += f"{COLORS['night']} ๐ด ะะะกะขะซ\n"
    text += f"   โข ะัะตะณะพ: {total_rests}\n"
    text += f"   โข ะะบัะธะฒะฝัั: {active_rests}\n\n"
    
    text += f"{COLORS['purple']} ๐ ะะะขะะะะะกะขะฌ\n"
    text += f"   โข ะะตัะฒัะน ัะฐั: {first_chat[:16] if first_chat != 'ะฝะตั' else 'ะฝะตั'}\n"
    text += f"   โข ะะพัะปะตะดะฝะธะน ัะฐั: {last_chat[:16] if last_chat != 'ะฝะตั' else 'ะฝะตั'}\n"
    
    if weekday_stats:
        text += f"   โข ะะพ ะดะฝัะผ:\n"
        for wd, count in weekday_stats:
            day_name = days[int(wd)] if wd and wd.isdigit() else '?'
            text += f"     {day_name}: {count} ัะพะพะฑั.\n"
    
    await update.message.reply_text(text)


async def stats_admins_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะฟะพ ะฒัะตะผ ะฐะดะผะธะฝะฐะผ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT 
            ut.user_tag,
            COUNT(DISTINCT ac.user_id) as chats_count,
            COUNT(m.id) as messages_count,
            COUNT(DISTINCT CASE WHEN r.status = 'active' THEN r.id END) as active_rests
        FROM user_tags ut
        LEFT JOIN active_chats ac ON ut.user_id = ac.taken_by_id
        LEFT JOIN messages m ON ut.user_id = m.from_taker
        LEFT JOIN rests r ON ut.user_id = r.admin_id
        WHERE ut.is_active = 1
        GROUP BY ut.user_tag
        ORDER BY messages_count DESC
    """)
    admins = c.fetchall()
    
    # ะะฑัะธะต ะฟะพะบะฐะทะฐัะตะปะธ
    total_messages = sum(a[2] for a in admins)
    total_chats = sum(a[1] for a in admins)
    total_admins = len(admins)
    
    # ะัะพ ัะตะนัะฐั ะฒ ัะตััะต
    c.execute("SELECT admin_tag FROM rests WHERE status = 'active'")
    in_rest = [r[0] for r in c.fetchall()]
    
    conn.close()
    
    if not admins:
        await update.message.reply_text(f"{COLORS['purple']} ๐ ะะตั ะฐะบัะธะฒะฝัั ะฐะดะผะธะฝะพะฒ")
        return
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะ ะะะะะะะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะฐะดะผะธะฝะพะฒ: {total_admins}\n"
    text += f"{COLORS['violet']} ะัะตะณะพ ัะพะพะฑัะตะฝะธะน: {total_messages}\n"
    text += f"{COLORS['night']} ะัะตะณะพ ัะฐัะพะฒ: {total_chats}\n\n"
    
    medals = ['๐ฅ', '๐ฅ', '๐ฅ']
    for i, (tag, chats, msgs, active_rests) in enumerate(admins[:10]):
        medal = medals[i] if i < 3 else f"{i+1}."
        rest_mark = " ๐ด" if tag in in_rest else ""
        text += f"{COLORS['purple']} {medal} {tag}{rest_mark}\n"
        text += f"{COLORS['blue']}    ๐จ {msgs} ัะพะพะฑั. | ๐ {chats} ัะฐัะพะฒ"
        if active_rests:
            text += f" | ๐ด ะฒ ัะตััะต"
        text += "\n\n"
    
    await update.message.reply_text(text)


async def stats_today_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะทะฐ ัะตะณะพะดะฝั"""
    await show_stats_period(update, context, "today", "ะกะะะะะะฏ")


async def stats_week_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะทะฐ ะฝะตะดะตะปั"""
    await show_stats_period(update, context, "week", "ะะะะะะฎ")


async def stats_month_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะทะฐ ะผะตััั"""
    await show_stats_period(update, context, "month", "ะะะกะฏะฆ")


async def show_stats_period(update: Update, context, period: str, period_name: str):
    """ะะฑัะฐั ััะฝะบัะธั ะดะปั ััะฐัะธััะธะบะธ ะทะฐ ะฟะตัะธะพะด"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    now = datetime.now()
    if period == "today":
        start_date = now.replace(hour=0, minute=0, second=0, microsecond=0)
    elif period == "week":
        start_date = now - timedelta(days=7)
    elif period == "month":
        start_date = now - timedelta(days=30)
    else:
        start_date = now - timedelta(days=1)
    
    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะฐัะฒะบะธ ะฝะฐ ะฐะดะผะธะฝะฐ
    c.execute("SELECT COUNT(*) FROM applications WHERE created_at > ?", (start_str,))
    new_apps = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM applications WHERE reviewed_at > ?", (start_str,))
    reviewed_apps = c.fetchone()[0] or 0
    
    # ะงะฐัั
    c.execute("SELECT COUNT(*) FROM active_chats WHERE created_at > ?", (start_str,))
    new_chats = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_at > ?", (start_str,))
    taken_chats = c.fetchone()[0] or 0
    
    # ะกะพะพะฑัะตะฝะธั
    c.execute("SELECT COUNT(*) FROM messages WHERE created_at > ?", (start_str,))
    total_msgs = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL AND created_at > ?", (start_str,))
    user_msgs = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL AND created_at > ?", (start_str,))
    admin_msgs = c.fetchone()[0] or 0
    
    # ะัะทัะฒั
    c.execute("SELECT COUNT(*) FROM reviews WHERE created_at > ?", (start_str,))
    new_reviews = c.fetchone()[0] or 0
    
    # ะะตััั
    c.execute("SELECT COUNT(*) FROM rests WHERE created_at > ?", (start_str,))
    new_rests = c.fetchone()[0] or 0
    
    # ะขะพะฟ ะฐะดะผะธะฝะพะฒ ะทะฐ ะฟะตัะธะพะด
    c.execute("""
        SELECT taker_tag, COUNT(*) as msg_count 
        FROM messages 
        WHERE from_taker IS NOT NULL AND created_at > ? 
        GROUP BY taker_tag 
        ORDER BY msg_count DESC 
        LIMIT 5
    """, (start_str,))
    top_admins = c.fetchall()
    
    # ะะพะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (start_str,))
    new_users = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะ {period_name}\n\n"
    
    text += f"{COLORS['blue']} ๐ฅ ะะพะฒัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {new_users}\n"
    text += f"{COLORS['violet']} ๐ ะะพะฒัั ะทะฐัะฒะพะบ: {new_apps}\n"
    text += f"{COLORS['night']} โ ะะฐััะผะพััะตะฝะพ ะทะฐัะฒะพะบ: {reviewed_apps}\n\n"
    
    text += f"{COLORS['purple']} ๐ฌ ะะพะฒัั ัะฐัะพะฒ: {new_chats}\n"
    text += f"{COLORS['blue']} ๐ ะะทััะพ ะฒ ัะฐะฑะพัั: {taken_chats}\n\n"
    
    text += f"{COLORS['violet']} ๐จ ะกะพะพะฑัะตะฝะธะน:\n"
    text += f"   โข ะัะตะณะพ: {total_msgs}\n"
    text += f"   โข ๐ค ะั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {user_msgs}\n"
    text += f"   โข ๐จโ๐ผ ะั ะฐะดะผะธะฝะพะฒ: {admin_msgs}\n\n"
    
    text += f"{COLORS['night']} โญ ะะพะฒัั ะพัะทัะฒะพะฒ: {new_reviews}\n"
    text += f"{COLORS['purple']} ๐ด ะะพะฒัั ัะตััะพะฒ: {new_rests}\n\n"
    
    if top_admins:
        text += f"{COLORS['blue']} ๐ ะขะพะฟ ะฐะดะผะธะฝะพะฒ:\n"
        for tag, count in top_admins:
            text += f"{COLORS['violet']}    {tag}: {count} ัะพะพะฑั.\n"
    
    await update.message.reply_text(text)


async def users_stats_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ััะฐัะธััะธะบั ะฟะพ ะฟะพะปัะทะพะฒะฐัะตะปัะผ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    # ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ (ัะพะปัะบะพ ะดะปั ะฐะดะผะธะฝะพะฒ)
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะัะฝะพะฒะฝะฐั ััะฐัะธััะธะบะฐ
    c.execute("SELECT COUNT(*) FROM users")
    total_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_active = 1")
    active_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    blocked_users = c.fetchone()[0] or 0
    
    # ะะบัะธะฒะฝะพััั ะทะฐ ะฟะพัะปะตะดะฝะธะต 24 ัะฐัะฐ
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (yesterday,))
    active_24h = c.fetchone()[0] or 0
    
    # ะะบัะธะฒะฝะพััั ะทะฐ ะฝะตะดะตะปั
    week_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (week_ago,))
    active_week = c.fetchone()[0] or 0
    
    # ะะบัะธะฒะฝะพััั ะทะฐ ะผะตััั
    month_ago = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d %H:%M:%S')
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (month_ago,))
    active_month = c.fetchone()[0] or 0
    
    # ะะพะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (week_ago,))
    new_week = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (month_ago,))
    new_month = c.fetchone()[0] or 0
    
    # ะกะพะพะฑัะตะฝะธั ะพั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL")
    total_user_messages = c.fetchone()[0] or 0
    
    # ะกัะตะดะฝะตะต ะบะพะปะธัะตััะฒะพ ัะพะพะฑัะตะฝะธะน ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
    if total_users > 0:
        avg_messages = total_user_messages / total_users
    else:
        avg_messages = 0
    
    # ะขะพะฟ-10 ัะฐะผัั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    c.execute("""
        SELECT u.user_id, u.username, u.first_name, COUNT(m.id) as msg_count
        FROM users u
        LEFT JOIN messages m ON u.user_id = m.user_id
        GROUP BY u.user_id
        ORDER BY msg_count DESC
        LIMIT 10
    """)
    top_users = c.fetchall()
    
    # ะะพัะปะตะดะฝะธะต ะฐะบัะธะฒะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ
    c.execute("""
        SELECT username, first_name, last_activity 
        FROM users 
        WHERE last_activity IS NOT NULL 
        ORDER BY last_activity DESC 
        LIMIT 5
    """)
    last_active = c.fetchall()
    
    conn.close()
    
    # ะคะพัะผะธััะตะผ ัะตะบัั
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะะฌะะะะะขะะะะ\n\n"
    
    text += f"{COLORS['blue']} ๐ฅ ะะะฉะะฏ ะะะคะะะะะฆะะฏ\n"
    text += f"   โข ะัะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {total_users}\n"
    text += f"   โข ะะบัะธะฒะฝัั (ัะตะนัะฐั): {active_users}\n"
    text += f"   โข ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {blocked_users}\n\n"
    
    text += f"{COLORS['violet']} โฑ ะะะขะะะะะกะขะฌ\n"
    text += f"   โข ะะฐ 24 ัะฐัะฐ: {active_24h}\n"
    text += f"   โข ะะฐ ะฝะตะดะตะปั: {active_week}\n"
    text += f"   โข ะะฐ ะผะตััั: {active_month}\n\n"
    
    text += f"{COLORS['night']} ๐ ะะะะซะ ะะะะฌะะะะะขะะะ\n"
    text += f"   โข ะะฐ ะฝะตะดะตะปั: {new_week}\n"
    text += f"   โข ะะฐ ะผะตััั: {new_month}\n\n"
    
    text += f"{COLORS['purple']} ๐จ ะกะะะะฉะะะะฏ\n"
    text += f"   โข ะัะตะณะพ ะพั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {total_user_messages}\n"
    text += f"   โข ะ ััะตะดะฝะตะผ ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั: {avg_messages:.1f}\n\n"
    
    if top_users:
        text += f"{COLORS['blue']} ๐ ะขะะ-10 ะะะขะะะะซะฅ ะะะะฌะะะะะขะะะะ\n"
        for i, (user_id, username, first_name, msg_count) in enumerate(top_users, 1):
            name = first_name or "ะะตะท ะธะผะตะฝะธ"
            username_str = f" (@{username})" if username else ""
            text += f"{COLORS['violet']}   {i}. {name}{username_str}\n"
            text += f"{COLORS['night']}      ๐จ {msg_count} ัะพะพะฑั. | ๐ {user_id}\n"
        text += "\n"
    
    if last_active:
        text += f"{COLORS['purple']} ๐ฅ ะะะกะะะะะะ ะะะขะะะะซะ\n"
        for username, first_name, last_time in last_active:
            name = first_name or "ะะตะท ะธะผะตะฝะธ"
            username_str = f" (@{username})" if username else ""
            time_str = last_time[:16] if last_time else "ะฝะตะธะทะฒ."
            text += f"{COLORS['blue']}   โข {name}{username_str}\n"
            text += f"{COLORS['violet']}     โฑ {time_str}\n"
    
    await update.message.reply_text(text)


async def users_top_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะพะฟ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฟะพ ัะพะพะฑัะตะฝะธัะผ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    # ะะพะปััะฐะตะผ ัััะฐะฝะธัั
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ะบะพะปะธัะตััะฒะพะผ ัะพะพะฑัะตะฝะธะน
    c.execute("""
        SELECT u.user_id, u.username, u.first_name, COUNT(m.id) as msg_count,
               MAX(m.created_at) as last_message
        FROM users u
        LEFT JOIN messages m ON u.user_id = m.user_id
        GROUP BY u.user_id
        HAVING msg_count > 0
        ORDER BY msg_count DESC
    """)
    all_users = c.fetchall()
    
    # ะะฑัะตะต ะบะพะปะธัะตััะฒะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ัะพะพะฑัะตะฝะธัะผะธ
    c.execute("SELECT COUNT(DISTINCT user_id) FROM messages WHERE from_user IS NOT NULL")
    total_active = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_users:
        await update.message.reply_text(f"{COLORS['purple']} ๐ ะะตั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน")
        return
    
    # ะะฐะณะธะฝะฐัะธั
    users_per_page = 10
    total_pages = (len(all_users) + users_per_page - 1) // users_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * users_per_page
    end_idx = min(start_idx + users_per_page, len(all_users))
    current_users = all_users[start_idx:end_idx]
    
    text = f"{COLORS['purple']} ๐ ะขะะ ะะะะฌะะะะะขะะะะ (ััั. {page}/{total_pages})\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ ะฐะบัะธะฒะฝัั: {total_active}\n\n"
    
    for i, (user_id, username, first_name, msg_count, last_msg) in enumerate(current_users, start_idx + 1):
        name = first_name or "ะะตะท ะธะผะตะฝะธ"
        username_str = f" (@{username})" if username else ""
        medal = "๐ฅ" if i == 1 else "๐ฅ" if i == 2 else "๐ฅ" if i == 3 else f"{i}."
        
        text += f"{COLORS['violet']} {medal} {name}{username_str}\n"
        text += f"{COLORS['night']}    ๐จ {msg_count} ัะพะพะฑั. | ๐ {user_id}\n"
        if last_msg:
            text += f"{COLORS['blue']}    โฑ {last_msg[:16]}\n"
        text += "\n"
    
    # ะะฐะฒะธะณะฐัะธั
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ", f"users_top_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("โถ๏ธ", f"users_top_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def users_blocked_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT user_id, username, first_name, last_activity 
        FROM users 
        WHERE is_bot_blocked = 1 
        ORDER BY last_activity DESC
    """)
    blocked = c.fetchall()
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    total_blocked = c.fetchone()[0] or 0
    
    conn.close()
    
    if not blocked:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ"
        )
        return
    
    text = f"{COLORS['purple']} ๐ซ ะะะะะะะะะะะะะจะะ ะะะขะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {total_blocked}\n\n"
    
    for user_id, username, first_name, last_activity in blocked[:20]:
        name = first_name or "ะะตะท ะธะผะตะฝะธ"
        username_str = f" (@{username})" if username else ""
        last_time = last_activity[:16] if last_activity else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} โข {name}{username_str}\n"
        text += f"{COLORS['night']}   ๐ {user_id}\n"
        text += f"{COLORS['blue']}   โฑ {last_time}\n\n"
    
    if len(blocked) > 20:
        text += f"{COLORS['purple']} ... ะธ ะตัะต {len(blocked) - 20} ะฟะพะปัะทะพะฒะฐัะตะปะตะน"
    
    await update.message.reply_text(text)


async def users_new_command(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฝะพะฒัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน"""
    user = update.effective_user
    user_tag = get_user_tag(user.id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    period = "week"
    if context.args and context.args[0] in ["day", "week", "month"]:
        period = context.args[0]
    
    now = datetime.now()
    if period == "day":
        start_date = now - timedelta(days=1)
        period_name = "ะะะะฌ"
    elif period == "week":
        start_date = now - timedelta(days=7)
        period_name = "ะะะะะะฎ"
    else:
        start_date = now - timedelta(days=30)
        period_name = "ะะะกะฏะฆ"
    
    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT user_id, username, first_name, first_seen 
        FROM users 
        WHERE first_seen > ? 
        ORDER BY first_seen DESC
    """, (start_str,))
    new_users = c.fetchall()
    
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (start_str,))
    total_new = c.fetchone()[0] or 0
    
    conn.close()
    
    if not new_users:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะตั ะฝะพะฒัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะทะฐ {period_name}"
        )
        return
    
    text = f"{COLORS['purple']} ๐ ะะะะซะ ะะะะฌะะะะะขะะะ ะะ {period_name}\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {total_new}\n\n"
    
    for user_id, username, first_name, first_seen in new_users[:20]:
        name = first_name or "ะะตะท ะธะผะตะฝะธ"
        username_str = f" (@{username})" if username else ""
        seen_time = first_seen[:16] if first_seen else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['violet']} โข {name}{username_str}\n"
        text += f"{COLORS['night']}   ๐ {user_id}\n"
        text += f"{COLORS['blue']}   ๐ {seen_time}\n\n"
    
    if len(new_users) > 20:
        text += f"{COLORS['purple']} ... ะธ ะตัะต {len(new_users) - 20} ะฟะพะปัะทะพะฒะฐัะตะปะตะน"
    
    await update.message.reply_text(text)


async def blocked_users_list(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะฟะธัะพะบ ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    # ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ (ัะพะปัะบะพ ะดะปั ะฐะดะผะธะฝะพะฒ)
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    # ะัะพะฒะตััะตะผ, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะดะผะธะฝ ะณััะฟะฟั
    if not await is_group_member(user_id, context):
        await update.message.reply_text(f"{COLORS['purple']} โ ะขะพะปัะบะพ ะฐะดะผะธะฝะธัััะฐัะพัั ะผะพะณัั ะธัะฟะพะปัะทะพะฒะฐัั ััั ะบะพะผะฐะฝะดั")
        return
    
    # ะะพะปััะฐะตะผ ะฝะพะผะตั ัััะฐะฝะธัั
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะตั ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั
    c.execute("""
        SELECT user_id, username, first_name, last_activity 
        FROM users 
        WHERE is_bot_blocked = 1 
        ORDER BY last_activity DESC
    """)
    all_blocked = c.fetchall()
    
    # ะะฑัะตะต ะบะพะปะธัะตััะฒะพ
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    total_blocked = c.fetchone()[0] or 0
    
    conn.close()
    
    if not all_blocked:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ\n\n"
            f"{COLORS['blue']} ะัะต ัะพัะพัะพ! ๐"
        )
        return
    
    # ะะฐะณะธะฝะฐัะธั
    items_per_page = 10
    total_pages = (len(all_blocked) + items_per_page - 1) // items_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * items_per_page
    end_idx = min(start_idx + items_per_page, len(all_blocked))
    current_blocked = all_blocked[start_idx:end_idx]
    
    # ะะฐะณะพะปะพะฒะพะบ
    text = f"{COLORS['purple']} ๐ซ ะะะะฌะะะะะขะะะ, ะะะะะะะะะะะะะจะะ ะะะขะ\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {total_blocked} | ะกััะฐะฝะธัะฐ {page}/{total_pages}\n\n"
    
    # ะกะฟะธัะพะบ
    for i, (uid, username, first_name, last_activity) in enumerate(current_blocked, start_idx + 1):
        name = first_name or "ะะตะท ะธะผะตะฝะธ"
        username_str = f" (@{username})" if username else ""
        last_time = last_activity[:16] if last_activity else "ะฝะตะธะทะฒะตััะฝะพ"
        
        text += f"{COLORS['violet']} {i}. {name}{username_str}\n"
        text += f"{COLORS['night']}    ๐ {uid}\n"
        text += f"{COLORS['blue']}    โฑ ะะพัะปะตะดะฝัั ะฐะบัะธะฒะฝะพััั: {last_time}\n\n"
    
    # ะะฐะฒะธะณะฐัะธั
    nav_buttons = []
    if page > 1:
        nav_buttons.append(create_fancy_button("โ๏ธ ะัะตะดัะดััะฐั", f"blocked_page_{page-1}", 'moon'))
    if page < total_pages:
        nav_buttons.append(create_fancy_button("ะกะปะตะดัััะฐั โถ๏ธ", f"blocked_page_{page+1}", 'night'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([create_fancy_button("๐ ะะฑะฝะพะฒะธัั", f"blocked_page_{page}", 'blue')])
    keyboard.append([create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def blocked_users_count(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะพะปัะบะพ ะบะพะปะธัะตััะฒะพ ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    count = c.fetchone()[0] or 0
    conn.close()
    
    if count == 0:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน, ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฑะพัะฐ"
        )
    else:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ซ ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {count}\n"
            f"{COLORS['blue']} /blockedlist - ะฟะพัะผะพััะตัั ัะฟะธัะพะบ"
        )


async def blocked_users_export(update: Update, context):
    """ะญะบัะฟะพััะธัะพะฒะฐัั ัะฟะธัะพะบ ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฒ ัะฐะนะป"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""
        SELECT user_id, username, first_name, last_activity 
        FROM users 
        WHERE is_bot_blocked = 1 
        ORDER BY last_activity DESC
    """)
    blocked = c.fetchall()
    
    conn.close()
    
    if not blocked:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั")
        return
    
    # ะกะพะทะดะฐะตะผ ัะตะบััะพะฒัะน ัะฐะนะป
    filename = f"blocked_users_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    
    with open(filename, 'w', encoding='utf-8') as f:
        f.write("ะกะะะกะะ ะะะะฌะะะะะขะะะะ, ะะะะะะะะะะะะะจะะฅ ะะะขะ\n")
        f.write("=" * 50 + "\n\n")
        f.write(f"ะัะตะณะพ: {len(blocked)}\n\n")
        
        for uid, username, first_name, last_activity in blocked:
            f.write(f"ID: {uid}\n")
            f.write(f"ะะผั: {first_name or 'ะะต ัะบะฐะทะฐะฝะพ'}\n")
            f.write(f"Username: @{username if username else 'ะพััััััะฒัะตั'}\n")
            f.write(f"ะะพัะปะตะดะฝัั ะฐะบัะธะฒะฝะพััั: {last_activity or 'ะฝะตะธะทะฒะตััะฝะพ'}\n")
            f.write("-" * 30 + "\n")
    
    # ะัะฟัะฐะฒะปัะตะผ ัะฐะนะป
    with open(filename, 'rb') as f:
        await update.message.reply_document(
            document=f,
            filename=filename,
            caption=f"{COLORS['purple']} ๐ ะญะบัะฟะพัั ะทะฐะฑะปะพะบะธัะพะฒะฐะฒัะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน\n\n{COLORS['blue']} ะัะตะณะพ: {len(blocked)}"
        )
    
    # ะฃะดะฐะปัะตะผ ัะฐะนะป
    os.remove(filename)


async def refresh_invite_command(update: Update, context):
    """ะะฑะฝะพะฒะธัั ะพะดะฝะพัะฐะทะพะฒัั ัััะปะบั-ะฟัะธะณะปะฐัะตะฝะธะต"""
    admin_id = update.effective_user.id
    admin_tag = get_user_tag(admin_id)
    
    # ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ (ัะพะปัะบะพ ะณะปะฐะฒะฝัะต ะฐะดะผะธะฝั)
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    # ะัะฟัะฐะฒะปัะตะผ ัะพะพะฑัะตะฝะธะต ะพ ะฝะฐัะฐะปะต ะฟัะพัะตััะฐ
    status_msg = await update.message.reply_text(
        f"{COLORS['purple']} ๐ ะะฑะฝะพะฒะปะตะฝะธะต ัััะปะบะธ...\n\n{COLORS['blue']} ะะพะถะฐะปัะนััะฐ, ะฟะพะดะพะถะดะธัะต."
    )
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะัะตะผ ะฟะพัะปะตะดะฝัั ะฐะบัะธะฒะฝัั ัััะปะบั
    c.execute("""
        SELECT link FROM invite_links 
        WHERE is_used = 0 
        ORDER BY created_at DESC LIMIT 1
    """)
    last_link = c.fetchone()
    
    new_link = None
    
    if last_link:
        old_link = last_link[0]
        
        # ะััะฐะตะผัั ะพัะพะทะฒะฐัั ััะฐััั ัััะปะบั
        try:
            await context.bot.revoke_chat_invite_link(
                chat_id=ADMIN_GROUP_ID,
                invite_link=old_link
            )
            print(f"โ ะกัะฐัะฐั ัััะปะบะฐ ะพัะพะทะฒะฐะฝะฐ: {old_link}")
        except Exception as e:
            print(f"โ๏ธ ะะต ัะดะฐะปะพัั ะพัะพะทะฒะฐัั ััะฐััั ัััะปะบั: {e}")
        
        # ะกะพะทะดะฐะตะผ ะฝะพะฒัั
        new_link = await create_invite_link(context, None)
    else:
        # ะัะปะธ ะฝะตั ััะฐััั ัััะปะพะบ, ะฟัะพััะพ ัะพะทะดะฐะตะผ ะฝะพะฒัั
        new_link = await create_invite_link(context, None)
    
    conn.close()
    
    # ะฃะดะฐะปัะตะผ ััะฐัััะฝะพะต ัะพะพะฑัะตะฝะธะต
    await status_msg.delete()
    
    if new_link:
        # ะคะพัะผะธััะตะผ ะบัะฐัะธะฒะพะต ัะพะพะฑัะตะฝะธะต
        text = f"{COLORS['purple']} ๐ ะะะะะฏ ะกะกะซะะะ-ะะะะะะะจะะะะ\n\n"
        text += f"{COLORS['blue']} ะกััะปะบะฐ:\n"
        text += f"`{new_link}`\n\n"
        text += f"{COLORS['violet']} โ๏ธ ะะะะะะะะะะะฏ\n"
        text += f"{COLORS['night']} ๐ ะะตะนััะฒัะตั 7 ะดะฝะตะน\n"
        text += f"{COLORS['purple']} ๐ค ะขะพะปัะบะพ ะดะปั ะพะดะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั\n\n"
        text += f"{COLORS['blue']} ะัะฟัะฐะฒะธัั ะฝะพะฒะพะผั ะฐะดะผะธะฝั:"
        
        # ะะฝะพะฟะบะธ ะดะปั ะพัะฟัะฐะฒะบะธ
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("๐ ะะพะฟะธัะพะฒะฐัั", callback_data="copy_link")],
            [create_fancy_button("๐ค ะัะฟัะฐะฒะธัั ะฒ ะะก", f"send_link_to_{admin_id}", 'moon')],
            [create_fancy_button("โ๏ธ ะะฐะทะฐะด", "admin_main_menu", 'fog')]
        ])
        
        await update.message.reply_text(
            text, 
            reply_markup=keyboard,
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัััะปะบะธ\n\n"
            f"{COLORS['blue']} ะะพะฟัะพะฑัะนัะต ะฟะพะทะถะต ะธะปะธ ะฟัะพะฒะตัััะต ะฟัะฐะฒะฐ ะฑะพัะฐ."
        )


async def refresh_invite_simple(update: Update, context):
    """ะัะพััะฐั ะบะพะผะฐะฝะดะฐ ะพะฑะฝะพะฒะปะตะฝะธั ัััะปะบะธ (ะฑะตะท ะปะธัะฝะธั ัะพะพะฑัะตะฝะธะน)"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะัะตะผ ะฟะพัะปะตะดะฝัั ะฐะบัะธะฒะฝัั ัััะปะบั
    c.execute("""
        SELECT link FROM invite_links 
        WHERE is_used = 0 
        ORDER BY created_at DESC LIMIT 1
    """)
    last_link = c.fetchone()
    
    if last_link:
        old_link = last_link[0]
        try:
            await context.bot.revoke_chat_invite_link(
                chat_id=ADMIN_GROUP_ID,
                invite_link=old_link
            )
        except:
            pass
    
    # ะกะพะทะดะฐะตะผ ะฝะพะฒัั ัััะปะบั
    new_link = await create_invite_link(context, None)
    
    conn.close()
    
    if new_link:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะะพะฒะฐั ัััะปะบะฐ ัะพะทะดะฐะฝะฐ:\n\n"
            f"{new_link}\n\n"
            f"{COLORS['blue']} โ๏ธ ะะดะฝะพัะฐะทะพะฒะฐั, ะดะตะนััะฒัะตั 7 ะดะฝะตะน"
        )
    else:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ")


async def invite_link_info(update: Update, context):
    """ะะพะบะฐะทะฐัั ะธะฝัะพัะผะฐัะธั ะพ ัะตะบััะตะน ัััะปะบะต"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝัั ะฐะบัะธะฒะฝัั ัััะปะบั
    c.execute("""
        SELECT link, created_at, expires_at, is_used 
        FROM invite_links 
        WHERE is_used = 0 
        ORDER BY created_at DESC LIMIT 1
    """)
    link_info = c.fetchone()
    
    # ะกัะฐัะธััะธะบะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
    c.execute("SELECT COUNT(*) FROM invite_links WHERE is_used = 1")
    used_count = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM invite_links")
    total_count = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะะะคะะะะะฆะะฏ ะ ะกะกะซะะะะฅ\n\n"
    
    if link_info:
        link, created, expires, is_used = link_info
        created_date = datetime.strptime(created, '%Y-%m-%d %H:%M:%S') if created else None
        expires_date = datetime.strptime(expires, '%Y-%m-%d %H:%M:%S') if expires else None
        
        if expires_date:
            days_left = (expires_date - datetime.now()).days
        
        text += f"{COLORS['blue']} ะขะตะบััะฐั ัััะปะบะฐ:\n"
        text += f"`{link}`\n\n"
        text += f"{COLORS['violet']} ๐ ะกะพะทะดะฐะฝะฐ: {created[:16] if created else 'ะฝะตะธะทะฒ.'}\n"
        if expires_date:
            text += f"{COLORS['night']} โฑ ะััะตะบะฐะตั: {expires[:16]}\n"
            text += f"{COLORS['purple']}   (ะพััะฐะปะพัั {days_left} ะดะฝ.)\n"
    else:
        text += f"{COLORS['blue']} ะะตั ะฐะบัะธะฒะฝัั ัััะปะพะบ\n\n"
    
    text += f"\n{COLORS['violet']} ๐ ะกัะฐัะธััะธะบะฐ:\n"
    text += f"   โข ะัะฟะพะปัะทะพะฒะฐะฝะพ: {used_count}\n"
    text += f"   โข ะัะตะณะพ ัะพะทะดะฐะฝะพ: {total_count}\n\n"
    
    text += f"{COLORS['night']} /refreshlink - ัะพะทะดะฐัั ะฝะพะฒัั ัััะปะบั"
    
    await update.message.reply_text(text, parse_mode='Markdown')


async def change_tag_command(update: Update, context):
    """ะกะผะตะฝะธัั ัะฒะพะน ัะตะณ: /changetag #ะฝะพะฒัะน_ัะตะณ"""
    user = update.effective_user
    user_id = user.id
    
    # ะัะพะฒะตััะตะผ ะฐัะณัะผะตะฝัั
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} โ๏ธ ะกะะะะ ะขะะะ\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /changetag [ะฝะพะฒัะน_ัะตะณ]\n"
            f"{COLORS['violet']} ะัะธะผะตั: /changetag #ัะธะณัะธัะฐ\n\n"
            f"{COLORS['night']} ะขะตะณ ะดะพะปะถะตะฝ ะฝะฐัะธะฝะฐัััั ั #"
        )
        return
    
    # ะะพะปััะฐะตะผ ะฝะพะฒัะน ัะตะณ
    new_tag = context.args[0]
    if not new_tag.startswith('#'):
        new_tag = '#' + new_tag
    
    # ะัะพะฒะตััะตะผ ัััะตััะฒัะตั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("SELECT user_tag FROM user_tags WHERE user_id = ?", (user_id,))
    old_tag = c.fetchone()
    
    if not old_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃ ะฒะฐั ะฝะตั ะทะฐัะตะณะธัััะธัะพะฒะฐะฝะฝะพะณะพ ัะตะณะฐ\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต /settag ะดะปั ัะตะณะธัััะฐัะธะธ"
        )
        conn.close()
        return
    
    # ะะฑะฝะพะฒะปัะตะผ ัะตะณ
    c.execute("""
        UPDATE user_tags 
        SET user_tag = ? 
        WHERE user_id = ?
    """, (new_tag, user_id))
    
    conn.commit()
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} โ ะขะะ ะะะะะะะ\n\n"
        f"{COLORS['blue']} ะกัะฐััะน ัะตะณ: {old_tag[0]}\n"
        f"{COLORS['violet']} ะะพะฒัะน ัะตะณ: {new_tag}"
    )


async def leave_forever_command(update: Update, context):
    """ะะพะบะธะฝััั ะฑะพั ะฝะฐะฒัะตะณะดะฐ (ะฑะฐะฝ)"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    # ะะฐะฟัะฐัะธะฒะฐะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("๐ด ะะ, ะะะะกะะะะ", f"confirm_leave_forever_{user_id}", 'night')],
        [create_fancy_button("โ๏ธ ะะขะะะะ", "admin_main_menu", 'fog')]
    ])
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ด ะะะะะะะะะ ะะะขะ ะะะะกะะะะ\n\n"
        f"{COLORS['blue']} ะขะตะณ: {user_tag}\n"
        f"{COLORS['violet']} ID: {user_id}\n\n"
        f"{COLORS['night']} ะญัะพ ะดะตะนััะฒะธะต ะะะะะะะขะะะ:\n"
        f"โข ะั ะฑัะดะตัะต ะทะฐะฑะฐะฝะตะฝั ะฒ ะณััะฟะฟะต\n"
        f"โข ะขะตะณ ะฑัะดะตั ะดะตะฐะบัะธะฒะธัะพะฒะฐะฝ\n"
        f"โข ะะบัะธะฒะฝัะต ัะฐัั ะฑัะดัั ะทะฐะบัััั\n"
        f"โข ะะตัะฝััััั ะฑัะดะตั ะฝะตะฒะพะทะผะพะถะฝะพ\n\n"
        f"{COLORS['purple']} ะะพะดัะฒะตัะดะธัะต ะดะตะนััะฒะธะต:",
        reply_markup=keyboard
    )


async def leave_temp_command(update: Update, context):
    """ะะพะบะธะฝััั ะฑะพั ะฒัะตะผะตะฝะฝะพ (ะบะธะบ)"""
    user = update.effective_user
    user_id = user.id
    user_tag = get_user_tag(user_id)
    
    if not user_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    # ะะฐะฟัะฐัะธะฒะฐะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โฑ ะะ, ะะะะะะะะ", f"confirm_leave_temp_{user_id}", 'blue')],
        [create_fancy_button("โ๏ธ ะะขะะะะ", "admin_main_menu", 'fog')]
    ])
    
    await update.message.reply_text(
        f"{COLORS['purple']} โฑ ะะะะะะะะซะ ะะซะฅะะ\n\n"
        f"{COLORS['blue']} ะขะตะณ: {user_tag}\n"
        f"{COLORS['violet']} ID: {user_id}\n\n"
        f"{COLORS['night']} ะงัะพ ะฟัะพะธะทะพะนะดะตั:\n"
        f"โข ะั ะฑัะดะตัะต ะบะธะบะฝััั ะธะท ะณััะฟะฟั\n"
        f"โข ะขะตะณ ะฑัะดะตั ะดะตะฐะบัะธะฒะธัะพะฒะฐะฝ\n"
        f"โข ะะบัะธะฒะฝัะต ัะฐัั ะฑัะดัั ะทะฐะบัััั\n"
        f"โข ะะพะถะฝะพ ะฒะตัะฝััััั ัะตัะตะท /start\n\n"
        f"{COLORS['purple']} ะะพะดัะฒะตัะดะธัะต ะดะตะนััะฒะธะต:",
        reply_markup=keyboard
    )


async def broadcast_text_command(update: Update, context):
    """ะะฐัััะปะบะฐ ัะตะบััะพะฒะพะณะพ ัะพะพะฑัะตะฝะธั ะฒัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ"""
    admin_id = update.effective_user.id
    
    # ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ (ัะพะปัะบะพ ะณะปะฐะฒะฝัะต ะฐะดะผะธะฝั)
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ ะดะปั ัะฐัััะปะบะธ")
        return
    
    # ะัะพะฒะตััะตะผ ัะตะบัั
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะขะะะกะขะะะะฏ ะะะกะกะซะะะ\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /broadcasttext [ัะตะบัั]\n"
            f"{COLORS['violet']} ะัะธะผะตั: /broadcasttext ะัะตะผ ะฟัะธะฒะตั! ๐\n\n"
            f"{COLORS['night']} ะขะตะบัั ะผะพะถะฝะพ ะฟะธัะฐัั ะฑะตะท ะบะฐะฒััะตะบ"
        )
        return
    
    broadcast_text = ' '.join(context.args)
    
    # ะกะพััะฐะฝัะตะผ ะฒ user_data
    context.user_data['broadcast_text'] = broadcast_text
    context.user_data['broadcast_type'] = 'text'
    
    # ะะพะบะฐะทัะฒะฐะตะผ ะฟัะตะดะฟัะพัะผะพัั
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โ ะะขะะะะะะขะฌ ะะกะะ", "confirm_broadcast", 'moon')],
        [create_fancy_button("โ ะะขะะะะ", "admin_main_menu", 'night')]
    ])
    
    # ะะพะปััะฐะตะผ ะบะพะปะธัะตััะฒะพ ะฟะพะปััะฐัะตะปะตะน
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM users WHERE is_active = 1 AND is_bot_blocked = 0")
    recipients = c.fetchone()[0] or 0
    conn.close()
    
    await update.message.reply_text(
        f"{COLORS['purple']} ๐ข ะะะะะะะะกะะะขะ ะะะกะกะซะะะ\n\n"
        f"{COLORS['blue']} ะขะตะบัั:\n"
        f"โ {broadcast_text}\n\n"
        f"{COLORS['violet']} ะะพะปััะฐัะตะปะตะน: {recipients}\n\n"
        f"{COLORS['night']} ะัะพะฒะตัััะต ัะตะบัั ะธ ะฟะพะดัะฒะตัะดะธัะต ะพัะฟัะฐะฒะบั:",
        reply_markup=keyboard
    )


async def broadcast_photo_command(update: Update, context):
    """ะะฐัััะปะบะฐ ัะพะพะฑัะตะฝะธั ั ัะพัะพ"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ ะดะปั ัะฐัััะปะบะธ")
        return
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ัะพัะพ ะฒ ัะพะพะฑัะตะฝะธะธ
    if not update.message.photo:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ ะก ะคะะขะ\n\n"
            f"{COLORS['blue']} ะัะฟัะฐะฒััะต ะบะพะผะฐะฝะดั ะฒะผะตััะต ั ัะพัะพ:\n"
            f"/broadcastphoto ะะพะดะฟะธัั ะบ ัะพัะพ\n\n"
            f"{COLORS['violet']} ะัะธะผะตั:\n"
            f"1. ะะฐะฟะธัะธัะต /broadcastphoto ะัะธะฒะตั!\n"
            f"2. ะะพะฑะฐะฒััะต ัะพัะพ ะบ ััะพะผั ะถะต ัะพะพะฑัะตะฝะธั"
        )
        return
    
    # ะะพะปััะฐะตะผ ัะพัะพ (ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ัะฐะทะผะตัะฐ)
    photo = update.message.photo[-1]
    caption = update.message.caption or ""
    
    # ะฃะฑะธัะฐะตะผ ะบะพะผะฐะฝะดั ะธะท ะฟะพะดะฟะธัะธ
    if caption.startswith('/broadcastphoto'):
        caption = caption.replace('/broadcastphoto', '', 1).strip()
    
    # ะกะพััะฐะฝัะตะผ ะฒ user_data
    context.user_data['broadcast_photo'] = photo.file_id
    context.user_data['broadcast_caption'] = caption
    context.user_data['broadcast_type'] = 'photo'
    
    # ะะพะปััะฐะตะผ ะบะพะปะธัะตััะฒะพ ะฟะพะปััะฐัะตะปะตะน
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM users WHERE is_active = 1 AND is_bot_blocked = 0")
    recipients = c.fetchone()[0] or 0
    conn.close()
    
    # ะะพะบะฐะทัะฒะฐะตะผ ะฟัะตะดะฟัะพัะผะพัั
    keyboard = InlineKeyboardMarkup([
        [create_fancy_button("โ ะะขะะะะะะขะฌ ะะกะะ", "confirm_broadcast", 'moon')],
        [create_fancy_button("โ ะะขะะะะ", "admin_main_menu", 'night')]
    ])
    
    await update.message.reply_photo(
        photo=photo.file_id,
        caption=f"{COLORS['purple']} ๐ข ะะะะะะะะกะะะขะ ะะะกะกะซะะะ ะก ะคะะขะ\n\n"
                f"{COLORS['blue']} ะะพะดะฟะธัั:\n"
                f"โ {caption if caption else '(ะฑะตะท ะฟะพะดะฟะธัะธ)'}\n\n"
                f"{COLORS['violet']} ะะพะปััะฐัะตะปะตะน: {recipients}\n\n"
                f"{COLORS['night']} ะัะพะฒะตัััะต ะธ ะฟะพะดัะฒะตัะดะธัะต ะพัะฟัะฐะฒะบั:",
        reply_markup=keyboard
    )



async def broadcast_quick(update: Update, context):
    """ะััััะฐั ัะฐัััะปะบะฐ ะฑะตะท ะฟัะตะดะฟัะพัะผะพััะฐ"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    if not context.args:
        await update.message.reply_text(
            f"{COLORS['purple']} ะัะฟะพะปัะทะพะฒะฐะฝะธะต: /broadcast [ัะตะบัั]"
        )
        return
    
    broadcast_text = ' '.join(context.args)
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT user_id FROM users WHERE is_active = 1 AND is_bot_blocked = 0")
    users = c.fetchall()
    conn.close()
    
    if not users:
        await update.message.reply_text(f"{COLORS['purple']} ๐ข ะะตั ะฟะพะปััะฐัะตะปะตะน")
        return
    
    status_msg = await update.message.reply_text(
        f"{COLORS['purple']} ๐ข ะะฐัััะปะบะฐ ะฝะฐัะฐะปะฐัั...\n"
        f"{COLORS['blue']} 0/{len(users)}"
    )
    
    sent = 0
    failed = 0
    
    for i, (user_id,) in enumerate(users, 1):
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ\n\n{broadcast_text}"
            )
            sent += 1
        except:
            failed += 1
        
        if i % 10 == 0:
            await status_msg.edit_text(
                f"{COLORS['purple']} ๐ข ะะฐัััะปะบะฐ...\n"
                f"{COLORS['blue']} {i}/{len(users)}"
            )
    
    await status_msg.edit_text(
        f"{COLORS['purple']} ๐ข ะะะกะกะซะะะ ะะะะะะจะะะ\n\n"
        f"{COLORS['blue']} โ ะัะฟัะฐะฒะปะตะฝะพ: {sent}\n"
        f"{COLORS['violet']} โ ะัะธะฑะพะบ: {failed}"
    )


async def warn_count(update: Update, context):
    """ะะพะบะฐะทะฐัั ะบะพะปะธัะตััะฒะพ ะฒะฐัะฝะพะฒ ั ะฟะพะปัะทะพะฒะฐัะตะปั"""
    admin_id = update.effective_user.id
    admin_tag = get_user_tag(admin_id)
    
    if not admin_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    target_user = None
    target_id = None
    
    # ะัะปะธ ะตััั ะพัะฒะตั ะฝะฐ ัะพะพะฑัะตะฝะธะต - ัะผะพััะธะผ ะฒะฐัะฝั ัะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
        target_name = target_user.first_name
    else:
        # ะะฝะฐัะต ัะผะพััะธะผ ัะฒะพะธ ะฒะฐัะฝั
        target_user = update.effective_user
        target_id = target_user.id
        target_name = "ะฃ ะฒะฐั"
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะต ะฐะบัะธะฒะฝัะต ะฒะฐัะฝั ะฟะพะปัะทะพะฒะฐัะตะปั
    now = get_current_time()
    c.execute("""
        SELECT id, admin_id, reason, created_at, expires_at 
        FROM warnings 
        WHERE user_id = ? AND (expires_at IS NULL OR expires_at > ?)
        ORDER BY created_at DESC
    """, (target_id, now))
    
    warnings = c.fetchall()
    total_warns = len(warnings)
    
    # ะะพะปััะฐะตะผ ะธััะพัะธั ะฒัะตั ะฒะฐัะฝะพะฒ (ะฒะบะปััะฐั ะธััะตะบัะธะต)
    c.execute("SELECT COUNT(*) FROM warnings WHERE user_id = ?", (target_id,))
    total_history = c.fetchone()[0] or 0
    
    conn.close()
    
    if total_warns == 0:
        await update.message.reply_text(
            f"{COLORS['purple']} โ {target_name} ะฝะตั ะฐะบัะธะฒะฝัั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน\n\n"
            f"{COLORS['blue']} ะัะตะณะพ ะฒะฐัะฝะพะฒ ะทะฐ ะฒัั ะธััะพัะธั: {total_history}"
        )
        return
    
    # ะคะพัะผะธััะตะผ ัะพะพะฑัะตะฝะธะต
    text = f"{COLORS['purple']} โ๏ธ ะะะะะฃะะะะะะะะะฏ {target_name.upper()}\n\n"
    text += f"{COLORS['blue']} ะะบัะธะฒะฝัั: {total_warns}/{MAX_WARNS}\n"
    text += f"{COLORS['violet']} ะัะตะณะพ (ะธััะพัะธั): {total_history}\n\n"
    
    for i, (warn_id, admin_id, reason, created, expires) in enumerate(warnings, 1):
        admin_tag = get_user_tag(admin_id) or f"ID{admin_id}"
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        text += f"{COLORS['night']} {i}. โฑ {created_short}\n"
        text += f"{COLORS['purple']}    ๐ค ะัะดะฐะป: {admin_tag}\n"
        text += f"{COLORS['blue']}    ๐ {reason}\n"
        
        if expires:
            expires_short = expires[:16]
            text += f"{COLORS['violet']}    โณ ะััะตะบะฐะตั: {expires_short}\n"
        else:
            text += f"{COLORS['violet']}    โณ ะะฐะฒัะตะณะดะฐ\n"
        text += "\n"
    
    await update.message.reply_text(text)


async def warn_history(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฟะพะปะฝัั ะธััะพัะธั ะฒะฐัะฝะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั"""
    admin_id = update.effective_user.id
    admin_tag = get_user_tag(admin_id)
    
    if not admin_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    target_user = None
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
        target_name = target_user.first_name
    else:
        target_user = update.effective_user
        target_id = target_user.id
        target_name = "ะะฐัะฐ"
    
    # ะะพะปััะฐะตะผ ัััะฐะฝะธัั
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะต ะฒะฐัะฝั ะฟะพะปัะทะพะฒะฐัะตะปั
    c.execute("""
        SELECT id, admin_id, reason, created_at, expires_at 
        FROM warnings 
        WHERE user_id = ? 
        ORDER BY created_at DESC
    """, (target_id,))
    
    all_warns = c.fetchall()
    total_warns = len(all_warns)
    
    conn.close()
    
    if not all_warns:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ {target_name} ะฝะตั ะธััะพัะธะธ ะฟัะตะดัะฟัะตะถะดะตะฝะธะน"
        )
        return
    
    # ะะฐะณะธะฝะฐัะธั
    warns_per_page = 5
    total_pages = (total_warns + warns_per_page - 1) // warns_per_page
    
    if page < 1 or page > total_pages:
        page = 1
    
    start_idx = (page - 1) * warns_per_page
    end_idx = min(start_idx + warns_per_page, total_warns)
    current_warns = all_warns[start_idx:end_idx]
    
    text = f"{COLORS['purple']} ๐ ะะกะขะะะะฏ ะะะะะฃะะะะะะะะะ {target_name.upper()}\n\n"
    text += f"{COLORS['blue']} ะัะตะณะพ: {total_warns} | ะกััะฐะฝะธัะฐ {page}/{total_pages}\n\n"
    
    now = datetime.now()
    for warn_id, admin_id, reason, created, expires in current_warns:
        admin_tag = get_user_tag(admin_id) or f"ID{admin_id}"
        created_short = created[:16] if created else "ะฝะตะธะทะฒ."
        
        # ะกัะฐััั ะฒะฐัะฝะฐ
        if expires:
            expires_date = datetime.strptime(expires, '%Y-%m-%d %H:%M:%S')
            if expires_date > now:
                status = "๐ข ะะบัะธะฒะตะฝ"
                expires_short = f"ะดะพ {expires[:16]}"
            else:
                status = "โช ะััะตะบ"
                expires_short = f"ะธััะตะบ {expires[:16]}"
        else:
            status = "๐ด ะะฐะฒัะตะณะดะฐ"
            expires_short = "ะฑะตัััะพัะฝะพ"
        
        text += f"{COLORS['night']} #{warn_id} | {status}\n"
        text += f"{COLORS['purple']}    โฑ {created_short}\n"
        text += f"{COLORS['blue']}    ๐ค {admin_tag}\n"
        text += f"{COLORS['violet']}    ๐ {reason}\n"
        text += f"{COLORS['night']}    โณ {expires_short}\n\n"
    
    await update.message.reply_text(text)



async def chat_time(update: Update, context):
    """ะะพะบะฐะทะฐัั ัะบะพะปัะบะพ ะฒัะตะผะตะฝะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐัะต"""
    admin_id = update.effective_user.id
    admin_tag = get_user_tag(admin_id)
    
    if not admin_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    target_user = None
    target_id = None
    
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
        target_name = target_user.first_name
    else:
        target_user = update.effective_user
        target_id = target_user.id
        target_name = "ะั"
    
    try:
        # ะะพะปััะฐะตะผ ะธะฝัะพัะผะฐัะธั ะพ ะฟะพะปัะทะพะฒะฐัะตะปะต ะฒ ัะฐัะต
        member = await context.bot.get_chat_member(ADMIN_GROUP_ID, target_id)
        
        # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะฐัะต
        if member.status in ['left', 'kicked']:
            await update.message.reply_text(
                f"{COLORS['purple']} โ {target_name} ะฝะต ะฒ ัะฐัะต"
            )
            return
        
        # ะะพะปััะฐะตะผ ะดะฐัั ะฒัััะฟะปะตะฝะธั
        if member.status == 'creator':
            role = "๐ ะกะพะทะดะฐัะตะปั"
            join_date = "ัะพะทะดะฐะฝะธั ัะฐัะฐ"
        elif member.status == 'administrator':
            role = "๐ก ะะดะผะธะฝะธัััะฐัะพั"
            # ะฃ ะฐะดะผะธะฝะพะฒ ะฝะตั ะดะฐัั ะฒัััะฟะปะตะฝะธั, ะธัะฟะพะปัะทัะตะผ ัะตะบัััั
            join_date = datetime.now()
        else:
            role = "๐ค ะฃัะฐััะฝะธะบ"
            # ะฃ ะพะฑััะฝัั ััะฐััะฝะธะบะพะฒ ัะพะถะต ะฝะตั ะดะฐัั
            join_date = datetime.now()
        
        # ะะพะปััะฐะตะผ ะธะฝัะพัะผะฐัะธั ะธะท ะะ (ะฟะตัะฒะพะต ะฟะพัะฒะปะตะฝะธะต)
        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        c.execute("SELECT first_seen FROM users WHERE user_id = ?", (target_id,))
        result = c.fetchone()
        conn.close()
        
        if result and result[0]:
            first_seen = datetime.strptime(result[0], '%Y-%m-%d %H:%M:%S')
            days_in_bot = (datetime.now() - first_seen).days
            bot_time = f"{days_in_bot} ะดะฝ."
        else:
            bot_time = "ะฝะตะธะทะฒะตััะฝะพ"
        
        # ะคะพัะผะธััะตะผ ัะพะพะฑัะตะฝะธะต
        text = f"{COLORS['purple']} โฑ ะะะคะะะะะฆะะฏ ะ ะะะะะะะ\n\n"
        text += f"{COLORS['blue']} ๐ค {target_name}\n"
        text += f"{COLORS['violet']} ๐ {target_id}\n"
        text += f"{COLORS['night']} {role}\n\n"
        text += f"{COLORS['purple']} ะ ะฑะพัะต:\n"
        text += f"{COLORS['blue']}   โข ะก {first_seen.strftime('%d.%m.%Y') if result else 'ะฝะตะธะทะฒะตััะฝะพ'}\n"
        text += f"{COLORS['violet']}   โข ะัะตะณะพ ะดะฝะตะน: {bot_time}\n\n"
        
        # ะัะปะธ ะฐะดะผะธะฝ - ะฟะพะบะฐะทัะฒะฐะตะผ ะฒัะตะผั ะฐะดะผะธะฝััะฒะฐ (ะฟัะธะฑะปะธะทะธัะตะปัะฝะพ)
        if member.status in ['creator', 'administrator']:
            text += f"{COLORS['night']} ะ ะฐะดะผะธะฝะบะต:\n"
            text += f"{COLORS['purple']}   โข ะกัะฐััั ะฟะพะปััะตะฝ ะฟัะธ ะฒัััะฟะปะตะฝะธะธ\n"
            text += f"{COLORS['blue']}   โข ะขะพัะฝะพะต ะฒัะตะผั ะฐะดะผะธะฝััะฒะฐ ะฝะตะธะทะฒะตััะฝะพ\n"
        
        await update.message.reply_text(text)
        
    except Exception as e:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะัะธะฑะบะฐ: {e}"
        )


async def chat_time_detailed(update: Update, context):
    """ะะตัะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั ะพ ะฒัะตะผะตะฝะธ ะฒ ัะฐัะต"""
    admin_id = update.effective_user.id
    admin_tag = get_user_tag(admin_id)
    
    if not admin_tag:
        await update.message.reply_text(f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ")
        return
    
    target_user = None
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
        target_name = target_user.first_name
    else:
        target_user = update.effective_user
        target_id = target_user.id
        target_name = "ะั"
    
    try:
        member = await context.bot.get_chat_member(ADMIN_GROUP_ID, target_id)
        
        if member.status in ['left', 'kicked']:
            await update.message.reply_text(f"{COLORS['purple']} โ {target_name} ะฝะต ะฒ ัะฐัะต")
            return
        
        # ะกัะฐัะธััะธะบะฐ ะธะท ะะ
        conn = sqlite3.connect('support_bot.db')
        c = conn.cursor()
        
        # ะะตัะฒะพะต ะฟะพัะฒะปะตะฝะธะต
        c.execute("SELECT first_seen FROM users WHERE user_id = ?", (target_id,))
        first_seen = c.fetchone()
        
        # ะะพัะปะตะดะฝัั ะฐะบัะธะฒะฝะพััั
        c.execute("SELECT last_activity FROM users WHERE user_id = ?", (target_id,))
        last_activity = c.fetchone()
        
        # ะะพะปะธัะตััะฒะพ ัะพะพะฑัะตะฝะธะน
        c.execute("SELECT COUNT(*) FROM messages WHERE from_user = ? OR from_taker = ?", (target_id, target_id))
        messages_count = c.fetchone()[0] or 0
        
        # ะะพะปะธัะตััะฒะพ ะฒะทัััั ัะฐัะพะฒ (ะตัะปะธ ะฐะดะผะธะฝ)
        c.execute("SELECT COUNT(*) FROM active_chats WHERE taken_by_id = ?", (target_id,))
        taken_chats = c.fetchone()[0] or 0
        
        # ะะพะปะธัะตััะฒะพ ัะตััะพะฒ (ะตัะปะธ ะฐะดะผะธะฝ)
        c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ?", (target_id,))
        rests_count = c.fetchone()[0] or 0
        
        conn.close()
        
        text = f"{COLORS['purple']} ๐ ะะะขะะะฌะะะฏ ะกะขะะขะะกะขะะะ ะะะะะะะ\n\n"
        text += f"{COLORS['blue']} ๐ค {target_name}\n"
        text += f"{COLORS['violet']} ๐ {target_id}\n\n"
        
        if first_seen and first_seen[0]:
            first = datetime.strptime(first_seen[0], '%Y-%m-%d %H:%M:%S')
            days_total = (datetime.now() - first).days
            text += f"{COLORS['night']} ๐ ะะตัะฒะพะต ะฟะพัะฒะปะตะฝะธะต:\n"
            text += f"{COLORS['purple']}   โข {first.strftime('%d.%m.%Y %H:%M')}\n"
            text += f"{COLORS['blue']}   โข {days_total} ะดะฝะตะน ะฒ ัะธััะตะผะต\n"
        else:
            text += f"{COLORS['night']} ๐ ะะตัะฒะพะต ะฟะพัะฒะปะตะฝะธะต: ะฝะตะธะทะฒะตััะฝะพ\n"
        
        if last_activity and last_activity[0]:
            last = datetime.strptime(last_activity[0], '%Y-%m-%d %H:%M:%S')
            hours_ago = (datetime.now() - last).total_seconds() / 3600
            text += f"{COLORS['violet']} โฑ ะะพัะปะตะดะฝัั ะฐะบัะธะฒะฝะพััั:\n"
            text += f"{COLORS['blue']}   โข {last.strftime('%d.%m.%Y %H:%M')}\n"
            text += f"{COLORS['purple']}   โข {hours_ago:.1f} ั. ะฝะฐะทะฐะด\n"
        
        text += f"\n{COLORS['night']} ๐ ะะบัะธะฒะฝะพััั:\n"
        text += f"{COLORS['blue']}   โข ะกะพะพะฑัะตะฝะธะน: {messages_count}\n"
        
        if member.status in ['creator', 'administrator']:
            text += f"{COLORS['violet']}   โข ะงะฐัะพะฒ ะฒะทััะพ: {taken_chats}\n"
            text += f"{COLORS['purple']}   โข ะะตััะพะฒ: {rests_count}\n"
        
        await update.message.reply_text(text)
        
    except Exception as e:
        await update.message.reply_text(f"{COLORS['purple']} โ ะัะธะฑะบะฐ: {e}")


async def stats_my(update: Update, context):
    """ะะพั ััะฐัะธััะธะบะฐ /ััะฐัะธััะธะบะฐ [ัะตะณะพะดะฝั|ะฝะตะดะตะปั|ะผะตััั|ะฒัั]"""
    user_id = update.effective_user.id
    user_tag = get_user_tag(user_id) or "ะะดะผะธะฝ"
    
    args = context.args
    period_input = args[0].lower() if args else "ะฒัั"
    
    period_map = {
        "ัะตะณะพะดะฝั": ("ะะ ะกะะะะะะฏ", datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)),
        "ะฝะตะดะตะปั": ("ะะ ะะะะะะฎ", datetime.now() - timedelta(days=7)),
        "ะผะตััั": ("ะะ ะะะกะฏะฆ", datetime.now() - timedelta(days=30)),
        "ะฒัั": ("ะะ ะะกะ ะะะะะฏ", datetime(2000, 1, 1))
    }
    
    if period_input not in period_map:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตะฒะตัะฝัะน ะฟะตัะธะพะด\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต:\n"
            f"/ััะฐัะธััะธะบะฐ ัะตะณะพะดะฝั - ะทะฐ ัะตะณะพะดะฝั\n"
            f"/ััะฐัะธััะธะบะฐ ะฝะตะดะตะปั - ะทะฐ ะฝะตะดะตะปั\n"
            f"/ััะฐัะธััะธะบะฐ ะผะตััั - ะทะฐ ะผะตััั\n"
            f"/ััะฐัะธััะธะบะฐ ะฒัั - ะทะฐ ะฒัะต ะฒัะตะผั"
        )
        return
    
    period_text, start_date = period_map[period_input]
    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ัะฐัะฐะผ
    c.execute("""SELECT 
                    COUNT(*) as total_chats,
                    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_chats,
                    SUM(CASE WHEN taken_at > ? THEN 1 ELSE 0 END) as chats_in_period
                 FROM active_chats 
                 WHERE taken_by_id = ?""", (start_str, user_id))
    chat_stats = c.fetchone()
    total_chats = chat_stats[0] or 0
    active_chats = chat_stats[1] or 0
    chats_in_period = chat_stats[2] or 0
    
    # ะกัะฐัะธััะธะบะฐ ะฟะพ ัะพะพะฑัะตะฝะธัะผ
    c.execute("""SELECT COUNT(*) FROM messages 
                 WHERE from_taker = ? AND created_at > ?""", (user_id, start_str))
    messages_in_period = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker = ?", (user_id,))
    total_messages = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(LENGTH(text)) FROM messages WHERE from_taker = ?", (user_id,))
    avg_length = c.fetchone()[0] or 0
    
    # ะัะพะฒะตัะบะฐ ะฒ ัะตััะต
    c.execute("SELECT status FROM rests WHERE admin_id = ? AND status = 'active'", (user_id,))
    in_rest = "โ ะะ" if c.fetchone() else "โ ะะะข"
    
    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ?", (user_id,))
    total_rests = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะะะฏ ะกะขะะขะะกะขะะะ\n{COLORS['blue']} {user_tag}\n{COLORS['violet']} {period_text}\n\n"
    text += f"{COLORS['night']} ๐ ะงะะขะซ:\n"
    text += f"โ ะัะตะณะพ ะฒะทััะพ: {total_chats}\n"
    text += f"โ ะะทััะพ ะทะฐ ะฟะตัะธะพะด: {chats_in_period}\n"
    text += f"โ ะะบัะธะฒะฝัั ัะตะนัะฐั: {active_chats}\n\n"
    text += f"{COLORS['purple']} ๐จ ะกะะะะฉะะะะฏ:\n"
    text += f"โ ะัะตะณะพ: {total_messages}\n"
    text += f"โ ะะฐ ะฟะตัะธะพะด: {messages_in_period}\n"
    text += f"โ ะกัะตะดะฝัั ะดะปะธะฝะฐ: {avg_length:.0f} ัะธะผะฒ.\n\n"
    text += f"{COLORS['blue']} ๐ด ะะะกะขะซ:\n"
    text += f"โ ะกะตะนัะฐั: {in_rest}\n"
    text += f"โ ะัะตะณะพ ัะตััะพะฒ: {total_rests}"
    
    await update.message.reply_text(text)


async def stats_admin(update: Update, context):
    """ะกัะฐัะธััะธะบะฐ ะฐะดะผะธะฝะฐ /ััะฐัะธััะธะบะฐ_ะฐะดะผะธะฝะฐ [ัะตะณ] [ัะตะณะพะดะฝั|ะฝะตะดะตะปั|ะผะตััั|ะฒัั]"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    args = context.args
    if len(args) < 1:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะฃะบะฐะถะธัะต ัะตะณ ะฐะดะผะธะฝะฐ\n\n"
            f"{COLORS['blue']} ะัะธะผะตั:\n"
            f"/ััะฐัะธััะธะบะฐ_ะฐะดะผะธะฝะฐ #ัะธะณัะธัะฐ ะฝะตะดะตะปั"
        )
        return
    
    target_tag = args[0]
    period_input = args[1].lower() if len(args) > 1 else "ะฒัั"
    
    # ะะฐัะพะดะธะผ ะฐะดะผะธะฝะฐ ะฟะพ ัะตะณั
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    c.execute("SELECT user_id FROM user_tags WHERE user_tag = ? AND is_active = 1", (target_tag,))
    result = c.fetchone()
    conn.close()
    
    if not result:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะดะผะธะฝ ั ัะตะณะพะผ {target_tag} ะฝะต ะฝะฐะนะดะตะฝ")
        return
    
    target_id = result[0]
    
    period_map = {
        "ัะตะณะพะดะฝั": ("ะะ ะกะะะะะะฏ", datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)),
        "ะฝะตะดะตะปั": ("ะะ ะะะะะะฎ", datetime.now() - timedelta(days=7)),
        "ะผะตััั": ("ะะ ะะะกะฏะฆ", datetime.now() - timedelta(days=30)),
        "ะฒัั": ("ะะ ะะกะ ะะะะะฏ", datetime(2000, 1, 1))
    }
    
    if period_input not in period_map:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตะฒะตัะฝัะน ะฟะตัะธะพะด\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต: ัะตะณะพะดะฝั, ะฝะตะดะตะปั, ะผะตััั, ะฒัั"
        )
        return
    
    period_text, start_date = period_map[period_input]
    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("""SELECT 
                    COUNT(*) as total_chats,
                    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_chats,
                    SUM(CASE WHEN taken_at > ? THEN 1 ELSE 0 END) as chats_in_period
                 FROM active_chats 
                 WHERE taken_by_id = ?""", (start_str, target_id))
    chat_stats = c.fetchone()
    total_chats = chat_stats[0] or 0
    active_chats = chat_stats[1] or 0
    chats_in_period = chat_stats[2] or 0
    
    c.execute("""SELECT COUNT(*) FROM messages 
                 WHERE from_taker = ? AND created_at > ?""", (target_id, start_str))
    messages_in_period = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker = ?", (target_id,))
    total_messages = c.fetchone()[0] or 0
    
    c.execute("SELECT AVG(LENGTH(text)) FROM messages WHERE from_taker = ?", (target_id,))
    avg_length = c.fetchone()[0] or 0
    
    c.execute("SELECT status FROM rests WHERE admin_id = ? AND status = 'active'", (target_id,))
    in_rest = "โ ะะ" if c.fetchone() else "โ ะะะข"
    
    c.execute("SELECT COUNT(*) FROM rests WHERE admin_id = ?", (target_id,))
    total_rests = c.fetchone()[0] or 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะะะะ\n{COLORS['blue']} {target_tag}\n{COLORS['violet']} {period_text}\n\n"
    text += f"{COLORS['night']} ๐ ะงะะขะซ:\n"
    text += f"โ ะัะตะณะพ ะฒะทััะพ: {total_chats}\n"
    text += f"โ ะะทััะพ ะทะฐ ะฟะตัะธะพะด: {chats_in_period}\n"
    text += f"โ ะะบัะธะฒะฝัั ัะตะนัะฐั: {active_chats}\n\n"
    text += f"{COLORS['purple']} ๐จ ะกะะะะฉะะะะฏ:\n"
    text += f"โ ะัะตะณะพ: {total_messages}\n"
    text += f"โ ะะฐ ะฟะตัะธะพะด: {messages_in_period}\n"
    text += f"โ ะกัะตะดะฝัั ะดะปะธะฝะฐ: {avg_length:.0f} ัะธะผะฒ.\n\n"
    text += f"{COLORS['blue']} ๐ด ะะะกะขะซ:\n"
    text += f"โ ะกะตะนัะฐั: {in_rest}\n"
    text += f"โ ะัะตะณะพ ัะตััะพะฒ: {total_rests}"
    
    await update.message.reply_text(text)


async def stats_top(update: Update, context):
    """ะขะพะฟ ะฐะดะผะธะฝะพะฒ /ัะพะฟ [ัะตะณะพะดะฝั|ะฝะตะดะตะปั|ะผะตััั|ะฒัั]"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    args = context.args
    period_input = args[0].lower() if args else "ะฒัั"
    
    period_map = {
        "ัะตะณะพะดะฝั": ("ะะ ะกะะะะะะฏ", datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)),
        "ะฝะตะดะตะปั": ("ะะ ะะะะะะฎ", datetime.now() - timedelta(days=7)),
        "ะผะตััั": ("ะะ ะะะกะฏะฆ", datetime.now() - timedelta(days=30)),
        "ะฒัั": ("ะะ ะะกะ ะะะะะฏ", datetime(2000, 1, 1))
    }
    
    if period_input not in period_map:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะะตะฒะตัะฝัะน ะฟะตัะธะพะด\n\n"
            f"{COLORS['blue']} ะัะฟะพะปัะทัะนัะต: ัะตะณะพะดะฝั, ะฝะตะดะตะปั, ะผะตััั, ะฒัั"
        )
        return
    
    period_text, start_date = period_map[period_input]
    start_str = start_date.strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะขะพะฟ ะฟะพ ัะพะพะฑัะตะฝะธัะผ
    c.execute("""SELECT ut.user_tag, COUNT(m.id) as msg_count
                 FROM messages m
                 JOIN user_tags ut ON m.from_taker = ut.user_id
                 WHERE m.from_taker IS NOT NULL AND m.created_at > ?
                 GROUP BY m.from_taker
                 ORDER BY msg_count DESC
                 LIMIT 5""", (start_str,))
    top_messages = c.fetchall()
    
    # ะขะพะฟ ะฟะพ ะฒะทัััะผ ัะฐัะฐะผ
    c.execute("""SELECT ut.user_tag, COUNT(ac.user_id) as chats_count
                 FROM active_chats ac
                 JOIN user_tags ut ON ac.taken_by_id = ut.user_id
                 WHERE ac.taken_by_id IS NOT NULL AND ac.taken_at > ?
                 GROUP BY ac.taken_by_id
                 ORDER BY chats_count DESC
                 LIMIT 5""", (start_str,))
    top_chats = c.fetchall()
    
    # ะขะพะฟ ะฟะพ ัะตััะฐะผ
    c.execute("""SELECT ut.user_tag, COUNT(r.id) as rests_count
                 FROM rests r
                 JOIN user_tags ut ON r.admin_id = ut.user_id
                 WHERE r.created_at > ?
                 GROUP BY r.admin_id
                 ORDER BY rests_count DESC
                 LIMIT 5""", (start_str,))
    top_rests = c.fetchall()
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะขะะ-5 ะะะะะะะ\n{COLORS['blue']} {period_text}\n\n"
    
    text += f"{COLORS['violet']} ๐จ ะะ ะกะะะะฉะะะะฏะ:\n"
    if top_messages:
        for i, (tag, count) in enumerate(top_messages, 1):
            medal = "๐ฅ" if i == 1 else "๐ฅ" if i == 2 else "๐ฅ" if i == 3 else f"{i}."
            text += f"{COLORS['blue']} {medal} {tag}: {count}\n"
    else:
        text += f"{COLORS['night']} ะะตั ะดะฐะฝะฝัั\n"
    
    text += f"\n{COLORS['purple']} ๐ ะะ ะงะะขะะ:\n"
    if top_chats:
        for i, (tag, count) in enumerate(top_chats, 1):
            medal = "๐ฅ" if i == 1 else "๐ฅ" if i == 2 else "๐ฅ" if i == 3 else f"{i}."
            text += f"{COLORS['blue']} {medal} {tag}: {count}\n"
    else:
        text += f"{COLORS['night']} ะะตั ะดะฐะฝะฝัั\n"
    
    text += f"\n{COLORS['night']} ๐ด ะะ ะะะกะขะะ:\n"
    if top_rests:
        for i, (tag, count) in enumerate(top_rests, 1):
            medal = "๐ฅ" if i == 1 else "๐ฅ" if i == 2 else "๐ฅ" if i == 3 else f"{i}."
            text += f"{COLORS['blue']} {medal} {tag}: {count}\n"
    else:
        text += f"{COLORS['night']} ะะตั ะดะฐะฝะฝัั\n"
    
    await update.message.reply_text(text)


async def stats_users(update: Update, context):
    """ะกัะฐัะธััะธะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน /ะฟะพะปัะทะพะฒะฐัะตะปะธ"""
    admin_id = update.effective_user.id
    
    if admin_id not in MAIN_ADMIN_IDS:
        await update.message.reply_text(f"{COLORS['purple']} โ ะะตั ะฟัะฐะฒ")
        return
    
    now = datetime.now()
    today_start = now.replace(hour=0, minute=0, second=0, microsecond=0).strftime('%Y-%m-%d %H:%M:%S')
    week_start = (now - timedelta(days=7)).strftime('%Y-%m-%d %H:%M:%S')
    month_start = (now - timedelta(days=30)).strftime('%Y-%m-%d %H:%M:%S')
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    c.execute("SELECT COUNT(*) FROM users")
    total_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (today_start,))
    active_today = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (week_start,))
    active_week = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (month_start,))
    active_month = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE is_bot_blocked = 1")
    blocked_users = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (today_start,))
    new_today = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM users WHERE first_seen > ?", (week_start,))
    new_week = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL")
    total_user_messages = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL AND created_at > ?", (today_start,))
    user_messages_today = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_user IS NOT NULL AND created_at > ?", (week_start,))
    user_messages_week = c.fetchone()[0] or 0
    
    c.execute("SELECT COUNT(*) FROM messages WHERE from_taker IS NOT NULL")
    total_admin_messages = c.fetchone()[0] or 0
    
    # ะขะพะฟ-5 ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    c.execute("""SELECT u.first_name, u.username, COUNT(m.id) as msg_count
                 FROM users u
                 LEFT JOIN messages m ON u.user_id = m.user_id AND m.from_user IS NOT NULL
                 GROUP BY u.user_id
                 ORDER BY msg_count DESC
                 LIMIT 5""")
    top_users = c.fetchall()
    
    avg_per_user = total_user_messages / total_users if total_users > 0 else 0
    
    conn.close()
    
    text = f"{COLORS['purple']} ๐ ะกะขะะขะะกะขะะะ ะะะะฌะะะะะขะะะะ\n\n"
    text += f"{COLORS['blue']} ๐ฅ ะัะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {total_users}\n"
    text += f"{COLORS['violet']} โ ะะบัะธะฒะฝัั ะทะฐ 24ั: {active_today}\n"
    text += f"{COLORS['night']} โ ะะบัะธะฒะฝัั ะทะฐ ะฝะตะดะตะปั: {active_week}\n"
    text += f"{COLORS['purple']} โ ะะบัะธะฒะฝัั ะทะฐ ะผะตััั: {active_month}\n"
    text += f"{COLORS['blue']} ๐ซ ะะฐะฑะปะพะบะธัะพะฒะฐะปะธ ะฑะพัะฐ: {blocked_users}\n\n"
    
    text += f"{COLORS['violet']} ๐ ะะพะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ:\n"
    text += f"โ ะะฐ ัะตะณะพะดะฝั: {new_today}\n"
    text += f"โ ะะฐ ะฝะตะดะตะปั: {new_week}\n\n"
    
    text += f"{COLORS['night']} ๐จ ะกะพะพะฑัะตะฝะธั:\n"
    text += f"โ ะั ะฟะพะปัะทะพะฒะฐัะตะปะตะน: {total_user_messages}\n"
    text += f"โ ะะฐ ัะตะณะพะดะฝั: {user_messages_today}\n"
    text += f"โ ะะฐ ะฝะตะดะตะปั: {user_messages_week}\n"
    text += f"โ ะั ะฐะดะผะธะฝะพะฒ: {total_admin_messages}\n"
    text += f"โ ะ ััะตะดะฝะตะผ ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั: {avg_per_user:.1f}\n\n"
    
    if top_users:
        text += f"{COLORS['purple']} ๐ ะขะะ-5 ะะ ะะะขะะะะะกะขะ:\n"
        for i, (name, username, msg_count) in enumerate(top_users, 1):
            if name or username:
                user_display = name or username or f"ID"
                text += f"{COLORS['blue']} {i}. {user_display} - {msg_count} ัะพะพะฑั.\n"
    
    await update.message.reply_text(text)


async def admin_my_chats(update: Update, context):
    """ะะพะบะฐะทะฐัั ะฒัะต ัะฐัั ะฐะดะผะธะฝะฐ ัะพ ัััะปะบะฐะผะธ /mychats ะธะปะธ /ะผะพะธัะฐัั"""
    admin = update.effective_user
    admin_id = admin.id
    admin_tag = get_user_tag(admin_id)
    
    # ะัะพะฒะตััะตะผ, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะดะผะธะฝ
    if not admin_tag:
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะกะฝะฐัะฐะปะฐ ะทะฐัะตะณะธัััะธััะนัะต ัะตะณ ัะตัะตะท /settag"
        )
        return
    
    # ะัะพะฒะตััะตะผ, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะณััะฟะฟะต
    if not await is_group_member(admin_id, context):
        await update.message.reply_text(
            f"{COLORS['purple']} โ ะั ะฝะต ัะฒะปัะตัะตัั ััะฐััะฝะธะบะพะผ ะณััะฟะฟั ะฐะดะผะธะฝะพะฒ"
        )
        return
    
    conn = sqlite3.connect('support_bot.db')
    c = conn.cursor()
    
    # ะะพะปััะฐะตะผ ะฒัะต ัะฐัั, ะณะดะต ะฐะดะผะธะฝ ะฑัะป ะฝะฐะทะฝะฐัะตะฝ (ะฐะบัะธะฒะฝัะต ะธ ะทะฐะฒะตััะตะฝะฝัะต)
    c.execute("""
        SELECT user_id, user_name, username, thread_id, status, created_at, taken_at 
        FROM active_chats 
        WHERE taken_by_id = ? 
        ORDER BY 
            CASE status 
                WHEN 'active' THEN 1 
                WHEN 'pending' THEN 2 
                ELSE 3 
            END,
            taken_at DESC
    """, (admin_id,))
    
    chats = c.fetchall()
    conn.close()
    
    if not chats:
        await update.message.reply_text(
            f"{COLORS['purple']} ๐ ะฃ ะฒะฐั ะฟะพะบะฐ ะฝะตั ัะฐัะพะฒ ั ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ"
        )
        return
    
    # ะะฐะทะดะตะปัะตะผ ะฝะฐ ะฐะบัะธะฒะฝัะต ะธ ะทะฐะฒะตััะตะฝะฝัะต
    active_chats = []
    completed_chats = []
    
    for chat in chats:
        if chat[4] == 'active':
            active_chats.append(chat)
        else:
            completed_chats.append(chat)
    
    # ะคะพัะผะธััะตะผ ัะพะพะฑัะตะฝะธะต
    text = f"{COLORS['purple']} ๐ ะะะ ะงะะขะซ ะก ะะะะฌะะะะะขะะะฏะะ\n"
    text += f"{COLORS['blue']} ๐ค ะะดะผะธะฝ: {admin_tag}\n\n"
    
    # ะะบัะธะฒะฝัะต ัะฐัั
    if active_chats:
        text += f"{COLORS['green']} ๐ด ะะะขะะะะซะ ะงะะขะซ ({len(active_chats)}):\n\n"
        for i, chat in enumerate(active_chats, 1):
            user_id, user_name, username, thread_id, status, created_at, taken_at = chat
            
            # ะกะพะทะดะฐะตะผ ัััะปะบั ะฝะฐ ััะตะด
            thread_link = f"https://t.me/c/{str(ADMIN_GROUP_ID).replace('-100', '')}/{thread_id}"
            
            username_text = f" (@{username})" if username else ""
            taken_time = f"ะฒะทัั {taken_at[:16]}" if taken_at else ""
            
            text += f"{COLORS['violet']} {i}. ๐ค {user_name}{username_text}\n"
            text += f"{COLORS['blue']}    ๐ ID: {user_id}\n"
            text += f"{COLORS['night']}    ๐ {taken_time}\n"
            text += f"{COLORS['purple']}    ๐ [ะะตัะตะนัะธ ะฒ ัะฐั]({thread_link})\n\n"
    else:
        text += f"{COLORS['yellow']} ๐ญ ะะตั ะฐะบัะธะฒะฝัั ัะฐัะพะฒ\n\n"
    
    # ะะฐะฒะตััะตะฝะฝัะต ัะฐัั (ะฟะพัะปะตะดะฝะธะต 5)
    if completed_chats:
        text += f"{COLORS['fog']} ๐ ะะะกะะะะะะ ะะะะะะจะะะะซะ (ะดะพ 5):\n\n"
        for i, chat in enumerate(completed_chats[:5], 1):
            user_id, user_name, username, thread_id, status, created_at, taken_at = chat
            
            thread_link = f"https://t.me/c/{str(ADMIN_GROUP_ID).replace('-100', '')}/{thread_id}"
            username_text = f" (@{username})" if username else ""
            
            text += f"{COLORS['violet']} {i}. ๐ค {user_name}{username_text}\n"
            text += f"{COLORS['blue']}    ๐ {user_id}\n"
            text += f"{COLORS['night']}    ๐ [ะกััะปะบะฐ]({thread_link})\n\n"
    
    # ะัะปะธ ัะพะพะฑัะตะฝะธะต ัะปะธัะบะพะผ ะดะปะธะฝะฝะพะต, ัะฐะทะฑะธะฒะฐะตะผ ะฝะฐ ัะฐััะธ
    if len(text) > 4000:
        parts = [text[i:i+4000] for i in range(0, len(text), 4000)]
        for part in parts:
            await update.message.reply_text(part, disable_web_page_preview=True)
    else:
        await update.message.reply_text(text, disable_web_page_preview=True)

      
def main():
    # ะ ะดะพะฑะฐะฒั ะตะณะพ ะฒ main() ะ ะกะะะะ ะะะงะะะ:
    application = Application.builder().token(TOKEN).build()


    init_database()
    print("=" * 70)
    print("๐ ะะะะฃะกะ ะะะขะ ะะะะะะะะะ")
    print("=" * 70)
    print(f"๐ฑ ะขะพะบะตะฝ: {TOKEN[:10]}...")
    print(f"๐ฅ ะััะฟะฟะฐ: {ADMIN_GROUP_ID}")
    print(f"๐ ะะปะฐะฒะฝัะต ะฐะดะผะธะฝั: {MAIN_ADMIN_IDS}")
    print("=" * 70)

    
    application = Application.builder().token(TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("write", user_write))
    application.add_handler(CommandHandler("admin", user_become_admin))
    application.add_handler(CommandHandler("review", user_leave_review))
    application.add_handler(CommandHandler("reviews", user_view_reviews))
    application.add_handler(CommandHandler("rules", user_rules))
    application.add_handler(CommandHandler("channel", user_channel))
    application.add_handler(CommandHandler(["mychat"], user_my_chat))
    application.add_handler(CommandHandler(["changeadmin"], user_change_admin))
    application.add_handler(CommandHandler("help", user_help))
    # ะะพะผะฐะฝะดั ะดะปั ะฟัะพัะผะพััะฐ ะฒะฐัะฝะพะฒ
    application.add_handler(CommandHandler("mood", mood_track))
    application.add_handler(CommandHandler("mood_history", mood_history))
    application.add_handler(CommandHandler("mood_stats", mood_stats))
    # ะะพะผะฐะฝะดั ััะตะบะตัะฐ ะดะปั ะฐะดะผะธะฝะพะฒ
    application.add_handler(CommandHandler("admin_mood_history", admin_mood_history))
    application.add_handler(CommandHandler("warns", warn_count))
    application.add_handler(CommandHandler("warnhistory", warn_history))
    # ะะพะผะฐะฝะดั ะดะปั ะฟัะพัะผะพััะฐ ะฒัะตะผะตะฝะธ ะฒ ัะฐัะต
    application.add_handler(CommandHandler("chattime", chat_time))
    application.add_handler(CommandHandler("mychats", admin_my_chats))
    application.add_handler(CommandHandler("chattimedetailed", chat_time_detailed))
    application.add_handler(CommandHandler("appsall", show_apps_all))
    # ะะปั ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ (ะตัะปะธ ะบัะพ-ัะพ ะฟัะธะฒัะบ ะบ ะฐะฝะณะปะธะนัะบะธะผ)
    application.add_handler(CommandHandler("stats_my", stats_my))
    application.add_handler(CommandHandler("stats_admin", stats_admin))
    application.add_handler(CommandHandler("stats_top", stats_top))
    application.add_handler(CommandHandler("stats_users", stats_users))
    application.add_handler(CommandHandler("statsgeneral", stats_general_command))
    application.add_handler(CommandHandler("statsmy", stats_my_command))
    application.add_handler(CommandHandler("statsadmins", stats_admins_command))
    application.add_handler(CommandHandler("statstoday", stats_today_command))
    application.add_handler(CommandHandler("statsweek", stats_week_command))
    application.add_handler(CommandHandler("statsmonth", stats_month_command))
    application.add_handler(CommandHandler("usersstats", users_stats_command))
    application.add_handler(CommandHandler("userstop", users_top_command))
    application.add_handler(CommandHandler("usersblocked", users_blocked_command))
    application.add_handler(CommandHandler("usersnew", users_new_command))
    application.add_handler(CommandHandler("blockedlist", blocked_users_list))
    application.add_handler(CommandHandler("blockedcount", blocked_users_count))
    application.add_handler(CommandHandler("blockedexport", blocked_users_export))
    application.add_handler(CommandHandler("refreshlink", refresh_invite_command))
    application.add_handler(CommandHandler("newlink", refresh_invite_simple))
    application.add_handler(CommandHandler("linkinfo", invite_link_info))
    application.add_handler(CommandHandler("changetag", change_tag_command))
    application.add_handler(CommandHandler("leaveforever", leave_forever_command))
    application.add_handler(CommandHandler("leavetemp", leave_temp_command))
    application.add_handler(CommandHandler("broadcasttext", broadcast_text_command))
    application.add_handler(CommandHandler("broadcastphoto", broadcast_photo_command))
    application.add_handler(CommandHandler("broadcast", broadcast_quick))
    application.add_handler(CommandHandler("reviewsnew", show_reviews_new))
    application.add_handler(CommandHandler("reviewsviewed", show_reviews_viewed))
    application.add_handler(CommandHandler("reviewsall", show_reviews_all))
    application.add_handler(CommandHandler("reviewstats", show_reviews_stats_command))
    application.add_handler(CommandHandler("review", show_review_detail))
    application.add_handler(CommandHandler("appspending", show_apps_pending))
    application.add_handler(CommandHandler("appsaccepted", show_apps_accepted))
    application.add_handler(CommandHandler("appsrejected", show_apps_rejected))
    application.add_handler(CommandHandler("app", show_app_detail))
    application.add_handler(CommandHandler("appsstats", apps_stats))
    application.add_handler(CommandHandler("pending", pending_requests))
    application.add_handler(CommandHandler("clearnew", clear_new_reviews))
    application.add_handler(CommandHandler("resttake", rest_take_command))
    application.add_handler(CommandHandler("restactive", rest_active_command))
    application.add_handler(CommandHandler("restmy", rest_my_command))
    application.add_handler(CommandHandler("resthistory", rest_history_command))
    application.add_handler(CommandHandler("reststats", rest_stats_command))
    application.add_handler(CommandHandler("restend", rest_end_command))
    application.add_handler(CommandHandler("settag", register_tag))
    application.add_handler(CommandHandler("kick", kick_user))
    application.add_handler(CommandHandler("ban", ban_user))
    application.add_handler(CommandHandler("unban", unban_user))
    application.add_handler(CommandHandler("mute", mute_user))
    application.add_handler(CommandHandler("unmute", unmute_user))
    application.add_handler(CommandHandler("warn", warn_user))
    application.add_handler(CommandHandler("unwarn", unwarn_user))
    application.add_handler(CommandHandler("broadcast", broadcast))
    application.add_handler(CommandHandler("userstats", user_stats))
    application.add_handler(CommandHandler("blocked", blocked_users))
    application.add_handler(CommandHandler("refreshlink", refresh_invite_link))
    application.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, new_chat_members))
    application.add_handler(MessageHandler(filters.COMMAND & filters.Regex('^/(' + '|'.join(RP_ACTIONS.keys()) + ')$'), 
        rp_action))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(
        (filters.TEXT | filters.PHOTO | filters.VIDEO |
         filters.Document.ALL | filters.AUDIO | filters.VOICE |
         filters.Sticker.ALL | filters.ANIMATION | filters.VIDEO_NOTE) & ~filters.COMMAND,
        message_handler
    ))
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

    async def init_bot():
        await application.initialize()
        await application.bot.initialize()
        # ะะดะตัั ะะะข ะฒัะทะพะฒะฐ create_threads
        print("โ ะะพั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ")

    try:
        loop.run_until_complete(init_bot())
    except Exception as e:
        logger.error(f"โ ะัะธะฑะบะฐ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ: {e}")
        print(f"โ ะัะธะฑะบะฐ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ: {e}")
    try:
        if application.job_queue:
            async def rest_checker(context):
                conn = sqlite3.connect('support_bot.db')
                c = conn.cursor()
                now = datetime.now().strftime('%d.%m.%Y')

                c.execute("""SELECT id, admin_id, admin_tag, end_date, reason, message_id, thread_id 
                             FROM rests WHERE status = 'active' AND end_date <= ? AND notified = 0""", (now,))
                expired_rests = c.fetchall()

                for rest in expired_rests:
                    rest_id, admin_id, admin_tag, end_date, reason, msg_id, thread_id = rest
                    try:
                        await context.bot.send_message(
                            chat_id=admin_id,
                            text=f"{COLORS['purple']} ๐ ะัะตะผั ะฒััะพะดะธัั ะธะท ัะตััะฐ!\n\n{COLORS['blue']} ะะฐั ัะตัั ะทะฐะบะพะฝัะธะปัั ัะตะณะพะดะฝั.\nะขะตะฟะตัั ะฒั ัะฝะพะฒะฐ ะผะพะถะตัะต ะฑัะฐัั ะทะฐัะฒะบะธ. {COLORS['cloud']}"
                        )
                    except:
                        pass

                    c.execute("""UPDATE rests SET status = 'completed', completed_at = ?, notified = 1 WHERE id = ?""",
                              (get_current_time(), rest_id))

                    try:
                        await context.bot.edit_message_text(
                            chat_id=ADMIN_GROUP_ID, message_id=msg_id,
                            text=f"{COLORS['purple']} โ ะะะกะข ะะะะะะจะะ\n\n{COLORS['blue']} ะะดะผะธะฝ: {admin_tag}\n{COLORS['violet']} ะะตัั ะทะฐะบะพะฝัะธะปัั: {end_date}\n{COLORS['night']} ะัะธัะธะฝะฐ: {reason}",
                            reply_markup=None
                        )
                    except:
                        pass

                conn.commit()
                conn.close()

            application.job_queue.run_repeating(rest_checker, interval=60, first=10)
            print("โ ะะปะฐะฝะธัะพะฒัะธะบ ัะตััะพะฒ ะทะฐะฟััะตะฝ")
        else:
            print("โ๏ธ Job queue ะฝะต ะดะพัััะฟะตะฝ")
    except Exception as e:
        print(f"โ๏ธ ะัะธะฑะบะฐ: {e}")

    print("\nโ **ะะพั ะณะพัะพะฒ ะบ ัะฐะฑะพัะต!**")
    print("=" * 70)

    application.run_polling()


if __name__ == "__main__":

    main()
